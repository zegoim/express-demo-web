/*! For license information please see ZegoExpressPlayer-1.2.0.js.LICENSE.txt */
var ZegoExpressPlayer;(()=>{var e={204:e=>{"use strict";var t,i="object"==typeof Reflect?Reflect:null,n=i&&"function"==typeof i.apply?i.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(i,n){function r(i){e.removeListener(t,o),n(i)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",r),i([].slice.call(arguments))}m(e,t,o,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&m(e,"error",t,i)}(e,r,{once:!0})}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var s=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function d(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function l(e,t,i,n){var r,o,s,l;if(a(i),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),s=o[t]),void 0===s)s=o[t]=i,++e._eventsCount;else if("function"==typeof s?s=o[t]=n?[i,s]:[s,i]:n?s.unshift(i):s.push(i),(r=d(e))>0&&s.length>r&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,l=u,console&&console.warn&&console.warn(l)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function c(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=u.bind(n);return r.listener=i,n.wrapFn=r,r}function h(e,t,i){var n=e._events;if(void 0===n)return[];var r=n[t];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(r):f(r,r.length)}function p(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function f(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}function m(e,t,i,n){if("function"==typeof e.on)n.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(o){n.once&&e.removeEventListener(t,r),i(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return d(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var d=o[e];if(void 0===d)return!1;if("function"==typeof d)n(d,this,t);else{var l=d.length,u=f(d,l);for(i=0;i<l;++i)n(u[i],this,t)}return!0},o.prototype.addListener=function(e,t){return l(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return l(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,c(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,c(this,e,t)),this},o.prototype.removeListener=function(e,t){var i,n,r,o,s;if(a(t),void 0===(n=this._events))return this;if(void 0===(i=n[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){s=i[o].listener,r=o;break}if(r<0)return this;0===r?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,r),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,o=Object.keys(i);for(n=0;n<o.length;++n)"removeListener"!==(r=o[n])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},o.prototype.listeners=function(e){return h(this,e,!0)},o.prototype.rawListeners=function(e){return h(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},705:(e,t,i)=>{const n=i(227),r=i(445),o=i(307);e.exports=n+r+o},701:(e,t,i)=>{e.exports={lowercase:i(445),uppercase:i(307),numbers:i(227),nolookalikes:i(251),nolookalikesSafe:i(403),alphanumeric:i(705)}},445:e=>{e.exports="abcdefghijklmnopqrstuvwxyz"},403:e=>{e.exports="6789BCDFGHJKLMNPQRTWbcdfghjkmnpqrtwz"},251:e=>{e.exports="346789ABCDEFGHJKLMNPQRTUVWXYabcdefghijkmnpqrtwxyz"},227:e=>{e.exports="0123456789"},307:e=>{e.exports="ABCDEFGHIJKLMNOPQRSTUVWXYZ"},933:(e,t,i)=>{var n;!function(e){!function(t){var n="object"==typeof i.g?i.g:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),r=o(e);function o(e,t){return function(i,n){"function"!=typeof e[i]&&Object.defineProperty(e,i,{configurable:!0,writable:!0,value:n}),t&&t(i,n)}}void 0===n.Reflect?n.Reflect=e:r=o(n.Reflect,r),function(e){var t=Object.prototype.hasOwnProperty,i="function"==typeof Symbol,n=i&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",r=i&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,s={__proto__:[]}instanceof Array,a=!o&&!s,d={create:o?function(){return ne(Object.create(null))}:s?function(){return ne({__proto__:null})}:function(){return ne({})},has:a?function(e,i){return t.call(e,i)}:function(e,t){return t in e},get:a?function(e,i){return t.call(e,i)?e[i]:void 0}:function(e,t){return e[t]}},l=Object.getPrototypeOf(Function),u="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,c=u||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?ee():Map,h=u||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?te():Set,p=new(u||"function"!=typeof WeakMap?ie():WeakMap);function f(e,t,i,n){if(I(i)){if(!H(e))throw new TypeError;if(!G(t))throw new TypeError;return w(e,t)}if(!H(e))throw new TypeError;if(!V(t))throw new TypeError;if(!V(n)&&!I(n)&&!L(n))throw new TypeError;return L(n)&&(n=void 0),R(e,t,i=q(i),n)}function m(e,t){function i(i,n){if(!V(i))throw new TypeError;if(!I(n)&&!z(n))throw new TypeError;x(e,t,i,n)}return i}function g(e,t,i,n){if(!V(i))throw new TypeError;return I(n)||(n=q(n)),x(e,t,i,n)}function y(e,t,i){if(!V(t))throw new TypeError;return I(i)||(i=q(i)),A(e,t,i)}function v(e,t,i){if(!V(t))throw new TypeError;return I(i)||(i=q(i)),P(e,t,i)}function b(e,t,i){if(!V(t))throw new TypeError;return I(i)||(i=q(i)),F(e,t,i)}function _(e,t,i){if(!V(t))throw new TypeError;return I(i)||(i=q(i)),T(e,t,i)}function C(e,t){if(!V(e))throw new TypeError;return I(t)||(t=q(t)),k(e,t)}function E(e,t){if(!V(e))throw new TypeError;return I(t)||(t=q(t)),M(e,t)}function S(e,t,i){if(!V(t))throw new TypeError;I(i)||(i=q(i));var n=D(t,i,!1);if(I(n))return!1;if(!n.delete(e))return!1;if(n.size>0)return!0;var r=p.get(t);return r.delete(i),r.size>0||p.delete(t),!0}function w(e,t){for(var i=e.length-1;i>=0;--i){var n=(0,e[i])(t);if(!I(n)&&!L(n)){if(!G(n))throw new TypeError;t=n}}return t}function R(e,t,i,n){for(var r=e.length-1;r>=0;--r){var o=(0,e[r])(t,i,n);if(!I(o)&&!L(o)){if(!V(o))throw new TypeError;n=o}}return n}function D(e,t,i){var n=p.get(e);if(I(n)){if(!i)return;n=new c,p.set(e,n)}var r=n.get(t);if(I(r)){if(!i)return;r=new c,n.set(t,r)}return r}function A(e,t,i){if(P(e,t,i))return!0;var n=J(t);return!L(n)&&A(e,n,i)}function P(e,t,i){var n=D(t,i,!1);return!I(n)&&j(n.has(e))}function F(e,t,i){if(P(e,t,i))return T(e,t,i);var n=J(t);return L(n)?void 0:F(e,n,i)}function T(e,t,i){var n=D(t,i,!1);if(!I(n))return n.get(e)}function x(e,t,i,n){D(i,n,!0).set(e,t)}function k(e,t){var i=M(e,t),n=J(e);if(null===n)return i;var r=k(n,t);if(r.length<=0)return i;if(i.length<=0)return r;for(var o=new h,s=[],a=0,d=i;a<d.length;a++){var l=d[a];o.has(l)||(o.add(l),s.push(l))}for(var u=0,c=r;u<c.length;u++){l=c[u];o.has(l)||(o.add(l),s.push(l))}return s}function M(e,t){var i=[],n=D(e,t,!1);if(I(n))return i;for(var r=Y(n.keys()),o=0;;){var s=X(r);if(!s)return i.length=o,i;var a=$(s);try{i[o]=a}catch(d){try{Z(r)}finally{throw d}}o++}}function O(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function I(e){return void 0===e}function L(e){return null===e}function B(e){return"symbol"==typeof e}function V(e){return"object"==typeof e?null!==e:"function"==typeof e}function U(e,t){switch(O(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var i=3===t?"string":5===t?"number":"default",r=K(e,n);if(void 0!==r){var o=r.call(e,i);if(V(o))throw new TypeError;return o}return N(e,"default"===i?"number":i)}function N(e,t){if("string"===t){var i=e.toString;if(Q(i))if(!V(r=i.call(e)))return r;if(Q(n=e.valueOf))if(!V(r=n.call(e)))return r}else{var n;if(Q(n=e.valueOf))if(!V(r=n.call(e)))return r;var r,o=e.toString;if(Q(o))if(!V(r=o.call(e)))return r}throw new TypeError}function j(e){return!!e}function W(e){return""+e}function q(e){var t=U(e,3);return B(t)?t:W(t)}function H(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function Q(e){return"function"==typeof e}function G(e){return"function"==typeof e}function z(e){switch(O(e)){case 3:case 4:return!0;default:return!1}}function K(e,t){var i=e[t];if(null!=i){if(!Q(i))throw new TypeError;return i}}function Y(e){var t=K(e,r);if(!Q(t))throw new TypeError;var i=t.call(e);if(!V(i))throw new TypeError;return i}function $(e){return e.value}function X(e){var t=e.next();return!t.done&&t}function Z(e){var t=e.return;t&&t.call(e)}function J(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===l)return t;if(t!==l)return t;var i=e.prototype,n=i&&Object.getPrototypeOf(i);if(null==n||n===Object.prototype)return t;var r=n.constructor;return"function"!=typeof r||r===e?t:r}function ee(){var e={},t=[],i=function(){function e(e,t,i){this._index=0,this._keys=e,this._values=t,this._selector=i}return e.prototype["@@iterator"]=function(){return this},e.prototype[r]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var i=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:i,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var i=this._find(e,!0);return this._values[i]=t,this},t.prototype.delete=function(t){var i=this._find(t,!1);if(i>=0){for(var n=this._keys.length,r=i+1;r<n;r++)this._keys[r-1]=this._keys[r],this._values[r-1]=this._values[r];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new i(this._keys,this._values,n)},t.prototype.values=function(){return new i(this._keys,this._values,o)},t.prototype.entries=function(){return new i(this._keys,this._values,s)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[r]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function n(e,t){return e}function o(e,t){return t}function s(e,t){return[e,t]}}function te(){return function(){function e(){this._map=new c}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[r]=function(){return this.keys()},e}()}function ie(){var e=16,i=d.create(),n=r();return function(){function e(){this._key=r()}return e.prototype.has=function(e){var t=o(e,!1);return void 0!==t&&d.has(t,this._key)},e.prototype.get=function(e){var t=o(e,!1);return void 0!==t?d.get(t,this._key):void 0},e.prototype.set=function(e,t){return o(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=o(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=r()},e}();function r(){var e;do{e="@@WeakMap@@"+l()}while(d.has(i,e));return i[e]=!0,e}function o(e,i){if(!t.call(e,n)){if(!i)return;Object.defineProperty(e,n,{value:d.create()})}return e[n]}function s(e,t){for(var i=0;i<t;++i)e[i]=255*Math.random()|0;return e}function a(e){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):s(new Uint8Array(e),e):s(new Array(e),e)}function l(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var i="",n=0;n<e;++n){var r=t[n];4!==n&&6!==n&&8!==n||(i+="-"),r<16&&(i+="0"),i+=r.toString(16).toLowerCase()}return i}}function ne(e){return e.__=void 0,delete e.__,e}e("decorate",f),e("metadata",m),e("defineMetadata",g),e("hasMetadata",y),e("hasOwnMetadata",v),e("getMetadata",b),e("getOwnMetadata",_),e("getMetadataKeys",C),e("getOwnMetadataKeys",E),e("deleteMetadata",S)}(r)}()}(n||(n={}))}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}i.m=e,i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.u=e=>e+".ZegoExpressPlayer-1.2.0.js",i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;i.g.importScripts&&(e=i.g.location+"");var t=i.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var r=n.length-1;r>-1&&!e;)e=n[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),i.b=document.baseURI||self.location.href;var n={};(()=>{"use strict";i.d(n,{ZegoExpressPlayer:()=>Qa});var e={Request:"Request",Singleton:"Singleton",Transient:"Transient"},t={ConstantValue:"ConstantValue",Constructor:"Constructor",DynamicValue:"DynamicValue",Factory:"Factory",Function:"Function",Instance:"Instance",Invalid:"Invalid",Provider:"Provider"},r={ClassProperty:"ClassProperty",ConstructorArgument:"ConstructorArgument",Variable:"Variable"},o=0;function s(){return o++}var a=function(){function i(e,i){this.id=s(),this.activated=!1,this.serviceIdentifier=e,this.scope=i,this.type=t.Invalid,this.constraint=function(e){return!0},this.implementationType=null,this.cache=null,this.factory=null,this.provider=null,this.onActivation=null,this.onDeactivation=null,this.dynamicValue=null}return i.prototype.clone=function(){var t=new i(this.serviceIdentifier,this.scope);return t.activated=t.scope===e.Singleton&&this.activated,t.implementationType=this.implementationType,t.dynamicValue=this.dynamicValue,t.scope=this.scope,t.type=this.type,t.factory=this.factory,t.provider=this.provider,t.constraint=this.constraint,t.onActivation=this.onActivation,t.onDeactivation=this.onDeactivation,t.cache=this.cache,t},i}(),d="Metadata key was used more than once in a parameter:",l="NULL argument",u="Key Not Found",c="Ambiguous match found for serviceIdentifier:",h="No matching bindings found for serviceIdentifier:",p="Missing required @injectable annotation in:",f="Missing required @inject or @multiInject annotation in:",m="Circular dependency found:",g="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",y=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return"The number of constructor arguments in the derived class "+e[0]+" must be >= than the number of constructor arguments of its base class."},v=function(e,t){return"@postConstruct error in class "+e+": "+t},b=function(e,t){return"@preDestroy error in class "+e+": "+t},_=function(e,t){return"onDeactivation() error in class "+e+": "+t},C="Maximum call stack size exceeded",E="named",S="name",w="unmanaged",R="optional",D="inject",A="multi_inject",P="inversify:tagged",F="inversify:tagged_props",T="inversify:paramtypes",x="post_construct",k="pre_destroy";var M=[D,A,S,w,E,R],O=function(){function e(){}return e.prototype.getConstructorMetadata=function(e){return{compilerGeneratedMetadata:Reflect.getMetadata(T,e),userGeneratedMetadata:Reflect.getMetadata(P,e)||{}}},e.prototype.getPropertiesMetadata=function(e){return Reflect.getMetadata(F,e)||[]},e}(),I={MultipleBindingsAvailable:2,NoBindingsAvailable:0,OnlyOneBindingAvailable:1};function L(e){return e instanceof RangeError||e.message===C}function B(e){return"function"==typeof e?e.name:"symbol"==typeof e?e.toString():e}function V(e,t,i){var n="",r=i(e,t);return 0!==r.length&&(n="\nRegistered bindings:",r.forEach((function(e){var t="Object";null!==e.implementationType&&(t=j(e.implementationType)),n=n+"\n "+t,e.constraint.metaData&&(n=n+" - "+e.constraint.metaData)}))),n}function U(e,t){return null!==e.parentRequest&&(e.parentRequest.serviceIdentifier===t||U(e.parentRequest,t))}function N(e){e.childRequests.forEach((function(e){if(U(e,e.serviceIdentifier)){var t=function(e){var t=function e(t,i){void 0===i&&(i=[]);var n=B(t.serviceIdentifier);return i.push(n),null!==t.parentRequest?e(t.parentRequest,i):i}(e);return t.reverse().join(" --\x3e ")}(e);throw new Error(m+" "+t)}N(e)}))}function j(e){if(e.name)return e.name;var t=e.toString(),i=t.match(/^function\s*([^\s(]+)/);return i?i[1]:"Anonymous function: "+t}var W=function(){function e(e){this.id=s(),this.container=e}return e.prototype.addPlan=function(e){this.plan=e},e.prototype.setCurrentRequest=function(e){this.currentRequest=e},e}(),q=function(){function e(e,t){this.key=e,this.value=t}return e.prototype.toString=function(){return this.key===E?"named: "+String(this.value).toString()+" ":"tagged: { key:"+this.key.toString()+", value: "+String(this.value)+" }"},e}(),H=function(e,t){this.parentContext=e,this.rootRequest=t},Q=function(){function e(e){this._cb=e}return e.prototype.unwrap=function(){return this._cb()},e}(),G=function(){function e(e){this.str=e}return e.prototype.startsWith=function(e){return 0===this.str.indexOf(e)},e.prototype.endsWith=function(e){var t,i=e.split("").reverse().join("");return t=this.str.split("").reverse().join(""),this.startsWith.call({str:t},i)},e.prototype.contains=function(e){return-1!==this.str.indexOf(e)},e.prototype.equals=function(e){return this.str===e},e.prototype.value=function(){return this.str},e}(),z=function(){function e(e,t,i,n){this.id=s(),this.type=e,this.serviceIdentifier=i;var r="symbol"==typeof t?t.toString().slice(7,-1):t;this.name=new G(r||""),this.identifier=t,this.metadata=new Array;var o=null;"string"==typeof n?o=new q(E,n):n instanceof q&&(o=n),null!==o&&this.metadata.push(o)}return e.prototype.hasTag=function(e){for(var t=0,i=this.metadata;t<i.length;t++){if(i[t].key===e)return!0}return!1},e.prototype.isArray=function(){return this.hasTag(A)},e.prototype.matchesArray=function(e){return this.matchesTag(A)(e)},e.prototype.isNamed=function(){return this.hasTag(E)},e.prototype.isTagged=function(){return this.metadata.some((function(e){return M.every((function(t){return e.key!==t}))}))},e.prototype.isOptional=function(){return this.matchesTag(R)(!0)},e.prototype.getNamedTag=function(){return this.isNamed()?this.metadata.filter((function(e){return e.key===E}))[0]:null},e.prototype.getCustomTags=function(){return this.isTagged()?this.metadata.filter((function(e){return M.every((function(t){return e.key!==t}))})):null},e.prototype.matchesNamedTag=function(e){return this.matchesTag(E)(e)},e.prototype.matchesTag=function(e){var t=this;return function(i){for(var n=0,r=t.metadata;n<r.length;n++){var o=r[n];if(o.key===e&&o.value===i)return!0}return!1}},e}(),K=function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};function Y(e,t,i,n){var r=e.getConstructorMetadata(i),o=r.compilerGeneratedMetadata;if(void 0===o)throw new Error(p+" "+t+".");var s=r.userGeneratedMetadata,a=Object.keys(s),d=0===i.length&&a.length>0,l=a.length>i.length,u=function(e,t,i,n,r){for(var o=[],s=0;s<r;s++){var a=$(s,e,t,i,n);null!==a&&o.push(a)}return o}(n,t,o,s,d||l?a.length:i.length),c=Z(e,i,t);return K(K([],u,!0),c,!0)}function $(e,t,i,n,o){var s=o[e.toString()]||[],a=ee(s),d=!0!==a.unmanaged,l=n[e],u=a.inject||a.multiInject;if((l=u||l)instanceof Q&&(l=l.unwrap()),d){if(!t&&(l===Object||l===Function||void 0===l))throw new Error(f+" argument "+e+" in class "+i+".");var c=new z(r.ConstructorArgument,a.targetName,l);return c.metadata=s,c}return null}function X(e,t,i,n){var r=e||t;if(void 0===r){var o=p+" for property "+String(i)+" in class "+n+".";throw new Error(o)}return r}function Z(e,t,i){for(var n=e.getPropertiesMetadata(t),o=[],s=Object.getOwnPropertySymbols(n),a=0,d=Object.keys(n).concat(s);a<d.length;a++){var l=d[a],u=n[l],c=ee(u),h=c.targetName||l,p=X(c.inject,c.multiInject,l,i),f=new z(r.ClassProperty,h,p);f.metadata=u,o.push(f)}var m=Object.getPrototypeOf(t.prototype).constructor;if(m!==Object){var g=Z(e,m,i);o=K(K([],o,!0),g,!0)}return o}function J(e,t){var i=Object.getPrototypeOf(t.prototype).constructor;if(i!==Object){var n=Y(e,j(i),i,!0),r=n.map((function(e){return e.metadata.filter((function(e){return e.key===w}))})),o=[].concat.apply([],r).length,s=n.length-o;return s>0?s:J(e,i)}return 0}function ee(e){var t={};return e.forEach((function(e){t[e.key.toString()]=e.value})),{inject:t[D],multiInject:t[A],targetName:t[S],unmanaged:t[w]}}var te=function(){function e(e,t,i,n,r){this.id=s(),this.serviceIdentifier=e,this.parentContext=t,this.parentRequest=i,this.target=r,this.childRequests=[],this.bindings=Array.isArray(n)?n:[n],this.requestScope=null===i?new Map:null}return e.prototype.addChildRequest=function(t,i,n){var r=new e(t,this.parentContext,this,i,n);return this.childRequests.push(r),r},e}();function ie(e){return e._bindingDictionary}function ne(e,t,i,n,r){var o=oe(i.container,r.serviceIdentifier),s=[];return o.length===I.NoBindingsAvailable&&i.container.options.autoBindInjectable&&"function"==typeof r.serviceIdentifier&&e.getConstructorMetadata(r.serviceIdentifier).compilerGeneratedMetadata&&(i.container.bind(r.serviceIdentifier).toSelf(),o=oe(i.container,r.serviceIdentifier)),s=t?o:o.filter((function(e){var t=new te(e.serviceIdentifier,i,n,e,r);return e.constraint(t)})),function(e,t,i,n){switch(t.length){case I.NoBindingsAvailable:if(i.isOptional())return t;var r=B(e),o=h;throw o+=function(e,t){if(t.isTagged()||t.isNamed()){var i="",n=t.getNamedTag(),r=t.getCustomTags();return null!==n&&(i+=n.toString()+"\n"),null!==r&&r.forEach((function(e){i+=e.toString()+"\n"}))," "+e+"\n "+e+" - "+i}return" "+e}(r,i),o+=V(n,r,oe),new Error(o);case I.OnlyOneBindingAvailable:return t;case I.MultipleBindingsAvailable:default:if(i.isArray())return t;r=B(e),o=c+" "+r;throw o+=V(n,r,oe),new Error(o)}}(r.serviceIdentifier,s,r,i.container),s}function re(e,i,n,r,o,s){var a,d;if(null===o){a=ne(e,i,r,null,s),d=new te(n,r,null,a,s);var l=new H(r,d);r.addPlan(l)}else a=ne(e,i,r,o,s),d=o.addChildRequest(s.serviceIdentifier,a,s);a.forEach((function(i){var n=null;if(s.isArray())n=d.addChildRequest(i.serviceIdentifier,i,s);else{if(i.cache)return;n=d}if(i.type===t.Instance&&null!==i.implementationType){var o=function(e,t){return Y(e,j(t),t,!1)}(e,i.implementationType);if(!r.container.options.skipBaseClassChecks){var a=J(e,i.implementationType);if(o.length<a){var l=y(j(i.implementationType));throw new Error(l)}}o.forEach((function(t){re(e,!1,t.serviceIdentifier,r,n,t)}))}}))}function oe(e,t){var i=[],n=ie(e);return n.hasKey(t)?i=n.get(t):null!==e.parent&&(i=oe(e.parent,t)),i}function se(e,t,i,n,r,o,s,a){void 0===a&&(a=!1);var d=new W(t),l=function(e,t,i,n,r,o){var s=new q(e?A:D,i),a=new z(t,n,i,s);if(void 0!==r){var d=new q(r,o);a.metadata.push(d)}return a}(i,n,r,"",o,s);try{return re(e,a,r,d,null,l),d}catch(u){throw L(u)&&N(d.plan.rootRequest),u}}function ae(e){return("object"==typeof e&&null!==e||"function"==typeof e)&&"function"==typeof e.then}function de(e){return!!ae(e)||Array.isArray(e)&&e.some(ae)}var le,ue=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))},ce=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(a){o=[6,a],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},he=function(e,t,i){e.has(t.id)||e.set(t.id,i)},pe=function(e,t){e.cache=t,e.activated=!0,ae(t)&&fe(e,t)},fe=function(e,t){return ue(void 0,void 0,void 0,(function(){var i,n;return ce(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,t];case 1:return i=r.sent(),e.cache=i,[3,3];case 2:throw n=r.sent(),e.cache=null,e.activated=!1,n;case 3:return[2]}}))}))};!function(e){e.DynamicValue="toDynamicValue",e.Factory="toFactory",e.Provider="toProvider"}(le||(le={}));var me=function(){return me=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},me.apply(this,arguments)},ge=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))},ye=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(a){o=[6,a],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},ve=function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};function be(e,t,i){var n;if(t.length>0){var o=function(e,t){return e.reduce((function(e,i){var n=t(i);return i.target.type===r.ConstructorArgument?e.constructorInjections.push(n):(e.propertyRequests.push(i),e.propertyInjections.push(n)),e.isAsync||(e.isAsync=de(n)),e}),{constructorInjections:[],propertyInjections:[],propertyRequests:[],isAsync:!1})}(t,i),s=me(me({},o),{constr:e});n=o.isAsync?function(e){return ge(this,void 0,void 0,(function(){var t,i;return ye(this,(function(n){switch(n.label){case 0:return[4,Ce(e.constructorInjections)];case 1:return t=n.sent(),[4,Ce(e.propertyInjections)];case 2:return i=n.sent(),[2,_e(me(me({},e),{constructorInjections:t,propertyInjections:i}))]}}))}))}(s):_e(s)}else n=new e;return n}function _e(e){var t,i=new((t=e.constr).bind.apply(t,ve([void 0],e.constructorInjections,!1)));return e.propertyRequests.forEach((function(t,n){var r=t.target.identifier,o=e.propertyInjections[n];t.target.isOptional()&&void 0===o||(i[r]=o)})),i}function Ce(e){return ge(this,void 0,void 0,(function(){var t,i,n,r;return ye(this,(function(o){for(t=[],i=0,n=e;i<n.length;i++)r=n[i],Array.isArray(r)?t.push(Promise.all(r)):t.push(r);return[2,Promise.all(t)]}))}))}function Ee(e,t){var i=function(e,t){var i,n;if(Reflect.hasMetadata(x,e)){var r=Reflect.getMetadata(x,e);try{return null===(n=(i=t)[r.value])||void 0===n?void 0:n.call(i)}catch(o){if(o instanceof Error)throw new Error(v(e.name,o.message))}}}(e,t);return ae(i)?i.then((function(){return t})):t}function Se(t,i){t.scope!==e.Singleton&&function(t,i){var n="Class cannot be instantiated in "+(t.scope===e.Request?"request":"transient")+" scope.";if("function"==typeof t.onDeactivation)throw new Error(_(i.name,n));if(Reflect.hasMetadata(k,i))throw new Error(b(i.name,n))}(t,i)}var we=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))},Re=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(a){o=[6,a],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},De=function(e){return function(t){t.parentContext.setCurrentRequest(t);var i=t.bindings,n=t.childRequests,r=t.target&&t.target.isArray(),o=!(t.parentRequest&&t.parentRequest.target&&t.target&&t.parentRequest.target.matchesArray(t.target.serviceIdentifier));if(r&&o)return n.map((function(t){return De(e)(t)}));if(!t.target.isOptional()||0!==i.length){var s=i[0];return Te(e,t,s)}}},Ae=function(e,i){var n=function(e){switch(e.type){case t.Factory:return{factory:e.factory,factoryType:le.Factory};case t.Provider:return{factory:e.provider,factoryType:le.Provider};case t.DynamicValue:return{factory:e.dynamicValue,factoryType:le.DynamicValue};default:throw new Error("Unexpected factory type "+e.type)}}(e);return function(e,t){try{return e()}catch(i){throw L(i)&&(i=t()),i}}((function(){return n.factory.bind(e)(i)}),(function(){return new Error((e=n.factoryType,t=i.currentRequest.serviceIdentifier.toString(),"It looks like there is a circular dependency in one of the '"+e+"' bindings. Please investigate bindings with service identifier '"+t+"'."));var e,t}))},Pe=function(e,i,n){var r,o=i.childRequests;switch(function(e){var i=null;switch(e.type){case t.ConstantValue:case t.Function:i=e.cache;break;case t.Constructor:case t.Instance:i=e.implementationType;break;case t.DynamicValue:i=e.dynamicValue;break;case t.Provider:i=e.provider;break;case t.Factory:i=e.factory}if(null===i){var n=B(e.serviceIdentifier);throw new Error("Invalid binding type: "+n)}}(n),n.type){case t.ConstantValue:case t.Function:r=n.cache;break;case t.Constructor:r=n.implementationType;break;case t.Instance:r=function(e,t,i,n){Se(e,t);var r=be(t,i,n);return ae(r)?r.then((function(e){return Ee(t,e)})):Ee(t,r)}(n,n.implementationType,o,De(e));break;default:r=Ae(n,i.parentContext)}return r},Fe=function(t,i,n){var r=function(t,i){return i.scope===e.Singleton&&i.activated?i.cache:i.scope===e.Request&&t.has(i.id)?t.get(i.id):null}(t,i);return null!==r||function(t,i,n){i.scope===e.Singleton&&pe(i,n),i.scope===e.Request&&he(t,i,n)}(t,i,r=n()),r},Te=function(e,t,i){return Fe(e,i,(function(){var n=Pe(e,t,i);return n=ae(n)?n.then((function(e){return xe(t,i,e)})):xe(t,i,n)}))};function xe(e,t,i){var n,r=ke(e.parentContext,t,i),o=Le(e.parentContext.container),s=o.next();do{n=s.value;var a=e.parentContext,d=e.serviceIdentifier,l=Ie(n,d);r=ae(r)?Oe(l,a,r):Me(l,a,r),s=o.next()}while(!0!==s.done&&!ie(n).hasKey(e.serviceIdentifier));return r}var ke=function(e,t,i){return"function"==typeof t.onActivation?t.onActivation(e,i):i},Me=function(e,t,i){for(var n=e.next();!n.done;){if(ae(i=n.value(t,i)))return Oe(e,t,i);n=e.next()}return i},Oe=function(e,t,i){return we(void 0,void 0,void 0,(function(){var n,r;return Re(this,(function(o){switch(o.label){case 0:return[4,i];case 1:n=o.sent(),r=e.next(),o.label=2;case 2:return r.done?[3,4]:[4,r.value(t,n)];case 3:return n=o.sent(),r=e.next(),[3,2];case 4:return[2,n]}}))}))},Ie=function(e,t){var i=e._activations;return i.hasKey(t)?i.get(t).values():[].values()},Le=function(e){for(var t=[e],i=e.parent;null!==i;)t.push(i),i=i.parent;return{next:function(){var e=t.pop();return void 0!==e?{done:!1,value:e}:{done:!0,value:void 0}}}};var Be=function(e,t){var i=e.parentRequest;return null!==i&&(!!t(i)||Be(i,t))},Ve=function(e){return function(t){var i=function(i){return null!==i&&null!==i.target&&i.target.matchesTag(e)(t)};return i.metaData=new q(e,t),i}},Ue=Ve(E),Ne=function(e){return function(t){var i=null;if(null!==t){if(i=t.bindings[0],"string"==typeof e)return i.serviceIdentifier===e;var n=t.bindings[0].implementationType;return e===n}return!1}},je=function(){function e(e){this._binding=e}return e.prototype.when=function(e){return this._binding.constraint=e,new We(this._binding)},e.prototype.whenTargetNamed=function(e){return this._binding.constraint=Ue(e),new We(this._binding)},e.prototype.whenTargetIsDefault=function(){return this._binding.constraint=function(e){return null!==e&&(null!==e.target&&!e.target.isNamed()&&!e.target.isTagged())},new We(this._binding)},e.prototype.whenTargetTagged=function(e,t){return this._binding.constraint=Ve(e)(t),new We(this._binding)},e.prototype.whenInjectedInto=function(e){return this._binding.constraint=function(t){return null!==t&&Ne(e)(t.parentRequest)},new We(this._binding)},e.prototype.whenParentNamed=function(e){return this._binding.constraint=function(t){return null!==t&&Ue(e)(t.parentRequest)},new We(this._binding)},e.prototype.whenParentTagged=function(e,t){return this._binding.constraint=function(i){return null!==i&&Ve(e)(t)(i.parentRequest)},new We(this._binding)},e.prototype.whenAnyAncestorIs=function(e){return this._binding.constraint=function(t){return null!==t&&Be(t,Ne(e))},new We(this._binding)},e.prototype.whenNoAncestorIs=function(e){return this._binding.constraint=function(t){return null!==t&&!Be(t,Ne(e))},new We(this._binding)},e.prototype.whenAnyAncestorNamed=function(e){return this._binding.constraint=function(t){return null!==t&&Be(t,Ue(e))},new We(this._binding)},e.prototype.whenNoAncestorNamed=function(e){return this._binding.constraint=function(t){return null!==t&&!Be(t,Ue(e))},new We(this._binding)},e.prototype.whenAnyAncestorTagged=function(e,t){return this._binding.constraint=function(i){return null!==i&&Be(i,Ve(e)(t))},new We(this._binding)},e.prototype.whenNoAncestorTagged=function(e,t){return this._binding.constraint=function(i){return null!==i&&!Be(i,Ve(e)(t))},new We(this._binding)},e.prototype.whenAnyAncestorMatches=function(e){return this._binding.constraint=function(t){return null!==t&&Be(t,e)},new We(this._binding)},e.prototype.whenNoAncestorMatches=function(e){return this._binding.constraint=function(t){return null!==t&&!Be(t,e)},new We(this._binding)},e}(),We=function(){function e(e){this._binding=e}return e.prototype.onActivation=function(e){return this._binding.onActivation=e,new je(this._binding)},e.prototype.onDeactivation=function(e){return this._binding.onDeactivation=e,new je(this._binding)},e}(),qe=function(){function e(e){this._binding=e,this._bindingWhenSyntax=new je(this._binding),this._bindingOnSyntax=new We(this._binding)}return e.prototype.when=function(e){return this._bindingWhenSyntax.when(e)},e.prototype.whenTargetNamed=function(e){return this._bindingWhenSyntax.whenTargetNamed(e)},e.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},e.prototype.whenTargetTagged=function(e,t){return this._bindingWhenSyntax.whenTargetTagged(e,t)},e.prototype.whenInjectedInto=function(e){return this._bindingWhenSyntax.whenInjectedInto(e)},e.prototype.whenParentNamed=function(e){return this._bindingWhenSyntax.whenParentNamed(e)},e.prototype.whenParentTagged=function(e,t){return this._bindingWhenSyntax.whenParentTagged(e,t)},e.prototype.whenAnyAncestorIs=function(e){return this._bindingWhenSyntax.whenAnyAncestorIs(e)},e.prototype.whenNoAncestorIs=function(e){return this._bindingWhenSyntax.whenNoAncestorIs(e)},e.prototype.whenAnyAncestorNamed=function(e){return this._bindingWhenSyntax.whenAnyAncestorNamed(e)},e.prototype.whenAnyAncestorTagged=function(e,t){return this._bindingWhenSyntax.whenAnyAncestorTagged(e,t)},e.prototype.whenNoAncestorNamed=function(e){return this._bindingWhenSyntax.whenNoAncestorNamed(e)},e.prototype.whenNoAncestorTagged=function(e,t){return this._bindingWhenSyntax.whenNoAncestorTagged(e,t)},e.prototype.whenAnyAncestorMatches=function(e){return this._bindingWhenSyntax.whenAnyAncestorMatches(e)},e.prototype.whenNoAncestorMatches=function(e){return this._bindingWhenSyntax.whenNoAncestorMatches(e)},e.prototype.onActivation=function(e){return this._bindingOnSyntax.onActivation(e)},e.prototype.onDeactivation=function(e){return this._bindingOnSyntax.onDeactivation(e)},e}(),He=function(){function t(e){this._binding=e}return t.prototype.inRequestScope=function(){return this._binding.scope=e.Request,new qe(this._binding)},t.prototype.inSingletonScope=function(){return this._binding.scope=e.Singleton,new qe(this._binding)},t.prototype.inTransientScope=function(){return this._binding.scope=e.Transient,new qe(this._binding)},t}(),Qe=function(){function e(e){this._binding=e,this._bindingWhenSyntax=new je(this._binding),this._bindingOnSyntax=new We(this._binding),this._bindingInSyntax=new He(e)}return e.prototype.inRequestScope=function(){return this._bindingInSyntax.inRequestScope()},e.prototype.inSingletonScope=function(){return this._bindingInSyntax.inSingletonScope()},e.prototype.inTransientScope=function(){return this._bindingInSyntax.inTransientScope()},e.prototype.when=function(e){return this._bindingWhenSyntax.when(e)},e.prototype.whenTargetNamed=function(e){return this._bindingWhenSyntax.whenTargetNamed(e)},e.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},e.prototype.whenTargetTagged=function(e,t){return this._bindingWhenSyntax.whenTargetTagged(e,t)},e.prototype.whenInjectedInto=function(e){return this._bindingWhenSyntax.whenInjectedInto(e)},e.prototype.whenParentNamed=function(e){return this._bindingWhenSyntax.whenParentNamed(e)},e.prototype.whenParentTagged=function(e,t){return this._bindingWhenSyntax.whenParentTagged(e,t)},e.prototype.whenAnyAncestorIs=function(e){return this._bindingWhenSyntax.whenAnyAncestorIs(e)},e.prototype.whenNoAncestorIs=function(e){return this._bindingWhenSyntax.whenNoAncestorIs(e)},e.prototype.whenAnyAncestorNamed=function(e){return this._bindingWhenSyntax.whenAnyAncestorNamed(e)},e.prototype.whenAnyAncestorTagged=function(e,t){return this._bindingWhenSyntax.whenAnyAncestorTagged(e,t)},e.prototype.whenNoAncestorNamed=function(e){return this._bindingWhenSyntax.whenNoAncestorNamed(e)},e.prototype.whenNoAncestorTagged=function(e,t){return this._bindingWhenSyntax.whenNoAncestorTagged(e,t)},e.prototype.whenAnyAncestorMatches=function(e){return this._bindingWhenSyntax.whenAnyAncestorMatches(e)},e.prototype.whenNoAncestorMatches=function(e){return this._bindingWhenSyntax.whenNoAncestorMatches(e)},e.prototype.onActivation=function(e){return this._bindingOnSyntax.onActivation(e)},e.prototype.onDeactivation=function(e){return this._bindingOnSyntax.onDeactivation(e)},e}(),Ge=function(){function i(e){this._binding=e}return i.prototype.to=function(e){return this._binding.type=t.Instance,this._binding.implementationType=e,new Qe(this._binding)},i.prototype.toSelf=function(){if("function"!=typeof this._binding.serviceIdentifier)throw new Error("The toSelf function can only be applied when a constructor is used as service identifier");var e=this._binding.serviceIdentifier;return this.to(e)},i.prototype.toConstantValue=function(i){return this._binding.type=t.ConstantValue,this._binding.cache=i,this._binding.dynamicValue=null,this._binding.implementationType=null,this._binding.scope=e.Singleton,new qe(this._binding)},i.prototype.toDynamicValue=function(e){return this._binding.type=t.DynamicValue,this._binding.cache=null,this._binding.dynamicValue=e,this._binding.implementationType=null,new Qe(this._binding)},i.prototype.toConstructor=function(i){return this._binding.type=t.Constructor,this._binding.implementationType=i,this._binding.scope=e.Singleton,new qe(this._binding)},i.prototype.toFactory=function(i){return this._binding.type=t.Factory,this._binding.factory=i,this._binding.scope=e.Singleton,new qe(this._binding)},i.prototype.toFunction=function(i){if("function"!=typeof i)throw new Error("Value provided to function binding must be a function!");var n=this.toConstantValue(i);return this._binding.type=t.Function,this._binding.scope=e.Singleton,n},i.prototype.toAutoFactory=function(i){return this._binding.type=t.Factory,this._binding.factory=function(e){return function(){return e.container.get(i)}},this._binding.scope=e.Singleton,new qe(this._binding)},i.prototype.toAutoNamedFactory=function(e){return this._binding.type=t.Factory,this._binding.factory=function(t){return function(i){return t.container.getNamed(e,i)}},new qe(this._binding)},i.prototype.toProvider=function(i){return this._binding.type=t.Provider,this._binding.provider=i,this._binding.scope=e.Singleton,new qe(this._binding)},i.prototype.toService=function(e){this.toDynamicValue((function(t){return t.container.get(e)}))},i}(),ze=function(){function e(){}return e.of=function(t,i,n,r,o){var s=new e;return s.bindings=t,s.middleware=i,s.deactivations=r,s.activations=n,s.moduleActivationStore=o,s},e}();var Ke=function(){function e(){this._map=new Map}return e.prototype.getMap=function(){return this._map},e.prototype.add=function(e,t){if(null==e)throw new Error(l);if(null==t)throw new Error(l);var i=this._map.get(e);void 0!==i?i.push(t):this._map.set(e,[t])},e.prototype.get=function(e){if(null==e)throw new Error(l);var t=this._map.get(e);if(void 0!==t)return t;throw new Error(u)},e.prototype.remove=function(e){if(null==e)throw new Error(l);if(!this._map.delete(e))throw new Error(u)},e.prototype.removeIntersection=function(e){var t=this;this.traverse((function(i,n){var r=e.hasKey(i)?e.get(i):void 0;if(void 0!==r){var o=n.filter((function(e){return!r.some((function(t){return e===t}))}));t._setValue(i,o)}}))},e.prototype.removeByCondition=function(e){var t=this,i=[];return this._map.forEach((function(n,r){for(var o=[],s=0,a=n;s<a.length;s++){var d=a[s];e(d)?i.push(d):o.push(d)}t._setValue(r,o)})),i},e.prototype.hasKey=function(e){if(null==e)throw new Error(l);return this._map.has(e)},e.prototype.clone=function(){var t=new e;return this._map.forEach((function(e,i){e.forEach((function(e){return t.add(i,"object"==typeof(n=e)&&null!==n&&"clone"in n&&"function"==typeof n.clone?e.clone():e);var n}))})),t},e.prototype.traverse=function(e){this._map.forEach((function(t,i){e(i,t)}))},e.prototype._setValue=function(e,t){t.length>0?this._map.set(e,t):this._map.delete(e)},e}(),Ye=function(){function e(){this._map=new Map}return e.prototype.remove=function(e){if(this._map.has(e)){var t=this._map.get(e);return this._map.delete(e),t}return this._getEmptyHandlersStore()},e.prototype.addDeactivation=function(e,t,i){this._getModuleActivationHandlers(e).onDeactivations.add(t,i)},e.prototype.addActivation=function(e,t,i){this._getModuleActivationHandlers(e).onActivations.add(t,i)},e.prototype.clone=function(){var t=new e;return this._map.forEach((function(e,i){t._map.set(i,{onActivations:e.onActivations.clone(),onDeactivations:e.onDeactivations.clone()})})),t},e.prototype._getModuleActivationHandlers=function(e){var t=this._map.get(e);return void 0===t&&(t=this._getEmptyHandlersStore(),this._map.set(e,t)),t},e.prototype._getEmptyHandlersStore=function(){return{onActivations:new Ke,onDeactivations:new Ke}},e}(),$e=function(){return $e=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},$e.apply(this,arguments)},Xe=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))},Ze=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(a){o=[6,a],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},Je=function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))},et=function(){function t(t){var i=t||{};if("object"!=typeof i)throw new Error("Invalid Container constructor argument. Container options must be an object.");if(void 0===i.defaultScope)i.defaultScope=e.Transient;else if(i.defaultScope!==e.Singleton&&i.defaultScope!==e.Transient&&i.defaultScope!==e.Request)throw new Error('Invalid Container option. Default scope must be a string ("singleton" or "transient").');if(void 0===i.autoBindInjectable)i.autoBindInjectable=!1;else if("boolean"!=typeof i.autoBindInjectable)throw new Error("Invalid Container option. Auto bind injectable must be a boolean");if(void 0===i.skipBaseClassChecks)i.skipBaseClassChecks=!1;else if("boolean"!=typeof i.skipBaseClassChecks)throw new Error("Invalid Container option. Skip base check must be a boolean");this.options={autoBindInjectable:i.autoBindInjectable,defaultScope:i.defaultScope,skipBaseClassChecks:i.skipBaseClassChecks},this.id=s(),this._bindingDictionary=new Ke,this._snapshots=[],this._middleware=null,this._activations=new Ke,this._deactivations=new Ke,this.parent=null,this._metadataReader=new O,this._moduleActivationStore=new Ye}return t.merge=function(e,i){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o=new t,s=Je([e,i],n,!0).map((function(e){return ie(e)})),a=ie(o);return s.forEach((function(e){var t;t=a,e.traverse((function(e,i){i.forEach((function(e){t.add(e.serviceIdentifier,e.clone())}))}))})),o},t.prototype.load=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var i=this._getContainerModuleHelpersFactory(),n=0,r=e;n<r.length;n++){var o=r[n],s=i(o.id);o.registry(s.bindFunction,s.unbindFunction,s.isboundFunction,s.rebindFunction,s.unbindAsyncFunction,s.onActivationFunction,s.onDeactivationFunction)}},t.prototype.loadAsync=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Xe(this,void 0,void 0,(function(){var t,i,n,r,o;return Ze(this,(function(s){switch(s.label){case 0:t=this._getContainerModuleHelpersFactory(),i=0,n=e,s.label=1;case 1:return i<n.length?(r=n[i],o=t(r.id),[4,r.registry(o.bindFunction,o.unbindFunction,o.isboundFunction,o.rebindFunction,o.unbindAsyncFunction,o.onActivationFunction,o.onDeactivationFunction)]):[3,4];case 2:s.sent(),s.label=3;case 3:return i++,[3,1];case 4:return[2]}}))}))},t.prototype.unload=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];t.forEach((function(t){var i=e._removeModuleBindings(t.id);e._deactivateSingletons(i),e._removeModuleHandlers(t.id)}))},t.prototype.unloadAsync=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Xe(this,void 0,void 0,(function(){var t,i,n,r;return Ze(this,(function(o){switch(o.label){case 0:t=0,i=e,o.label=1;case 1:return t<i.length?(n=i[t],r=this._removeModuleBindings(n.id),[4,this._deactivateSingletonsAsync(r)]):[3,4];case 2:o.sent(),this._removeModuleHandlers(n.id),o.label=3;case 3:return t++,[3,1];case 4:return[2]}}))}))},t.prototype.bind=function(t){var i=this.options.defaultScope||e.Transient,n=new a(t,i);return this._bindingDictionary.add(t,n),new Ge(n)},t.prototype.rebind=function(e){return this.unbind(e),this.bind(e)},t.prototype.rebindAsync=function(e){return Xe(this,void 0,void 0,(function(){return Ze(this,(function(t){switch(t.label){case 0:return[4,this.unbindAsync(e)];case 1:return t.sent(),[2,this.bind(e)]}}))}))},t.prototype.unbind=function(e){if(this._bindingDictionary.hasKey(e)){var t=this._bindingDictionary.get(e);this._deactivateSingletons(t)}this._removeServiceFromDictionary(e)},t.prototype.unbindAsync=function(e){return Xe(this,void 0,void 0,(function(){var t;return Ze(this,(function(i){switch(i.label){case 0:return this._bindingDictionary.hasKey(e)?(t=this._bindingDictionary.get(e),[4,this._deactivateSingletonsAsync(t)]):[3,2];case 1:i.sent(),i.label=2;case 2:return this._removeServiceFromDictionary(e),[2]}}))}))},t.prototype.unbindAll=function(){var e=this;this._bindingDictionary.traverse((function(t,i){e._deactivateSingletons(i)})),this._bindingDictionary=new Ke},t.prototype.unbindAllAsync=function(){return Xe(this,void 0,void 0,(function(){var e,t=this;return Ze(this,(function(i){switch(i.label){case 0:return e=[],this._bindingDictionary.traverse((function(i,n){e.push(t._deactivateSingletonsAsync(n))})),[4,Promise.all(e)];case 1:return i.sent(),this._bindingDictionary=new Ke,[2]}}))}))},t.prototype.onActivation=function(e,t){this._activations.add(e,t)},t.prototype.onDeactivation=function(e,t){this._deactivations.add(e,t)},t.prototype.isBound=function(e){var t=this._bindingDictionary.hasKey(e);return!t&&this.parent&&(t=this.parent.isBound(e)),t},t.prototype.isCurrentBound=function(e){return this._bindingDictionary.hasKey(e)},t.prototype.isBoundNamed=function(e,t){return this.isBoundTagged(e,E,t)},t.prototype.isBoundTagged=function(e,t,i){var n=!1;if(this._bindingDictionary.hasKey(e)){var o=this._bindingDictionary.get(e),s=function(e,t,i,n){var o=new z(r.Variable,"",t,new q(i,n)),s=new W(e);return new te(t,s,null,[],o)}(this,e,t,i);n=o.some((function(e){return e.constraint(s)}))}return!n&&this.parent&&(n=this.parent.isBoundTagged(e,t,i)),n},t.prototype.snapshot=function(){this._snapshots.push(ze.of(this._bindingDictionary.clone(),this._middleware,this._activations.clone(),this._deactivations.clone(),this._moduleActivationStore.clone()))},t.prototype.restore=function(){var e=this._snapshots.pop();if(void 0===e)throw new Error("No snapshot available to restore.");this._bindingDictionary=e.bindings,this._activations=e.activations,this._deactivations=e.deactivations,this._middleware=e.middleware,this._moduleActivationStore=e.moduleActivationStore},t.prototype.createChild=function(e){var i=new t(e||this.options);return i.parent=this,i},t.prototype.applyMiddleware=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=this._middleware?this._middleware:this._planAndResolve();this._middleware=e.reduce((function(e,t){return t(e)}),i)},t.prototype.applyCustomMetadataReader=function(e){this._metadataReader=e},t.prototype.get=function(e){var t=this._getNotAllArgs(e,!1);return this._getButThrowIfAsync(t)},t.prototype.getAsync=function(e){return Xe(this,void 0,void 0,(function(){var t;return Ze(this,(function(i){return t=this._getNotAllArgs(e,!1),[2,this._get(t)]}))}))},t.prototype.getTagged=function(e,t,i){var n=this._getNotAllArgs(e,!1,t,i);return this._getButThrowIfAsync(n)},t.prototype.getTaggedAsync=function(e,t,i){return Xe(this,void 0,void 0,(function(){var n;return Ze(this,(function(r){return n=this._getNotAllArgs(e,!1,t,i),[2,this._get(n)]}))}))},t.prototype.getNamed=function(e,t){return this.getTagged(e,E,t)},t.prototype.getNamedAsync=function(e,t){return this.getTaggedAsync(e,E,t)},t.prototype.getAll=function(e){var t=this._getAllArgs(e);return this._getButThrowIfAsync(t)},t.prototype.getAllAsync=function(e){var t=this._getAllArgs(e);return this._getAll(t)},t.prototype.getAllTagged=function(e,t,i){var n=this._getNotAllArgs(e,!0,t,i);return this._getButThrowIfAsync(n)},t.prototype.getAllTaggedAsync=function(e,t,i){var n=this._getNotAllArgs(e,!0,t,i);return this._getAll(n)},t.prototype.getAllNamed=function(e,t){return this.getAllTagged(e,E,t)},t.prototype.getAllNamedAsync=function(e,t){return this.getAllTaggedAsync(e,E,t)},t.prototype.resolve=function(e){var t=this.isBound(e);t||this.bind(e).toSelf();var i=this.get(e);return t||this.unbind(e),i},t.prototype._preDestroy=function(e,t){var i,n;if(Reflect.hasMetadata(k,e))return null===(n=(i=t)[Reflect.getMetadata(k,e).value])||void 0===n?void 0:n.call(i)},t.prototype._removeModuleHandlers=function(e){var t=this._moduleActivationStore.remove(e);this._activations.removeIntersection(t.onActivations),this._deactivations.removeIntersection(t.onDeactivations)},t.prototype._removeModuleBindings=function(e){return this._bindingDictionary.removeByCondition((function(t){return t.moduleId===e}))},t.prototype._deactivate=function(e,t){var i=this,n=Object.getPrototypeOf(t).constructor;try{if(this._deactivations.hasKey(e.serviceIdentifier)){var r=this._deactivateContainer(t,this._deactivations.get(e.serviceIdentifier).values());if(ae(r))return this._handleDeactivationError(r.then((function(){return i._propagateContainerDeactivationThenBindingAndPreDestroyAsync(e,t,n)})),n)}var o=this._propagateContainerDeactivationThenBindingAndPreDestroy(e,t,n);if(ae(o))return this._handleDeactivationError(o,n)}catch(s){if(s instanceof Error)throw new Error(_(n.name,s.message))}},t.prototype._handleDeactivationError=function(e,t){return Xe(this,void 0,void 0,(function(){var i;return Ze(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,e];case 1:return n.sent(),[3,3];case 2:if((i=n.sent())instanceof Error)throw new Error(_(t.name,i.message));return[3,3];case 3:return[2]}}))}))},t.prototype._deactivateContainer=function(e,t){for(var i=this,n=t.next();n.value;){var r=n.value(e);if(ae(r))return r.then((function(){return i._deactivateContainerAsync(e,t)}));n=t.next()}},t.prototype._deactivateContainerAsync=function(e,t){return Xe(this,void 0,void 0,(function(){var i;return Ze(this,(function(n){switch(n.label){case 0:i=t.next(),n.label=1;case 1:return i.value?[4,i.value(e)]:[3,3];case 2:return n.sent(),i=t.next(),[3,1];case 3:return[2]}}))}))},t.prototype._getContainerModuleHelpersFactory=function(){var e=this,t=function(e,t){e._binding.moduleId=t},i=function(i){return function(n){var r=e.rebind(n);return t(r,i),r}},n=function(t){return function(i,n){e._moduleActivationStore.addActivation(t,i,n),e.onActivation(i,n)}},r=function(t){return function(i,n){e._moduleActivationStore.addDeactivation(t,i,n),e.onDeactivation(i,n)}};return function(o){return{bindFunction:(s=o,function(i){var n=e.bind(i);return t(n,s),n}),isboundFunction:function(t){return e.isBound(t)},onActivationFunction:n(o),onDeactivationFunction:r(o),rebindFunction:i(o),unbindFunction:function(t){return e.unbind(t)},unbindAsyncFunction:function(t){return e.unbindAsync(t)}};var s}},t.prototype._getAll=function(e){return Promise.all(this._get(e))},t.prototype._get=function(e){var t=$e($e({},e),{contextInterceptor:function(e){return e},targetType:r.Variable});if(this._middleware){var i=this._middleware(t);if(null==i)throw new Error("Invalid return type in middleware. Middleware must return!");return i}return this._planAndResolve()(t)},t.prototype._getButThrowIfAsync=function(e){var t=this._get(e);if(de(t))throw new Error("You are attempting to construct '"+e.serviceIdentifier+"' in a synchronous way\n but it has asynchronous dependencies.");return t},t.prototype._getAllArgs=function(e){return{avoidConstraints:!0,isMultiInject:!0,serviceIdentifier:e}},t.prototype._getNotAllArgs=function(e,t,i,n){return{avoidConstraints:!1,isMultiInject:t,serviceIdentifier:e,key:i,value:n}},t.prototype._planAndResolve=function(){var e=this;return function(t){var i=se(e._metadataReader,e,t.isMultiInject,t.targetType,t.serviceIdentifier,t.key,t.value,t.avoidConstraints);return function(e){return De(e.plan.rootRequest.requestScope)(e.plan.rootRequest)}(i=t.contextInterceptor(i))}},t.prototype._deactivateIfSingleton=function(e){var t=this;if(e.activated)return ae(e.cache)?e.cache.then((function(i){return t._deactivate(e,i)})):this._deactivate(e,e.cache)},t.prototype._deactivateSingletons=function(e){for(var t=0,i=e;t<i.length;t++){var n=i[t];if(ae(this._deactivateIfSingleton(n)))throw new Error("Attempting to unbind dependency with asynchronous destruction (@preDestroy or onDeactivation)")}},t.prototype._deactivateSingletonsAsync=function(e){return Xe(this,void 0,void 0,(function(){var t=this;return Ze(this,(function(i){switch(i.label){case 0:return[4,Promise.all(e.map((function(e){return t._deactivateIfSingleton(e)})))];case 1:return i.sent(),[2]}}))}))},t.prototype._propagateContainerDeactivationThenBindingAndPreDestroy=function(e,t,i){return this.parent?this._deactivate.bind(this.parent)(e,t):this._bindingDeactivationAndPreDestroy(e,t,i)},t.prototype._propagateContainerDeactivationThenBindingAndPreDestroyAsync=function(e,t,i){return Xe(this,void 0,void 0,(function(){return Ze(this,(function(n){switch(n.label){case 0:return this.parent?[4,this._deactivate.bind(this.parent)(e,t)]:[3,2];case 1:return n.sent(),[3,4];case 2:return[4,this._bindingDeactivationAndPreDestroyAsync(e,t,i)];case 3:n.sent(),n.label=4;case 4:return[2]}}))}))},t.prototype._removeServiceFromDictionary=function(e){try{this._bindingDictionary.remove(e)}catch(t){throw new Error("Could not unbind serviceIdentifier: "+B(e))}},t.prototype._bindingDeactivationAndPreDestroy=function(e,t,i){var n=this;if("function"==typeof e.onDeactivation){var r=e.onDeactivation(t);if(ae(r))return r.then((function(){return n._preDestroy(i,t)}))}return this._preDestroy(i,t)},t.prototype._bindingDeactivationAndPreDestroyAsync=function(e,t,i){return Xe(this,void 0,void 0,(function(){return Ze(this,(function(n){switch(n.label){case 0:return"function"!=typeof e.onDeactivation?[3,2]:[4,e.onDeactivation(t)];case 1:n.sent(),n.label=2;case 2:return[4,this._preDestroy(i,t)];case 3:return n.sent(),[2]}}))}))},t}();const tt={VideoFrameQueue:Symbol("VidFrameQueue"),AudioFrameQueue:Symbol("AudFrameQueue"),PacketContext:Symbol("PacketContext"),DemuxerPacketsReceivers:Symbol("DemuxerPacketsReceivers"),ContextFactory:Symbol("ContextFactory"),AudioPacketsProvider:Symbol("AudioPacketsProvider"),VideoPacketsProvider:Symbol("VideoPacketsProvider"),FormatContext:Symbol("FormatContextProxy"),RenderContext:Symbol("RenderContext"),VideoClock:Symbol("VideoClock"),AudioClock:Symbol("AudioClock"),NetworkRequestor:Symbol("NetworkRequestor"),PlayerState:Symbol("PlayerState"),OptionsContext:Symbol("OptionsContext"),GlobalEvent:Symbol("GlobalEvent"),MediaUI:Symbol("MediaUI"),WasmFactory:Symbol("WasmFactory"),NaluParser:Symbol("NaluParser"),SEIReceiver:Symbol("SEIReceiver"),LogMana:Symbol("LoggerManager"),QualityStatisticContext:Symbol("QualityStatisticContext"),FlvDemuxer:Symbol("FlvDemuxer"),DemuxContext:Symbol("DemuxContext"),UIContainer:Symbol("UIContainer"),AVPlayerOperator:Symbol("AVPlayerOperator"),PlayerEventEmitter:Symbol("PlayerEventEmitter"),Utils:Symbol("Utils"),DecodeContextBuilder:Symbol("DecodeContextBuilder"),MseContextBuilder:Symbol("MseContext"),RemoteMuteStateDetect:Symbol("RemoteMuteStateDetect"),DecodeOperatorBuilder:Symbol("DecodeOperator"),RenderStatistic:Symbol("RenderStatistic"),NetworkStatistic:Symbol("NetworkStatistic"),DecodeStatistic:Symbol("DecodeStatistic"),WebCodecDecoderBuilder:Symbol("WebCodecDecoderBuilder"),HttpFetchBuilder:Symbol("HttpFetchBuilder"),AudioPacketsReceiver:Symbol("AudioPacketsReceiver"),VideoPacketsReceiver:Symbol("VideoPacketsReceiver"),AudioMasterFrameSynchronizerBuilder:Symbol("AudioMasterFrameSynchronizerBuilder"),VideoMasterFrameSynchronizerBuilder:Symbol("VideoMasterFrameSynchronizerBuilder"),RenderableMedia:Symbol("RenderableMedia"),AudioPlayerBuilder:Symbol("AudioPlayerBuilder"),VideoPlayerBuilder:Symbol("VideoPlayerBuilder"),MediaChangingOperator:Symbol("MediaChangingOperator"),MediaWaitingHandler:Symbol("MediaWaitingHandler"),PacketsDropSyncSignal:Symbol("PacketsDropSync"),MSEVideoControl:Symbol("MseVideoControl"),PlayerController:Symbol("PlayerController"),SeiEmitter:Symbol("SeiEmitter"),ConstantState:Symbol("ConstantState"),MSEWaitingDetection:Symbol("MSEWaitingDetection"),DomVideoFPSDetection:Symbol("MSEVideoFPSDetection"),MSEAutoPlayDetect:Symbol("MSEAutoPlayDetect"),CustomVideoControl:Symbol("CustomVideoControl")};function it(){return function(e){if(Reflect.hasOwnMetadata(T,e))throw new Error("Cannot apply @injectable decorator multiple times.");var t=Reflect.getMetadata("design:paramtypes",e)||[];return Reflect.defineMetadata(T,t,e),e}}var nt;i(933);!function(e){e.PUSH="push"}(nt||(nt={}));var rt=i(204),ot=i.n(rt);class st{constructor(){this.event=new rt,this.queue=[]}push(e){this.queue.push(e),this.event.emit(nt.PUSH)}pop(){return this.queue.shift()||null}front(){return this.queue[0]||null}last(){const e=this.queue.length;return e>0&&this.queue[e-1]||null}clear(){return this.queue=[],!0}indexOf(e){return this.queue[e]||null}removeOf(e){const t=this.queue.length-1;if(e<0||e>=this.queue.length)return!1;for(let i=e;i<t;i++)this.queue[i]=this.queue[i+1];return this.queue.length=t,!0}size(){return this.queue.length}}class at{constructor(){this.event=new rt,this.queue=new st,this.iFrameIndexes=[]}front(){return this.queue.front()}last(){return this.queue.last()}push(e){e.isKeyFrame&&this.iFrameIndexes.push(this.queue.size());const t=this.queue.push(e);return this.event.emit(nt.PUSH),t}degradeIFrameIndexes(e){this.iFrameIndexes=this.iFrameIndexes.map(((t,i)=>i>=e?t-1:t))}IFrameCount(){return this.iFrameIndexes.length}pop(){const e=this.queue.pop();return e&&e.isKeyFrame?this.removeOfIFrame(0):this.degradeIFrameIndexes(0),e}clear(){return this.iFrameIndexes=[],this.queue.clear()}indexOf(e){return this.queue.indexOf(e)}removeByIndexFromArray(e,t){const i=t.length-1;if(e<0||e>=t.length)return!1;for(let n=e;n<i;n++)t[n]=t[n+1];return t.length=i,!0}removeOfIFrame(e){const t=this.iFrameIndexes.indexOf(e);this.degradeIFrameIndexes(t),this.removeByIndexFromArray(t,this.iFrameIndexes)}removeOf(e){const t=this.indexOf(e);return t&&t.isKeyFrame&&this.removeOfIFrame(e),this.queue.removeOf(e)}size(){return this.queue.size()}lastIFrameTime(){if(null===this.front()||this.iFrameIndexes.length<=0)return 0;const e=this.iFrameIndexes[this.iFrameIndexes.length-1];if(!e)return 0;const t=this.indexOf(e);return t&&t.isKeyFrame?t.pts:0}firstIFrameTime(){if(null===this.front()||this.iFrameIndexes.length<=0)return 0;const e=this.iFrameIndexes[0];if(!e)return 0;const t=this.indexOf(e);return t&&t.isKeyFrame?t.pts:0}IFrameSize(){return this.iFrameIndexes.length}}var dt=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let lt=class{constructor(){this.videoSerial=0,this.audioSerial=0,this.videoPktQueue=new at,this.audioPktQueue=new st}get videoPackets(){return this.videoPktQueue}get audioPackets(){return this.audioPktQueue}};function ut(e,t,i,n){!function(e){if(void 0!==e)throw new Error(g)}(t),ht(P,e,i.toString(),n)}function ct(e){var t=[];if(Array.isArray(e)){var i=function(e){for(var t=new Set,i=0,n=e;i<n.length;i++){var r=n[i];if(t.has(r))return r;t.add(r)}}((t=e).map((function(e){return e.key})));if(void 0!==i)throw new Error(d+" "+i.toString())}else t=[e];return t}function ht(e,t,i,n){var r=ct(n),o={};Reflect.hasOwnMetadata(e,t)&&(o=Reflect.getMetadata(e,t));var s=o[i];if(void 0===s)s=[];else for(var a=function(e){if(r.some((function(t){return t.key===e.key})))throw new Error(d+" "+e.key.toString())},l=0,u=s;l<u.length;l++){a(u[l])}s.push.apply(s,r),o[i]=s,Reflect.defineMetadata(e,o,t)}function pt(e){return function(t,i,n){"number"==typeof n?ut(t,i,n,e):function(e,t,i){if(void 0!==e.prototype)throw new Error(g);ht(F,e.constructor,t,i)}(t,i,e)}}lt=dt([it()],lt);var ft,mt=(ft=D,function(e){return function(t,i,n){if(void 0===e){var r="function"==typeof t?t.name:t.constructor.name;throw new Error("@inject called with undefined this could mean that the class "+r+" has a circular dependency problem. You can use a LazyServiceIdentifier to  overcome this limitation.")}return pt(new q(ft,e))(t,i,n)}}),gt=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},yt=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let vt=class{constructor(){}get audio(){return this._audio}get video(){return this._video}};gt([mt(tt.AudioPacketsReceiver),yt("design:type",Object)],vt.prototype,"_audio",void 0),gt([mt(tt.VideoPacketsReceiver),yt("design:type",Object)],vt.prototype,"_video",void 0),vt=gt([it(),yt("design:paramtypes",[])],vt);class bt{constructor(e,t,i,n){this._useWebCodec=e,this._useWasm=t,this._useMse=i,this.webCodecRollbackToMse=n,this.chooseOneOption()}chooseOneOption(){this._useWebCodec?this._useMse=this._useWasm=!1:this._useWasm?this._useMse=this._useWebCodec=!1:this._useMse?this._useWebCodec=this._useWasm=!1:this._useWebCodec=!0}supportMseEnv(){return!!window.MediaSource}supportWebCodecEnv(){return!!window.VideoDecoder&&!!window.VideoFrame&&!!window.Worker}supportWasmEnv(){return!!window.WebAssembly&&!!window.Worker}useMse(){return(this.supportMseEnv()&&this._useMse||!(this.supportWebCodecEnv()||!this._useWebCodec||!this.webCodecRollbackToMse))&&this.supportMseEnv()}useWebCodec(){return!(!this.supportWebCodecEnv()||!this._useWebCodec)&&this.supportWebCodecEnv()}useWasm(){return this.supportWasmEnv()&&this._useWasm?this.supportWasmEnv():this.supportWebCodecEnv()||!this._useWebCodec||this.webCodecRollbackToMse?!(this.supportMseEnv()||!this._useMse&&!this.webCodecRollbackToMse)&&this.supportWasmEnv():this.supportWasmEnv()}}class _t{constructor(){this._model={}}update(e){for(const t in e)this._model[t]=e[t]}getModel(){return this._model}}let Ct=e=>crypto.getRandomValues(new Uint8Array(e)),Et=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"),"");const St="1.2.0";var wt=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Rt=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let Dt=class{constructor(){this._model=new _t;const e={appid:0,version:St,uuid:Et(6),advanceConfig:{}};this._model.update(e)}setConfig(e){this._model.update(e)}get appid(){return this._model.getModel().appid}get version(){return this._model.getModel().version}get uuid(){return this._model.getModel().uuid}get advanceConfig(){return this._model.getModel().advanceConfig}};Dt=wt([it(),Rt("design:paramtypes",[])],Dt);const At="__ZegoError___";class Pt extends Error{constructor(e){super(JSON.stringify(e)),this.name=At}}function Ft(e,t){return{code:t.code,msg:t.msg+": "+e}}const Tt={code:100001,msg:"InputParamError"},xt={code:100002,msg:"EnvironmentError"},kt={code:100003,msg:"RuntimeError"},Mt={code:100004,msg:"NetworkError"},Ot={code:100005,msg:"DecodeError"},It={code:100006,msg:"AutoPlayError"};class Lt extends Error{constructor(e){super(JSON.stringify(Ft(e,Tt)))}}class Bt extends Error{constructor(e){super(JSON.stringify(Ft(e,xt)))}}class Vt extends Pt{constructor(e){super(Ft(e,kt))}}class Ut extends Pt{constructor(e){super(Ft(e,Mt))}}class Nt extends Pt{constructor(e){super(Ft(e,Ot))}}class jt extends Pt{constructor(e){super(Ft(e,It))}}class Wt{constructor(e){if(e.min>e.max)throw new Vt("illegal value!");this._min=e.min,this._max=e.max}get max(){return this._max}get min(){return this._min}contain(e){return e>=this._min&&e<=this._max}onLeft(e){return e<this._min}onRight(e){return e>this._max}}class qt{constructor(e){this._param=e,this._error=!1,this._negate=!1}static bind(e){return new qt(e)}static expect(e){return new qt(e)}_verify(e){let t=e();return t=this._negate?!t:t,t||(this._error=!0),this._negate=!1,this}get is(){return this}get not(){return this._negate=!this._negate,this}get true(){return this._verify((()=>"boolean"==typeof this._param&&!0===this._param))}get false(){return this._verify((()=>"boolean"==typeof this._param&&!1===this._param))}get exist(){return this._verify((()=>void 0!==this._param&&null!==this._param))}then(e){return this._param=e,this}oneOf(e){return this._verify((()=>e.some((e=>e===this._param))))}keyof(e){return this._verify((()=>("object"==typeof e||"function"==typeof e)&&e.hasOwnProperty(this._param)))}hasKey(e){return this._verify((()=>("object"==typeof this._param||"function"==typeof this._param)&&(this._param.hasOwnProperty(e)||void 0!==this._param[e])))}verify(e){return this._verify((()=>e(this._param)))}equal(e){return this._verify((()=>this._param===e))}eq(e){return this.equal(e)}typeof(e){return this._verify((()=>typeof this._param===e))}range([e,t]){return this._verify((()=>"number"==typeof this._param&&new Wt({min:e,max:t}).contain(this._param)))}contain(e){return this._verify((()=>"number"==typeof this._param&&e.contain(this._param)))}instanceof(e){return this._verify((()=>this._param instanceof e))}catch(e){return e&&this._error&&e(),this._error=!1,this}}function Ht(e,t){return function(...i){const[n,r,o]=i;if(o){const i=o.value;return o.value=function(){(e=>{const t=e.logger;qt.bind(t).is.exist.catch((()=>{throw new Vt(`class ${e.constructor.name} is missing the attribute 'logger'.`)})),qt.bind(t.originalAction).is.exist.not.eq("").catch((()=>{throw new Vt(`class ${e.constructor.name} don't have an action.`)}))})(this);const n=this.logger,r=n.action,o=n.originalAction;n.action=o+"."+e;const s=(e=>{let t="call";const i=[];for(let n=0;n<e.length;n++)"function"==typeof e[n]&&i.push("[func]"),"object"==typeof e[n]&&i.push("[obj]"),"function"!=typeof e[n]&&"object"!=typeof e[n]&&i.push(e[n]);return 0!==i.length&&(t+=", args:[ "+i.join(", ")+" ]"),t})(arguments);let a;(!t||void 0===t.callInfo||t.callInfo)&&n.info(s);try{a=i.apply(this,arguments),a instanceof Promise&&a.then((()=>{n.action=o+"."+e,n.action=r}))}catch(d){throw n.action=r,d}return n.action=r,a},o}Reflect.defineMetadata("_action_",e,n)}}class Qt{constructor(e,t,i){this._metainfo=e,this._action=t,this.logCache=i,this.throttleLogMap=new Map,this._originalAction=t}get prefix(){return`${this._action} ${this._metainfo} `}get log(){return this.logCache}set metainfo(e){this._metainfo=e}get metainfo(){return this._metainfo}set action(e){this._action=e}get action(){return this._action}get originalAction(){return this._originalAction}getSubAction(e){return this.action+"."+e}sub(e){return new Qt(this.metainfo,this.getSubAction(e),this.log)}info(...e){this.log.add("info",[this.prefix,...e])}warn(...e){this.log.add("warn",[this.prefix,...e])}error(...e){this.log.add("error",[this.prefix,...e])}throttle(e,t){let i=e,n=null,r=0;return()=>{r++,1!==r?n||(n=setTimeout((()=>{clearTimeout(n),n=null,i(r),r=0}),t)):i(r)}}throttleInfo(e,t=3e3){let i=this.throttleLogMap.get(e);if(!i){const n=t=>{this.info(e,` [count] ${t}`)};i=this.throttle(n,t),this.throttleLogMap.set(e,i)}i()}throttleWarn(e,t=3e3){let i=this.throttleLogMap.get(e);if(!i){const n=t=>{this.warn(e,` count: ${t}`)};i=this.throttle(n,t),this.throttleLogMap.set(e,i)}i()}throttleError(e,t=3e3){let i=this.throttleLogMap.get(e);if(!i){const n=t=>{this.error(e,` count: ${t}`)};i=this.throttle(n,t),this.throttleLogMap.set(e,i)}i()}}class Gt{constructor(){this._MAX_CACHE=10240,this._cache=[]}setLogger(e){this.zglogger=e}add(e,t){this._cache.length<this._MAX_CACHE&&this._cache.push({type:e,args:t}),this._clear()}_log(e){switch(e.type){case"info":this.zglogger&&this.zglogger.info(...e.args);break;case"warn":this.zglogger&&this.zglogger.warn(...e.args);break;case"error":this.zglogger&&this.zglogger.error(...e.args)}}_clear(){this.zglogger&&(this._cache.forEach((e=>{this._log(e)})),this._cache=[])}}var zt=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Kt=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Yt=function(e,t){return function(i,n){t(i,n,e)}};let $t=class{constructor(e){this._configState=e,this.logCache=new Gt}get metainfo(){return`${this._configState.uuid}#`}createLogger(e){return new Qt(this.metainfo,"zep."+e,this.logCache)}setZegoLogger(e){this.logCache.setLogger(e)}postMessage(e){}onmessage(e){const{type:t,data:i}=e;switch(t){case"workerlog":{const{level:e,action:t,args:n}=i,r=()=>`${t} ${this.metainfo} `;"info"===e?this.logCache.add("info",[r(),...n]):"warn"===e?this.logCache.add("warn",[r(),...n]):"error"===e&&this.logCache.add("error",[r(),...n]);break}default:this.logCache.add("error",[`zep.0.err ${this.metainfo} `,"unknown msg type: ",e.type])}}terminate(){}};$t=zt([it(),Yt(0,mt(tt.ConstantState)),Kt("design:paramtypes",[Dt])],$t);var Xt=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Zt=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Jt=function(e,t){return function(i,n){t(i,n,e)}};let ei=class{constructor(e,t){this.optionsContext=e,this.lm=t,this.contextFactoryOptions={},this.logger=t.createLogger("p.cf")}setOptions(e){this.contextFactoryOptions=Object.assign(Object.assign({},this.contextFactoryOptions),e),this.logger.info("set options "+JSON.stringify(this.contextFactoryOptions)),this.setDecodeOptions(this.contextFactoryOptions.decodeType)}setDecodeOptions(e){switch(e){case"WebCodecs":default:this.optionsContext.setDecodeOptions(new bt(!0,!1,!1,!0));break;case"wasm":this.optionsContext.setDecodeOptions(new bt(!1,!0,!1,!1));break;case"MSE":this.optionsContext.setDecodeOptions(new bt(!1,!1,!0,!1))}}createRenderContext(){return this.renderContext}createDemuxContext(){return this.demuxContext}createDecodeContext(){return this.decodeContextSingleton()}};Xt([mt(tt.RenderContext),Zt("design:type",Object)],ei.prototype,"renderContext",void 0),Xt([mt(tt.DemuxContext),Zt("design:type",Object)],ei.prototype,"demuxContext",void 0),Xt([mt(tt.DecodeContextBuilder),Zt("design:type",Function)],ei.prototype,"decodeContextSingleton",void 0),ei=Xt([it(),Jt(0,mt(tt.OptionsContext)),Jt(1,mt(tt.LogMana)),Zt("design:paramtypes",[Object,$t])],ei);var ti;!function(e){e.DATA="data"}(ti||(ti={}));var ii=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let ni=class{constructor(){this.syncSignalSlot=!1,this.syncPts=0}trigger(e){this.syncPts=e,this.syncSignalSlot=!0}hasSignal(){return this.syncSignalSlot}reset(){this.syncPts=0,this.syncSignalSlot=!1}capture(){if(this.syncSignalSlot)return this.syncPts;this.syncSignalSlot=!1}};ni=ii([it()],ni);var ri=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},oi=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},si=function(e,t){return function(i,n){t(i,n,e)}};let ai=class{constructor(e,t,i,n,r,o){this.packetContext=e,this.playerState=t,this.lm=i,this.optionsContext=n,this.packetsDropSyncSignal=r,this.formatContext=o,this.logger=this.lm.createLogger("dmx.ape")}on(e,t){if(e!==ti.DATA)throw new Vt("<audio-packets-provider> unknown event. "+e);this.packetContext.audioPackets.event.on(nt.PUSH,t)}off(e,t){if(e!==ti.DATA)throw new Vt("<audio-packets-provider> unknown event. "+e);this.packetContext.audioPackets.event.off(nt.PUSH,t)}get audioPackets(){return this.packetContext.audioPackets}exportByPausedRule(){return null}dropToPts(e){let t=!1;for(;this.audioPackets.size()>1;){const i=this.audioPackets.front();if(!(i&&(null==i?void 0:i.pts)<e))break;this.audioPackets.pop(),t=!0}return t}dropByPlayRule(){if(this.audioPackets.size()<=0)return;let e=!1;if(this.formatContext.hasVideo()){const t=this.packetsDropSyncSignal.capture();void 0!==t&&(e=this.dropToPts(t))}else e=this.dropUntilLastFrame();e&&this.packetContext.audioSerial++}dropUntilLastFrame(){let e=!1;for(;this.audioPackets.size()>1;)this.audioPackets.pop(),e=!0;return e}hasLatedFrame(){var e,t;if(this.formatContext.hasVideo())return this.packetsDropSyncSignal.hasSignal();{if(this.audioPackets.size()<2)return!1;const i=null===(e=this.audioPackets.front())||void 0===e?void 0:e.pts,n=null===(t=this.audioPackets.last())||void 0===t?void 0:t.pts;if(void 0===i||void 0===n)return!1;const r=n-i;return!(r<=0)&&r>=2e3}}exportByPlayRule(){return this.hasLatedFrame()&&this.dropByPlayRule(),this.audioPackets.pop()}setSerial(e){e&&(e.serial=this.packetContext.audioSerial)}exportByMseRule(){return this.audioPackets.pop()}read(){let e=null;return e=this.optionsContext.useMse()?this.exportByMseRule():!this.playerState.userPlayed&&this.playerState.mediaOpened?this.exportByPausedRule():this.exportByPlayRule(),this.setSerial(e),e}};var di,li;function ui(e){for(var t in li){if(li[t]==e)return!0}return!1}ai=ri([it(),si(0,mt(tt.PacketContext)),si(1,mt(tt.PlayerState)),si(2,mt(tt.LogMana)),si(3,mt(tt.OptionsContext)),si(4,mt(tt.PacketsDropSyncSignal)),si(5,mt(tt.FormatContext)),oi("design:paramtypes",[Object,Object,$t,Object,ni,Object])],ai),function(e){e.DESTROY="destroy",e.MEDIA_REFETCH="media_refetch",e.MEDIA_FETCH_BEGIN="media_fetch_begin",e.MEDIA_FETCH_END="media_fetch_end",e.MSE_ERROR="mse_error",e.MSE_DURATION_ERROR="mse_duration_error",e.WEB_CODEC_ERROR="web_codec_error",e.HAS_KEY_FRAME_DROP="has_key_frame_drop",e.CURRENT_TIME_CHANGE="current_time_changed",e.ON_QUALITY_SCORE="on_quality_score",e.DTS_ERROR_OCCUR="dts_error_occur"}(di||(di={})),function(e){e.MEDIA_CAN_PLAY="canplay",e.MEDIA_PLAYED="played",e.MEDIA_PAUSED="paused",e.MEDIA_LOADED="loaded",e.CURRENT_TIME_CHANGE="currentTimeChanged",e.MEDIA_PLAY_ENDED="ended",e.MEDIA_PLAY_WAITING="waiting",e.MEDIA_PLAYING="playing",e.ERROR="error",e.MEDIA_INFO_UPDATE="mediaInfoUpdate",e.RECV_SEI="recvSei"}(li||(li={}));var ci=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},hi=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},pi=function(e,t){return function(i,n){t(i,n,e)}};let fi=class{get serial(){return this.packetContext.videoSerial}constructor(e,t,i,n,r,o,s){this.packetContext=e,this.playerState=t,this.lm=i,this.optionContext=n,this.globalEvent=r,this.packetsDropSyncSignal=o,this.formatContext=s,this.logger=this.lm.createLogger("dmx.vpe")}get videoPackets(){return this.packetContext.videoPackets}exportByPausedRule(){const e=this.videoPackets.front();return e&&e.firstKeyFrame?this.videoPackets.pop():null}hasKeyFrameOutOfDate(){const e=this.videoPackets.firstIFrameTime();if(e<=0)return!1;const t=this.videoPackets.lastIFrameTime();return t!=e&&t-e>1e-4}dropUntilLastKeyFrame(){const e=this.videoPackets.lastIFrameTime();if(e<=0)return!1;let t=!1,i=0,n=0;if(this.videoPackets.size()>0){const e=this.videoPackets.front();e&&(n=e.pts)}for(;this.videoPackets.size()>0;){const n=this.videoPackets.front();if(!n||n&&n.isKeyFrame&&n.pts===e)break;this.videoPackets.pop(),t=!0,i=n.pts}return t&&!this.optionContext.useMse()&&(this.packetsDropSyncSignal.trigger(i),this.packetContext.videoSerial++,this.globalEvent.event.emit(di.HAS_KEY_FRAME_DROP)),t}exportByPlayRule(){return this.hasKeyFrameOutOfDate()&&this.dropUntilLastKeyFrame(),this.videoPackets.pop()}setSerial(e){e&&(e.serial=this.serial)}exportByMseRule(){return this.videoPackets.pop()}read(){let e=null;return e=this.optionContext.useMse()?this.exportByMseRule():!this.playerState.userPlayed&&this.playerState.mediaOpened?this.exportByPausedRule():this.exportByPlayRule(),this.setSerial(e),e}on(e,t){if(e!==ti.DATA)throw new Vt("<video-packets-provider> unknown event. "+e);this.packetContext.videoPackets.event.on(nt.PUSH,t)}off(e,t){if(e!==ti.DATA)throw new Vt("<video-packets-provider> unknown event. "+e);this.packetContext.videoPackets.event.off(nt.PUSH,t)}};var mi,gi,yi;function vi(){return null!==navigator.platform.match("iPhone")||/(iPhone|iPad|iPod|iOS|ios)/i.test(navigator.userAgent)}fi=ci([it(),pi(0,mt(tt.PacketContext)),pi(1,mt(tt.PlayerState)),pi(2,mt(tt.LogMana)),pi(3,mt(tt.OptionsContext)),pi(4,mt(tt.GlobalEvent)),pi(5,mt(tt.PacketsDropSyncSignal)),pi(6,mt(tt.FormatContext)),hi("design:paramtypes",[Object,Object,$t,Object,Object,ni,Object])],fi),function(e){e.VideoDescriptionChange="vid_description_change",e.AudioDescriptionChange="aud_description_change",e.MediaFormatChange="media_formate_change",e.AudioRemoteMuteStateUpdate="audio_remote_mute_state_update",e.VideoRemoteMuteStateUpdate="video_remote_mute_state_update"}(mi||(mi={})),function(e){e[e.H264=27]="H264",e[e.H265=173]="H265",e[e.AAC=86018]="AAC",e[e.Unknown=0]="Unknown"}(gi||(gi={})),function(e){e.WIN32="WIN32",e.MAC="Mac",e.ANDROID="Android",e.LINUX="Linux",e.IOS="iOS",e.UNKNOWN="WTF"}(yi||(yi={}));class bi{static getBrowser(){var e,t={},i=navigator.userAgent.toLowerCase();return(e=i.match(/msie ([\d.]+)/))?t.ie=e[1]:(e=i.match(/firefox\/([\d.]+)/))?t.firefox=e[1]:(e=i.match(/chrome\/([\d.]+)/))?t.chrome=e[1]:(e=i.match(/opera.([\d.]+)/))?t.opera=e[1]:(e=i.match(/version\/([\d.]+).*safari/))&&(t.safari=e[1]),t.ie?"ie":t.firefox?"firefox":t.chrome?"chrome":t.opera?"opera":t.safari?"safari":"unknown"}static change2fullPath(e){const t=document.createElement("A");return t.href=e,e=t.href}static deepClone(e){return JSON.parse(JSON.stringify(e))}static wait(e){return new Promise((t=>{setTimeout((()=>t()),e)}))}static isFlvMediaSource(e){if(""===e)return!1;e=bi.change2fullPath(e);return new URL(e).pathname.endsWith("flv")}}class _i{constructor(e){this._info={frameWidth:0,frameHeight:0,frameRate:0,sampleRate:0,channelCount:0,formatName:"",videoCodecName:"",audioCodecName:"",duration:-1},e&&(this._info=Object.assign(Object.assign({},this._info),e))}equal(e){return this.frameWidth===e.frameWidth&&this.frameHeight===e.frameHeight&&this.frameRate===e.frameRate&&this.sampleRate===e.sampleRate&&this.channelCount===e.channelCount&&this.formatName===e.formatName&&this.videoCodecName===e.videoCodecName&&this.audioCodecName===e.audioCodecName&&this.duration===e.duration}get noAudioInfo(){return Object.assign(Object.assign({},this.info),{channelCount:0,sampleRate:0,audioCodecName:""})}get noVideoInfo(){return Object.assign(Object.assign({},this.info),{frameWidth:0,frameHeight:0,videoCodecName:""})}get info(){return bi.deepClone(this._info)}get sampleRate(){return this._info.sampleRate}get frameHeight(){return this._info.frameHeight}get frameWidth(){return this._info.frameWidth}get duration(){return this._info.duration}get channelCount(){return this._info.channelCount}get noVideo(){return this._info.frameHeight<=0||this._info.frameWidth<=0}get noAudio(){return this._info.sampleRate<=0||this._info.channelCount<=0}get videoCodecName(){return this._info.videoCodecName}get audioCodecName(){return this._info.audioCodecName}get formatName(){return this._info.formatName}get frameRate(){return this._info.frameRate}validate(){return this.sampleRate>=3e3&&this.sampleRate<=768e3&&this.channelCount>0||this.frameWidth>0&&this.frameHeight>0}toString(){return`media info: ${JSON.stringify(this.info)}`}}var Ci=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ei=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Si=function(e,t){return function(i,n){t(i,n,e)}};let wi=class{constructor(e,t){this.playerState=e,this.lm=t,this._event=new rt,this.timeStampsOffset={video:0,audio:0},this.muteStates={video:!0,audio:!0},this.republishCorrection_=0,this.logger=this.lm.createLogger("da.fmc"),this.format={sampleRate:0,numbersOfChanel:0,videoCodecID:0,audioCodecID:0,formatName:"",videoCodecName:"",audioCodecName:"",frameRate:0,codecFrameWidth:0,codecFrameHeight:0,duration:-1,videoDescription:null,audioDescription:null,timeScale:1e3},this.resetFormat()}hasVideo(){return!(!(this.videoCodecID&&this.codecFrameHeight&&this.codecFrameWidth)||this.videoNetTrackMuted)}hasAudio(){return!(!this.audioCodecID||!this.sampleRate||this.audioNetTrackMuted)}update(e){Object.keys(e).length<=0||(this.format=Object.assign(Object.assign({},this.format),e),this.emitMediaFormatUpdate())}isH264(){return this.videoCodecID===gi.H264}isH265(){return this.videoCodecID===gi.H265}setPlayerStateMediaInfo(e){this.logger.info("media info update: "+e.toString()),this.playerState.mediaInfo=e}emitForUserMediaInfoUpdate(){const e=new _i({frameWidth:this.codecFrameWidth,frameHeight:this.codecFrameHeight,sampleRate:this.sampleRate,duration:this.duration,channelCount:this.numbersOfChanel,videoCodecName:this.videoCodecName,audioCodecName:this.audioCodecName,formatName:this.formatName,frameRate:this.frameRate});this.playerState.mediaInfo.equal(e)||this.setPlayerStateMediaInfo(e)}emitMediaFormatUpdate(){this._event.emit(mi.MediaFormatChange),this.emitForUserMediaInfoUpdate()}setContextValue(e,t){t!=this.format[e]&&(this.format[e]=t,this.emitMediaFormatUpdate())}get event(){return this._event}get sampleRate(){return this.format.sampleRate}set sampleRate(e){this.setContextValue("sampleRate",e)}get numbersOfChanel(){return this.format.numbersOfChanel}set numbersOfChanel(e){this.setContextValue("numbersOfChanel",e)}get videoCodecID(){return this.format.videoCodecID}set videoCodecID(e){this.setContextValue("videoCodecID",e)}get audioCodecID(){return this.format.audioCodecID}set audioCodecID(e){this.setContextValue("audioCodecID",e)}get formatName(){return this.format.formatName}set formatName(e){this.setContextValue("formatName",e)}get videoCodecName(){return this.format.videoCodecName}set videoCodecName(e){this.setContextValue("videoCodecName",e)}get audioCodecName(){return this.format.audioCodecName}set audioCodecName(e){this.setContextValue("audioCodecName",e)}get frameRate(){return this.format.frameRate}set frameRate(e){this.setContextValue("frameRate",e)}get codecFrameWidth(){return this.format.codecFrameWidth}set codecFrameWidth(e){this.setContextValue("codecFrameWidth",e)}get codecFrameHeight(){return this.format.codecFrameHeight}set codecFrameHeight(e){this.setContextValue("codecFrameHeight",e)}get duration(){return this.format.duration}set duration(e){this.setContextValue("duration",e)}get videoDescription(){return this.format.videoDescription}set videoDescription(e){this._event.emit(mi.VideoDescriptionChange),this.setContextValue("videoDescription",e)}get audioDescription(){return this.format.audioDescription}set audioDescription(e){this._event.emit(mi.AudioDescriptionChange),this.setContextValue("audioDescription",e)}get videoTimestampOffset(){return this.timeStampsOffset.video}set videoTimestampOffset(e){this.timeStampsOffset.video=e}get audioTimestampOffset(){return this.timeStampsOffset.audio}set audioTimestampOffset(e){this.timeStampsOffset.audio=e}get audioNetTrackMuted(){return this.muteStates.audio}set audioNetTrackMuted(e){this.muteStates.audio=e,this._event.emit(mi.AudioRemoteMuteStateUpdate)}get videoNetTrackMuted(){return this.muteStates.video}set videoNetTrackMuted(e){this.muteStates.video=e,this._event.emit(mi.VideoRemoteMuteStateUpdate)}set timeScale(e){this.setContextValue("timeScale",e)}get timeScale(){return this.format.timeScale}set republishCorrection(e){this.republishCorrection_=e}get republishCorrection(){return this.republishCorrection_}resetFormat(){this.format.sampleRate=0,this.format.numbersOfChanel=0,this.format.videoCodecID=0,this.format.audioCodecID=0,this.format.formatName="",this.format.videoCodecName="",this.format.audioCodecName="",this.format.frameRate=0,this.format.codecFrameWidth=0,this.format.codecFrameHeight=0,this.format.duration=-1,this.format.videoDescription=null,this.format.audioDescription=null,this.muteStates={video:!0,audio:!0},this.republishCorrection_=0}reset(){this.resetFormat(),this.emitMediaFormatUpdate()}setVideoFrameSize(e,t){this.format.codecFrameHeight=t,this.format.codecFrameWidth=e,this.emitMediaFormatUpdate()}setAudioFormat(e,t,i){this.format.audioCodecName=e,this.format.sampleRate=t,this.format.numbersOfChanel=i,this.emitMediaFormatUpdate()}};function Ri(e){return!!(e&&window.VideoFrame&&"object"==typeof e&&e instanceof window.VideoFrame)}var Di;wi=Ci([it(),Si(0,mt(tt.PlayerState)),Si(1,mt(tt.LogMana)),Ei("design:paramtypes",[Object,$t])],wi),function(e){e.ReadToEmpty="read_to_empty",e.SizeChange="size_change"}(Di||(Di={}));class Ai{constructor(e){this.packetContext=e,this._event=new rt,this.queue=[]}get event(){return this._event}get numberOfPackets(){return this.queue.length}get duration(){let e=0;if(this.empty())return e;const t=this.front();if(!t)throw new Vt("read video packet error when get duration");let i=t.pts;for(let n=1;n<this.queue.length;n++)this.queue.forEach((t=>{e+=i-t.pts,i=t.pts}));return e}dropPtsErrFrame(e){this.queue.length>0&&e.pts<this.queue[this.queue.length-1].pts&&this.clear()}updateQueueChangeEvent(e){e!=this.numberOfPackets&&this._event.emit(Di.SizeChange,this.numberOfPackets)}push(e){const t=this.numberOfPackets;this.dropPtsErrFrame(e),this.queue.push(e),this.updateQueueChangeEvent(t)}pop(){if(this.empty())return null;const e=this.numberOfPackets,t=this.queue.shift();return this.empty()&&this._event.emit(Di.ReadToEmpty),this.serialCorrect(t)?(this.updateQueueChangeEvent(e),t||null):(t&&Ri(t.payload)&&t.payload.close(),this.clear(),null)}closeFrames(){for(let e=0;e<this.queue.length;e++)Ri(this.queue[e].payload)&&this.queue[e].payload.close()}clear(){const e=this.numberOfPackets;return this.closeFrames(),this.queue=[],this.updateQueueChangeEvent(e),!0}indexOf(e){throw new Error("Method not implemented.")}removeOf(e){throw new Error("Method not implemented.")}size(){return this.queue.length}empty(){return 0===this.numberOfPackets}serialCorrect(e){return!e||e.serial===this.packetContext.videoSerial}front(){const e=this.queue[0];return this.serialCorrect(e)?e||null:(this.clear(),null)}destroy(){this.clear()}}class Pi{constructor(){this.MIN_VIDEO_BITRATE_KBPS=20,this.QualityConstant={MinQuality:0,DieQuality:0,PoorMinQuality:1,MiddleMinQuality:30,GoodMinQuality:60,ExcellentMinQuality:85,MaxQuality:100},this.streamIDList={qualityArray:[]},this.streamData=null}CalcNetQualityGradeSmooth(e,t,i,n){if((e||t||i||n)&&this.streamIDList.cannotCalc&&(this.streamIDList.cannotCalc=!1),this.streamIDList.cannotCalc&&0==e&&0==t&&0==i&&0==n)return!1;{const r=this.CalcQualityGrade(e,t,i,n);this.streamIDList.qualityArray||(this.streamIDList.qualityArray=[]),this.streamIDList.qualityArray.push(r),this.streamIDList.qualityArray.length>10&&this.streamIDList.qualityArray.shift();const o=this.streamIDList.qualityArray.length*(this.streamIDList.qualityArray.length+1)/2;return this._weightSumQuality(this.streamIDList.qualityArray)/o}}removeStreamRefer(){this.streamIDList={}}_weightSumQuality(e){return e.reduce((function(e,t,i,n){return e+t*(i+1)}),0)}CalcQualityGrade(e,t,i,n){if(e<=0&&i<=0&&t<=0)return this.QualityConstant.MinQuality;let r=0,o=0,s=0;return t&&e&&(r=Math.min(t,e)/e*100),n&&i&&(o=n<=3?10+20*n/3:n<=6?30+30*(n-3)/3:50+Math.min(n,i)/i*50),s=r&&o?Math.min(r,o):Math.max(r,o),s}}var Fi=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ti=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},xi=function(e,t){return function(i,n){t(i,n,e)}};let ki=class{constructor(e){this.calcQuality=new Pi,this.logger=e.createLogger("qlt.net"),this.reset()}networkStatisticDataReset(){this.networkFetchTime=0,this.audioNetBitrateKB=0,this.videoNetBitrateKB=0,this.demuxedFirstVideoData=!1,this.demuxedFirstAudioData=!1,this.GOP=-1,this.iFrameCount=0,this.totalIFrameCount=0,this.targetVideoFrameRate=0,this.targetAudioFrameRate=0,this.downloadVideoFrameRate=0,this.downloadAudioFrameRate=0}reset(){this.lastNetworkRequestTime=0,this.networkStatisticDataReset()}resetIFrameCount(){this.iFrameCount=0}countIFrame(){this.iFrameCount++,this.totalIFrameCount++}getNetQuality(){const e=this.calcQuality.CalcQualityGrade(this.targetAudioFrameRate,this.downloadAudioFrameRate,this.targetVideoFrameRate,this.downloadVideoFrameRate);return e||0}networkRequestStart(){this.lastNetworkRequestTime=performance.now(),this.networkStatisticDataReset()}fetchedFirstData(){this.lastNetworkRequestTime>0&&(this.networkFetchTime=performance.now()-this.lastNetworkRequestTime,this.logger.info(`network fetch first data time cost: ${this.networkFetchTime.toFixed(2)} ms`))}onDemuxAudioData(){this.demuxedFirstAudioData||this.lastNetworkRequestTime<=0||(this.demuxedFirstAudioData=!0,this.networkFetchTime=performance.now()-this.lastNetworkRequestTime,this.logger.info(`network fetch first audio frame time cost: ${this.networkFetchTime.toFixed(2)} ms`))}onDemuxVideoData(){this.demuxedFirstVideoData||this.lastNetworkRequestTime<=0||(this.demuxedFirstVideoData=!0,this.networkFetchTime=performance.now()-this.lastNetworkRequestTime,this.logger.info(`network fetch first video frame time cost: ${this.networkFetchTime.toFixed(2)} ms`))}};ki=Fi([it(),xi(0,mt(tt.LogMana)),Ti("design:paramtypes",[$t])],ki);class Mi{constructor(){this.countFrames=[0],this.statisticTimer=null,this.lastUpdateCountTime=performance.now(),this.statisticPeriodMs=1e3,this.countFramesMaxLen=3,this.startStatisticTimer(),this.reset()}startStatisticTimer(){this.statisticTimer=setInterval((()=>{this.lastUpdateCountTime=performance.now(),this.countFrames.push(0),this.countFrames.length>this.countFramesMaxLen&&this.countFrames.shift()}),this.statisticPeriodMs)}clearStatisticTimer(){clearInterval(this.statisticTimer)}destroy(){this.clearStatisticTimer()}frameRate(){const e=performance.now()-this.lastUpdateCountTime+(this.countFrames.length-1)*this.statisticPeriodMs;if(0===e)return 0;return this.countFrames.reduce(((e,t)=>e+t))/(e/1e3)}count(){this.countFrames[this.countFrames.length-1]+=1}reset(){this.countFrames=[0],this.lastUpdateCountTime=performance.now()}}var Oi=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ii=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Li=function(e,t){return function(i,n){t(i,n,e)}};let Bi=class{constructor(e,t){this.videoFrameRateCalculator=new Mi,this.audioFrameRateCalculator=new Mi,this.videoFpsSet=null,this.volumeIn100=0,this.logger=e.createLogger("qlt.rnd"),t.event.once(di.DESTROY,(()=>{this.videoFrameRateCalculator.destroy()})),this.reset()}get videoRealtimeFrameRate(){return null!==this.videoFpsSet?this.videoFpsSet:this.videoFrameRateCalculator.frameRate()}get audioRealtimeFrameRate(){return this.audioFrameRateCalculator.frameRate()}reset(){this.lastRenderRequestTime=0,this.audioFirstFrameTime=0,this.videoFirstFrameTime=0,this.firstVideoFrameRendered=!1,this.firstAudioFrameRendered=!1,this.videoFrameRateCalculator.reset()}renderRequestStart(){this.lastRenderRequestTime=performance.now(),this.firstVideoFrameRendered=!1,this.firstAudioFrameRendered=!1}renderFailed(){this.lastRenderRequestTime=0,this.logger.info("renderFailed recv")}firstAudioFrame(){this.lastRenderRequestTime>0&&(this.audioFirstFrameTime=performance.now()-this.lastRenderRequestTime,this.logger.info(`First audio frame time cost: ${this.audioFirstFrameTime.toFixed(2)} ms`))}firstVideoFrame(){this.lastRenderRequestTime>0&&!this.firstVideoFrameRendered&&(this.videoFirstFrameTime=performance.now()-this.lastRenderRequestTime,this.logger.info(`First video frame time cost: ${this.videoFirstFrameTime.toFixed(2)} ms`),this.firstVideoFrameRendered=!0)}setVideoFPS(e){this.videoFpsSet=e}clearVideoFpsSet(){this.videoFpsSet=null}onRenderVideoFrame(){this.firstVideoFrameRendered||(this.firstVideoFrame(),this.firstVideoFrameRendered=!0),this.videoFrameRateCalculator.count()}onRenderAudioFrame(){this.firstAudioFrameRendered||(this.firstAudioFrame(),this.firstAudioFrameRendered=!0),this.audioFrameRateCalculator.count()}};Bi=Oi([it(),Li(0,mt(tt.LogMana)),Li(1,mt(tt.GlobalEvent)),Ii("design:paramtypes",[$t,Object])],Bi);var Vi=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ui=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let Ni=class{constructor(){this.reset()}reset(){this.videoDecodeBitrateKB=0,this.audioDecodeBitrateKB=0}};Ni=Vi([it(),Ui("design:paramtypes",[])],Ni);var ji,Wi=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},qi=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Hi=function(e,t){return function(i,n){t(i,n,e)}};!function(e){e.BEFORE_UPLOAD_QUALITY="before_upload_quality"}(ji||(ji={}));let Qi=class{constructor(e,t,i,n){this.lm=e,this.playerState=t,this.globalEvent=i,this.optionsContext=n,this._event=new rt,this.qualityUploadTimer=null,this.qualityUploadMs=3e3,this.qualityData={},this.logger=this.lm.createLogger("qlt"),this.bindGlobalEvent()}get event(){return this._event}bindGlobalEvent(){this.globalEvent.event.addListener(di.MEDIA_FETCH_BEGIN,(e=>{this.url=e,this.startUploadQuality(),this.reset()})),this.globalEvent.event.addListener(di.MEDIA_FETCH_END,(e=>{this.url==e&&this.stopUploadQuality()}))}stopQualityTimer(){this.qualityUploadTimer&&(clearInterval(this.qualityUploadTimer),this.qualityUploadTimer=null)}isAudioMuted(){return this.playerState.muted||0==this.playerState.volume||0==this.renderStatistic.volumeIn100}onUploadQuality(){this.event.emit(ji.BEFORE_UPLOAD_QUALITY);const e={decodeType:this.optionsContext.getDecodeType(),hasAudio:this.formatContext.hasAudio(),hasVideo:this.formatContext.hasVideo(),GOP:this.networkStatistic.GOP,targetVideoFPS:this.networkStatistic.targetVideoFrameRate,targetAudioFPS:this.networkStatistic.targetAudioFrameRate,downloadAudioFPS:this.networkStatistic.downloadAudioFrameRate,downloadVideoFPS:this.networkStatistic.downloadVideoFrameRate,netQuality:this.networkStatistic.getNetQuality(),videoNetDataKBPerSecond:this.networkStatistic.videoNetBitrateKB,audioNetDataKBPerSecond:this.networkStatistic.audioNetBitrateKB,videoDecodedKBPerSecond:this.decodeStatistic.videoDecodeBitrateKB,audioDecodedKBPerSecond:this.decodeStatistic.audioDecodeBitrateKB,iFrameCount:this.networkStatistic.iFrameCount,totalIFrameCount:this.networkStatistic.totalIFrameCount,videoRenderFPS:this.renderStatistic.videoRealtimeFrameRate,audioRenderFPS:this.renderStatistic.audioRealtimeFrameRate,audioMuted:this.isAudioMuted()};this.optionsContext.useCustomStream()||this.globalEvent.event.emit(di.ON_QUALITY_SCORE,this.networkStatistic.getNetQuality()),this.networkStatistic.resetIFrameCount(),this.qualityData=e,this.logger.info(JSON.stringify(e))}startUploadQuality(){this.stopQualityTimer(),this.qualityUploadTimer=setInterval(this.onUploadQuality.bind(this),this.qualityUploadMs)}stopUploadQuality(){this.stopQualityTimer()}reset(){this.networkStatistic.reset(),this.decodeStatistic.reset(),this.renderStatistic.reset()}postMessage(e){}onmessage(e){this.logger.info("msg: ",e.type),e.type,this.logger.error("unknown msg type: ",e.type)}terminate(){this.stopQualityTimer(),this.networkStatistic.reset(),this.decodeStatistic.reset(),this.renderStatistic.reset()}};Wi([mt(tt.DecodeStatistic),qi("design:type",Ni)],Qi.prototype,"decodeStatistic",void 0),Wi([mt(tt.NetworkStatistic),qi("design:type",ki)],Qi.prototype,"networkStatistic",void 0),Wi([mt(tt.RenderStatistic),qi("design:type",Bi)],Qi.prototype,"renderStatistic",void 0),Wi([mt(tt.FormatContext),qi("design:type",Object)],Qi.prototype,"formatContext",void 0),Wi([Ht("uq",{callInfo:!1}),qi("design:type",Function),qi("design:paramtypes",[]),qi("design:returntype",void 0)],Qi.prototype,"onUploadQuality",null),Wi([Ht("srq"),qi("design:type",Function),qi("design:paramtypes",[]),qi("design:returntype",void 0)],Qi.prototype,"startUploadQuality",null),Wi([Ht("soq"),qi("design:type",Function),qi("design:paramtypes",[]),qi("design:returntype",void 0)],Qi.prototype,"stopUploadQuality",null),Qi=Wi([it(),Hi(0,mt(tt.LogMana)),Hi(1,mt(tt.PlayerState)),Hi(2,mt(tt.GlobalEvent)),Hi(3,mt(tt.OptionsContext)),qi("design:paramtypes",[$t,Object,Object,Object])],Qi);class Gi{constructor(e,t){this.globalEvent=e,this.onBitRateUpdate=t,this.nextNode=null,this.countBytes=[0],this.statisticTimer=null,this.lastUpdateCountTime=performance.now(),this.statisticPeriodMs=1e3,this.countBytesMaxLen=3,this.startStatisticTimer(),this.globalEvent.event.once(di.DESTROY,(()=>{this.destroy()}))}startStatisticTimer(){this.statisticTimer=setInterval((()=>{this.lastUpdateCountTime=performance.now(),this.countBytes.push(0),this.countBytes.length>this.countBytesMaxLen&&this.countBytes.shift(),this.onBitRateUpdate()}),this.statisticPeriodMs)}statistic(e){this.countBytes[this.countBytes.length-1]+=e}clearStatisticTimer(){clearInterval(this.statisticTimer)}destroy(){this.clearStatisticTimer()}KBRate(){const e=performance.now()-this.lastUpdateCountTime+(this.countBytes.length-1)*this.statisticPeriodMs;return this.countBytes.reduce(((e,t)=>e+t))/(e/1e3)/1024}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}statisticAudio(e){const t=e.payload.leftChannel.byteLength+e.payload.rightChannel.byteLength;this.statistic(t)}statisticVideo(e){if(Ri(e.payload)){const t=e.payload.allocationSize();this.statistic(t)}else{const t=e.payload.yuvData,i=t.y.data.byteLength+t.u.data.byteLength+t.v.data.byteLength;this.statistic(i)}}receive(e){var t;e.payload.leftChannel?this.statisticAudio(e):e.payload&&this.statisticVideo(e),null===(t=this.nextNode)||void 0===t||t.receive(e)}}var zi=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ki=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Yi=function(e,t){return function(i,n){t(i,n,e)}};let $i=class{constructor(e,t,i){this.packetContext=e,this.qualityCtx=t,this.videoQueue=new Ai(this.packetContext),this.bitrateStatisticNode=new Gi(i,(()=>{this.qualityCtx.decodeStatistic.videoDecodeBitrateKB=this.bitrateStatisticNode.KBRate()}))}get event(){return this.videoQueue.event}push(e){this.bitrateStatisticNode.receive(e),this.videoQueue.push(e)}pop(){return this.videoQueue.pop()}clear(){return this.videoQueue.clear()}indexOf(e){throw new Error("Method not implemented.")}removeOf(e){throw new Error("Method not implemented.")}size(){return this.videoQueue.size()}empty(){return this.videoQueue.empty()}front(){return this.videoQueue.front()}destroy(){this.videoQueue.destroy()}};var Xi;$i=zi([it(),Yi(0,mt(tt.PacketContext)),Yi(1,mt(tt.QualityStatisticContext)),Yi(2,mt(tt.GlobalEvent)),Ki("design:paramtypes",[Object,Qi,Object])],$i),function(e){e.SizeChange="numberOfPakcetsChanged",e.ReadToEmpty="readEmpty"}(Xi||(Xi={}));var Zi=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ji=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},en=function(e,t){return function(i,n){t(i,n,e)}};let tn=class{constructor(e,t,i){this.packetContext=e,this.qualityCtx=t,this.queue=[],this._event=new rt,this.bitrateStatisticNode=new Gi(i,(()=>{this.qualityCtx.decodeStatistic.audioDecodeBitrateKB=this.bitrateStatisticNode.KBRate()}))}push(e){this.bitrateStatisticNode.receive(e),this.dropPtsErrData(e);const t=this.numberOfPackets;this.queue.push(e),this.updateQueueChangeEvent(t)}serialCorrect(e){return!e||e.serial===this.packetContext.audioSerial}pop(){const e=this.numberOfPackets,t=this.read(1024);return this.serialCorrect(t)?(this.updateQueueChangeEvent(e),t||null):(this.clear(),null)}clear(){const e=this.numberOfPackets;return this.queue=[],this.updateQueueChangeEvent(e),!0}indexOf(e){throw new Error("Method not implemented.")}removeOf(e){throw new Error("Method not implemented.")}size(){return this.queue.length}empty(){return 0===this.queue.length}front(){const e=this.queue[0];return this.serialCorrect(e)?e||null:(this.clear(),null)}get byteSize(){let e=0;return this.queue.forEach((t=>{e+=t.payload.leftChannel.byteLength,e+=t.payload.rightChannel.byteLength})),e}get numberOfPackets(){return this.queue.length}get event(){return this._event}dropPtsErrData(e){this.queue.length>0&&e.pts<this.queue[this.queue.length-1].pts&&this.clear()}updateQueueChangeEvent(e){e!=this.numberOfPackets&&this._event.emit(Xi.SizeChange,this.numberOfPackets)}read(e){if(this.isEmpty())return;const t=this.numberOfPackets;let i;const n=this.queue[0];if(n&&n.payload.leftChannel&&n.payload.rightChannel&&e===n.payload.leftChannel.length&&e===n.payload.rightChannel.length)i=this.queue.shift();else{i={payload:{leftChannel:new Float32Array(e),rightChannel:new Float32Array(e)},pts:-1,serial:0};let t=0;for(;t<e;){const n=this.queue[0];if(!n)return;const r=Math.min(e-t,n.payload.leftChannel.length);i.payload.leftChannel.set(n.payload.leftChannel.subarray(0,r),t),i.payload.rightChannel.set(n.payload.rightChannel.subarray(0,r),t),i.pts<0&&(i.pts=n.pts),i.serial=n.serial,r===n.payload.leftChannel.length?this.queue.shift():(n.payload.leftChannel=n.payload.leftChannel.subarray(r),n.payload.rightChannel=n.payload.rightChannel.subarray(r)),t+=r}}return this.updateQueueChangeEvent(t),0===this.queue.length&&this.isEmpty()&&this._event.emit(Xi.ReadToEmpty),i}isEmpty(){return this.empty()}destroy(){this.clear()}};var nn;tn=Zi([it(),en(0,mt(tt.PacketContext)),en(1,mt(tt.QualityStatisticContext)),en(2,mt(tt.GlobalEvent)),Ji("design:paramtypes",[Object,Qi,Object])],tn),function(e){e.RESET="reset",e.DOWNLOAD="download",e.PLAY="play",e.PAUSE="pause",e.SRC_CHANGED="mediaResourceChanged",e.SET_VOLUME="setVolume",e.STOP="stop",e.TASK="NewTask",e.PLAYER_EVENT_EMIT="playerEventEmit"}(nn||(nn={}));var rn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},on=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},sn=function(e,t){return function(i,n){t(i,n,e)}};let an=class extends rt{constructor(e){super(),this.lm=e,this.logger=this.lm.createLogger("0.peve")}onmessage(e){if(e.type===nn.PLAYER_EVENT_EMIT)this.logger.info("msg: ",e.type),this.emit(e.data.eventName,...e.data.args);else this.logger.error("unknown msg type: ",e.type)}postMessage(e){}terminate(){this.removeAllListeners()}};var dn;an=rn([it(),sn(0,mt(tt.LogMana)),on("design:paramtypes",[$t])],an),function(e){e.EmitUpdateMediaInfo="emit_update_media_info",e.ResumeFetchUrl="resume_fetch_url"}(dn||(dn={}));class ln{constructor(){this.tagMap=new Map,this.lastTaskRunTimeMap=new Map,this.timerMap=new Map}setTag(e,t){this.tagMap.set(e,t)}getTimerList(e){return void 0===this.timerMap.get(e)&&this.timerMap.set(e,[]),this.timerMap.get(e)}setTimerList(e,t){this.timerMap.set(e,t)}setDelayTaskTime(e,t,i){const n=(new Date).getTime();"queue"==i&&this.lastTaskRunTimeMap.set(e,n+t)}updateTaskRunTimeNow(e){const t=(new Date).getTime();this.lastTaskRunTimeMap.set(e,t)}runTaskDelay(e,t,i){const n=setTimeout((()=>{const t=this.getTimerList(e).filter((e=>e!=n));this.setTimerList(e,t),this.updateTaskRunTimeNow(e),i()}),t);this.getTimerList(e).push(n)}parseRunOptions(e){let t=0;e&&e.minDelayMs&&(t=e.minDelayMs);let i="queue";return e&&e.mode&&(i=e.mode),{minDelayMs:t,mode:i}}run(e,t,i){let{minDelayMs:n,mode:r}=this.parseRunOptions(i);void 0===this.tagMap.get(e)&&this.setTag(e,n),"cancel_before"==r&&this.clearTask(e),n=this.tagMap.get(e)||0;const o=this.lastTaskRunTimeMap.get(e)||0,s=(new Date).getTime()-o;if(s>n||0===n)return this.updateTaskRunTimeNow(e),void t();const a=n-s;this.setDelayTaskTime(e,a,r),this.runTaskDelay(e,a,t)}clearTask(e){this.getTimerList(e).forEach((e=>{clearTimeout(e)})),this.setTimerList(e,[])}}var un=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let cn=class{constructor(){this.antiShake=new ln}};cn=un([it()],cn);var hn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},pn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let fn=class{checkPlayedEvent(){!this.playedEvent&&this.audioDeviceReady&&this.isRendering&&this.mediaOpened&&(this.playerEmitter.emit(li.MEDIA_PLAYED),this.playedEvent=!0)}constructor(){this.playedEvent=!1,this.model={taskID:0,url:"",customStream:null,isRendering:!1,userPlayed:!1,loaded:!1,volume:100,decodeEnded:!1,mediaPlayEnded:!1,muted:!1,waiting:!1,destroy:!1,mediaOpened:!1,audioDeviceReady:!1,currentTime:0,currentTimestampOffset:0,mediaInfo:new _i}}set mediaPlayEnded(e){const t=e&&!this.mediaPlayEnded;this.model.mediaPlayEnded=e,t&&this.playerEmitter.emit(li.MEDIA_PLAY_ENDED)}get mediaPlayEnded(){return this.model.mediaPlayEnded}set audioDeviceReady(e){this.model.audioDeviceReady=e,this.checkPlayedEvent()}get audioDeviceReady(){return this.model.audioDeviceReady}set decodeEnded(e){this.model.decodeEnded=e}get decodeEnded(){return this.model.decodeEnded}set userPlayed(e){this.model.userPlayed=e}get userPlayed(){return this.model.userPlayed}setRefetchRuntimeState(){this.loaded=!1,this.decodeEnded=!1,this.mediaPlayEnded=!1,this.mediaInfo=new _i}set url(e){this.setRefetchRuntimeState(),this.mediaOpened=!1,this.url!==e&&(this.currentTime=0,this.waiting=!1),this.model.url=e,this.playedEvent=!1,this.model.customStream=null}get url(){return this.model.url}set customStream(e){this.model.customStream=e}get customStream(){return this.model.customStream}set mediaOpened(e){e&&!this.mediaOpened&&(this.playerEmitter.emit(li.MEDIA_CAN_PLAY),this.checkPlayedEvent()),this.model.mediaOpened=e}get mediaOpened(){return this.model.mediaOpened}set isRendering(e){this.model.isRendering=e,this.checkPlayedEvent()}get isRendering(){return this.model.isRendering}set pausedRendering(e){const t=e&&!this.pausedRendering;this.model.isRendering=!e,t&&(this.playedEvent=!1),t&&this.playerEmitter.emit(li.MEDIA_PAUSED)}get pausedRendering(){return!this.model.isRendering}set volume(e){this.model.volume=e}get volume(){return this.model.volume}set currentTime(e){(e=Number(e.toFixed(2)))>=0&&e!==this.currentTime&&(this.mediaInfo.duration<=0||e<=this.mediaInfo.duration)&&(this.model.currentTime=e,this.playerEmitter.emit(li.CURRENT_TIME_CHANGE),this.globalEvent.event.emit(di.CURRENT_TIME_CHANGE))}get currentTime(){return this.model.currentTime}set currentTimestampOffset(e){this.model.currentTimestampOffset=e}get currentTimestampOffset(){return this.model.currentTimestampOffset}set loaded(e){const t=e&&!this.loaded;this.model.loaded=e,t&&this.playerEmitter.emit(li.MEDIA_LOADED)}get loaded(){return this.model.loaded}set mediaInfo(e){this.model.mediaInfo=e,e.validate()&&this.utils.antiShake.run(dn.EmitUpdateMediaInfo,(()=>{this.model.mediaInfo.noAudio?this.playerEmitter.emit(li.MEDIA_INFO_UPDATE,this.model.mediaInfo.noAudioInfo):this.mediaInfo.noVideo?this.playerEmitter.emit(li.MEDIA_INFO_UPDATE,this.model.mediaInfo.noVideoInfo):this.playerEmitter.emit(li.MEDIA_INFO_UPDATE,this.model.mediaInfo.info)}),{minDelayMs:500,mode:"cancel_before"})}get mediaInfo(){return this.model.mediaInfo}get duration(){return this.model.mediaInfo.duration}set muted(e){this.model.muted=e}get muted(){return this.model.muted}set waiting(e){const t=e&&!this.waiting&&this.isRendering;e?(this.model.waiting=e,t&&this.playerEmitter.emit(li.MEDIA_PLAY_WAITING)):this.playing=!e}get waiting(){return this.model.waiting}set playing(e){const t=e&&!this.playing;e?(this.model.waiting=!e,t&&!this.mediaPlayEnded&&!this.loaded&&this.playerEmitter.emit(li.MEDIA_PLAYING)):this.waiting=!e}get playing(){return!this.model.waiting}set destroy(e){this.model.destroy=e}get destroy(){return this.model.destroy}set taskID(e){this.model.taskID=e}get taskID(){return this.model.taskID}};hn([mt(tt.PlayerEventEmitter),pn("design:type",an)],fn.prototype,"playerEmitter",void 0),hn([mt(tt.Utils),pn("design:type",cn)],fn.prototype,"utils",void 0),hn([mt(tt.GlobalEvent),pn("design:type",Object)],fn.prototype,"globalEvent",void 0),fn=hn([it(),pn("design:paramtypes",[])],fn);var mn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},gn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},yn=function(e,t){return function(i,n){t(i,n,e)}};let vn=class{constructor(e,t,i){this._playerState=e,this.formateCtx=t,this.globalEvent=i,this._lastPts=-1,this._firstPtsUpdateTime=-1,this._firstPts=-1,this.globalEvent.event.on(di.HAS_KEY_FRAME_DROP,(()=>{this.reset()}))}get firstPtsReceived(){return this._firstPts>=0}reset(){this._lastPts=-1,this._firstPtsUpdateTime=-1,this._firstPts=-1}updateClock(e){this._firstPts<0&&(this._firstPts=e,this._firstPtsUpdateTime=performance.now()),this._playerState.mediaPlayEnded||this.formateCtx.hasAudio()&&!this.formateCtx.audioNetTrackMuted||(this._playerState.currentTime=this.getClock()-this.formateCtx.videoTimestampOffset,this._playerState.currentTimestampOffset=this.formateCtx.videoTimestampOffset),this._lastPts=e}durationFromFirstPts(){return this._firstPtsUpdateTime<0||this._firstPts<0?0:performance.now()-this._firstPtsUpdateTime+this._firstPts}getClock(){return this._lastPts<0?0:this._lastPts}};var bn;vn=mn([it(),yn(0,mt(tt.PlayerState)),yn(1,mt(tt.FormatContext)),yn(2,mt(tt.GlobalEvent)),gn("design:paramtypes",[fn,Object,Object])],vn),function(e){e.ClockUpdate="clockUpdate"}(bn||(bn={}));var _n=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Cn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},En=function(e,t){return function(i,n){t(i,n,e)}};let Sn=class{constructor(e,t){this._playerState=e,this.formateCtx=t,this.currentPts=-1,this.lastPausedTime=-1,this.lastUpdateTime=-1,this._event=new rt}get event(){return this._event}reset(){this.currentPts=-1}paused(){this.lastPausedTime=performance.now(),this.lastUpdateTime=-1}getLiveClock(){return this.currentPts<0?0:this.lastPausedTime<0?this.getClock():performance.now()-this.lastPausedTime+this.currentPts}getClock(){let e=0;return this.lastUpdateTime>0&&(e=performance.now()-this.lastUpdateTime),Math.max(this.currentPts+e,0)}updateClock(e){this.currentPts!==e&&e>0&&(this.currentPts=e,this.lastUpdateTime=performance.now(),this.lastPausedTime=-1,this._playerState.mediaPlayEnded||this.formateCtx.hasAudio()&&!this.formateCtx.audioNetTrackMuted&&(this._playerState.currentTime=this.getClock()-this.formateCtx.audioTimestampOffset,this._playerState.currentTimestampOffset=this.formateCtx.audioTimestampOffset),this._event.emit(bn.ClockUpdate))}};Sn=_n([it(),En(0,mt(tt.PlayerState)),En(1,mt(tt.FormatContext)),Cn("design:paramtypes",[fn,Object])],Sn);var wn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Rn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Dn=function(e,t){return function(i,n){t(i,n,e)}};let An=class{constructor(e,t){this.lm=e,this.httpFetchBuilder=t,this.httpFetch=null,this.logger=e.createLogger("dmx.hpr")}onsuccess(){}onerror(e){}onprogress(e){}onabort(){}onresume(){}destroyHttpFetch(){this.httpFetch&&this.httpFetch.destroy()}createHttpFetch(e){this.destroyHttpFetch(),this.httpFetch=this.httpFetchBuilder(),this.httpFetch.init({url:e,onsuccess:()=>{this.onsuccess()},onerror:e=>{this.onerror(e)},onprogress:e=>{this.onprogress(e)},onabort:()=>{this.onabort()},onresume:()=>{this.onresume()}})}abort(){var e;null===(e=this.httpFetch)||void 0===e||e.abort()}destroy(){this.destroyHttpFetch(),this.onabort=()=>{},this.onerror=()=>{},this.onprogress=()=>{},this.onresume=()=>{},this.onsuccess=()=>{}}request(e){this.destroyHttpFetch(),this.createHttpFetch(e)}};wn([Ht("abt"),Rn("design:type",Function),Rn("design:paramtypes",[]),Rn("design:returntype",void 0)],An.prototype,"abort",null),wn([Ht("rq"),Rn("design:type",Function),Rn("design:paramtypes",[String]),Rn("design:returntype",void 0)],An.prototype,"request",null),An=wn([it(),Dn(0,mt(tt.LogMana)),Dn(1,mt(tt.HttpFetchBuilder)),Rn("design:paramtypes",[$t,Function])],An);var Pn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Fn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Tn=function(e,t){return function(i,n){t(i,n,e)}};let xn=class{constructor(e){this.enableCustomStream=!1,this.logger=e.createLogger("d.oc")}setCustomStream(e){this.enableCustomStream=e}useCustomStream(){return this.enableCustomStream}getDecodeType(){return this.enableCustomStream?"customStream":this.useWebCodec()?"WebCodecs":this.useMse()?"MSE":(this.useWasm(),"wasm")}setWebCodecFailed(){this.setDecodeOptions(new bt(!1,!1,!0,!1))}setMseFailed(){this.setDecodeOptions(new bt(!1,!0,!1,!0))}setDecodeOptions(e){this.logger.info(`set ${e.useWebCodec()} ${e.useWasm()} ${e.useMse()}`),this.decodeOptions=e}useMse(){return!(!this.decodeOptions||this.useCustomStream())&&this.decodeOptions.useMse()}useWebCodec(){return!(!this.decodeOptions||this.useCustomStream())&&this.decodeOptions.useWebCodec()}useWasm(){return!(this.decodeOptions&&!this.useCustomStream())||this.decodeOptions.useWasm()}};xn=Pn([it(),Tn(0,mt(tt.LogMana)),Fn("design:paramtypes",[$t])],xn);var kn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Mn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let On=class{constructor(){this._event=new rt,this._event.setMaxListeners(100)}get event(){return this._event}};On=kn([it(),Mn("design:paramtypes",[])],On);var In,Ln=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Bn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Vn=function(e,t){return function(i,n){t(i,n,e)}};!function(e){e.BUFFER_CAN_PLAY="canplay",e.MEDIA_END="mediaEnd"}(In||(In={}));let Un=class{constructor(e,t,i,n,r,o,s){this.playerState=e,this.lm=t,this.audioFrameQueue=i,this.videoFrameQueue=n,this.formateContext=r,this.audioSyncBuilder=o,this.videoSyncBuilder=s,this.lastLegalMediaInfo=new _i,this.currentLegalMediaInfo=new _i,this._event=new rt,this.canPlayAudioBufferListener=e=>{this.isAudioCanplay()&&(this.logger.info("meida can play (by audio buffer)"),this.audioFrameQueue.event.off(Xi.SizeChange,this.canPlayAudioBufferListener),this._event.emit(In.BUFFER_CAN_PLAY))},this.canPlayVideoBufferListener=e=>{this.isVideoCanplay()&&(this.logger.info("meida can play (by video buffer)"),this.videoFrameQueue.event.off(Di.SizeChange,this.canPlayVideoBufferListener),this._event.emit(In.BUFFER_CAN_PLAY))},this.mediaEndAudioBufferListener=()=>{!this.playerState.mediaPlayEnded&&this.playerState.decodeEnded&&this.playerState.loaded&&(this.logger.info("media play ended. (by audio buffer)"),this.playerState.mediaPlayEnded=!0,this._event.emit(In.MEDIA_END))},this.mediaEndVideoBufferListener=()=>{!this.playerState.mediaPlayEnded&&this.playerState.decodeEnded&&this.playerState.loaded&&(this.logger.info("media play ended."),this.playerState.mediaPlayEnded=!0,this._event.emit(In.MEDIA_END))},this.logger=this.lm.createLogger("rd.rdmd"),this.resetBindCanplayEvent(),this.bindRemoteMuteStateEvent()}bindRemoteMuteStateEvent(){this.formateContext.event.on(mi.AudioRemoteMuteStateUpdate,(()=>{this.updateSynchronizer(),this.resetBindCanplayEvent()})),this.formateContext.event.on(mi.VideoRemoteMuteStateUpdate,(()=>{this.updateSynchronizer(),this.resetBindCanplayEvent()}))}get event(){return this._event}get sync(){return this.synchronizer}get audioFrames(){return this.audioFrameQueue}get videoFrames(){return this.videoFrameQueue}get partialInfo(){return this.currentLegalMediaInfo}get lastMediaInfo(){return this.lastLegalMediaInfo}isMediaLegal(){const e=this.partialInfo.validate();return this.logger.info(`info validate: ${e}`),e}bindCanPlayEventByAudioBuffer(){this.audioFrameQueue.event.off(Xi.SizeChange,this.canPlayAudioBufferListener),this.isAudioCanplay()?this._event.emit(In.BUFFER_CAN_PLAY):this.audioFrameQueue.event.on(Xi.SizeChange,this.canPlayAudioBufferListener)}isVideoCanplay(){return this.videoFrameQueue.size()>2}isAudioCanplay(){return this.audioFrameQueue.size()>5}bindCanPlayEventByVideoBuffer(){this.videoFrameQueue.event.off(Di.SizeChange,this.canPlayVideoBufferListener),this.isVideoCanplay()?this._event.emit(In.BUFFER_CAN_PLAY):this.videoFrameQueue.event.on(Di.SizeChange,this.canPlayVideoBufferListener)}isNoAudio(){return this.partialInfo.noAudio||!this.formateContext.hasAudio()||this.formateContext.audioNetTrackMuted}updateSynchronizer(){this.isNoAudio()?(this.logger.info("use video master Synchronizer"),this.synchronizer=this.videoSyncBuilder()):(this.logger.info("use audio master Synchronizer"),this.synchronizer=this.audioSyncBuilder())}updateMedia(e){this.audioFrameQueue.clear(),this.videoFrameQueue.clear(),e.validate()&&(this.logger.info("last media info set"),this.lastLegalMediaInfo=this.currentLegalMediaInfo,this.currentLegalMediaInfo=e),this.playerState.mediaPlayEnded=!1,this.resetBindCanplayEvent(),this.updateSynchronizer()}clear(){this.audioFrameQueue.clear(),this.videoFrameQueue.clear()}mediaPlayEndByAudioBuffer(){this.audioFrameQueue.event.off(Xi.ReadToEmpty,this.mediaEndAudioBufferListener),this.audioFrameQueue.event.on(Xi.ReadToEmpty,this.mediaEndAudioBufferListener)}mediaPlayEndByVideoBuffer(){this.videoFrameQueue.event.off(Di.ReadToEmpty,this.mediaEndVideoBufferListener),this.videoFrameQueue.event.on(Di.ReadToEmpty,this.mediaEndVideoBufferListener)}offBufferSizeChangeListener(){this.audioFrameQueue.event.off(Xi.SizeChange,this.canPlayAudioBufferListener),this.videoFrameQueue.event.off(Di.SizeChange,this.canPlayVideoBufferListener)}offBufferReadToEmptyListener(){this.audioFrameQueue.event.off(Xi.ReadToEmpty,this.mediaEndAudioBufferListener),this.videoFrameQueue.event.off(Di.ReadToEmpty,this.mediaEndVideoBufferListener)}removeAllBufferEventListener(){this.offBufferReadToEmptyListener(),this.offBufferSizeChangeListener()}resetBindCanplayEvent(){this.removeAllBufferEventListener(),this.isNoAudio()?(this.logger.info("media buffer event by video buffer"),this.bindCanPlayEventByVideoBuffer(),this.mediaPlayEndByVideoBuffer()):(this.logger.info("media buffer event by audio buffer"),this.bindCanPlayEventByAudioBuffer(),this.mediaPlayEndByAudioBuffer())}isEmpty(){return this.isNoAudio()?this.videoFrames.empty():this.audioFrames.empty()}};Ln([Ht("imll"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",Boolean)],Un.prototype,"isMediaLegal",null),Ln([Ht("0.cpeab"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"bindCanPlayEventByAudioBuffer",null),Ln([Ht("0.cpevb"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"bindCanPlayEventByVideoBuffer",null),Ln([Ht("updm"),Bn("design:type",Function),Bn("design:paramtypes",[_i]),Bn("design:returntype",void 0)],Un.prototype,"updateMedia",null),Ln([Ht("clr"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"clear",null),Ln([Ht("0.mpeab"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"mediaPlayEndByAudioBuffer",null),Ln([Ht("0.mpevb"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"mediaPlayEndByVideoBuffer",null),Ln([Ht("0.babe"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"resetBindCanplayEvent",null),Ln([Ht("isem"),Bn("design:type",Function),Bn("design:paramtypes",[]),Bn("design:returntype",void 0)],Un.prototype,"isEmpty",null),Un=Ln([it(),Vn(0,mt(tt.PlayerState)),Vn(1,mt(tt.LogMana)),Vn(2,mt(tt.AudioFrameQueue)),Vn(3,mt(tt.VideoFrameQueue)),Vn(4,mt(tt.FormatContext)),Vn(5,mt(tt.AudioMasterFrameSynchronizerBuilder)),Vn(6,mt(tt.VideoMasterFrameSynchronizerBuilder)),Bn("design:paramtypes",[fn,$t,Object,Object,Object,Function,Function])],Un);var Nn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},jn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class Wn{constructor(e,t,i,n){this.playerState=e,this.lm=t,this.mediaPlayer=i,this.media=n,this.shouldReplay=!1,this.e={onVisibilitychange:this.onVisibilitychange.bind(this)},this.logger=this.lm.createLogger("rd.mbgh")}HiddenAndShouldPause(){return"hidden"===document.visibilityState&&(this.logger.info("visibilitychange hidden"),!!this.playerState.isRendering&&(this.logger.info("media should pause"),!0))}VisibleAndShouldReplay(){return"visible"===document.visibilityState&&(!!this.shouldReplay&&(this.logger.info("visibilitychange, media should play"),!0))}isPageHidden(){return"hidden"===document.visibilityState}setReplayWhenPageVisible(){this.shouldReplay=!0}onVisibilitychange(){var e;this.logger.info("visibilitychange "+document.visibilityState+" "+this.shouldReplay),this.VisibleAndShouldReplay()?(null===(e=this.media)||void 0===e||e.clear(),this.mediaPlayer.play(),this.shouldReplay=!1):this.HiddenAndShouldPause()&&(this.mediaPlayer.pause(),this.shouldReplay=!0)}active(){document.removeEventListener("visibilitychange",this.e.onVisibilitychange),document.addEventListener("visibilitychange",this.e.onVisibilitychange)}pause(){document.removeEventListener("visibilitychange",this.e.onVisibilitychange)}destroy(){document.removeEventListener("visibilitychange",this.e.onVisibilitychange)}}Nn([Ht("0.actv"),jn("design:type",Function),jn("design:paramtypes",[]),jn("design:returntype",void 0)],Wn.prototype,"active",null),Nn([Ht("pus"),jn("design:type",Function),jn("design:paramtypes",[]),jn("design:returntype",void 0)],Wn.prototype,"pause",null);var qn,Hn=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Qn=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Gn=function(e,t){return function(i,n){t(i,n,e)}},zn=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};!function(e){e.MediaCanPlay="mediaCanPlay",e.Play="play"}(qn||(qn={}));class Kn{constructor(){this.canvas=document.createElement("canvas"),this.startRender()}startRender(){const e=this.canvas.getContext("2d");this.timer=setInterval((()=>{e&&e.fillRect(0,0,1,1)}),66)}stop(){this.timer&&(clearInterval(this.timer),this.timer=null)}getStream(){return this.canvas.captureStream()}}let Yn=class{get userPlayed(){return this.playerState.userPlayed}get event(){return this._event}get playable(){return this.avPlayer.getPlayable()}get rendering(){return this._rendering}get canvas(){return this.uiContainer.canvas}get divContainer(){return this.uiContainer.wrapper}constructor(e,t,i,n,r,o){this.media=e,this.audioClock=t,this.playerState=i,this.lm=n,this.uiContainer=r,this.avPlayer=o,this._event=new rt,this.videoEl=null,this.isFullScreenVideoEl=!1,this.detectAutoPlayTimer=null,this._rendering=!1,this.canplay=!1,this.mediaChanging=!1,this.fullScreenPrefixes=["","moz","webkit","ms"],this.playingEmptyCanvasStream=!1,this.emptyCanvasStream=null,this.videoPauseTimeStamp=null,this.outScreenTaskTimer=null,this.e={videoOnPlay:this.videoOnPlay.bind(this),videoOnPause:this.videoOnPause.bind(this),videoOnVolumeChange:this.videoOnVolumeChange.bind(this)},this.onEnterFullScreen=()=>{this.stopOutScreenTaskTimer()},this.onOutFullScreen=()=>{const e=performance.now(),t=()=>{this.isFullScreenVideoEl&&this.divContainer&&this.videoEl&&(this.divContainer.contains(this.videoEl)&&(this.videoEl.style.display="none"),this.removeVideo(),this.isFullScreenVideoEl=!1,this.uiContainer.showCanvas(),this.isIOSMobile()&&this.videoPauseTimeStamp&&e-this.videoPauseTimeStamp<100&&this.play()),this.offFullScreenEvent()};this.isIOSMobile()?this.outScreenTaskTimer=setTimeout(t,100):t()},this.onEnterPictureInPicture=()=>{this.logger.info("picture in picture enter."),this.isIOSMobile()&&this.stopOutScreenTaskTimer()},this.onLeavePictureInPicture=()=>{this.logger.info("picture in picture out."),this.isIOSMobile()&&(this.videoPauseTimeStamp=performance.now(),this.onOutFullScreen())},this.fullscreenchangeListener=()=>{!this.windowIsFullScreen()&&this.videoEl?this.onOutFullScreen():this.windowIsFullScreen()&&this.videoEl&&this.onEnterFullScreen()},this.logger=this.lm.createLogger("rd.mdp"),this.media.isMediaLegal()&&this.updateMediaInfo(this.media.partialInfo),this.bindMediaEvent(),this.windowBackgroundHandler=new Wn(this.playerState,this.lm,this,this.media),this.windowBackgroundHandler.active()}mount(){this.logger.info("media player mounted (not mse)"),this.windowBackgroundHandler.active(),this.uiContainer.isUserVideoElement()?this.initVideoElement(this.uiContainer.videoElement):this.uiContainer.showCanvas()}unmount(){this.logger.info("media player unmount (not mse)"),this.windowBackgroundHandler.pause(),this.uiContainer.isUserVideoElement()?this.removeVideo():this.uiContainer.hideCanvas()}bindMediaEvent(){this.media.event.on(In.MEDIA_END,(()=>{this.onMediaPlayEnd()}))}isCanplay(){return this.canplay&&this.media.isMediaLegal()&&null!==this.avPlayer.getStream()}resume(){this.avPlayer.resumeAudio()}videoOnPlay(){if(this.checkAndRemoveEmptyCanvasStream(),this.avPlayer.resumeAudio(),this.playerState.userPlayed=!0,this.isCanplay()){if(this.logger.info("start render"),this.setRendering(!0),this.windowBackgroundHandler.isPageHidden())return this.windowBackgroundHandler.setReplayWhenPageVisible(),void this.pause();this.startMediaRender(),this._event.emit(qn.Play)}else this.logger.info("media cannot play")}videoOnPause(){this.playerState.userPlayed=!1,this.videoPauseTimeStamp=performance.now(),this.pauseMediaRender(),this.setRendering(!1)}videoOnVolumeChange(){this.videoEl&&this.setMuted(this.videoEl.muted),this.videoEl&&this.setVolume(100*this.videoEl.volume)}updateConfigFromVideoEl(){if(!this.videoEl)throw new Vt("not video element set!");this.playerState.muted=this.videoEl.muted,this.playerState.volume=100*this.videoEl.volume,this.logger.info("video config set muted "+this.playerState.muted+" volume "+this.playerState.volume)}bindVideoElementEvents(){this.videoEl&&this.videoEl.addEventListener("play",this.e.videoOnPlay),this.videoEl&&this.videoEl.addEventListener("pause",this.e.videoOnPause),this.videoEl&&this.videoEl.addEventListener("volumechange",this.e.videoOnVolumeChange)}unbindVideoElementEvents(){this.videoEl&&this.videoEl.removeEventListener("play",this.e.videoOnPlay),this.videoEl&&this.videoEl.removeEventListener("pause",this.e.videoOnPause),this.videoEl&&this.videoEl.removeEventListener("volumechange",this.e.videoOnVolumeChange)}initVideoElement(e){if(this.videoEl)throw new Vt("cannot repeatly set video element");this.videoEl=e,this.videoEl&&this.updateConfigFromVideoEl(),this.bindVideoElementEvents(),this.setVideoEmptyCanvas(this.videoEl)}removeVideo(){this.videoEl&&(this.unbindVideoElementEvents(),this.stopEmptyCanvasStream(),this.videoEl.srcObject=null,this.videoEl=null)}endVideo(){this.videoEl&&(this.videoEl.srcObject=null,this.videoEl.poster="",this.videoEl.pause()),this.canplay=!1,this.pauseMediaRender()}resetAudioPlayer(e){this.avPlayer.initAudio(e)}resetVideoPlayer(e){this.avPlayer.initVideo(e)}updateVideoSrcObject(e){return zn(this,void 0,void 0,(function*(){if(!this.videoEl)throw new Vt("video not bind");if(null===this.videoEl.srcObject&&(this.logger.info("set video stream"),this.videoEl.srcObject=e),this.logger.info("update video src "+this.userPlayed+" "+this.videoEl.autoplay+" "+this.videoEl.paused),(this.videoEl.autoplay||this.userPlayed)&&this.videoEl.paused){this.logger.info("video auto play"),clearTimeout(this.detectAutoPlayTimer);const e=()=>{var e;if(clearTimeout(this.detectAutoPlayTimer),null===(e=this.videoEl)||void 0===e?void 0:e.paused)throw this.logger.error("video element auto play failed."),new jt("Auto play failed. Please call play() method after click.")};this.detectAutoPlayTimer=setTimeout((()=>{e()}),3e3),this.videoEl.play().then((()=>{this.videoEl&&!this.videoEl.paused&&clearTimeout(this.detectAutoPlayTimer)})).catch((t=>{e()}))}}))}resetVideoElementStream(){this.stopEmptyCanvasStream(),this.videoEl&&this.updateConfigFromVideoEl(),this.media.lastMediaInfo.validate()&&this.media.partialInfo.noVideo!==this.media.lastMediaInfo.noVideo&&this.videoEl&&(this.videoEl.srcObject=null),this.avPlayer.resetStream(),this.videoEl&&this.updateVideoSrcObject(this.avPlayer.getStream())}updateMediaInfo(e){this.canplay=!1,this.media.isMediaLegal()&&(this.logger.info("media legal and reset media player"),this.audioClock.reset(),this.resetAudioPlayer(e),this.resetVideoPlayer(e),this.resetVideoElementStream(),this.restartPlay(),this.canplay=!0,this._event.emit(qn.MediaCanPlay),this.playerState.mediaOpened=!0)}restartPlay(){this.userPlayed&&(this.logger.info("restart play"),this.setMuted(this.playerState.muted),this.setVolume(this.playerState.volume),this.startMediaRender())}onMediaPlayEnd(){this.playerState.mediaPlayEnded||(this.playerState.mediaPlayEnded=!0),this.videoEl&&!this.videoEl.paused&&this.videoEl.pause()}isWaitingNewMedia(){return this.logger.info(`isWaitingNewMedia: ${!this.media.isMediaLegal()} ${this.playerState.waiting}  ${this.mediaChanging}`),!this.media.isMediaLegal()||this.playerState.waiting||this.mediaChanging}isPlayedButVideoPaused(){return this.videoEl&&this.videoEl.paused&&this.userPlayed}isVideoNoSource(){return this.videoEl&&null===this.videoEl.srcObject}launchAudioVideoPlayers(){this.logger.info("media play."),this._rendering=!0,this.avPlayer.play()}pauseAudioVideoPlayers(){this._rendering=!1,this.avPlayer.pause()}startMediaRender(){if(this.isPlayedButVideoPaused())return this.logger.info("set play false"),void this.setRendering(!1);this.isVideoNoSource()?this.logger.info("video el no source"):this.isWaitingNewMedia()?this.logger.info("waiting new media"):this.launchAudioVideoPlayers()}pauseMediaRender(){this.logger.info("media pause."),this.pauseAudioVideoPlayers()}setRendering(e){e?this.playerState.isRendering=!0:this.playerState.pausedRendering=!0}play(){this.videoEl&&this.videoEl.paused?this.videoEl.play().catch((e=>{this.logger.info(e)})):this.videoOnPlay()}pause(){this.videoEl&&!this.videoEl.paused?this.videoEl.pause():this.videoOnPause()}setVolume(e){this.avPlayer.setVolume(e)}setMuted(e){this.avPlayer.setMuted(e)}onMediaChanging(){this.mediaChanging=!0}onMediaChangingEnd(){this.mediaChanging=!1}requestVideoFullScreen(e){e&&!this.windowIsFullScreen()&&(this.bindFullScreenEvent(e),e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitSupportsFullscreen&&e.webkitEnterFullscreen&&e.webkitEnterFullscreen())}isIOSMobile(){return vi()}exitFullScreen(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}windowIsFullScreen(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitCurrentFullScreenElement||this.videoEl&&this.videoEl.webkitDisplayingFullscreen}stopOutScreenTaskTimer(){this.outScreenTaskTimer&&(clearTimeout(this.outScreenTaskTimer),this.outScreenTaskTimer=null)}bindFullScreenEvent(e){this.fullScreenPrefixes.forEach((e=>{document.addEventListener(e+"fullscreenchange",this.fullscreenchangeListener)})),e&&(e.addEventListener("webkitendfullscreen",this.onOutFullScreen),e.addEventListener("webkitenterfullscreen",this.onEnterFullScreen),e.addEventListener("enterpictureinpicture",this.onEnterPictureInPicture),e.addEventListener("leavepictureinpicture",this.onLeavePictureInPicture))}offFullScreenEvent(){this.fullScreenPrefixes.forEach((e=>{document.removeEventListener(e+"fullscreenchange",this.fullscreenchangeListener)})),this.videoEl&&(this.videoEl.removeEventListener("webkitendfullscreen",this.onOutFullScreen),this.videoEl.removeEventListener("webkitenterfullscreen",this.onEnterFullScreen),this.videoEl.removeEventListener("enterpictureinpicture",this.onEnterPictureInPicture),this.videoEl.removeEventListener("leavepictureinpicture",this.onLeavePictureInPicture))}useContainerDidNotFullScreen(){return!this.videoEl&&!!this.divContainer&&!this.isFullScreenVideoEl}useVideoElDidNotFullScreen(){return!!this.videoEl&&!this.isFullScreenVideoEl}replaceContainerInnerToScreenVideo(){const e=this.uiContainer.videoElement;return e.style.display="block",e.volume=this.playerState.volume/100,e.muted=this.playerState.muted,this.initVideoElement(e),this.isFullScreenVideoEl=!0,this.userPlayed&&e.play(),this.uiContainer.hideCanvas(),e}waitVideoPlaying(e){let t=e.currentTime;return new Promise((i=>{const n=()=>{Math.abs(e.currentTime-t)>.1&&(e.removeEventListener("timeupdate",n),i())};e.addEventListener("timeupdate",n)}))}stopEmptyCanvasStream(){var e;return!!this.playingEmptyCanvasStream&&(null===(e=this.emptyCanvasStream)||void 0===e||e.stop(),this.emptyCanvasStream=null,this.playingEmptyCanvasStream=!1,this.videoEl&&(this.videoEl.srcObject=null),!0)}checkAndRemoveEmptyCanvasStream(){this.stopEmptyCanvasStream()&&this.resetVideoElementStream()}setVideoEmptyCanvas(e){this.emptyCanvasStream=new Kn,this.playingEmptyCanvasStream=!0,e.srcObject=this.emptyCanvasStream.getStream()}requestContainerFullScreen(){const e=this.replaceContainerInnerToScreenVideo(),t=()=>{try{this.requestVideoFullScreen(e)}catch(t){}};this.isIOSMobile()?this.userPlayed?(this.resetVideoElementStream(),this.waitVideoPlaying(e).then((()=>{t()}))):(this.setVideoEmptyCanvas(e),setTimeout((()=>{t(),setTimeout((()=>{this.checkAndRemoveEmptyCanvasStream()}),500)}),500)):(this.resetVideoElementStream(),t())}fullScreen(){this.windowIsFullScreen()||(this.useContainerDidNotFullScreen()?this.requestContainerFullScreen():this.useVideoElDidNotFullScreen()&&this.requestVideoFullScreen(this.videoEl))}destroy(){this.videoEl&&(this.videoEl.srcObject=null),this.videoEl&&(this.videoEl.poster=""),this.uiContainer.destroy(),this.avPlayer.destroy(),this.canplay=!1,this.media.updateMedia(new _i),this.windowBackgroundHandler.destroy(),this.removeVideo(),this.offFullScreenEvent()}};var $n,Xn,Zn;Hn([Ht("0.bmde"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"bindMediaEvent",null),Hn([Ht("rsum"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"resume",null),Hn([Ht("0.vopl"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"videoOnPlay",null),Hn([Ht("0.vopu"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"videoOnPause",null),Hn([Ht("0.rcfve"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"updateConfigFromVideoEl",null),Hn([Ht("svo"),Qn("design:type",Function),Qn("design:paramtypes",[HTMLVideoElement]),Qn("design:returntype",void 0)],Yn.prototype,"initVideoElement",null),Hn([Ht("0.rmvo"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"removeVideo",null),Hn([Ht("edv"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"endVideo",null),Hn([Ht("0.rsaup"),Qn("design:type",Function),Qn("design:paramtypes",[_i]),Qn("design:returntype",void 0)],Yn.prototype,"resetAudioPlayer",null),Hn([Ht("0.rsvdp"),Qn("design:type",Function),Qn("design:paramtypes",[_i]),Qn("design:returntype",void 0)],Yn.prototype,"resetVideoPlayer",null),Hn([Ht("0.udvso"),Qn("design:type",Function),Qn("design:paramtypes",[MediaStream]),Qn("design:returntype",Promise)],Yn.prototype,"updateVideoSrcObject",null),Hn([Ht("0.rstve"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"resetVideoElementStream",null),Hn([Ht("rst"),Qn("design:type",Function),Qn("design:paramtypes",[_i]),Qn("design:returntype",void 0)],Yn.prototype,"updateMediaInfo",null),Hn([Ht("0.rstp"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"restartPlay",null),Hn([Ht("0.ompe"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"onMediaPlayEnd",null),Hn([Ht("mdsr"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"startMediaRender",null),Hn([Ht("mdpr"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"pauseMediaRender",null),Hn([Ht("pl"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"play",null),Hn([Ht("pau"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"pause",null),Hn([Ht("omci"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"onMediaChanging",null),Hn([Ht("omce"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"onMediaChangingEnd",null),Hn([Ht("fuscn"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"fullScreen",null),Hn([Ht("dsty"),Qn("design:type",Function),Qn("design:paramtypes",[]),Qn("design:returntype",void 0)],Yn.prototype,"destroy",null),Yn=Hn([it(),Gn(0,mt(tt.RenderableMedia)),Gn(1,mt(tt.AudioClock)),Gn(2,mt(tt.PlayerState)),Gn(3,mt(tt.LogMana)),Gn(4,mt(tt.UIContainer)),Gn(5,mt(tt.AVPlayerOperator)),Qn("design:paramtypes",[Un,Object,fn,$t,Object,Object])],Yn),function(e){e.DECODER="decoder",e.LOADER="loader",e.RENDER="render",e.EVENT_EMITTER="playerEventEmitter",e.DATA_MANAGER="dataManager",e.LOGGER_MANAGER="logger",e.ERROR_HANDLER="errorHandler",e.PLAYER_CONTROLLER="playerController",e.QUALITY_STATISTIC="qualityStatistic",e.WASM_WORKER="wasmWorker",e.WASM_FACTORY="wasmFactory"}($n||($n={}));class Jn{constructor(e){this.eventName=e,this.eventEmitter=new rt}on(e){this.eventEmitter.on(this.eventName,e)}off(e){e?this.eventEmitter.off(this.eventName,e):this.eventEmitter.removeAllListeners()}once(e){this.eventEmitter.once(this.eventName,e)}emit(...e){this.eventEmitter.emit(this.eventName,...e)}}!function(e){e.CALL_VIDEO_DECODER="callVideoDecoder",e.CALL_AUDIO_DECODER="callAudioDecoder",e.CALL_SEI_PARSER="callSeiParser"}(Xn||(Xn={})),function(e){e.WASM_READY="wasmReady",e.YUV_DECODED="yuvDecoded",e.PCM_DECODED="pcmDecoded",e.SEI_PARSED="seiParsed",e.SAMPLE_RATE_UPDATE="sampleRateUpdate"}(Zn||(Zn={}));var er=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},tr=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class ir{constructor(e,t,i,n,r){this.sendMsg2Worker=e,this.messageEmitter=t,this.frameQueue=i,this.lm=n,this.formatContext=r,this.destroyEmitter=new Jn("destroy"),this.configured=!1,this.logger=this.lm.createLogger("wm.fad"),this.e={onReceiveWorkerMessage:this.onReceiveWorkerMessage.bind(this)},this.destroyEmitter.once((()=>this.messageEmitter.off(this.e.onReceiveWorkerMessage))),this.init()}onError(e){}onReceiveWorkerMessage(e){if(e.type!=Zn.PCM_DECODED){if(e.type==Zn.SAMPLE_RATE_UPDATE){const{sampleRate:t}=e.data;t&&this.formatContext.sampleRate!==t&&(this.formatContext.sampleRate=t)}}else this.addPCM2FrameQueue(e.data.payload,e.data.pts,e.data.serial)}addPCM2FrameQueue(e,t,i){this.confirmPCMFrame(e,t)&&this.frameQueue.push(this.createPCMFrame(e,t,i))}createPCMFrame(e,t,i){return{payload:e,pts:t,serial:i}}init(){this.messageEmitter.off(this.e.onReceiveWorkerMessage),this.messageEmitter.on(this.e.onReceiveWorkerMessage),this.configured=!1}confirmPCMFrame(e,t){return void 0!==e&&void 0!==t||(this.logger.error("audio frame data or pts undefined"),!1)}destroy(){this.destroyEmitter.emit()}reset(){const e={target:$n.WASM_WORKER,type:Xn.CALL_AUDIO_DECODER,data:{funcName:"reset",args:[]}};this.sendMsg2Worker(e),this.init()}decode(e){if(!this.configured)return void this.logger.throttleInfo("cannot decode before configure (audio wasm)");const t={target:$n.WASM_WORKER,type:Xn.CALL_AUDIO_DECODER,data:{funcName:"decode",args:[e.payload,e.pts,e.serial]},transferableObjects:[e.payload.buffer]};this.sendMsg2Worker(t)}configure(e,t){const i={target:$n.WASM_WORKER,type:Xn.CALL_AUDIO_DECODER,data:{funcName:"configure",args:[e,t]}};this.sendMsg2Worker(i),this.configured=!0}flush(){const e={target:$n.WASM_WORKER,type:Xn.CALL_AUDIO_DECODER,data:{funcName:"flush",args:[]}};this.sendMsg2Worker(e)}}er([Ht("r"),tr("design:type",Function),tr("design:paramtypes",[]),tr("design:returntype",void 0)],ir.prototype,"reset",null),er([Ht("cf"),tr("design:type",Function),tr("design:paramtypes",[Number,Uint8Array]),tr("design:returntype",void 0)],ir.prototype,"configure",null),er([Ht("fus"),tr("design:type",Function),tr("design:paramtypes",[]),tr("design:returntype",void 0)],ir.prototype,"flush",null);var nr,rr=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},or=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class sr{constructor(e,t,i,n){this.sendMsg2Worker=e,this.messageEmitter=t,this.frameQueue=i,this.lm=n,this.destroyEmitter=new Jn("destroy"),this.firstIFrameReceived=!1,this.configured=!1,this.logger=this.lm.createLogger("wm.fvd"),this.e={onReceiveWorkerMessage:this.onReceiveWorkerMessage.bind(this)},this.destroyEmitter.once((()=>this.messageEmitter.off(this.e.onReceiveWorkerMessage))),this.init()}onError(e){}destroy(){this.destroyEmitter.emit()}onReceiveWorkerMessage(e){e.type===Zn.YUV_DECODED&&this.addYUV2FrameQueue(e.data.payload,e.data.pts,e.data.serial)}init(){this.messageEmitter.off(this.e.onReceiveWorkerMessage),this.messageEmitter.on(this.e.onReceiveWorkerMessage),this.firstIFrameReceived=!1,this.configured=!1}confirmYUVFrame(e,t){return void 0!==e&&void 0!==t||(this.logger.error("video frame data or pts undefined"),!1)}createVideoFrame(e,t,i){return{payload:e,pts:t,serial:i}}addYUV2FrameQueue(e,t,i){this.confirmYUVFrame(e,t)&&this.frameQueue.push(this.createVideoFrame(e,t,i))}reset(){const e={target:$n.WASM_WORKER,type:Xn.CALL_VIDEO_DECODER,data:{funcName:"reset",args:[]}};this.sendMsg2Worker(e),this.init()}configure(e,t){const i={target:$n.WASM_WORKER,type:Xn.CALL_VIDEO_DECODER,data:{funcName:"configure",args:[e,t]}};this.sendMsg2Worker(i),this.configured=!0}decode(e){if(!this.configured)return void this.logger.throttleInfo("cannot decode before configure (video wasm)");if(!this.firstIFrameReceived&&!e.isKeyFrame)return;this.firstIFrameReceived||(this.firstIFrameReceived=!0);const t={target:$n.WASM_WORKER,type:Xn.CALL_VIDEO_DECODER,data:{funcName:"decode",args:[e.payload,e.pts,e.dts,e.serial]},transferableObjects:[e.payload.buffer]};this.sendMsg2Worker(t)}flush(){const e={target:$n.WASM_WORKER,type:Xn.CALL_AUDIO_DECODER,data:{funcName:"flush",args:[]}};this.sendMsg2Worker(e)}}rr([Ht("r"),or("design:type",Function),or("design:paramtypes",[]),or("design:returntype",void 0)],sr.prototype,"reset",null),rr([Ht("cf"),or("design:type",Function),or("design:paramtypes",[Number,Uint8Array]),or("design:returntype",void 0)],sr.prototype,"configure",null),rr([Ht("fus"),or("design:type",Function),or("design:paramtypes",[]),or("design:returntype",void 0)],sr.prototype,"flush",null),function(e){e[e.NALU_TYPE_SEI_AVC=6]="NALU_TYPE_SEI_AVC",e[e.NALU_TYPE_SEI_HEVC=39]="NALU_TYPE_SEI_HEVC"}(nr||(nr={}));var ar=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},dr=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class lr{constructor(e,t,i){this.sendMsg2Worker=e,this.lm=t,this.messageEmiter=i,this.parseOptions={},this.seq=0,this.seiParsedCallbackMap={},this.logger=this.lm.createLogger("wm.sei"),this.reset(),this.bindWorkerMessage()}bindWorkerMessage(){this.messageEmiter.on((e=>{if(e.type!==Zn.SEI_PARSED)return;const{seiData:t,from:i}=e.data;i&&this.seiParsedCallbackMap[i]&&this.seiParsedCallbackMap[i](t)}))}configSeiOptions(e){if(void 0!==e.emulationPreventionByte||void 0!==e.unregisterSeiFilter){const t={target:$n.WASM_WORKER,type:Xn.CALL_SEI_PARSER,data:{funcName:"setSeiConfig",args:[e.unregisterSeiFilter||"",!!e.emulationPreventionByte]}};this.sendMsg2Worker(t)}}isDiffOptions(e){for(const t in e)if(e[t]!==this.parseOptions[t])return!0;return!1}setOptions(e){this.isDiffOptions(e)&&(this.logger.info(`set options ${JSON.stringify(e)}, ${JSON.stringify(this.parseOptions)}`),this.parseOptions=Object.assign(Object.assign({},this.parseOptions),e),this.configSeiOptions(e))}reset(){this.parseOptions={};const e={target:$n.WASM_WORKER,type:Xn.CALL_SEI_PARSER,data:{funcName:"reset",args:[]}};this.sendMsg2Worker(e)}isSei(e){if(this.parseOptions.isH265){return(126&e[0])>>1==nr.NALU_TYPE_SEI_HEVC}return(31&e[0])==nr.NALU_TYPE_SEI_AVC}parseSei(e){return new Promise((t=>{++this.seq;const i=!!this.parseOptions.isH265,n=`parse-${this.seq}`,r={target:$n.WASM_WORKER,type:Xn.CALL_SEI_PARSER,data:{funcName:"parse",args:[e,i,n]}};this.seiParsedCallbackMap[n]=t,this.sendMsg2Worker(r)}))}}ar([Ht("r"),dr("design:type",Function),dr("design:paramtypes",[]),dr("design:returntype",void 0)],lr.prototype,"reset",null);var ur=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},cr=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},hr=function(e,t){return function(i,n){t(i,n,e)}},pr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};let fr=class{constructor(e,t,i,n){this.lm=e,this.formatContext=t,this.vidFrameQueue=i,this.audFrameQueue=n,this.sendMsg2Worker=e=>{this.postMessage(e)},this.messageEmitter=new Jn("message"),this.videoDecoder=null,this.audioDecoder=null,this.seiParser=null,this.workerReady=!1,this.logger=this.lm.createLogger("wm.fc")}createSeiParser(){return new Promise(((e,t)=>pr(this,void 0,void 0,(function*(){if(this.seiParser)return this.seiParser.reset(),void e(this.seiParser);const t=()=>{this.logger.info("construct sei parser (wasm wrapper)"),this.seiParser=new lr(this.sendMsg2Worker,this.lm,this.messageEmitter),e(this.seiParser)};this.workerReady||(yield this.waitWorkerReady()),t()}))))}postMessage(e){}onmessage(e){this.messageEmitter.emit(e)}terminate(){this.vidFrameQueue.clear(),this.audFrameQueue.clear(),this.messageEmitter.off()}msgIsWorkerReady(e){return e.type===Zn.WASM_READY}waitWorkerReady(){return new Promise((e=>{const t=i=>{if(this.msgIsWorkerReady(i))return this.workerReady=!0,this.messageEmitter.off(t),void e()};this.messageEmitter.on(t)}))}createVideoDecoder(){return new Promise(((e,t)=>pr(this,void 0,void 0,(function*(){if(this.videoDecoder)return this.logger.info("reset wasm video decoder (wasm wrapper)"),this.videoDecoder.reset(),void e(this.videoDecoder);const t=()=>{this.logger.info("construct wasm video decoder (wasm wrapper)"),this.videoDecoder=new sr(this.sendMsg2Worker,this.messageEmitter,this.vidFrameQueue,this.lm),this.videoDecoder.reset(),e(this.videoDecoder)};this.workerReady||(yield this.waitWorkerReady()),t()}))))}createAudioDecoder(){return new Promise(((e,t)=>pr(this,void 0,void 0,(function*(){if(this.audioDecoder)return this.logger.info("reset wasm audio decoder (wasm wrapper)"),this.audioDecoder.reset(),void e(this.audioDecoder);const t=()=>{this.logger.info("construct wasm audio decoder (wasm wrapper)"),this.audioDecoder=new ir(this.sendMsg2Worker,this.messageEmitter,this.audFrameQueue,this.lm,this.formatContext),this.audioDecoder.reset(),e(this.audioDecoder)};this.workerReady||(yield this.waitWorkerReady()),t()}))))}};fr=ur([it(),hr(0,mt(tt.LogMana)),hr(1,mt(tt.FormatContext)),hr(2,mt(tt.VideoFrameQueue)),hr(3,mt(tt.AudioFrameQueue)),cr("design:paramtypes",[$t,Object,Object,Object])],fr);var mr=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};let gr=class{getNalu(e,t,i){const n=[];let r=0;for(;r+3<e.length;){const o=(e[r+0]<<24)+(e[r+1]<<16)+(e[r+2]<<8)+e[r+3];if(o<=0)break;if(r+=4,t){let n=0;if(n=i?(126&e[r])>>1:31&e[r],n!==t){r+=o;continue}}const s=e.subarray(r,r+o);n.push({payloadView:s}),r+=o}return e.length,n}};gr=mr([it()],gr);var yr=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},vr=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},br=function(e,t){return function(i,n){t(i,n,e)}};let _r=class{constructor(e,t,i,n){this.lm=e,this.playerEventEmitter=t,this.playerState=i,this.globalEvent=n,this.seiCache=[],this.logger=this.lm.createLogger("rd.sei"),this.globalEvent.event.on(di.CURRENT_TIME_CHANGE,this.active.bind(this))}addSei(e,t){t<=0?this.playerEventEmitter.emit(li.RECV_SEI,e):this.seiCache.push({sei:e,pts:t})}poll(){this.stopPoll(),this.pollTimer=setInterval(this.active.bind(this),50)}stopPoll(){this.pollTimer&&clearInterval(this.pollTimer)}active(){let e=0;for(e=this.playerState.currentTime+this.playerState.currentTimestampOffset;0!=this.seiCache.length&&this.seiCache[0].pts<e-200;)this.seiCache.shift();for(;0!=this.seiCache.length&&e-200<=this.seiCache[0].pts&&this.seiCache[0].pts<=e+50;){const{sei:e,pts:t}=this.seiCache.shift();this.playerEventEmitter.emit(li.RECV_SEI,e)}}};_r=yr([it(),br(0,mt(tt.LogMana)),br(1,mt(tt.PlayerEventEmitter)),br(2,mt(tt.PlayerState)),br(3,mt(tt.GlobalEvent)),vr("design:paramtypes",[$t,an,Object,Object])],_r);var Cr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};class Er{constructor(){this._queue=[],this._maxConcurrency=1}acquire(){return Cr(this,void 0,void 0,(function*(){this._maxConcurrency<=0&&(yield new Promise((e=>this._queue.push(e)))),this._maxConcurrency--}))}release(){var e;this._maxConcurrency++,null===(e=this._queue.shift())||void 0===e||e()}}var Sr=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};class wr{constructor(){this.queue=[],this.mutex=new Er}pushTask(e,t,i,n,r){let o={task:e};t&&(o=Object.assign(Object.assign({},o),{args:t})),i&&(o=Object.assign(Object.assign({},o),{successCallback:i})),n&&(o=Object.assign(Object.assign({},o),{errorCallback:n})),r&&(o=Object.assign(Object.assign({},o),{completeCallback:r})),this.queue.push(o)}runTaskQueueItem(e){return Sr(this,void 0,void 0,(function*(){let t=null;try{e&&e.args?t=e.task(...e.args):e&&(t=e.task()),t instanceof Promise&&(t=yield t),e.successCallback&&e.successCallback(t)}catch(i){if(!e.errorCallback)throw i;e.errorCallback(i)}finally{e.completeCallback&&e.completeCallback()}}))}shiftTaskAndRun(){return Sr(this,void 0,void 0,(function*(){yield this.mutex.acquire();const e=this.queue.shift();e&&(yield this.runTaskQueueItem(e)),this.mutex.release()}))}runATask(){return Sr(this,void 0,void 0,(function*(){this.queue.length<=0||(yield this.shiftTaskAndRun())}))}runAllTask(){return Sr(this,void 0,void 0,(function*(){for(;this.queue.length>0;)yield this.shiftTaskAndRun()}))}clearWithoutRunning(){return Sr(this,void 0,void 0,(function*(){yield this.mutex.acquire(),this.queue=[],this.mutex.release()}))}size(){return this.queue.length}}var Rr=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Dr=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Ar=function(e,t){return function(i,n){t(i,n,e)}};let Pr=class{constructor(e,t,i,n,r){this.wasmFactory=e,this.format=t,this.naluParser=i,this.seiEmitter=n,this.lm=r,this.seiParserTaskQueue=new wr,this.logger=r.createLogger("d.sr"),this.wasmFactory.createSeiParser().then((e=>{this.logger.info("created sei parser"),this.seiParser=e,this.seiParserTaskQueue.runAllTask()}))}addSeiParserTask(e){this.seiParser?e():this.seiParserTaskQueue.pushTask(e)}updateSeiConfig(e){this.addSeiParserTask((()=>{var t;this.logger.info("update sei config "+JSON.stringify(e)),null===(t=this.seiParser)||void 0===t||t.setOptions({unregisterSeiFilter:e.unregisterSEIFilter,emulationPreventionByte:e.emulationPreventionByte})}))}receive(e,t){if(!this.seiParser||!this.format.isH265()&&!this.format.isH264())return;const i=this.format.isH265();let n;n=i?this.naluParser.getNalu(e,nr.NALU_TYPE_SEI_HEVC,i):this.naluParser.getNalu(e,nr.NALU_TYPE_SEI_AVC,i),this.seiParser.setOptions({isH265:i});for(const r of n)this.seiParser.isSei(r.payloadView)&&this.seiParser.parseSei(r.payloadView).then((e=>{e.payload.length<=0||this.seiEmitter.addSei(e.payload,t)}))}};Pr=Rr([it(),Ar(0,mt(tt.WasmFactory)),Ar(1,mt(tt.FormatContext)),Ar(2,mt(tt.NaluParser)),Ar(3,mt(tt.SeiEmitter)),Ar(4,mt(tt.LogMana)),Dr("design:paramtypes",[Object,Object,Object,_r,$t])],Pr);const Fr=8,Tr=9;class xr{constructor(e){this.tagQueue={audio:[],video:[]},this.input=this.inputFlv(),this.receive=this.createDemuxFunc(),this.outputAudioTag=e.outputAudio,this.outputVideoTag=e.outputVideo,e.outputFormatInfo&&(this.outputFormatInfo=e.outputFormatInfo)}*inputFlv(){const e=yield 9;70===e[0]&&76===e[1]&&86===e[2]&&this.outputFormatInfo&&this.outputFormatInfo({isFlv:!0});const t=new ArrayBuffer(4),i=new Uint8Array(t),n=new Uint32Array(t);for(;;){i[3]=0;const e=yield 15,t=e[4];i[0]=e[7],i[1]=e[6],i[2]=e[5];const r=n[0];i[0]=e[10],i[1]=e[9],i[2]=e[8];let o=n[0];16777215===o&&(i[3]=e[11],o=n[0]);const s=yield r;switch(t){case Fr:s.byteLength>0&&this.tagQueue.audio.push({payload:s,ts:o});break;case Tr:if(s.byteLength>0){const e=s[0]>>4==1;s.byteLength>0&&this.tagQueue.video.push({payload:s,isIFrame:e,ts:o})}}}}clearTagQueue(){const e=this.tagQueue.audio,t=this.tagQueue.video;for(;e.length>0;){const t=e.shift();t&&this.outputAudioTag(t.payload,t.ts)}for(;t.length>0;){const e=t.shift();e&&this.outputVideoTag(e.payload,e.isIFrame,e.ts)}}createDemuxFunc(){let e=this.input.next(),t=null;return i=>{let n=new Uint8Array(i);if(t){let e=new Uint8Array(t.length+n.length);e.set(t),e.set(n,t.length),n=e,t=null}for(;n.length>=e.value;){let t=n.slice(e.value);e=this.input.next(n.slice(0,e.value)),n=t,this.clearTagQueue()}n.length>0&&(t=n)}}receive(e){}close(){setTimeout((()=>{this.input&&this.input.return(null),this.tagQueue={audio:[],video:[]}}))}}class kr{constructor(e){this._message=e}get name(){return"RuntimeException"}get message(){return this._message}toString(){return this.name+": "+this.message}}class Mr extends kr{constructor(e){super(e)}get name(){return"IllegalStateException"}}class Or extends kr{constructor(e){super(e)}get name(){return"InvalidArgumentException"}}const Ir=class{constructor(e){this.TAG="ExpGolomb",this._buffer=e,this._buffer_index=0,this._total_bytes=e.byteLength,this._total_bits=8*e.byteLength,this._current_word=0,this._current_word_bits_left=0}destroy(){this._buffer=null}_fillCurrentWord(){let e=this._total_bytes-this._buffer_index;if(e<=0)throw new Mr("ExpGolomb: _fillCurrentWord() but no bytes available");let t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._buffer_index,this._buffer_index+t)),this._current_word=new DataView(i.buffer).getUint32(0,!1),this._buffer_index+=t,this._current_word_bits_left=8*t}readBits(e){if(e>32)throw new Or("ExpGolomb: readBits() bits exceeded max 32bits!");if(e<=this._current_word_bits_left){let t=this._current_word>>>32-e;return this._current_word<<=e,this._current_word_bits_left-=e,t}let t=this._current_word_bits_left?this._current_word:0;t>>>=32-this._current_word_bits_left;let i=e-this._current_word_bits_left;this._fillCurrentWord();let n=Math.min(i,this._current_word_bits_left),r=this._current_word>>>32-n;return this._current_word<<=n,this._current_word_bits_left-=n,t=t<<n|r,t}readBool(){return 1===this.readBits(1)}readByte(){return this.readBits(8)}_skipLeadingZero(){let e;for(e=0;e<this._current_word_bits_left;e++)if(0!=(this._current_word&2147483648>>>e))return this._current_word<<=e,this._current_word_bits_left-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}readUEG(){let e=this._skipLeadingZero();return this.readBits(e+1)-1}readSEG(){let e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}};class Lr{static _ebsp2rbsp(e){let t=e,i=t.byteLength,n=new Uint8Array(i),r=0;for(let o=0;o<i;o++)o>=2&&3===t[o]&&0===t[o-1]&&0===t[o-2]||(n[r]=t[o],r++);return new Uint8Array(n.buffer,0,r)}static parseSPS(e){let t=Lr._ebsp2rbsp(e),i=new Ir(t);i.readByte();let n=i.readByte();i.readByte();let r=i.readByte();i.readUEG();let o=Lr.getProfileString(n),s=Lr.getLevelString(r),a=1,d=420,l=[0,420,422,444],u=8;if((100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n||138===n||144===n)&&(a=i.readUEG(),3===a&&i.readBits(1),a<=3&&(d=l[a]),u=i.readUEG()+8,i.readUEG(),i.readBits(1),i.readBool())){let e=3!==a?8:12;for(let t=0;t<e;t++)i.readBool()&&(t<6?Lr._skipScalingList(i,16):Lr._skipScalingList(i,64))}i.readUEG();let c=i.readUEG();if(0===c)i.readUEG();else if(1===c){i.readBits(1),i.readSEG(),i.readSEG();let e=i.readUEG();for(let t=0;t<e;t++)i.readSEG()}let h=i.readUEG();i.readBits(1);let p=i.readUEG(),f=i.readUEG(),m=i.readBits(1);0===m&&i.readBits(1),i.readBits(1);let g=0,y=0,v=0,b=0;i.readBool()&&(g=i.readUEG(),y=i.readUEG(),v=i.readUEG(),b=i.readUEG());let _=1,C=1,E=0,S=!0,w=0,R=0;if(i.readBool()){if(i.readBool()){let e=i.readByte();e>0&&e<16?(_=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],C=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):255===e&&(_=i.readByte()<<8|i.readByte(),C=i.readByte()<<8|i.readByte())}if(i.readBool()&&i.readBool(),i.readBool()&&(i.readBits(4),i.readBool()&&i.readBits(24)),i.readBool()&&(i.readUEG(),i.readUEG()),i.readBool()){let e=i.readBits(32),t=i.readBits(32);S=i.readBool(),w=t,R=2*e,E=w/R}}let D=1;1===_&&1===C||(D=_/C);let A=0,P=0;if(0===a)A=1,P=2-m;else{A=3===a?1:2,P=(1===a?2:1)*(2-m)}let F=16*(p+1),T=16*(f+1)*(2-m);F-=(g+y)*A,T-=(v+b)*P;let x=Math.ceil(F*D);return i.destroy(),i=null,{profile_string:o,level_string:s,bit_depth:u,ref_frames:h,chroma_format:d,chroma_format_string:Lr.getChromaFormatString(d),frame_rate:{fixed:S,fps:E,fps_den:R,fps_num:w},sar_ratio:{width:_,height:C},codec_size:{width:F,height:T},present_size:{width:x,height:T}}}static _skipScalingList(e,t){let i=8,n=8,r=0;for(let o=0;o<t;o++)0!==n&&(r=e.readSEG(),n=(i+r+256)%256),i=0===n?i:n}static getProfileString(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}static getLevelString(e){return(e/10).toFixed(1)}static getChromaFormatString(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}const Br=Lr;function Vr(e){const t={},i=new DataView(e.buffer);let n=i.getUint8(0),r=i.getUint8(1);i.getUint8(2),i.getUint8(3);if(1!==n||0===r)return t;const o=1+(3&i.getUint8(4));if(3!==o&&4!==o)return t;let s=31&i.getUint8(5);if(0===s)return;let a=6;for(let l=0;l<s;l++){let n=i.getUint16(a,!1);if(a+=2,0===n)continue;let r=new Uint8Array(e.buffer,a,n);a+=n;let o=Br.parseSPS(r);if(0!==l)continue;t.codecWidth=o.codec_size.width,t.codecHeight=o.codec_size.height,t.presentWidth=o.present_size.width,t.presentHeight=o.present_size.height,t.profile=o.profile_string,t.level=o.level_string,t.bitDepth=o.bit_depth,t.chromaFormat=o.chroma_format,t.sarRatio=o.sar_ratio,t.frameRate=o.frame_rate,!1===o.frame_rate.fixed||0===o.frame_rate.fps_num||o.frame_rate.fps_den;let s=t.frameRate.fps_den,d=t.frameRate.fps_num;t.refSampleDuration=t.timescale*(s/d);let u=r.subarray(1,4),c="avc1.";for(let e=0;e<3;e++){let t=u[e].toString(16);t.length<2&&(t="0"+t),c+=t}t.codec=c}let d=i.getUint8(a);if(0===d)return t;a++;for(let l=0;l<d;l++){let t=i.getUint16(a,!1);if(a+=2,0===t)continue;new Uint8Array(e.buffer,a,t);a+=t}return t.videoType="avc",t}class Ur{static getSampleRate(e){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][e]||null}static get32BitNumByOffset(e,t,i){let n=0;if(i>32)return 0;let r=Math.floor(t/8),o=t%8,s=Math.min(o+i-1,7);for(;i>0&&s>=o&&r<e.length;){let t=255>>o&255;t=t&255<<7-s&255;let a=s-o+1;n<<=a,n|=(e[r]&t)>>7-s,i-=Math.max(a,0),o=0,s=Math.min(o+i-1,7),r++}return n}static getObjectTypeName(e){return["Null","AAC Main","AAC LC (Low Complexity)","AAC SSR (Scalable Sample Rate)","AAC LTP (Long Term Prediction)","SBR (Spectral Band Replication)","AAC Scalable","TwinVQ","CELP (Code Excited Linear Prediction)","HXVC (Harmonic Vector eXcitation Coding)","Reserved","Reserved","TTSI (Text-To-Speech Interface)","Main Synthesis","Wavetable Synthesis","General MIDI","Algorithmic Synthesis and Audio Effects","ER (Error Resilient) AAC LC","Reserved","ER AAC LTP","ER AAC Scalable","ER TwinVQ","ER BSAC (Bit-Sliced Arithmetic Coding)","ER AAC LD (Low Delay)","ER CELP","ER HVXC","ER HILN (Harmonic and Individual Lines plus Noise)","ER Parametric","SSC (SinuSoidal Coding)","PS (Parametric Stereo)","MPEG Surround","(Escape value)","Layer-1","Layer-2","Layer-3","DST (Direct Stream Transfer)","ALS (Audio Lossless)","SLS (Scalable LosslesS)","SLS non-core","ER AAC ELD (Enhanced Low Delay)","SMR (Symbolic Music Representation) Simple","SMR Main","USAC (Unified Speech and Audio Coding) (no SBR)","SAOC (Spatial Audio Object Coding)","LD MPEG Surround","USAC"][e]||"Unknown"}static parseAudioSpecificConfig(e){const t={codecType:"Unknown",sampleRate:0,numbersOfChanel:0};let i=0;const n=(248&e[0])>>3;i+=5,31===n&&(i+=38);const r=this.get32BitNumByOffset(e,i,4);i+=4;let o=0;15===r?(o=this.get32BitNumByOffset(e,i,24),i+=24):o=this.getSampleRate(r)||0;let s=0;return s=this.get32BitNumByOffset(e,i,4),i+=4,t.sampleRate=o,t.codecType=this.getObjectTypeName(n),t.numbersOfChanel=s,t}static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}var Nr,jr;!function(e){e[e.kNull=0]="kNull",e[e.kAACMain=1]="kAACMain",e[e.kAAC_LC=2]="kAAC_LC",e[e.kAAC_SSR=3]="kAAC_SSR",e[e.kAAC_LTP=4]="kAAC_LTP",e[e.kAAC_SBR=5]="kAAC_SBR",e[e.kAAC_Scalable=6]="kAAC_Scalable",e[e.kLayer1=32]="kLayer1",e[e.kLayer2=33]="kLayer2",e[e.kLayer3=34]="kLayer3"}(Nr||(Nr={})),function(e){e[e.k96000Hz=0]="k96000Hz",e[e.k88200Hz=1]="k88200Hz",e[e.k64000Hz=2]="k64000Hz",e[e.k48000Hz=3]="k48000Hz",e[e.k44100Hz=4]="k44100Hz",e[e.k32000Hz=5]="k32000Hz",e[e.k24000Hz=6]="k24000Hz",e[e.k22050Hz=7]="k22050Hz",e[e.k16000Hz=8]="k16000Hz",e[e.k12000Hz=9]="k12000Hz",e[e.k11025Hz=10]="k11025Hz",e[e.k8000Hz=11]="k8000Hz",e[e.k7350Hz=12]="k7350Hz"}(jr||(jr={}));class Wr{static _ebsp2rbsp(e){let t=e,i=t.byteLength,n=new Uint8Array(i),r=0;for(let o=0;o<i;o++)o>=2&&3===t[o]&&0===t[o-1]&&0===t[o-2]||(n[r]=t[o],r++);return new Uint8Array(n.buffer,0,r)}static parseVPS(e){let t=Wr._ebsp2rbsp(e),i=new Ir(t);i.readByte(),i.readByte();i.readBits(4);i.readBits(2);i.readBits(6);return{num_temporal_layers:i.readBits(3)+1,temporal_id_nested:i.readBool()}}static parseSPS(e){let t=Wr._ebsp2rbsp(e),i=new Ir(t);i.readByte(),i.readByte();let n=0,r=0,o=0,s=0,a=(i.readBits(4),i.readBits(3)),d=(i.readBool(),i.readBits(2)),l=i.readBool(),u=i.readBits(5),c=i.readByte(),h=i.readByte(),p=i.readByte(),f=i.readByte(),m=i.readByte(),g=i.readByte(),y=i.readByte(),v=i.readByte(),b=i.readByte(),_=i.readByte(),C=i.readByte(),E=[],S=[];for(let q=0;q<a;q++)E.push(i.readBool()),S.push(i.readBool());if(a>0)for(let q=a;q<8;q++)i.readBits(2);for(let q=0;q<a;q++)E[q]&&(i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte(),i.readByte()),S[q]&&i.readByte();i.readUEG();let w=i.readUEG();3==w&&i.readBits(1);let R=i.readUEG(),D=i.readUEG();i.readBool()&&(n+=i.readUEG(),r+=i.readUEG(),o+=i.readUEG(),s+=i.readUEG());let A=i.readUEG(),P=i.readUEG(),F=i.readUEG();for(let q=i.readBool()?0:a;q<=a;q++)i.readUEG(),i.readUEG(),i.readUEG();i.readUEG(),i.readUEG(),i.readUEG(),i.readUEG(),i.readUEG(),i.readUEG();if(i.readBool()){if(i.readBool())for(let e=0;e<4;e++)for(let t=0;t<(3===e?2:6);t++){if(i.readBool()){let t=Math.min(64,1<<4+(e<<1));e>1&&i.readSEG();for(let e=0;e<t;e++)i.readSEG()}else i.readUEG()}}i.readBool(),i.readBool();i.readBool()&&(i.readByte(),i.readUEG(),i.readUEG(),i.readBool());let T=i.readUEG(),x=0;for(let q=0;q<T;q++){let e=!1;if(0!==q&&(e=i.readBool()),e){q===T&&i.readUEG(),i.readBool(),i.readUEG();let e=0;for(let t=0;t<=x;t++){let t=i.readBool(),n=!1;t||(n=i.readBool()),(t||n)&&e++}x=e}else{let e=i.readUEG(),t=i.readUEG();x=e+t;for(let n=0;n<e;n++)i.readUEG(),i.readBool();for(let n=0;n<t;n++)i.readUEG(),i.readBool()}}if(i.readBool()){let e=i.readUEG();for(let t=0;t<e;t++){for(let e=0;e<F+4;e++)i.readBits(1);i.readBits(1)}}let k=!1,M=0,O=1,I=1,L=!1,B=1,V=1;i.readBool(),i.readBool();if(i.readBool()){if(i.readBool()){let e=i.readByte();e>0&&e<=16?(O=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],I=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):255===e&&(O=i.readBits(16),I=i.readBits(16))}if(i.readBool()&&i.readBool(),i.readBool()){i.readBits(3),i.readBool(),i.readBool()&&(i.readByte(),i.readByte(),i.readByte())}i.readBool()&&(i.readUEG(),i.readUEG());i.readBool(),i.readBool(),i.readBool();if(k=i.readBool(),k&&(i.readUEG(),i.readUEG(),i.readUEG(),i.readUEG()),i.readBool()){if(B=i.readBits(32),V=i.readBits(32),i.readBool()&&i.readUEG(),i.readBool()){let e=!1,t=!1,n=!1;if(1&&(e=i.readBool(),t=i.readBool(),e||t)){n=i.readBool(),n&&(i.readByte(),i.readBits(5),i.readBool(),i.readBits(5));i.readBits(4),i.readBits(4);n&&i.readBits(4),i.readBits(5),i.readBits(5),i.readBits(5)}for(let r=0;r<=a;r++){let r=i.readBool();L=r;let o=!0,s=1;r||(o=i.readBool());let a=!1;if(o?i.readUEG():a=i.readBool(),a||(s=i.readUEG()+1),e){for(let e=0;e<s;e++)i.readUEG(),i.readUEG(),n&&(i.readUEG(),i.readUEG());i.readBool()}if(t){for(let e=0;e<s;e++)i.readUEG(),i.readUEG(),n&&(i.readUEG(),i.readUEG());i.readBool()}}}}if(i.readBool()){i.readBool(),i.readBool(),i.readBool();M=i.readUEG();i.readUEG(),i.readUEG(),i.readUEG(),i.readUEG()}}i.readBool();let U=`hvc1.${u}.1.L${C}.B0`,N=R-(n+r)*(1===w||2===w?2:1),j=D-(o+s)*(1===w?2:1),W=1;return 1!==O&&1!==I&&(W=O/I),i.destroy(),i=null,{codec_mimetype:U,profile_string:Wr.getProfileString(u),level_string:Wr.getLevelString(C),profile_idc:u,bit_depth:A+8,ref_frames:1,chroma_format:w,chroma_format_string:Wr.getChromaFormatString(w),general_level_idc:C,general_profile_space:d,general_tier_flag:l,general_profile_idc:u,general_profile_compatibility_flags_1:c,general_profile_compatibility_flags_2:h,general_profile_compatibility_flags_3:p,general_profile_compatibility_flags_4:f,general_constraint_indicator_flags_1:m,general_constraint_indicator_flags_2:g,general_constraint_indicator_flags_3:y,general_constraint_indicator_flags_4:v,general_constraint_indicator_flags_5:b,general_constraint_indicator_flags_6:_,min_spatial_segmentation_idc:M,constant_frame_rate:0,chroma_format_idc:w,bit_depth_luma_minus8:A,bit_depth_chroma_minus8:P,frame_rate:{fixed:L,fps:V/B,fps_den:B,fps_num:V},sar_ratio:{width:O,height:I},codec_size:{width:N,height:j},present_size:{width:N*W,height:j}}}static parsePPS(e){let t=Wr._ebsp2rbsp(e),i=new Ir(t);i.readByte(),i.readByte();i.readUEG(),i.readUEG(),i.readBool(),i.readBool(),i.readBits(3),i.readBool(),i.readBool(),i.readUEG(),i.readUEG(),i.readSEG(),i.readBool(),i.readBool();if(i.readBool()){i.readUEG()}i.readSEG(),i.readSEG(),i.readBool(),i.readBool(),i.readBool(),i.readBool();let n=i.readBool(),r=i.readBool(),o=1;return r&&n?o=0:r?o=3:n&&(o=2),{parallelismType:o}}static getChromaFormatString(e){switch(e){case 0:return"4:0:0";case 1:return"4:2:0";case 2:return"4:2:2";case 3:return"4:4:4";default:return"Unknown"}}static getProfileString(e){switch(e){case 1:return"Main";case 2:return"Main10";case 3:return"MainSP";case 4:return"Rext";case 9:return"SCC";default:return"Unknown"}}static getLevelString(e){return(e/30).toFixed(1)}}const qr=Wr;function Hr(e){return e.byteOffset%2==0&&e.byteLength%2==0}function Qr(e){return e.byteOffset%4==0&&e.byteLength%4==0}function Gr(e,t){for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}const zr=function(e,t){return e.byteLength===t.byteLength&&(Qr(e)&&Qr(t)?function(e,t){return Gr(new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4))}(e,t):Hr(e)&&Hr(t)?function(e,t){return Gr(new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2))}(e,t):function(e,t){return Gr(e,t)}(e,t))};function Kr(e,t){const i=e.buffer,n=e.length;if(n<22)return void console.warn("Flv: Invalid HEVCDecoderConfigurationRecord, lack of data!");let r={},o=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),s=new DataView(i,0,n);if(r){if(void 0!==r.hvcc){let e=new Uint8Array(i,0,n);if(zr(e,r.hvcc))return}}else r={},r.type="video",r.timescale=t||1e3,r.duration=0;let a=s.getUint8(0),d=31&s.getUint8(1);if(1!==a||0===d)return;const l=1+(3&s.getUint8(21));if(3!==l&&4!==l)return;let u=s.getUint8(22);for(let c=0,h=23;c<u;c++){let e=63&s.getUint8(h+0),t=s.getUint16(h+1,!o);h+=3;for(let n=0;n<t;n++){let t=s.getUint16(h+0,!o);if(0===n)if(33===e){h+=2;let e=new Uint8Array(i,0+h,t),n=qr.parseSPS(e);r.codecWidth=n.codec_size.width,r.codecHeight=n.codec_size.height,r.presentWidth=n.present_size.width,r.presentHeight=n.present_size.height,r.profile=n.profile_string,r.level=n.level_string,r.bitDepth=n.bit_depth,r.chromaFormat=n.chroma_format,r.sarRatio=n.sar_ratio,r.frameRate=n.frame_rate,!1===n.frame_rate.fixed||0===n.frame_rate.fps_num||n.frame_rate.fps_den;let o=r.frameRate.fps_den,s=r.frameRate.fps_num;r.refSampleDuration=r.timescale*(o/s)||0,r.codec=n.codec_mimetype;let a={};a.width=r.codecWidth,a.height=r.codecHeight,a.fps=r.frameRate.fps,a.profile=r.profile,a.level=r.level,a.refFrames=n.ref_frames,a.chromaFormat=n.chroma_format_string,a.sarNum=r.sarRatio.width,a.sarDen=r.sarRatio.height,a.videoCodec=n.codec_mimetype,a.hasAudio?null!=a.audioCodec&&(a.mimeType='video/x-flv; codecs="'+a.videoCodec+","+a.audioCodec+'"'):a.mimeType='video/x-flv; codecs="'+a.videoCodec+'"',h+=t}else h+=2+t;else h+=2+t}}return r.hvcc=new Uint8Array(n),r.hvcc.set(new Uint8Array(i,0,n),0),r}class Yr{static isEqual(e,t){if(e.length!=t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}}var $r=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Xr=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Zr=function(e,t){return function(i,n){t(i,n,e)}};let Jr=class{constructor(e){this.formatCtx=e,this.hasAudio=!1,this.hasVideo=!1,this.lastVideoTime=0,this.lastAudioTime=0,this.maxVideoDelayMS=1500,this.maxAudioDelayMS=1500,this.maxCheckMutedCount=10,this.checkVideoMutedAudioCount=0,this.checkAudioMutedVideoCount=0,this.noDetect=!0}resetStates(){this.hasAudio=!1,this.hasVideo=!1,this.lastVideoTime=0,this.lastAudioTime=0}onAudioReceive(){if(!this.noDetect&&(this.hasAudio=!0,this.lastAudioTime=performance.now(),this.checkAudioMutedVideoCount=0,this.formatCtx.audioNetTrackMuted&&(this.formatCtx.audioNetTrackMuted=!1),!this.formatCtx.videoNetTrackMuted&&this.hasVideo)){this.lastAudioTime-this.lastVideoTime>this.maxVideoDelayMS?this.checkVideoMutedAudioCount++:this.checkVideoMutedAudioCount=0,this.checkVideoMutedAudioCount>this.maxCheckMutedCount&&(this.formatCtx.videoNetTrackMuted=!0)}}onVideoReceive(){if(!this.noDetect&&(this.hasVideo=!0,this.lastVideoTime=performance.now(),this.checkVideoMutedAudioCount=0,this.formatCtx.videoNetTrackMuted&&(this.formatCtx.videoNetTrackMuted=!1),!this.formatCtx.audioNetTrackMuted&&this.hasAudio)){this.lastVideoTime-this.lastAudioTime>this.maxAudioDelayMS?this.checkAudioMutedVideoCount++:this.checkAudioMutedVideoCount=0,this.checkAudioMutedVideoCount>this.maxCheckMutedCount&&(this.formatCtx.audioNetTrackMuted=!0)}}startDetect(){this.resetStates(),this.noDetect=!1}stopDetect(){this.resetStates(),this.noDetect=!0}};Jr=$r([it(),Zr(0,mt(tt.FormatContext)),Xr("design:paramtypes",[Object])],Jr);let eo=class{constructor(e,t,i,n,r,o,s,a){this.packetsReceivers=e,this.formatContext=t,this.qualityCtx=i,this.lm=n,this.remoteMuteStateDetect=r,this.packetsDropSyncSignal=o,this.globalEvent=s,this.playerState=a,this.firstIFrameDemuxed=!1,this.firstAudioFrameDemuxed=!1,this.ended=!1,this.logger=n.createLogger("dmx.fvm"),this.reset()}addAudioPacket(e,t){const i={payload:e,pts:t,dts:t};this.checkFirstAudioFrame(i),this.remoteMuteStateDetect.onAudioReceive(),this.packetsReceivers.audio.receive(i)}checkFirstAudioFrame(e){this.firstAudioFrameDemuxed||(this.firstAudioFrameDemuxed=!0,this.formatContext.audioTimestampOffset=e.pts)}checkFirstIFrame(e){!this.firstIFrameDemuxed&&e.isKeyFrame&&(this.logger.info("set first i frame."),this.firstIFrameDemuxed=!0,e.firstKeyFrame=!0,this.formatContext.videoTimestampOffset=e.pts)}setPFrame(e){e.isKeyFrame||(e.PFrame=!0)}addVideoPacket(e){e.isKeyFrame&&this.qualityCtx.networkStatistic.countIFrame(),this.checkFirstIFrame(e),this.setPFrame(e),this.remoteMuteStateDetect.onVideoReceive(),this.packetsReceivers.video.receive(e)}getCodecIDFromVidTag(e){switch(15&e[0]){case 7:return gi.H264;case 12:return gi.H265;default:return gi.Unknown}}getCodecIDFromAudTag(e){return 10===(240&e[0])>>4?gi.AAC:gi.Unknown}isAACSequenceHeader(e){return 0===e[1]}sliceAACPacketData(e){return e.slice(2)}sliceAVCPacketData(e){return e.slice(5)}sliceHEVCPacketData(e){return e.slice(5)}isDecoderConfigurationRecord(e){return 0===e[1]}isNaluTag(e){return 1===e[1]}unsupportedVideoCodecFormat(){throw this.closeDemux(),new Vt("unsupported video codec format.")}unsupportedAudioCodecFormat(){throw this.closeDemux(),new Vt("unsupported audio codec format.")}setAVCCodecID(){this.formatContext.videoCodecID!=gi.H264&&(this.formatContext.videoCodecID=gi.H264)}setAACCodecID(){this.formatContext.audioCodecID!=gi.AAC&&(this.formatContext.audioCodecID=gi.AAC)}saveAVCDecoderConfigurationRecord(e){const t=Vr(e),i={};(null==t?void 0:t.codecHeight)&&t.codecWidth&&(i.codecFrameHeight=t.codecHeight,i.codecFrameWidth=t.codecWidth),(null==t?void 0:t.frameRate.fps)&&(i.frameRate=null==t?void 0:t.frameRate.fps),(null==t?void 0:t.codec)&&""!==(null==t?void 0:t.codec)&&(i.videoCodecName="AVC/H.264 ("+t.codec+")"),this.formatContext.update(i),this.saveVideoDescription(e,t)}saveVideoDescription(e,t){this.formatContext.videoDescription&&e&&Yr.isEqual(e,this.formatContext.videoDescription)||(t.hvcc&&delete t.hvcc,this.logger.info("video description "+JSON.stringify(t)),this.firstIFrameDemuxed=!1,this.packetsReceivers.video.reset(),this.formatContext.videoDescription=e)}saveHEVCDecoderConfigurationRecord(e){const t=Kr(e),i={};(null==t?void 0:t.codecHeight)&&t.codecWidth&&(i.codecFrameHeight=t.codecHeight,i.codecFrameWidth=t.codecWidth),(null==t?void 0:t.frameRate.fps)&&(i.frameRate=null==t?void 0:t.frameRate.fps),(null==t?void 0:t.codec)&&""!==(null==t?void 0:t.codec)&&(i.videoCodecName="HEVC/H.265 ("+t.codec+")"),this.formatContext.update(i),this.saveVideoDescription(e,t)}setHEVCodecID(){this.formatContext.videoCodecID!=gi.H265&&(this.formatContext.videoCodecID=gi.H265)}parseHEVCVideoTagData(e,t,i){if(this.setHEVCodecID(),this.isDecoderConfigurationRecord(e)){const t=this.sliceHEVCPacketData(e);return void this.saveHEVCDecoderConfigurationRecord(t)}const n=this.getCompositionTime(e),r=i+n,o={payload:this.sliceHEVCPacketData(e),isKeyFrame:t,pts:r,cts:n,dts:i,naluPkt:this.isNaluTag(e)};this.addVideoPacket(o)}getCompositionTime(e){let t=e[2]<<16|e[3]<<8|e[4];return 8388608&t?(t&=8388607,t*=-1):t&=8388607,t}parseAVCVideoTagData(e,t,i){if(this.setAVCCodecID(),this.isDecoderConfigurationRecord(e)){const t=this.sliceAVCPacketData(e);return void this.saveAVCDecoderConfigurationRecord(t)}if(!this.formatContext.videoDescription)return;const n=this.getCompositionTime(e),r=i+n,o={payload:this.sliceAVCPacketData(e),isKeyFrame:t,pts:r,dts:i,cts:n,naluPkt:this.isNaluTag(e)};this.addVideoPacket(o)}saveAudioFormatFromAACConfig(e){const t=Ur.parseAudioSpecificConfig(e);(t.codecType||t.sampleRate||t.numbersOfChanel)&&this.saveAudioDescription(e,t)}saveAudioDescription(e,t){this.formatContext.audioDescription&&e&&Yr.isEqual(e,this.formatContext.audioDescription)||(this.formatContext.setAudioFormat(t.codecType,t.sampleRate,t.numbersOfChanel),this.packetsReceivers.audio.reset(),this.logger.info("audio description "+JSON.stringify(t)),this.formatContext.audioDescription=e)}parseAACAudioTagData(e,t){if(this.setAACCodecID(),this.isAACSequenceHeader(e)){const t=this.sliceAACPacketData(e);this.saveAudioFormatFromAACConfig(t)}else this.formatContext.audioDescription&&this.addAudioPacket(this.sliceAACPacketData(e),t)}flvDemuxVideoTag(e,t,i){if(this.qualityCtx.networkStatistic.onDemuxVideoData(),this.ended)return;const n=this.getCodecIDFromVidTag(e);if(this.formatContext.videoCodecID&&this.formatContext.videoCodecID!==gi.Unknown&&n!==this.formatContext.videoCodecID)return this.ended=!0,void this.globalEvent.event.emit(di.MEDIA_REFETCH,this.playerState.url);switch(n){case gi.H264:return void this.parseAVCVideoTagData(e,t,i);case gi.H265:return void this.parseHEVCVideoTagData(e,t,i);default:return void this.unsupportedVideoCodecFormat()}}flvDemuxAudioTag(e,t){if(this.qualityCtx.networkStatistic.onDemuxAudioData(),this.ended)return;this.getCodecIDFromAudTag(e)===gi.AAC?this.parseAACAudioTagData(e,t):this.unsupportedAudioCodecFormat()}flvDemuxerInfoUpdate(e){e.isFlv&&(this.formatContext.formatName="FLV"),this.ended||this.remoteMuteStateDetect.startDetect()}closeDemux(){this.demux&&(this.demux.close(),this.remoteMuteStateDetect.stopDetect())}createDemux(){this.demux=new xr({outputAudio:this.flvDemuxAudioTag.bind(this),outputVideo:this.flvDemuxVideoTag.bind(this),outputFormatInfo:this.flvDemuxerInfoUpdate.bind(this)})}resetPacketsInputs(){this.packetsReceivers.audio.reset(),this.packetsReceivers.video.reset()}resetFirstFrameDemuxed(){this.firstIFrameDemuxed=!1,this.firstAudioFrameDemuxed=!1}resetFlvDemux(){this.closeDemux(),this.createDemux(),this.resetPacketsInputs(),this.resetFirstFrameDemuxed(),this.ended=!1}reset(){this.resetFlvDemux(),this.formatContext.reset(),this.packetsDropSyncSignal.reset()}receive(e){this.demux.receive(e)}};eo=$r([it(),Zr(0,mt(tt.DemuxerPacketsReceivers)),Zr(1,mt(tt.FormatContext)),Zr(2,mt(tt.QualityStatisticContext)),Zr(3,mt(tt.LogMana)),Zr(4,mt(tt.RemoteMuteStateDetect)),Zr(5,mt(tt.PacketsDropSyncSignal)),Zr(6,mt(tt.GlobalEvent)),Zr(7,mt(tt.PlayerState)),Xr("design:paramtypes",[Object,Object,Qi,$t,Jr,ni,Object,Object])],eo);var to=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},io=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},no=function(e,t){return function(i,n){t(i,n,e)}};let ro=class{constructor(e,t,i,n,r){this.requestor=e,this.demuxer=t,this.lm=i,this.globalEvt=n,this.playerState=r,this.logger=i.createLogger("dmx.cx"),this.globalEvt.event.once(di.DESTROY,(()=>this.destroy())),this.bindRequestorEvent()}bindRequestorEvent(){this.requestor.onsuccess=()=>{this.logger.info("requestor on success"),this.playerState.loaded=!0,this.globalEvt.event.emit(di.MEDIA_FETCH_END,this.url)},this.requestor.onprogress=e=>{this.demuxer.receive(e)},this.requestor.onresume=()=>{this.logger.info("requestor on resume"),this.globalEvt.event.emit(di.MEDIA_REFETCH,this.url)},this.requestor.onerror=()=>{throw this.logger.info("requestor on error"),this.playerState.loaded=!0,this.globalEvt.event.emit(di.MEDIA_FETCH_END,this.url),new Ut("failed to request media: "+this.url)}}setUrl(e){e!==this.url&&(this.url=e,this.playerState.loaded=!1,this.demuxer.reset(),this.requestor.request(e),this.logger.info("fetch end emit from set url"),this.globalEvt.event.emit(di.MEDIA_FETCH_BEGIN,this.url))}stop(){this.requestor.abort(),this.demuxer.reset(),this.url&&""!==this.url&&(this.logger.info("fetch end emit from stop"),this.globalEvt.event.emit(di.MEDIA_FETCH_END,this.url)),this.url=""}destroy(){this.stop()}};to([Ht("url"),io("design:type",Function),io("design:paramtypes",[String]),io("design:returntype",void 0)],ro.prototype,"setUrl",null),to([Ht("stp"),io("design:type",Function),io("design:paramtypes",[]),io("design:returntype",void 0)],ro.prototype,"stop",null),ro=to([it(),no(0,mt(tt.NetworkRequestor)),no(1,mt(tt.FlvDemuxer)),no(2,mt(tt.LogMana)),no(3,mt(tt.GlobalEvent)),no(4,mt(tt.PlayerState)),io("design:paramtypes",[Object,Object,$t,Object,Object])],ro);var oo=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},so=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ao=function(e,t){return function(i,n){t(i,n,e)}};let lo=class{constructor(e){this.lm=e,this.logger=e.createLogger("rd.uic"),this.isUserVideoDom=!1,this.createDoms()}remountVideoInWrapper(){this.divContainer&&this._videoElement&&this.divContainer.contains(this._videoElement)&&(this.divContainer.removeChild(this._videoElement),this.divContainer.appendChild(this._videoElement))}isUserVideoElement(){return this.isUserVideoDom}setUserVideoElement(e){this.logger.info("set user video element."),this.isUserVideoDom=!0,this._videoElement=e}hideCanvas(){var e;(null===(e=this.divContainer)||void 0===e?void 0:e.contains(this.canvas))&&(this.logger.info("hide canvas"),this.canvas.style.display="none")}showCanvas(){this.logger.info("show canvas"),this.canvas.style.display="block"}hideVideoElement(){this.logger.info("hide video el"),this.videoElement.style.display="none"}showVideoElement(){this.logger.info("show video el"),this.videoElement.style.display="block"}setVideoElementAttributes(e,t){for(const i in e)if(void 0!==this.videoElement[i])this.videoElement[i]=e[i];else{if("string"!=typeof e[i])throw new Vt("cannot set attribute name: "+i+" on videoElement");this.videoElement.setAttribute(i,e[i])}for(const i in t)this.videoElement.removeAttribute(i)}createCanvas(){return document.createElement("canvas")}createDoms(){this.renderCanvas=this.createCanvas(),this._videoElement=this.createHiddenVideoEl()}createHiddenVideoEl(){const e=document.createElement("video");return e.setAttribute("x-webkit-airplay","allow"),e.setAttribute("x5-playsinline","true"),e.setAttribute("webkit-playsinline","true"),e.style.display="none",e.controls=!0,e.disablePictureInPicture=!0,e.playsInline=!0,e}destroy(){this.divContainer&&this.divContainer.contains(this.renderCanvas)&&this.divContainer.removeChild(this.renderCanvas),this.divContainer&&this.divContainer.contains(this.videoElement)&&this.divContainer.removeChild(this.videoElement),this.divObserver&&this.divObserver.disconnect()}get canvas(){return this.renderCanvas}get videoElement(){return this._videoElement}get wrapper(){return this.divContainer}getAttrFromMutationRecord(e){return e.target.getAttribute(e.attributeName)}setContainerWidth(e){e?(this.renderCanvas.style.width=e+"px",this.videoElement.setAttribute("width",e.toString()),this.videoElement.style.width=e+"px"):(this.renderCanvas.style.width="",this.videoElement.removeAttribute("width"),this.videoElement.style.width="")}switchAttributesMutation(e){switch(e.attributeName){case"zg-width":{const t=this.getAttrFromMutationRecord(e);this.setContainerWidth(t);break}case"zg-height":{const t=this.getAttrFromMutationRecord(e);this.setContainerHeight(t);break}}}setContainerHeight(e){e?(this.renderCanvas.style.height=e+"px",this.videoElement.setAttribute("height",e.toString()),this.videoElement.style.height=e+"px"):(this.renderCanvas.style.height="",this.videoElement.removeAttribute("height"),this.videoElement.style.height="")}filterAttrChangeFromMutations(e){e.forEach((e=>{"attributes"===e.type&&this.switchAttributesMutation(e)}))}observeContainer(){this.divContainer&&(this.divObserver=new MutationObserver(this.filterAttrChangeFromMutations.bind(this)),this.divObserver.observe(this.divContainer,{attributes:!0}))}resetCanvas(){this.divContainer&&(this.divContainer.removeChild(this.renderCanvas),this.renderCanvas=this.createCanvas(),this.divContainer.appendChild(this.renderCanvas),this.sizeCanvasStyle())}sizeCanvasStyle(){const e=this.divContainer,t=null==e?void 0:e.attributes["zg-width"];t&&t.value&&(this.renderCanvas.style.width=t.value+"px");const i=null==e?void 0:e.attributes["zg-height"];i&&i.value&&(this.renderCanvas.style.height=i.value+"px")}sizeVideoElementByContainerAttri(){const e=this.divContainer,t=null==e?void 0:e.attributes["zg-width"];t&&t.value&&(this.videoElement.width=t.value,this.videoElement.style.width=t.value+"px");const i=null==e?void 0:e.attributes["zg-height"];i&&i.value&&(this.videoElement.height=i.value,this.videoElement.style.height=i.value+"px")}bindContainer(e){this.logger.info("bind call"),this.divContainer=e,this.divContainer.style.overflow="hidden",this.divContainer.style.display="flex",this.divContainer.style.justifyContent="center",e.appendChild(this.renderCanvas),e.appendChild(this.videoElement),this.sizeCanvasStyle(),this.sizeVideoElementByContainerAttri(),this.observeContainer()}};lo=oo([it(),ao(0,mt(tt.LogMana)),so("design:paramtypes",[$t])],lo);var uo=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},co=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ho=function(e,t){return function(i,n){t(i,n,e)}};let po=class{constructor(e,t,i,n,r,o){this.playerState=e,this.lm=t,this.media=i,this.videoClock=n,this.audioPlayerBuilder=r,this.videoPlayerBuilder=o,this._stream=new MediaStream,this.logger=this.lm.createLogger("rd.avp")}get muted(){return this.playerState.muted}get storedVolume(){return this.playerState.volume}initAudioPlayerVolume(){this.audioPlayer&&(this.muted?(this.logger.info("set player muted"),this.audioPlayer.setVolume(0)):(this.logger.info("set player volume "+this.storedVolume),this.audioPlayer.setVolume(this.storedVolume)))}initAudio(e){if(e.noAudio)return this.logger.info("audio player set null"),this.audioPlayer&&this.audioPlayer.destroy(),void(this.audioPlayer=void 0);this.audioPlayer&&e.sampleRate===this.audioPlayer.sampleRate?(this.logger.info("use old audio player "),this.audioPlayer&&this.audioPlayer.reset()):(this.logger.info("create new audio player "),this.audioPlayer&&this.audioPlayer.destroy(),this.audioPlayer=this.audioPlayerBuilder(),this.initAudioPlayerVolume())}initVideo(e){if(e.noVideo)return this.logger.info("video player set null"),this.videoPlayer&&this.videoPlayer.destroy(),void(this.videoPlayer=void 0);this.logger.info("create new video player"),this.videoPlayer&&this.videoPlayer.destroy(),this.videoClock.reset(),this.videoPlayer=this.videoPlayerBuilder()}getPlayable(){return void 0!==this.audioPlayer||void 0!==this.videoPlayer}getAudioPlayer(){return null}getVideoPlayer(){return null}getStream(){return this._stream}resetStream(){this.getStream().getTracks().forEach((e=>{this.getStream().removeTrack(e)})),this.videoPlayer&&this.videoPlayer.captureStream().getTracks().forEach((e=>{this.getStream().addTrack(e)})),this.audioPlayer&&this.audioPlayer.stream.getTracks().forEach((e=>{this.getStream().addTrack(e)}))}resumeAudio(){this.audioPlayer&&!this.audioPlayer.deviceReady()&&this.audioPlayer.resume()}play(){this.media.audioFrames.clear(),this.audioPlayer&&this.audioPlayer.play(),this.videoPlayer&&this.videoPlayer.play()}pause(){this.audioPlayer&&this.audioPlayer.pause(),this.videoPlayer&&this.videoPlayer.pause()}captureImage(){let e="";return this.videoPlayer&&(e=this.videoPlayer.captureImage()),e}destroy(){this.audioPlayer&&this.audioPlayer.destroy(),this.videoPlayer&&this.videoPlayer.destroy()}setMuted(e){this.playerState.muted=e,e?this.audioPlayer&&this.audioPlayer.setVolume(0):this.audioPlayer&&this.audioPlayer.setVolume(this.playerState.volume)}setVolume(e){this.playerState.muted||this.playerState.volume===e||this.audioPlayer&&this.audioPlayer.setVolume(e),this.playerState.volume=e}clearVideoRender(){this.videoPlayer&&this.videoPlayer.clearCanvas()}};uo([Ht("iapv"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",void 0)],po.prototype,"initAudioPlayerVolume",null),uo([Ht("iaio"),co("design:type",Function),co("design:paramtypes",[_i]),co("design:returntype",void 0)],po.prototype,"initAudio",null),uo([Ht("ivio"),co("design:type",Function),co("design:paramtypes",[_i]),co("design:returntype",void 0)],po.prototype,"initVideo",null),uo([Ht("rstm"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",void 0)],po.prototype,"resetStream",null),uo([Ht("rsao"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",void 0)],po.prototype,"resumeAudio",null),uo([Ht("pl.0"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",void 0)],po.prototype,"play",null),uo([Ht("pl.1"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",void 0)],po.prototype,"pause",null),uo([Ht("capis"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",String)],po.prototype,"captureImage",null),uo([Ht("stmu"),co("design:type",Function),co("design:paramtypes",[Boolean]),co("design:returntype",void 0)],po.prototype,"setMuted",null),uo([Ht("stvm"),co("design:type",Function),co("design:paramtypes",[Number]),co("design:returntype",void 0)],po.prototype,"setVolume",null),uo([Ht("clvr"),co("design:type",Function),co("design:paramtypes",[]),co("design:returntype",void 0)],po.prototype,"clearVideoRender",null),po=uo([it(),ho(0,mt(tt.PlayerState)),ho(1,mt(tt.LogMana)),ho(2,mt(tt.RenderableMedia)),ho(3,mt(tt.VideoClock)),ho(4,mt(tt.AudioPlayerBuilder)),ho(5,mt(tt.VideoPlayerBuilder)),co("design:paramtypes",[fn,$t,Un,Object,Function,Function])],po);const fo="FormatError";class mo{constructor(){this.mimeType=null,this.duration=null,this.hasAudio=!1,this.hasVideo=!1,this.audioCodec=null,this.videoCodec=null,this.audioDataRate=null,this.videoDataRate=null,this.audioSampleRate=null,this.audioChannelCount=null,this.width=null,this.height=null,this.fps=null,this.profile=null,this.level=null,this.refFrames=null,this.chromaFormat=null,this.sarNum=null,this.sarDen=null,this.metadata=null,this.segments=null,this.segmentCount=null,this.hasKeyframesIndex=null,this.keyframesIndex=null}isComplete(){let e=!1===this.hasAudio||!0===this.hasAudio&&null!=this.audioCodec&&null!=this.audioSampleRate&&null!=this.audioChannelCount,t=!1===this.hasVideo||!0===this.hasVideo&&null!=this.videoCodec&&null!=this.width&&null!=this.height&&null!=this.fps&&null!=this.profile&&null!=this.level&&null!=this.refFrames&&null!=this.chromaFormat&&null!=this.sarNum&&null!=this.sarDen;return null!=this.mimeType&&null!=this.duration&&null!=this.metadata&&null!=this.hasKeyframesIndex&&e&&t}isSeekable(){return!0===this.hasKeyframesIndex}getNearestKeyframe(e){if(null==this.keyframesIndex)return null;let t=this.keyframesIndex,i=this._search(t.times,e);return{index:i,milliseconds:t.times[i]}}_search(e,t){let i=0,n=e.length-1,r=0,o=0,s=n;for(t<e[0]&&(i=0,o=s+1);o<=s;){if(r=o+Math.floor((s-o)/2),r===n||t>=e[r]&&t<e[r+1]){i=r;break}e[r]<t?o=r+1:s=r-1}return i}}class go{constructor(e,t,i){this.mseDecoder=e,this.playerState=t,this.lm=i,this.configured=!1,this.logger=i.createLogger("mse.akm"),this.mseDecoder.event.on(yo.ERROR,((e,t)=>{this.onError(t)}))}reset(){this.logger.info("mse audio track maker reset"),this.configured=!1}configure(e,t){this.logger.info("mse audio track maker configure "+e),this.mseDecoder.configureAudio(e,t),this.configured=!0}flush(){this.logger.info("mse audio track maker flush ")}decode(e){this.configured?(this.playerState.currentTimestampOffset<0&&(this.logger.info("set player state currentTimestampOffset (mse audio)"+e.pts),this.playerState.currentTimestampOffset=e.pts),this.mseDecoder.decodeAudioPacket(e)):this.logger.throttleInfo("can not decode audio before configure",1e3)}destroy(){}onError(e){}}var yo;!function(e){e.ERROR="error"}(yo||(yo={}));class vo{constructor(e,t,i){this.mseDecoder=e,this.playerState=t,this.lm=i,this.hasFirstIFrame=!1,this.logger=i.createLogger("mse.vkm"),this.mseDecoder.event.on(yo.ERROR,((e,t)=>{this.onError(t)}))}reset(){this.logger.info("video track maker reset"),this.hasFirstIFrame=!1}configure(e,t){this.logger.info("video track maker configure. "+e),this.mseDecoder.configureVideo(e,t)}flush(){this.logger.info("flush mse video track maker"),this.hasFirstIFrame=!1}decode(e){!this.hasFirstIFrame&&e.isKeyFrame&&(this.hasFirstIFrame=!0,this.logger.info("has first i frame")),this.hasFirstIFrame?(this.playerState.currentTimestampOffset<0&&(this.logger.info("set player state currentTimestampOffset (mse video)"+e.pts),this.playerState.currentTimestampOffset=e.pts),this.mseDecoder.decodeVideoPacket(e)):this.logger.throttleInfo("has first i frame no detect. drop frame and no decode",1e3)}destroy(){}onError(e){}}class bo{get event(){return this._event}get isAudioMetadataParsed(){return this._audioInitialMetadataDispatched}get isVideoMetadataParsed(){return this._videoInitialMetadataDispatched}constructor(e,t){this.formatContext=e,this.lm=t,this._event=new rt,this._hasAudio=!0,this._hasVideo=!0,this._mpegSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],this._littleEndian=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),this._timestampBase=0,this._naluLengthSize=4,this._referenceFrameRate={fixed:!0,fps:23.976,fps_num:23976,fps_den:1e3},this._audioMetadata=null,this._videoMetadata=null,this.logger=t.createLogger("mse.mtm"),this._timescale=e.timeScale,this.e={onFormatUpdate:this.onFormatUpdate.bind(this)},this.formatContext.event.on(mi.MediaFormatChange,this.e.onFormatUpdate),this.reset()}onFormatUpdate(){this._timescale!=this.formatContext.timeScale&&(this._timescale=this.formatContext.timeScale,this.logger.info("set timescale "+this._timescale))}_parseAACAudioSpecificConfig(e,t,i){let n=new Uint8Array(e,t,i),r=null,o=0,s=0,a=null,d=0,l=null;if(o=s=n[0]>>>3,d=(7&n[0])<<1|n[1]>>>7,d<0||d>=this._mpegSamplingRates.length)return void this._onError(fo,"AAC invalid sampling frequency index!");let u=this._mpegSamplingRates[d],c=(120&n[1])>>>3;if(c<0||c>=8)return void this._onError(fo,"AAC invalid channel configuration");5===o&&(l=(7&n[1])<<1|n[2]>>>7,a=(124&n[2])>>>2);let h=self.navigator.userAgent.toLowerCase();return-1!==h.indexOf("firefox")?d>=6?(o=5,r=new Array(4),l=d-3):(o=2,r=new Array(2),l=d):-1!==h.indexOf("android")?(o=2,r=new Array(2),l=d):(o=5,l=d,r=new Array(4),d>=6?l=d-3:1===c&&(o=2,r=new Array(2),l=d)),r[0]=o<<3,r[0]|=(15&d)>>>1,r[1]=(15&d)<<7,r[1]|=(15&c)<<3,5===o&&(r[1]|=(15&l)>>>1,r[2]=(1&l)<<7,r[2]|=8,r[3]=0),{config:r,samplingRate:u,channelCount:c,codec:"mp4a.40."+o,originalCodec:"mp4a.40."+s}}_onError(e,t){this.logger.warn("mse error "+t),this.event.emit(yo.ERROR,e,t)}_parseVideoData(e,t,i,n,r){let o=this._littleEndian,s=e.byteLength,a=new DataView(e,0,s),d=[],l=0,u=0;const c=this._naluLengthSize;let h=this._timestampBase+i,p=n;for(;u<s;){if(u+4>=s){this.logger.warn(`Malformed Nalu near timestamp ${h}, offset = ${u}, dataSize = ${s}`);break}let i=a.getUint32(u,!o);if(3===c&&(i>>>=8),i>s-c)return void this.logger.warn(`Malformed Nalus near timestamp ${h}, NaluSize > DataSize!`);let n=0;t===gi.H265?n=(126&a.getUint8(u+c))>>1:t===gi.H264&&(n=31&a.getUint8(u+c));let r=new Uint8Array(e,0+u,c+i),p={type:n,data:r};d.push(p),l+=r.byteLength,u+=c+i}if(d.length){let e=this._videoTrack,t={units:d,length:l,isKeyframe:p,dts:h,cts:r,pts:h+r};e.samples.push(t),e.length+=l}}_parseAVCDecoderConfigurationRecord(e,t,i){if(i<7)return void this.logger.warn("Invalid AVCDecoderConfigurationRecord, lack of data!");let n=this._videoMetadata,r=this._videoTrack,o=this._littleEndian,s=new DataView(e,t,i);n?void 0!==n.avcc&&this.logger.warn("Found another AVCDecoderConfigurationRecord!"):(!1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),n=this._videoMetadata={},n.type="video",n.id=r.id,n.timescale=this._timescale,n.duration=this._duration);let a=s.getUint8(0),d=s.getUint8(1);s.getUint8(2),s.getUint8(3);if(1!==a||0===d)return void this._onError(fo,"Invalid AVCDecoderConfigurationRecord");if(this._naluLengthSize=1+(3&s.getUint8(4)),3!==this._naluLengthSize&&4!==this._naluLengthSize)return void this._onError(fo,"Strange NaluLengthSizeMinusOne: "+(this._naluLengthSize-1));let l=31&s.getUint8(5);if(0===l)return void this._onError(fo,"Invalid AVCDecoderConfigurationRecord: No SPS");l>1&&this.logger.warn(`Strange AVCDecoderConfigurationRecord: SPS Count = ${l}`);let u=6;for(let h=0;h<l;h++){let i=s.getUint16(u,!o);if(u+=2,0===i)continue;let r=new Uint8Array(e,t+u,i);u+=i;let a=Br.parseSPS(r);if(0!==h)continue;n.codecWidth=a.codec_size.width,n.codecHeight=a.codec_size.height,n.presentWidth=a.present_size.width,n.presentHeight=a.present_size.height,n.profile=a.profile_string,n.level=a.level_string,n.bitDepth=a.bit_depth,n.chromaFormat=a.chroma_format,n.sarRatio=a.sar_ratio,n.frameRate=a.frame_rate,!1!==a.frame_rate.fixed&&0!==a.frame_rate.fps_num&&0!==a.frame_rate.fps_den||(n.frameRate=this._referenceFrameRate);let d=n.frameRate.fps_den,l=n.frameRate.fps_num;n.refSampleDuration=n.timescale*(d/l);let c=r.subarray(1,4),p="avc1.";for(let e=0;e<3;e++){let t=c[e].toString(16);t.length<2&&(t="0"+t),p+=t}n.codec=p;let f=this._mediaInfo;f.width=n.codecWidth,f.height=n.codecHeight,f.fps=n.frameRate.fps,f.profile=n.profile,f.level=n.level,f.refFrames=a.ref_frames,f.chromaFormat=a.chroma_format_string,f.sarNum=n.sarRatio.width,f.sarDen=n.sarRatio.height,f.videoCodec=p,f.hasAudio?null!=f.audioCodec&&(f.mimeType='video/x-flv; codecs="'+f.videoCodec+","+f.audioCodec+'"'):f.mimeType='video/x-flv; codecs="'+f.videoCodec+'"',f.isComplete()&&this._onMediaInfo(f)}let c=s.getUint8(u);if(0!==c){c>1&&this.logger.warn(`Strange AVCDecoderConfigurationRecord: PPS Count = ${c}`),u++;for(let e=0;e<c;e++){let e=s.getUint16(u,!o);u+=2,0!==e&&(u+=e)}n.avcc=new Uint8Array(i),n.avcc.set(new Uint8Array(e,t,i),0),this.logger.info("Parsed AVCDecoderConfigurationRecord"),this._isInitialMetadataDispatched()?(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._onTrackMetadata("video",n)}else this._onError(fo,"Invalid AVCDecoderConfigurationRecord: No PPS")}_parseHEVCDecoderConfigurationRecord(e){let t=this._videoMetadata,i=this._videoTrack;this._littleEndian;t?void 0!==t.hvcc&&this.logger.warn("Found another HEVCDecoderConfigurationRecord!"):(!1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),t=this._videoMetadata={},t.type="video",t.id=i.id,t.timescale=this._timescale,t.duration=this._duration);const n=Kr(e);n?(t=this._videoMetadata=Object.assign(Object.assign({},t),n),this._isInitialMetadataDispatched()?(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._onTrackMetadata("video",t)):this._onError("DecodeError","cannot parse hevc configuration record")}_isInitialMetadataDispatched(){return this._hasAudio&&this._hasVideo?this._audioInitialMetadataDispatched&&this._videoInitialMetadataDispatched:this._hasAudio&&!this._hasVideo?this._audioInitialMetadataDispatched:!(this._hasAudio||!this._hasVideo)&&this._videoInitialMetadataDispatched}_onMediaInfo(e){this.onMediaInfo(e)}_onDataAvailable(e,t){this.onDataAvailable(e,t)}_onTrackMetadata(e,t){this.logger.info("on track meta data "+e+" "+JSON.stringify(t)),this.onTrackMetadata(e,t)}onDataAvailable(e,t){}onTrackMetadata(e,t){}onMediaInfo(e){}initAudioMeta(e,t){let i=this._audioMetadata,n=this._audioTrack;return i||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),i=this._audioMetadata={},i.type="audio",i.id=n.id,i.timescale=this._timescale,i.duration=this._duration,i.audioSampleRate=e,i.channelCount=0===t?1:2),i}setAudioMetaByAudioSpecificConfig(e,t){t.config&&this.logger.warn("MseDecoder Found another AudioSpecificConfig!");let i=e.data;t.audioSampleRate=i.samplingRate,t.channelCount=i.channelCount,t.codec=i.codec,t.originalCodec=i.originalCodec,t.config=i.config,t.refSampleDuration=1024/t.audioSampleRate*t.timescale,this.logger.info("MseDecoder Parsed AudioSpecificConfig"),this._isInitialMetadataDispatched()?(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._onTrackMetadata("audio",t);let n=this._mediaInfo;n.audioCodec=t.originalCodec,n.audioSampleRate=t.audioSampleRate,n.audioChannelCount=t.channelCount,n.hasVideo?null!=n.videoCodec&&(n.mimeType='video/x-flv; codecs="'+n.videoCodec+","+n.audioCodec+'"'):n.mimeType='video/x-flv; codecs="'+n.audioCodec+'"',n.isComplete()&&this._onMediaInfo(n)}addAudioTrackSample(e,t){let i=this._audioTrack,n=this._timestampBase+t,r={unit:e.data,length:e.data.byteLength,dts:n,pts:n};i.samples.push(r),i.length+=e.data.length}flushVideoData(){this._hasVideo=this.formatContext.hasVideo(),this._videoTrack={type:"video",id:1,sequenceNumber:0,samples:[],length:0},this._videoInitialMetadataDispatched=!1,this._videoMetadata=null,this._hasVideoFlagOverrided=!1}flushAudioData(){this._hasAudio=this.formatContext.hasAudio(),this._audioTrack={type:"audio",id:2,sequenceNumber:0,samples:[],length:0},this._audioInitialMetadataDispatched=!1,this._audioMetadata=null,this._hasAudioFlagOverrided=!1}reset(){this._mediaInfo=new mo,this.flushAudioData(),this.flushVideoData(),this._duration=0}configureAudio(e,t){if(e!==gi.AAC)return void this._onError("DecodeError","unsupport audio codec ID "+e);this._audioInitialMetadataDispatched=!1,this.flushAudioData();const i=this.initAudioMeta(0,0);let n={};if(n.data=this._parseAACAudioSpecificConfig(t.buffer,0,t.byteLength),!n.data)throw this.logger.error("Unsupported to Configure AAC data."),new Nt("Unsupported to Configure AAC Description");this.setAudioMetaByAudioSpecificConfig(n,i)}decodeAudioPacket(e){if(!this.isAudioMetadataParsed)return;const{payload:t,pts:i}=e;let n={};if(n.data=t,t.length<=0)throw this.logger.error("Unsupported to Parse AAC Payload"),new Nt("Unsupported to Parse AAC Payload");this.addAudioTrackSample(n,i),this._isInitialMetadataDispatched()&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack)}configureVideo(e,t){e===gi.H264||e===gi.H265?(this._videoInitialMetadataDispatched=!1,this.flushVideoData(),e===gi.H264?this._parseAVCDecoderConfigurationRecord(t.buffer,0,t.byteLength):this._parseHEVCDecoderConfigurationRecord(t)):this._onError("DecodeError","MSE unsupport video codec ID "+e)}decodeVideoPacket(e){if(!this.isVideoMetadataParsed)return;const{payload:t,cts:i,dts:n}=e,r=this.formatContext.videoCodecID;this._parseVideoData(t.buffer,r,n,e.isKeyFrame,i),this._isInitialMetadataDispatched()&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack)}destroy(){this.reset(),this.formatContext.event.off(mi.MediaFormatChange,this.e.onFormatUpdate)}onError(e){}}var _o=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Co=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Eo=function(e,t){return function(i,n){t(i,n,e)}};let So=class{get useDecodeType(){return this.optionContext.getDecodeType()}get useWebCodec(){return"WebCodecs"===this.useDecodeType}get useMSE(){return"MSE"===this.useDecodeType}constructor(e,t,i,n,r,o,s,a,d,l){this.wasmFactory=e,this.audioFrameQueue=t,this.videoFrameQueue=i,this.lm=n,this.optionContext=r,this.globalEvent=o,this.playerState=s,this.webCodecBuilder=a,this.mseContextSingleton=d,this.decodeOperatorSingleton=l,this.audioDecoder=null,this.videoDecoder=null,this.decodeTaskQueue=new wr,this.decodeOperator=null,this.switchingVideoDecoder=!1,this.switchingAudioDecoder=!1,this.mseContext=null,this.logger=n.createLogger("d.dc"),this.createOperator(),this.createDecoder(),this.logger.info("use decode type "+this.useDecodeType),this.globalEvent.event.once(di.DESTROY,(()=>this.destroy())),this.globalEvent.event.on(di.MEDIA_FETCH_END,(()=>{this.logger.warn("media fetch ended. stop decode"),this.stopDecode()})),this.globalEvent.event.on(di.WEB_CODEC_ERROR,(()=>{this.optionContext.setWebCodecFailed(),this.logger.warn("WebCodecs decode Error occur, switching decoder"),this.optionContext.useWasm()?(this.logger.info("switch video decoder to wasm"),this.switchVidDecoder()):this.optionContext.useMse()&&(this.logger.info("switch decoder to mse"),this.getMseContext().reinit(),this.switchVidDecoder(),this.switchAudioDecoder())})),this.globalEvent.event.on(di.MSE_ERROR,(()=>{this.logger.warn("MSE Error occur, switching decoder"),this.optionContext.setMseFailed(),this.optionContext.useWasm()&&(this.logger.info("witch video & audio decoder to wasm"),this.switchVidDecoder(),this.switchAudioDecoder())})),this.globalEvent.event.on(di.MSE_DURATION_ERROR,(()=>{var e;this.logger.warn("MSE Duration Error occur, restart decoder"),this.optionContext.useMse()&&(this.logger.info("reset & restart mse context"),this.getMseContext().reinit(),null===(e=this.decodeOperator)||void 0===e||e.restart())}))}reset(){var e;this.audioFrameQueue.clear(),this.videoFrameQueue.clear(),null===(e=this.decodeOperator)||void 0===e||e.reset(),this.mseContext&&this.optionContext.useMse()&&this.mseContext.reinit()}createOperatorTask(){if(!this.audioDecoder||!this.videoDecoder)throw this.logger.error("no audio and video decoder, cannot create operator."),new Nt("no audio and video decoder, cannot create operator.");this.logger.info("create decode operator."),this.decodeOperator=this.decodeOperatorSingleton(),this.decodeOperator.initDecoder(this.audioDecoder,this.videoDecoder)}createOperator(){this.decodeTaskQueue.pushTask(this.createOperatorTask.bind(this))}checkAndRunDecodeTaskQueue(){this.audioDecoder&&this.videoDecoder&&this.decodeTaskQueue.runAllTask()}switchVidDecoder(){var e,t;if(this.switchingVideoDecoder)return;this.logger.info("switching video decoder"),null===(e=this.decodeOperator)||void 0===e||e.switchVideoDecoder(null),null===(t=this.videoDecoder)||void 0===t||t.destroy(),this.videoDecoder=null,this.switchingVideoDecoder=!0;this.decodeTaskQueue.pushTask((()=>{var e;if(this.logger.info("new decoder created."),!this.decodeOperator)return this.logger.error("switch decoder failed, no decode operation"),void(this.switchingVideoDecoder=!1);null===(e=this.decodeOperator)||void 0===e||e.switchVideoDecoder(this.videoDecoder),this.switchingVideoDecoder=!1})),this.createVideoDecoder()}switchAudioDecoder(){var e,t;if(this.switchingAudioDecoder)return;this.logger.info("switching audio decoder"),null===(e=this.decodeOperator)||void 0===e||e.switchAudioDecoder(null),null===(t=this.audioDecoder)||void 0===t||t.destroy(),this.audioDecoder=null,this.switchingAudioDecoder=!0;this.decodeTaskQueue.pushTask((()=>{var e;if(this.logger.info("new decoder created."),!this.decodeOperator)return this.logger.error("switch decoder failed, no decode operation"),void(this.switchingAudioDecoder=!1);null===(e=this.decodeOperator)||void 0===e||e.switchAudioDecoder(this.audioDecoder),this.switchingAudioDecoder=!1})),this.createAudioDecoder()}getMseContext(){return this.mseContext||(this.mseContext=this.mseContextSingleton()),this.mseContext}getMSETrackMaker(){return this.getMseContext().coreTrackMaker}createVideoDecoder(){if(this.useWebCodec)this.logger.info("using webcodec decoder."),this.videoDecoder=this.webCodecBuilder(),this.videoDecoder.onError=e=>{this.logger.error("webcodec decoder error. "+e),this.globalEvent.event.emit(di.WEB_CODEC_ERROR)},this.checkAndRunDecodeTaskQueue();else if(this.useMSE){this.logger.info("using MSE decode");const e=this.getMSETrackMaker();this.videoDecoder=new vo(e,this.playerState,this.lm),this.videoDecoder.onError=e=>{this.logger.error("mse make video track error. "+e),this.globalEvent.event.emit(di.MSE_ERROR)},this.checkAndRunDecodeTaskQueue()}else this.wasmFactory.createVideoDecoder().then((e=>{this.logger.info("using wasm video decoder."),this.videoDecoder=e,this.checkAndRunDecodeTaskQueue()}))}createAudioDecoder(){if(this.useMSE){this.logger.info("new mse decoder created.");const e=this.getMSETrackMaker();this.audioDecoder=new go(e,this.playerState,this.lm),this.audioDecoder.onError=e=>{this.logger.error("mse make audio track error. "+e),this.globalEvent.event.emit(di.MSE_ERROR)},this.checkAndRunDecodeTaskQueue()}else this.wasmFactory.createAudioDecoder().then((e=>{this.logger.info("using wasm audio decoder."),this.audioDecoder=e,this.checkAndRunDecodeTaskQueue()}))}createDecoder(){this.createVideoDecoder(),this.createAudioDecoder()}createDecodeTask(){return()=>{var e;this.logger.info("decode operator start decode."),null===(e=this.decodeOperator)||void 0===e||e.startDecode()}}startDecode(){const e=this.createDecodeTask();this.decodeOperator?e():this.decodeTaskQueue.pushTask(e)}createStopDecodeTask(){return()=>{var e;this.logger.info("stop decode operator."),null===(e=this.decodeOperator)||void 0===e||e.stopDecode()}}stopDecode(){const e=this.createStopDecodeTask();this.decodeOperator?e():this.decodeTaskQueue.pushTask(e)}destroy(){var e,t;this.stopDecode(),null===(e=this.videoDecoder)||void 0===e||e.destroy(),null===(t=this.audioDecoder)||void 0===t||t.destroy()}};_o([Ht("r"),Co("design:type",Function),Co("design:paramtypes",[]),Co("design:returntype",void 0)],So.prototype,"reset",null),_o([Ht("swd.v"),Co("design:type",Function),Co("design:paramtypes",[]),Co("design:returntype",void 0)],So.prototype,"switchVidDecoder",null),_o([Ht("swd.a"),Co("design:type",Function),Co("design:paramtypes",[]),Co("design:returntype",void 0)],So.prototype,"switchAudioDecoder",null),_o([Ht("sd.0"),Co("design:type",Function),Co("design:paramtypes",[]),Co("design:returntype",void 0)],So.prototype,"startDecode",null),_o([Ht("sd.1"),Co("design:type",Function),Co("design:paramtypes",[]),Co("design:returntype",void 0)],So.prototype,"stopDecode",null),So=_o([it(),Eo(0,mt(tt.WasmFactory)),Eo(1,mt(tt.AudioFrameQueue)),Eo(2,mt(tt.VideoFrameQueue)),Eo(3,mt(tt.LogMana)),Eo(4,mt(tt.OptionsContext)),Eo(5,mt(tt.GlobalEvent)),Eo(6,mt(tt.PlayerState)),Eo(7,mt(tt.WebCodecDecoderBuilder)),Eo(8,mt(tt.MseContextBuilder)),Eo(9,mt(tt.DecodeOperatorBuilder)),Co("design:paramtypes",[Object,Object,Object,$t,Object,Object,Object,Function,Function,Function])],So);class wo{static init(){wo.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],hvc1:[],hvcC:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],".mp3":[]};for(let t in wo.types)wo.types.hasOwnProperty(t)&&(wo.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);let e=wo.constants={};e.FTYP=new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),e.STSD_PREFIX=new Uint8Array([0,0,0,0,0,0,0,1]),e.STTS=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSC=e.STCO=e.STTS,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.HDLR_VIDEO=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),e.HDLR_AUDIO=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),e.DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}static box(e){let t=8,i=null,n=Array.prototype.slice.call(arguments,1),r=n.length;for(let s=0;s<r;s++)t+=n[s].byteLength;i=new Uint8Array(t),i[0]=t>>>24&255,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=255&t,i.set(e,4);let o=8;for(let s=0;s<r;s++)i.set(n[s],o),o+=n[s].byteLength;return i}static generateInitSegment(e){let t=wo.box(wo.types.ftyp,wo.constants.FTYP),i=wo.moov(e),n=new Uint8Array(t.byteLength+i.byteLength);return n.set(t,0),n.set(i,t.byteLength),n}static moov(e){let t=wo.mvhd(e.timescale,e.duration),i=wo.trak(e),n=wo.mvex(e);return wo.box(wo.types.moov,t,i,n)}static mvhd(e,t){return wo.box(wo.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))}static trak(e){return wo.box(wo.types.trak,wo.tkhd(e),wo.mdia(e))}static tkhd(e){let t=e.id,i=e.duration,n=e.presentWidth,r=e.presentHeight;return wo.box(wo.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>>8&255,255&n,0,0,r>>>8&255,255&r,0,0]))}static mdia(e){return wo.box(wo.types.mdia,wo.mdhd(e),wo.hdlr(e),wo.minf(e))}static mdhd(e){let t=e.timescale,i=e.duration;return wo.box(wo.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]))}static hdlr(e){let t=null;return t="audio"===e.type?wo.constants.HDLR_AUDIO:wo.constants.HDLR_VIDEO,wo.box(wo.types.hdlr,t)}static minf(e){let t=null;return t="audio"===e.type?wo.box(wo.types.smhd,wo.constants.SMHD):wo.box(wo.types.vmhd,wo.constants.VMHD),wo.box(wo.types.minf,t,wo.dinf(),wo.stbl(e))}static dinf(){return wo.box(wo.types.dinf,wo.box(wo.types.dref,wo.constants.DREF))}static stbl(e){return wo.box(wo.types.stbl,wo.stsd(e),wo.box(wo.types.stts,wo.constants.STTS),wo.box(wo.types.stsc,wo.constants.STSC),wo.box(wo.types.stsz,wo.constants.STSZ),wo.box(wo.types.stco,wo.constants.STCO))}static stsd(e){return"audio"===e.type?"mp3"===e.codec?wo.box(wo.types.stsd,wo.constants.STSD_PREFIX,wo.mp3(e)):wo.box(wo.types.stsd,wo.constants.STSD_PREFIX,wo.mp4a(e)):"video"===e.type&&e.codec.startsWith("hvc1")?wo.box(wo.types.stsd,wo.constants.STSD_PREFIX,wo.hvc1(e)):wo.box(wo.types.stsd,wo.constants.STSD_PREFIX,wo.avc1(e))}static mp3(e){let t=e.channelCount,i=e.audioSampleRate,n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,i>>>8&255,255&i,0,0]);return wo.box(wo.types[".mp3"],n)}static mp4a(e){let t=e.channelCount,i=e.audioSampleRate,n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,i>>>8&255,255&i,0,0]);return wo.box(wo.types.mp4a,n,wo.esds(e))}static esds(e){let t=e.config||[],i=t.length,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return wo.box(wo.types.esds,n)}static avc1(e){let t=e.avcc,i=e.codecWidth,n=e.codecHeight,r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,i>>>8&255,255&i,n>>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return wo.box(wo.types.avc1,r,wo.box(wo.types.avcC,t))}static hvc1(e){let t=e.hvcc,i=e.codecWidth,n=e.codecHeight,r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,i>>>8&255,255&i,n>>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return wo.box(wo.types.hvc1,r,wo.box(wo.types.hvcC,t))}static mvex(e){return wo.box(wo.types.mvex,wo.trex(e))}static trex(e){let t=e.id,i=new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return wo.box(wo.types.trex,i)}static moof(e,t){return wo.box(wo.types.moof,wo.mfhd(e.sequenceNumber),wo.traf(e,t))}static mfhd(e){let t=new Uint8Array([0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e]);return wo.box(wo.types.mfhd,t)}static traf(e,t){let i=e.id,n=wo.box(wo.types.tfhd,new Uint8Array([0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i])),r=wo.box(wo.types.tfdt,new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t])),o=wo.sdtp(e),s=wo.trun(e,o.byteLength+16+16+8+16+8+8);return wo.box(wo.types.traf,n,r,s,o)}static sdtp(e){let t=e.samples||[],i=t.length,n=new Uint8Array(4+i);for(let r=0;r<i;r++){let e=t[r].flags;n[r+4]=e.isLeading<<6|e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy}return wo.box(wo.types.sdtp,n)}static trun(e,t){let i=e.samples||[],n=i.length,r=12+16*n,o=new Uint8Array(r);t+=8+r,o.set([0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,255&n,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0);for(let s=0;s<n;s++){let e=i[s].duration,t=i[s].size,n=i[s].flags,r=i[s].cts;o.set([e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.isNonSync,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r],12+16*s)}return wo.box(wo.types.trun,o)}static mdat(e){return wo.box(wo.types.mdat,e)}}wo.init();const Ro=wo;let Do={};!function(){let e=self.navigator.userAgent.toLowerCase(),t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(firefox)[ \/]([\w.]+)/.exec(e)||[],i=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(android)/.exec(e)||/(windows)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||[],n={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",majorVersion:t[4]||t[2]||"0",platform:i[0]||""},r={};if(n.browser){r[n.browser]=!0;let e=n.majorVersion.split(".");r.version={major:parseInt(n.majorVersion,10),string:n.version},e.length>1&&(r.version.minor=parseInt(e[1],10)),e.length>2&&(r.version.build=parseInt(e[2],10))}if(n.platform&&(r[n.platform]=!0),(r.chrome||r.opr||r.safari)&&(r.webkit=!0),r.rv||r.iemobile){r.rv&&delete r.rv;let e="msie";n.browser=e,r[e]=!0}if(r.edge){delete r.edge;let e="msedge";n.browser=e,r[e]=!0}if(r.opr){let e="opera";n.browser=e,r[e]=!0}if(r.safari&&r.android){let e="android";n.browser=e,r[e]=!0}r.name=n.browser,r.platform=n.platform;for(let o in Do)Do.hasOwnProperty(o)&&delete Do[o];Object.assign(Do,r)}();const Ao=Do;class Po{constructor(e,t,i,n,r){this.dts=e,this.pts=t,this.duration=i,this.originalDts=n,this.isSyncPoint=r}}class Fo{constructor(){this.syncPoints=[],this.beginDts=0,this.endDts=0,this.beginPts=0,this.endPts=0,this.originalBeginDts=0,this.originalEndDts=0,this.syncPoints=[],this.firstSample=null,this.lastSample=null}appendSyncPoint(e){e.isSyncPoint=!0,this.syncPoints.push(e)}}class To{constructor(){this._list=[]}clear(){this._list=[]}appendArray(e){let t=this._list;0!==e.length&&(t.length>0&&e[0].originalDts<t[t.length-1].originalDts&&this.clear(),Array.prototype.push.apply(t,e))}getLastSyncPointBeforeDts(e){if(0==this._list.length)return null;let t=this._list,i=0,n=t.length-1,r=0,o=0,s=n;for(e<t[0].dts&&(i=0,o=s+1);o<=s;){if(r=o+Math.floor((s-o)/2),r===n||e>=t[r].dts&&e<t[r+1].dts){i=r;break}t[r].dts<e?o=r+1:s=r-1}return this._list[i]}}class xo{constructor(e){this._type=e,this._list=[],this._lastAppendLocation=-1}get type(){return this._type}get length(){return this._list.length}isEmpty(){return 0===this._list.length}clear(){this._list=[],this._lastAppendLocation=-1}_searchNearestSegmentBefore(e){let t=this._list;if(0===t.length)return-2;let i=t.length-1,n=0,r=0,o=i,s=0;if(e<t[0].originalBeginDts)return s=-1,s;for(;r<=o;){if(n=r+Math.floor((o-r)/2),n===i||e>t[n].lastSample.originalDts&&e<t[n+1].originalBeginDts){s=n;break}t[n].originalBeginDts<e?r=n+1:o=n-1}return s}_searchNearestSegmentAfter(e){return this._searchNearestSegmentBefore(e)+1}append(e){let t=this._list,i=e,n=this._lastAppendLocation,r=0;-1!==n&&n<t.length&&i.originalBeginDts>=t[n].lastSample.originalDts&&(n===t.length-1||n<t.length-1&&i.originalBeginDts<t[n+1].originalBeginDts)?r=n+1:t.length>0&&(r=this._searchNearestSegmentBefore(i.originalBeginDts)+1),this._lastAppendLocation=r,this._list.splice(r,0,i)}getLastSegmentBefore(e){let t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}getLastSampleBefore(e){let t=this.getLastSegmentBefore(e);return null!=t?t.lastSample:null}getLastSyncPointBefore(e){let t=this._searchNearestSegmentBefore(e),i=this._list[t].syncPoints;for(;0===i.length&&t>0;)t--,i=this._list[t].syncPoints;return i.length>0?i[i.length-1]:null}}const ko={enableStashBuffer:!0,stashInitialSize:void 0,isLive:!0,lazyLoad:!0,lazyLoadMaxDuration:180,lazyLoadRecoverDuration:30,deferLoadAfterSourceOpen:!0,autoCleanupSourceBuffer:!0,autoCleanupMaxBackwardDuration:30,autoCleanupMinBackwardDuration:20,statisticsInfoReportInterval:600,fixAudioTimestampGap:!0,accurateSeek:!1,seekType:"range",seekParamStart:"bstart",seekParamEnd:"bend",rangeLoadZeroStart:!1,customSeekHandler:void 0,reuseRedirectedURL:!1,headers:void 0,customLoader:void 0};function Mo(){return Object.assign({},ko)}const Oo=class{constructor(e,t){this.lm=e,this.formatContext=t,this._audioStashedLastSample=null,this._videoStashedLastSample=null,this.logger=this.lm.createLogger("mse.m4r"),this._config=Mo(),this._isLive=!0===this._config.isLive,this._dtsBase=-1,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioMeta=null,this._videoMeta=null,this._videoSegmentInfoList=new xo("video"),this._onInitSegment=null,this._onMediaSegment=null,this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._forceFirstIDR=!(!Ao.chrome||!(Ao.version.major<50||50===Ao.version.major&&Ao.version.build<2661)),this._fillSilentAfterSeek=Ao.msedge||Ao.msie,this._mp3UseMpegAudio=!Ao.firefox,this._fillAudioTimestampGap=this._config.fixAudioTimestampGap}destroy(){var e;this._dtsBase=-1,this._dtsBaseInited=!1,this._audioMeta=null,this._videoMeta=null,null===(e=this._videoSegmentInfoList)||void 0===e||e.clear(),this._videoSegmentInfoList=null,this._onInitSegment=null,this._onMediaSegment=null}bindDataSource(e){return e.onTrackMetadata=this._onTrackMetadataReceived.bind(this),e.onDataAvailable=this.remux.bind(this),this}get onInitSegment(){return this._onInitSegment}set onInitSegment(e){this._onInitSegment=e}get onMediaSegment(){return this._onMediaSegment}set onMediaSegment(e){this._onMediaSegment=e}remux(e,t){if(!this._onMediaSegment)throw new Mr("MP4Remuxer: onMediaSegment callback must be specificed!");this._dtsBaseInited||this._calculateDtsBase(e,t),this._dtsBaseInited?(this._remuxVideo(t),this._remuxAudio(e)):this.logger.throttleInfo("dts base didn't init, pause remux tracks",1e3)}_onTrackMetadataReceived(e,t){let i=null,n="mp4",r=t.codec;if("audio"===e)this._audioMeta=t,"mp3"===t.codec&&this._mp3UseMpegAudio?(n="mpeg",r="",i=new Uint8Array):i=Ro.generateInitSegment(t);else{if("video"!==e)return;this._videoMeta=t,i=Ro.generateInitSegment(t)}if(!this._onInitSegment)throw new Mr("MP4Remuxer: onInitSegment callback must be specified!");this.logger.info("onInitSegment "+e+" "+`${e}/${n} `+r+" "+t.duration),this._onInitSegment(e,{type:e,data:i.buffer,codec:r,container:`${e}/${n}`,mediaDuration:t.duration})}_calculateDtsBase(e,t){if(!this._dtsBaseInited){if(this.formatContext.hasAudio()&&this.formatContext.hasVideo()){if(!(e.samples&&e.samples.length&&t.samples&&t.samples.length))return void this.logger.throttleInfo("a/v sample not enough to set dts base.")}else if(this.formatContext.hasAudio()){if(!e.samples||!e.samples.length)return void this.logger.throttleInfo("audio sample not enough to set dts base.")}else if(!t.samples||!t.samples.length)return void this.logger.throttleInfo("video sample not enough to set dts base.");e.samples&&e.samples.length&&(this._audioDtsBase=e.samples[0].dts),t.samples&&t.samples.length&&(this._videoDtsBase=t.samples[0].dts),this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase),this._dtsBaseInited=!0,this.logger.info(`set dts base ${this._dtsBase}, min(${this._audioDtsBase},${this._videoDtsBase})`)}}flushStashedSamples(){this._remuxVideo({type:"video",id:1,sequenceNumber:0,samples:[],length:0},!0),this._remuxAudio({type:"audio",id:2,sequenceNumber:0,samples:[],length:0},!0)}_remuxAudio(e,t){var i,n,r,o;if(null==this._audioMeta)return;let s,a=e,d=a.samples,l=-1,u=-1,c=this._audioMeta.refSampleDuration,h="mp3"===this._audioMeta.codec&&this._mp3UseMpegAudio,p=this._dtsBaseInited&&void 0===this._audioNextDts,f=!1;if(!d||0===d.length)return;if(1===d.length&&!t)return;let m=!1;for(let P=0;P<d.length;P++){d[P].dts<d[P>0?P-1:P].dts&&(m=!0)}m&&(this.logger.info("sort audio samples order by dts then pts."),d.sort((function(e,t){const i=e.dts-t.dts,n=e.pts-t.pts;return i||n})));let g=0,y=null,v=0;h?(g=0,v=a.length):(g=8,v=8+a.length);let b=null;if(d.length>1&&(b=d.pop(),v-=b.length),null!=this._audioStashedLastSample){let e=this._audioStashedLastSample;this._audioStashedLastSample=null,d.unshift(e),v+=e.length}null!=b&&(this._audioStashedLastSample=b);let _=d[0].dts-this._dtsBase;if(this._audioNextDts)s=_-this._audioNextDts;else if(null===(i=this._audioSegmentInfoList)||void 0===i?void 0:i.isEmpty())s=0,this._fillSilentAfterSeek&&!(null===(n=this._videoSegmentInfoList)||void 0===n?void 0:n.isEmpty())&&"mp3"!==this._audioMeta.originalCodec&&(f=!0);else{let e=null===(r=this._audioSegmentInfoList)||void 0===r?void 0:r.getLastSampleBefore(_);if(null!=e){let t=_-(e.originalDts+e.duration);t<=3&&(t=0),s=_-(e.dts+e.duration+t)}else s=0}if(f){let e=_-s,t=null===(o=this._videoSegmentInfoList)||void 0===o?void 0:o.getLastSegmentBefore(_);if(null!=t&&t.beginDts<e){let i=Ur.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);if(i){let n=t.beginDts,r=e-t.beginDts;this.logger.warn(`InsertPrefixSilentAudio: dts: ${n}, duration: ${r}`),d.unshift({unit:i,dts:n,pts:n}),v+=i.byteLength}}else f=!1}let C=[],E=!1;this._audioNextDts||(E=!0);for(let P=0;P<d.length;P++){let e=d[P],t=e.unit,i=e.dts-this._dtsBase;0===P&&E&&i>0&&(i=0);let n=i,r=!1,o=null,a=0;if(!(i<-.001)){if("mp3"!==this._audioMeta.codec){let e=i;const d=3;if(this._audioNextDts&&(e=this._audioNextDts),s=i-e,s<=-d*c){this.logger.info(`Dropping 1 audio frame (originalDts: ${i} ms ,curRefDts: ${e} ms)  due to dtsCorrection: ${s} ms overlap.`);continue}if(s>=d*c&&this._fillAudioTimestampGap){r=!0;let d=Math.floor(s/c);this.logger.info(`Large audio timestamp gap detected, may cause AV sync to drift. Silent frames will be generated to avoid unsync. originalDts: ${i} ms, curRefDts: ${e} ms, dtsCorrection: ${Math.round(s)} ms, generate: ${d} frames`),n=Math.floor(e),a=Math.floor(e+c)-n;let l=Ur.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);null==l&&(this.logger.warn(`Unable to generate silent frame for ${this._audioMeta.originalCodec} with ${this._audioMeta.channelCount} channels, repeat last frame`),l=t),o=[];for(let t=0;t<d;t++){e+=c;let t=Math.floor(e),n=Math.floor(e+c)-t,r={dts:t,pts:t,cts:0,unit:l,size:l.byteLength,duration:n,originalDts:i,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};o.push(r),v+=r.size}this._audioNextDts=e+c}else n=Math.floor(e),a=Math.floor(e+c)-n,this._audioNextDts=e+c}else{n=i-s;let e=0;P!==d.length-1?(e=d[P+1].dts-this._dtsBase-s,a=e-n):null!=b?(e=b.dts-this._dtsBase-s,a=e-n):a=C.length>=1?C[C.length-1].duration:Math.floor(c),this._audioNextDts=n+a,a<=0&&this.logger.throttleError(`audio sampleDuration error: ${a} ${e} ${n} ${s}`)}-1===l&&(l=n),C.push({dts:n,pts:n,cts:0,unit:e.unit,size:e.unit.byteLength,duration:a,originalDts:i,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}}),r&&C.push.apply(C,o)}}if(0===C.length)return a.samples=[],void(a.length=0);h?y=new Uint8Array(v):(y=new Uint8Array(v),y[0]=v>>>24&255,y[1]=v>>>16&255,y[2]=v>>>8&255,y[3]=255&v,y.set(Ro.types.mdat,4));for(let P=0;P<C.length;P++){let e=C[P].unit;y.set(e,g),g+=e.byteLength}let S=C[C.length-1];u=S.dts+S.duration;let w=new Fo;w.beginDts=l,w.endDts=u,w.beginPts=l,w.endPts=u,w.originalBeginDts=C[0].originalDts,w.originalEndDts=S.originalDts+S.duration,w.firstSample=new Po(C[0].dts,C[0].pts,C[0].duration,C[0].originalDts,!1),w.lastSample=new Po(S.dts,S.pts,S.duration,S.originalDts,!1),!this._isLive&&this._audioSegmentInfoList&&this._audioSegmentInfoList.append(w),a.samples=C,a.sequenceNumber++;let R=null;R=h?new Uint8Array:Ro.moof(a,l),a.samples=[],a.length=0;let D={type:"audio",data:this._mergeBoxes(R,y).buffer,sampleCount:C.length,info:w};h&&p&&(D.timestampOffset=l);let A=0;C.length>0&&C.forEach((e=>A+=e.duration)),this._onMediaSegment&&this._onMediaSegment("audio",D)}_remuxVideo(e,t){if(null==this._videoMeta)return;let i,n=e,r=n.samples,o=-1,s=-1,a=-1,d=-1;if(!r||0===r.length)return;if(1===r.length&&!t)return;let l=8,u=null,c=8+e.length,h=!1;for(let C=0;C<r.length;C++){r[C].dts<r[C>0?C-1:C].dts&&(h=!0)}h&&(this.logger.info("sort video samples order by dts then pts."),r.sort((function(e,t){const i=e.dts-t.dts,n=e.pts-t.pts;return i||n})));let p=null;if(r.length>1&&(p=r.pop(),c-=p.length),null!=this._videoStashedLastSample){let e=this._videoStashedLastSample;this._videoStashedLastSample=null,r.unshift(e),c+=e.length}null!=p&&(this._videoStashedLastSample=p);let f=r[0].dts-this._dtsBase,m=!1;this._videoNextDts?i=f-this._videoNextDts:(i=0,m=!0);let g=new Fo,y=[];for(let C=0;C<r.length;C++){let e=r[C],t=e.dts-this._dtsBase;0===C&&m&&t>0&&(this.logger.info("lengthen first video frame duration."),t=0);let n=e.isKeyframe,s=t-i,d=e.cts,l=s+d;-1===o&&(o=s,a=l);let u=0,c=0;if(C!==r.length-1?(c=r[C+1].dts-this._dtsBase-i,u=c-s):null!=p?(c=p.dts-this._dtsBase-i,u=c-s):u=y.length>=1?y[y.length-1].duration:Math.floor(this._videoMeta.refSampleDuration),u<=0&&this.logger.throttleError(`video sampleDuration error: ${u} ${c} ${s} ${i}`),n){let t=new Po(s,l,u,e.dts,!0);g.appendSyncPoint(t)}y.push({dts:s,pts:l,cts:d,units:e.units,size:e.length,isKeyframe:n,duration:u,originalDts:t,flags:{isLeading:0,dependsOn:n?2:1,isDependedOn:n?1:0,hasRedundancy:0,isNonSync:n?0:1}})}u=new Uint8Array(c),u[0]=c>>>24&255,u[1]=c>>>16&255,u[2]=c>>>8&255,u[3]=255&c,u.set(Ro.types.mdat,4);for(let C=0;C<y.length;C++){let e=y[C].units;for(;e.length;){let t=e.shift().data;u.set(t,l),l+=t.byteLength}}let v=y[y.length-1];if(s=v.dts+v.duration,d=v.pts+v.duration,this._videoNextDts=s,g.beginDts=o,g.endDts=s,g.beginPts=a,g.endPts=d,g.originalBeginDts=y[0].originalDts,g.originalEndDts=v.originalDts+v.duration,g.firstSample=new Po(y[0].dts,y[0].pts,y[0].duration,y[0].originalDts,y[0].isKeyframe),g.lastSample=new Po(v.dts,v.pts,v.duration,v.originalDts,v.isKeyframe),!this._isLive&&this._videoSegmentInfoList&&this._videoSegmentInfoList.append(g),n.samples=y,n.sequenceNumber++,this._forceFirstIDR){let e=y[0].flags;e.dependsOn=2,e.isNonSync=0}let b=Ro.moof(n,o);n.samples=[],n.length=0;let _=0;y.length>0&&y.forEach((e=>_+=e.duration)),this._onMediaSegment&&this._onMediaSegment("video",{type:"video",data:this._mergeBoxes(b,u).buffer,sampleCount:y.length,info:g,mediaDuration:_})}_mergeBoxes(e,t){let i=new Uint8Array(e.byteLength+t.byteLength);return i.set(e,0),i.set(t,e.byteLength),i}},Io={ERROR:"error",SOURCE_OPEN:"source_open",UPDATE_END:"update_end",BUFFER_FULL:"buffer_full"};class Lo{constructor(e,t){var i;this.logger=t.createLogger("mse.msc"),this._config=Mo(),this._formatContext=e,this._emitter=new(ot()),this._config.isLive&&null==this._config.autoCleanupSourceBuffer&&(this._config.autoCleanupSourceBuffer=!0),this.e={onSourceOpen:this._onSourceOpen.bind(this),onSourceEnded:this._onSourceEnded.bind(this),onSourceClose:this._onSourceClose.bind(this),onSourceBufferError:this._onSourceBufferError.bind(this),onSourceBufferUpdateEnd:this._onSourceBufferUpdateEnd.bind(this)},this.resetStates(),null===(i=this._emitter)||void 0===i||i.on(Io.ERROR,(()=>{this.destroy()}))}resetStates(){this._mediaSource=null,this._mediaSourceObjectURL=null,this._mediaElement=null,this._isBufferFull=!1,this._hasPendingEos=!1,this._requireSetMediaDuration=!1,this._pendingMediaDuration=0,this._pendingSourceBufferInit=[],this._mimeTypes={video:null,audio:null},this._sourceBuffers={video:null,audio:null},this._lastInitSegments={video:null,audio:null},this._pendingSegments={video:[],audio:[]},this._pendingRemoveRanges={video:[],audio:[]},this._idrList=new To}destroy(){var e;this.logger.info("media source control destroy"),(this._mediaElement||this._mediaSource)&&this.detachMediaElement(),null===(e=this._emitter)||void 0===e||e.removeAllListeners(),this._emitter=null,this.resetStates()}on(e,t){var i;null===(i=this._emitter)||void 0===i||i.addListener(e,t)}off(e,t){var i;null===(i=this._emitter)||void 0===i||i.removeListener(e,t)}hasAttachMedia(){return!!this._mediaElement}attachMediaElement(e){if(this._mediaSource)throw new Mr("MediaSource has been attached to an HTMLMediaElement!");let t=this._mediaSource=new window.MediaSource;t.addEventListener("sourceopen",this.e.onSourceOpen),t.addEventListener("sourceended",this.e.onSourceEnded),t.addEventListener("sourceclose",this.e.onSourceClose),this._mediaElement=e,this._mediaSourceObjectURL=window.URL.createObjectURL(this._mediaSource),e.src=this._mediaSourceObjectURL,this.logger.info("attachMediaElement call success")}removeBuffer(e){if(!this._mediaSource)return;let t=this._mediaSource;this._pendingSegments[e]=[],this._pendingRemoveRanges[e]=[],this._lastInitSegments[e]=[];let i=this._sourceBuffers[e];if(i){if("closed"!==t.readyState)try{t.removeSourceBuffer(i)}catch(n){this.logger.error(n.message)}this._mimeTypes[e]=null,this._sourceBuffers[e]=null,i.removeEventListener("error",this.e.onSourceBufferError),i.removeEventListener("updateend",this.e.onSourceBufferUpdateEnd)}this._pendingSourceBufferInit=this._pendingSourceBufferInit.filter((t=>t.type!==e)),this._isBufferFull=!1}detachMediaElement(){if(this._mediaSource){let t=this._mediaSource;for(let i in this._sourceBuffers){this.logger.info("remove source buffer type "+i);const n=i;let r=this._pendingSegments[n];r&&r.splice(0,r.length),this._pendingSegments[n]=null,this._pendingRemoveRanges[n]=null,this._lastInitSegments[n]=null;let o=this._sourceBuffers[n];if(o){if("closed"!==t.readyState)try{t.removeSourceBuffer(o)}catch(e){this.logger.error(e.message)}this._mimeTypes[n]=null,this._sourceBuffers[n]=null,o.removeEventListener("error",this.e.onSourceBufferError),o.removeEventListener("updateend",this.e.onSourceBufferUpdateEnd)}}if("open"===t.readyState)try{t.endOfStream()}catch(e){this.logger.error(e.message)}t.removeEventListener("sourceopen",this.e.onSourceOpen),t.removeEventListener("sourceended",this.e.onSourceEnded),t.removeEventListener("sourceclose",this.e.onSourceClose),this._pendingSourceBufferInit=[],this._isBufferFull=!1,this._idrList.clear(),this._mediaSource=null,this._sourceBuffers.audio=null,this._sourceBuffers.video=null}this._mediaElement&&(this.logger.info("set media element src empty"),this._mediaElement.src="",this._mediaElement.removeAttribute("src"),this._mediaElement=null),this._mediaSourceObjectURL&&(this.logger.info("MediaSource revokeObjectURL"),window.URL.revokeObjectURL(this._mediaSourceObjectURL),this._mediaSourceObjectURL=null),this.logger.info("media source control detach MediaElement success")}_pendingSegmentsEnough(){let e=this._pendingSourceBufferInit.some((e=>"audio"===e.type)),t=this._pendingSourceBufferInit.some((e=>"video"===e.type)),i=!!this._sourceBuffers.audio,n=!!this._sourceBuffers.video;return this._formatContext.hasAudio()&&this._formatContext.hasVideo()?(e||i)&&(t||n):this._formatContext.hasAudio()?e||i:!this._formatContext.hasVideo()||(t||n)}_appendInitSegment(e){var t,i;let n=e,r=`${n.container}`;if(n.codec&&n.codec.length>0&&(r+=`;codecs=${n.codec}`),!MediaSource.isTypeSupported(r))return this.logger.warn("mse unsupported mimeType: "+r),void(null===(t=this._emitter)||void 0===t||t.emit(Io.ERROR));let o=!1;if(this.logger.info("Received Initialization Segment, mimeType: "+r),this._lastInitSegments[n.type]=n,this._mimeTypes[n.type]&&r!==this._mimeTypes[n.type]&&this.logger.info(`Notice: ${n.type} mimeType changed, origin: ${this._mimeTypes[n.type]}, target: ${r}`),this._mediaSource&&r!==this._mimeTypes[n.type]&&!this._mimeTypes[n.type]){let e=this._sourceBuffers[n.type];e&&this.removeBuffer(n.type),o=!0,e=this._sourceBuffers[n.type]=this._mediaSource.addSourceBuffer(r),e.addEventListener("error",this.e.onSourceBufferError),e.addEventListener("updateend",this.e.onSourceBufferUpdateEnd),this._mimeTypes[n.type]=r}o||this._sourceBuffers[n.type]&&!(null===(i=this._sourceBuffers[n.type])||void 0===i?void 0:i.updating)&&this._doAppendSegments(),Ao.safari&&"audio/mpeg"===n.container&&n.mediaDuration>0&&(this._requireSetMediaDuration=!0,this._pendingMediaDuration=n.mediaDuration/1e3,this._updateMediaSourceDuration())}appendInitSegment(e){var t,i;const n=e;if(this._pendingSourceBufferInit.push(n),null===(t=this._pendingSegments[n.type])||void 0===t||t.push(n),!this._mediaSource||"open"!==this._mediaSource.readyState||!this._pendingSegmentsEnough())return;let r=this._pendingSourceBufferInit;try{for(;r.length;){let e=r.shift();e&&this._appendInitSegment(e)}}catch(o){return this.logger.error(o.message),void(null===(i=this._emitter)||void 0===i||i.emit(Io.ERROR))}}appendMediaSegment(e){var t;let i=e;null===(t=this._pendingSegments[i.type])||void 0===t||t.push(i),this._config.autoCleanupSourceBuffer&&this._needCleanupSourceBuffer()&&this._doCleanupSourceBuffer();let n=this._sourceBuffers[i.type];!n||n.updating||this._hasPendingRemoveRanges()||this._doAppendSegments()}endOfStream(){let e=this._mediaSource,t=this._sourceBuffers;e&&"open"===e.readyState?t.video&&t.video.updating||t.audio&&t.audio.updating?this._hasPendingEos=!0:(this._hasPendingEos=!1,e.endOfStream()):e&&"closed"===e.readyState&&this._hasPendingSegments()&&(this._hasPendingEos=!0)}getNearestKeyframe(e){return this._idrList.getLastSyncPointBeforeDts(e)}_needCleanupSourceBuffer(){if(!this._config.autoCleanupSourceBuffer||!this._mediaElement||!this._sourceBuffers)return!1;let e=this._mediaElement.currentTime;for(let t in this._sourceBuffers){let i=this._sourceBuffers[t];if(i){let t=i.buffered;if(t.length>=1&&e-t.start(0)>=this._config.autoCleanupMaxBackwardDuration)return!0}}return!1}_doCleanupSourceBuffer(){var e,t;if(!this._mediaElement)return;let i=this._mediaElement.currentTime;for(let n in this._sourceBuffers){const r=n;let o=this._sourceBuffers[r];if(o){let n=o.buffered,s=!1;for(let o=0;o<n.length;o++){let a=n.start(o),d=n.end(o);if(a<=i&&i<d+3){if(i-a>=this._config.autoCleanupMaxBackwardDuration){s=!0;let t=i-this._config.autoCleanupMinBackwardDuration;null===(e=this._pendingRemoveRanges[r])||void 0===e||e.push({start:a,end:t})}}else d<i&&(s=!0,null===(t=this._pendingRemoveRanges[r])||void 0===t||t.push({start:a,end:d}))}s&&!o.updating&&this._doRemoveRanges()}}}_updateMediaSourceDuration(){let e=this._sourceBuffers;if(!this._mediaElement||!this._mediaSource)return;if(0===this._mediaElement.readyState||"open"!==this._mediaSource.readyState)return;if(e.video&&e.video.updating||e.audio&&e.audio.updating)return;let t=this._mediaSource.duration,i=this._pendingMediaDuration;i>0&&(isNaN(t)||i>t)&&(this.logger.info(`Update MediaSource duration from ${t} to ${i}`),this._mediaSource.duration=i),this._requireSetMediaDuration=!1,this._pendingMediaDuration=0}_doRemoveRanges(){var e;for(let t in this._pendingRemoveRanges){const i=t;if(!this._sourceBuffers[i]||(null===(e=this._sourceBuffers[i])||void 0===e?void 0:e.updating))continue;let n=this._sourceBuffers[i],r=this._pendingRemoveRanges[i];if(!n||!r)return;for(;r.length&&!n.updating;){let e=r.shift();n.remove(e.start,e.end)}}}_doAppendSegments(){var e,t,i;let n=this._pendingSegments;for(let o in n){const s=o;if(!this._sourceBuffers[s]||(null===(e=this._sourceBuffers[s])||void 0===e?void 0:e.updating))continue;const a=n[s],d=this._sourceBuffers[s];if(a&&d&&a.length>0){let e=a.shift();if(e.timestampOffset){let t=d.timestampOffset,i=e.timestampOffset/1e3;Math.abs(t-i)>.1&&(this.logger.info(`Update MPEG audio timestampOffset from ${t} to ${i}`),d.timestampOffset=i),delete e.timestampOffset}if(!e.data||0===e.data.byteLength)continue;try{d.appendBuffer(e.data),this._isBufferFull=!1,"video"===s&&e.hasOwnProperty("info")&&this._idrList.appendArray(e.info.syncPoints)}catch(r){if(a.unshift(e),22===r.code)return this._isBufferFull||(null===(t=this._emitter)||void 0===t||t.emit(Io.ERROR),this.logger.warn("buffer full, rollback to webassembly decode")),void(this._isBufferFull=!0);this.logger.error(r.message),null===(i=this._emitter)||void 0===i||i.emit(Io.ERROR)}}}}_onSourceOpen(){var e,t;if(this.logger.info("MediaSource onSourceOpen"),this._mediaSource){if(this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._pendingSegmentsEnough()){let t=this._pendingSourceBufferInit;try{for(;t.length;){let e=t.shift();e&&this._appendInitSegment(e)}}catch(i){return this.logger.error(i.message),void(null===(e=this._emitter)||void 0===e||e.emit(Io.ERROR))}}this._hasPendingSegments()&&this._doAppendSegments(),null===(t=this._emitter)||void 0===t||t.emit(Io.SOURCE_OPEN)}}_onSourceEnded(){this.logger.info("MediaSource onSourceEnded")}closeMediaSource(){this._mediaSource&&null!=this.e&&(this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._mediaSource.removeEventListener("sourceended",this.e.onSourceEnded),this._mediaSource.removeEventListener("sourceclose",this.e.onSourceClose),this._mediaSource=null)}_onSourceClose(){this.logger.info("MediaSource onSourceClose"),this.closeMediaSource()}_hasPendingSegments(){let e=this._pendingSegments;return e.video&&e.video.length>0||e.audio&&e.audio.length>0}_hasPendingRemoveRanges(){let e=this._pendingRemoveRanges;return e.video&&e.video.length>0||e.audio&&e.audio.length>0}_onSourceBufferUpdateEnd(){var e;this._requireSetMediaDuration?this._updateMediaSourceDuration():this._hasPendingRemoveRanges()?this._doRemoveRanges():this._hasPendingSegments()?this._doAppendSegments():this._hasPendingEos&&this.endOfStream(),null===(e=this._emitter)||void 0===e||e.emit(Io.UPDATE_END)}_onSourceBufferError(e){var t;this.logger.error("SourceBuffer Error"),this.closeMediaSource(),null===(t=this._emitter)||void 0===t||t.emit(Io.ERROR)}}var Bo=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Vo=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Uo=function(e,t){return function(i,n){t(i,n,e)}};let No=class{unbindVideoElement(){const e=this.videoElement;e.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.removeEventListener("seeking",this.e.onvSeeking),e.removeEventListener("canplay",this.e.onvCanPlay),e.removeEventListener("stalled",this.e.onvStalled),e.removeEventListener("progress",this.e.onvProgress),e.removeEventListener("timeupdate",this.e.onvTimeUpdate)}rebindVideoElement(){this.unbindVideoElement();const e=this.videoElement;e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.addEventListener("seeking",this.e.onvSeeking),e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("stalled",this.e.onvStalled),e.addEventListener("progress",this.e.onvProgress),e.addEventListener("timeupdate",this.e.onvTimeUpdate)}constructor(e,t,i,n,r,o){this.uiContainer=e,this.globalEvent=t,this.optionsContext=i,this.playerState=n,this.formatContext=r,this.lm=o,this._receivedCanPlay=!1,this.browser=bi.getBrowser(),this.logger=o.createLogger("mse.mct"),this.e={onvLoadedMetadata:this.onvLoadedMetadata.bind(this),onvSeeking:this.onvSeeking.bind(this),onvCanPlay:this.onvCanPlay.bind(this),onvStalled:this.onvStalled.bind(this),onvProgress:this.onvProgress.bind(this),onvTimeUpdate:this.onvTimeUpdate.bind(this),onMseControllerError:this.onMseControllerError.bind(this)},this.trackMaker=new bo(r,this.lm),this._mp4Remuxer=null,this._mseController=null,this.globalEvent.event.on(di.MSE_ERROR,(()=>{this.end()})),this.globalEvent.event.on(di.WEB_CODEC_ERROR,(()=>{this.optionsContext.setWebCodecFailed(),this.optionsContext.useMse()&&this.reinit()}))}checkAndResumeStuck(e){let t=this.videoElement;if((e||!this._receivedCanPlay||t.readyState<=2)&&!this.videoElement.paused){const e="firefox"!==bi.getBrowser();this.seekToEnd(e)}const i=t.buffered.length;"safari"===this.browser&&t.duration!==1/0&&t.duration>4e6&&i>0&&t.buffered.end(i-1)>0&&t.buffered.end(i-1)<t.duration&&(this.pause(),this.globalEvent.event.emit(di.MSE_DURATION_ERROR))}onvLoadedMetadata(){this.logger.info("Video Element onvLoadedMetadata")}onvSeeking(){let e=this.videoElement.currentTime;this.logger.info("Video Element onvSeeking target "+e)}onvCanPlay(){this._receivedCanPlay=!0,this.logger.info("Video Element onvCanPlay")}onvStalled(){this.logger.info("Video Element onvStalled");let e=this.videoElement,t=e.buffered;t.length>0&&e.currentTime<t.start(0)&&(this.logger.info(`MSEContext Playback seems stuck at ${e.currentTime}, seek to ${t.start(0)}`),e.currentTime=t.start(0))}onvProgress(){this.checkAndResumeStuck()}onvTimeUpdate(){this.seekToEnd()}onMseControllerError(){this.globalEvent.event.emit(di.MSE_ERROR)}seekToEnd(e){const t=this.videoElement.buffered.length;if(t<=0||!this._mseController)return;const i=this.videoElement.buffered.end(t-1);if(i-this.videoElement.currentTime>4&&!this.videoElement.paused){let t=i-2;if(e)return void(this.videoElement.currentTime=t);const n=this._mseController.getNearestKeyframe(Math.floor(t*this.formatContext.timeScale));if(!n)return;t=n.pts/this.formatContext.timeScale,"chrome"===this.browser&&(t=n.dts/this.formatContext.timeScale),t-this.videoElement.currentTime>2&&(this.logger.info(`video current time too late, seek from ${this.videoElement.currentTime} to ${t}, duration ${i}.`),this.videoElement.currentTime=t)}}pause(){this.logger.info("mse context pause"),this.trackMaker.reset(),this._mp4Remuxer&&this._mp4Remuxer.destroy(),this._mp4Remuxer=null,this._receivedCanPlay=!1,this._lastMSEController=this._mseController,this._mseController=null}end(){this.pause(),this.unbindVideoElement()}destroyLastMseController(){this._lastMSEController&&(this._lastMSEController.destroy(),this._lastMSEController=null)}reinit(){this.pause(),this.rebindVideoElement(),this.playerState.currentTimestampOffset=-1,this._mp4Remuxer=new Oo(this.lm,this.formatContext),this._mseController=new Lo(this.formatContext,this.lm),this._mp4Remuxer.bindDataSource(this.trackMaker),this._mp4Remuxer.onInitSegment=(e,t)=>{var i,n,r;(null===(i=this._mseController)||void 0===i?void 0:i.hasAttachMedia())||(this.logger.info("attach MediaElement"),this.destroyLastMseController(),null===(n=this._mseController)||void 0===n||n.attachMediaElement(this.videoElement)),null===(r=this._mseController)||void 0===r||r.appendInitSegment(t)},this._mp4Remuxer.onMediaSegment=(e,t)=>{var i;null===(i=this._mseController)||void 0===i||i.appendMediaSegment(t)},this._mseController.off(Io.ERROR,this.e.onMseControllerError),this._mseController.on(Io.ERROR,this.e.onMseControllerError)}get mediaSourceController(){return this._mseController}get videoElement(){return this.uiContainer.videoElement}get coreTrackMaker(){return this.trackMaker}get mp4Remuxer(){return this._mp4Remuxer}};No=Bo([it(),Uo(0,mt(tt.UIContainer)),Uo(1,mt(tt.GlobalEvent)),Uo(2,mt(tt.OptionsContext)),Uo(3,mt(tt.PlayerState)),Uo(4,mt(tt.FormatContext)),Uo(5,mt(tt.LogMana)),Vo("design:paramtypes",[Object,Object,Object,Object,Object,$t])],No);var jo=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};const Wo="promise aborted";class qo{constructor(){this._map=new Map}get(e){let t=this._map.get(e);return t||(this._map.set(e,new Ho),t=this._map.get(e)),t}reset(){this._map.forEach((e=>{e.reset()})),this._map=new Map}}class Ho{constructor(){this._list=[]}add(...e){this._list.push(...e)}reset(){this._list.forEach((e=>{e.abort(Wo)})),this._list=[]}all(){return jo(this,void 0,void 0,(function*(){const e=[];this._list.forEach((t=>{e.push(t.promise)})),yield Promise.all(e),this._list=[]}))}}class Qo{constructor(e){const t=new Promise(e),i=new Promise(((e,t)=>{this._abort=t}));this._promise=Promise.race([t,i])}get promise(){return this._promise}abort(e){this._abort(e)}}var Go,zo=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ko=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Yo=function(e,t){return function(i,n){t(i,n,e)}};!function(e){e.CHANGING_START="MediachangeStart",e.CHANGING_END="MediachangeEnd"}(Go||(Go={}));let $o=class{get event(){return this._event}constructor(e,t){this.playerState=e,this._mediaPlayer=t,this.shouldReplayMedia=!1,this._changing=!1,this._event=new rt}get changing(){return this._changing}mediaChanging(){this._changing||(this._changing=!0,this._mediaPlayer.onMediaChanging(),this.shouldReplayMedia=this.playerState.isRendering,this.shouldReplayMedia&&this._mediaPlayer.pauseMediaRender(),this._event.emit(Go.CHANGING_START))}cancelMediaChanging(){this._changing=!1,this._mediaPlayer.onMediaChangingEnd(),this.shouldReplayMedia&&this._mediaPlayer.startMediaRender(),this.shouldReplayMedia=!1,this._event.emit(Go.CHANGING_END)}};$o=zo([it(),Yo(0,mt(tt.PlayerState)),Yo(1,mt(tt.MediaUI)),Ko("design:paramtypes",[Object,Object])],$o);var Xo=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Zo=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Jo=function(e,t){return function(i,n){t(i,n,e)}};let es=class{constructor(e,t,i,n,r,o,s){this.lm=e,this.media=t,this.playerState=i,this.mediaChangingOperater=n,this.mediaPlayer=r,this.optionsContext=o,this.formateContext=s,this.bufferWaitingTask=null,this.destroyed=!1,this.waitingEventAudioBufferListener=()=>{this.startBufferWaitingTask()},this.waitingEventVideoBufferListener=()=>{this.startBufferWaitingTask()},this.logger=this.lm.createLogger("rd.mwhr"),this.bindRemoteMuteStateEvent()}bindRemoteMuteStateEvent(){this.formateContext.event.on(mi.AudioRemoteMuteStateUpdate,(()=>{this.reset()})),this.formateContext.event.on(mi.VideoRemoteMuteStateUpdate,(()=>{this.reset()}))}checkPlayStateAndPlayMedia(){!this.mediaChangingOperater.changing&&this.playerState.isRendering&&this.mediaPlayer.isCanplay()&&this.mediaPlayer.startMediaRender()}playingMedia(){this.logger.info("replaying media"),this.playerState.playing=!0,this.checkPlayStateAndPlayMedia(),clearTimeout(this.detectMediaCanRenderTimer),this.detectMediaCanRenderTimer=null}playAndClearTimer(){this.playingMedia(),this.detectMediaCanRenderTimer&&clearTimeout(this.detectMediaCanRenderTimer),this.detectionTimeoutTimer&&clearTimeout(this.detectionTimeoutTimer),this.detectMediaCanRenderTimer=this.detectionTimeoutTimer=null}noNeedWaiting(){if(this.media.isNoAudio()){if(this.media.videoFrames.size()>=1||this.playerState.decodeEnded&&this.playerState.loaded)return this.logger.info("should replay media, stop waiting. (by video buffer)"),!0}else if(this.media.audioFrames.size()>3||this.playerState.decodeEnded&&this.playerState.loaded)return this.logger.info("should replay media, stop waiting. (by audio buffer)"),!0;return!1}nextDetection(e){if(this.logger.info("next detection call"),!this.detectMediaCanRenderTimer)return void this.logger.info("no timer");if(this.noNeedWaiting())return void this.playAndClearTimer();this.detectMediaCanRenderTimer&&clearTimeout(this.detectMediaCanRenderTimer);const t=Math.min(2*e,4e3);this.detectMediaCanRenderTimer=setTimeout((()=>{this.nextDetection(t)}),t)}startWaitingBufferDetection(){this.detectMediaCanRenderTimer&&(clearTimeout(this.detectMediaCanRenderTimer),this.detectMediaCanRenderTimer=null),this.detectionTimeoutTimer&&(clearTimeout(this.detectionTimeoutTimer),this.detectionTimeoutTimer=null),this.detectionTimeoutTimer=setTimeout((()=>{if(this.detectMediaCanRenderTimer)return this.playingMedia(),this.detectMediaCanRenderTimer&&clearTimeout(this.detectMediaCanRenderTimer),this.detectMediaCanRenderTimer=null,void this.logger.error("decode slow or network week.")}),91e3),this.detectMediaCanRenderTimer=setTimeout((()=>this.nextDetection(2e3)),2e3)}bufferWaitingCall(){this.playerState.waiting||this.playerState.decodeEnded&&this.playerState.loaded||(this.logger.info("buffer waiting callback"),this.playerState.waiting=!0,this.mediaPlayer.rendering&&this.playerState.isRendering&&this.mediaPlayer.pauseMediaRender(),this.startWaitingBufferDetection())}startBufferWaitingTask(){this.bufferWaitingTask&&(clearTimeout(this.bufferWaitingTask),this.bufferWaitingTask=null),this.bufferWaitingTask=setTimeout((()=>{this.noNeedWaiting()||this.bufferWaitingCall()}),500)}waitingEventByAudioBuffer(){this.media.audioFrames.event.off(Xi.ReadToEmpty,this.waitingEventAudioBufferListener),this.media.audioFrames.event.on(Xi.ReadToEmpty,this.waitingEventAudioBufferListener)}waitingEventByVideoBuffer(){this.media.videoFrames.event.off(Di.ReadToEmpty,this.waitingEventVideoBufferListener),this.media.videoFrames.event.on(Di.ReadToEmpty,this.waitingEventVideoBufferListener)}cancelWaiting(){this.bufferWaitingTask&&(clearTimeout(this.bufferWaitingTask),this.bufferWaitingTask=null),this.playAndClearTimer()}waiting(){this.destroyed||this.startBufferWaitingTask()}reset(){this.destroyed||(this.cancelWaiting(),this.resetBufferWaitingEvent())}clearWaitingEventBind(){this.media.videoFrames.event.off(Di.ReadToEmpty,this.waitingEventVideoBufferListener),this.media.audioFrames.event.off(Xi.ReadToEmpty,this.waitingEventAudioBufferListener)}resetBufferWaitingEvent(){this.clearWaitingEventBind(),this.optionsContext.useMse()||(this.media.isNoAudio()?(this.logger.info("waiting event by video buffer."),this.waitingEventByVideoBuffer()):(this.logger.info("waiting event by audio buffer."),this.waitingEventByAudioBuffer()))}destroy(){this.clearWaitingEventBind(),this.cancelWaiting(),this.destroyed=!0}};Xo([Ht("0.plmd"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"playingMedia",null),Xo([Ht("0.pact"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"playAndClearTimer",null),Xo([Ht("0.ndtt"),Zo("design:type",Function),Zo("design:paramtypes",[Number]),Zo("design:returntype",void 0)],es.prototype,"nextDetection",null),Xo([Ht("0.swbd"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"startWaitingBufferDetection",null),Xo([Ht("0.bfw",{callInfo:!1}),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"startBufferWaitingTask",null),Xo([Ht("0.webab"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"waitingEventByAudioBuffer",null),Xo([Ht("0.webab"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"waitingEventByVideoBuffer",null),Xo([Ht("ccwt"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"cancelWaiting",null),Xo([Ht("rset"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"reset",null),Xo([Ht("bbwe"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"resetBufferWaitingEvent",null),Xo([Ht("dsty"),Zo("design:type",Function),Zo("design:paramtypes",[]),Zo("design:returntype",void 0)],es.prototype,"destroy",null),es=Xo([it(),Jo(0,mt(tt.LogMana)),Jo(1,mt(tt.RenderableMedia)),Jo(2,mt(tt.PlayerState)),Jo(3,mt(tt.MediaChangingOperator)),Jo(4,mt(tt.MediaUI)),Jo(5,mt(tt.OptionsContext)),Jo(6,mt(tt.FormatContext)),Zo("design:paramtypes",[$t,Un,fn,$o,Object,Object,Object])],es);var ts=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},is=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ns=function(e,t){return function(i,n){t(i,n,e)}},rs=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};let os=class{constructor(e,t,i,n,r,o,s,a,d){this.media=e,this.mediaPlayer=t,this.playerState=i,this.lm=n,this.formatContext=r,this.optionContext=o,this.mediaChangingOperater=s,this.waitingHandler=a,this.globalEvent=d,this.renderConfig={frameWidth:0,frameHeight:0,sampleRate:0},this.pMap=new qo,this.isUsingMseRender=!1,this.changingEndListener=null,this.canPlayListener=null,this.renderMediaCanplayListener=()=>{this.mediaChangingOperater.cancelMediaChanging(),this.waitingHandler.reset(),this.waitingHandler.cancelWaiting(),this.mediaPlayer.updateMediaInfo(this.createMediaInfoEntity(this.renderConfig)),this.media.event.off(In.BUFFER_CAN_PLAY,this.renderMediaCanplayListener),this.logger.info("update media info success!")},this.logger=this.lm.createLogger("rd.rnd"),this.media.postMessage=e=>{this.postMessage(e)},this.renderingUiController=this.mediaPlayer,this.bindWaitingHandler(),this.observeFormateUpdateEvent(),this.bindGlobalEvents()}bindCustomStream(e){this.optionContext.setCustomStream(!!e),this.optionContext.useCustomStream()&&this.renderingUiController!==this.customVideoControl?(this.renderingUiController.unmount(),this.customVideoControl.mount(),this.renderingUiController=this.customVideoControl):this.optionContext.useCustomStream()||this.renderingUiController!==this.customVideoControl||(this.optionContext.useMse()?(this.renderingUiController.unmount(),this.mseVideoControl.mount(),this.renderingUiController=this.mseVideoControl,this.isUsingMseRender=!0):(this.optionContext.useWebCodec()||this.optionContext.useWasm())&&(this.renderingUiController.unmount(),this.mediaPlayer.mount(),this.renderingUiController=this.mediaPlayer,this.isUsingMseRender=!1))}bindGlobalEvents(){this.globalEvent.event.on(di.MSE_ERROR,(()=>{if(this.isUsingMseRender){if(this.optionContext.setMseFailed(),this.optionContext.useMse())return;this.isUsingMseRender=!1,this.uiContainer.resetCanvas(),this.renderingUiController.unmount(),this.mediaPlayer.mount(),this.renderingUiController=this.mediaPlayer,this.updateMediaInfoFromFormatContext()}})),this.globalEvent.event.on(di.WEB_CODEC_ERROR,(()=>{this.optionContext.setWebCodecFailed(),this.optionContext.useMse()&&!this.isUsingMseRender&&(this.renderingUiController.unmount(),this.mseVideoControl.mount(),this.renderingUiController=this.mseVideoControl,this.isUsingMseRender=!0,this.updateMediaInfoFromFormatContext())}))}isHistoryMediaInfoDiff(){return this.renderConfig.sampleRate!==this.formatContext.sampleRate||this.renderConfig.frameHeight!==this.formatContext.codecFrameHeight||this.renderConfig.frameWidth!==this.formatContext.codecFrameWidth||this.renderConfig.useMse!==this.optionContext.useMse()}updateMediaInfoFromFormatContext(){this.updateMediaInfo({sampleRate:this.formatContext.sampleRate,frameHeight:this.formatContext.codecFrameHeight,frameWidth:this.formatContext.codecFrameWidth,useMse:this.optionContext.useMse()})}checkRenderMediaInfoChange(){this.isHistoryMediaInfoDiff()&&this.updateMediaInfoFromFormatContext()}observeFormateUpdateEvent(){this.formatContext.event.on(mi.MediaFormatChange,this.checkRenderMediaInfoChange.bind(this))}setVolume(e){this.playerState.volume=e,this.optionContext.useCustomStream()?this.customVideoControl.setVolume(e):this.optionContext.useMse()?this.mseVideoControl.setVolume(e):this.mediaPlayer.setVolume(e)}bindWaitingHandler(){this.mediaPlayer.event.on(qn.Play,(()=>{this.playerState.waiting&&(this.logger.info("cancel waiting"),this.waitingHandler.cancelWaiting())}))}terminate(){this.stop(),this.mediaPlayer.destroy(),this.mseVideoControl.destroy(),this.waitingHandler.destroy()}stop(){this.mediaChangingOperater.cancelMediaChanging(),this.mediaPlayer.endVideo(),this.waitingHandler.cancelWaiting(),this.media.clear()}bindVideoElement(e){this.mediaPlayer.initVideoElement(e),this.uiContainer.setUserVideoElement(e),this.optionContext.useMse()&&(this.isUsingMseRender=!0,this.mediaPlayer.unmount(),this.mseVideoControl.mount())}postMessage(e){}onmessage(e){e.type,this.logger.error("unknown msg type: ",e.type)}createWaitMediaPlayablePromise(){return this.canPlayListener=null,new Qo(((e,t)=>{this.mediaPlayer.playable?e():(this.canPlayListener=()=>e(),this.mediaPlayer.event.once(qn.MediaCanPlay,this.canPlayListener))}))}createWaitChangingPromise(){return this.changingEndListener=null,new Qo(((e,t)=>{this.mediaChangingOperater.changing?(this.changingEndListener=()=>e(),this.mediaChangingOperater.event.once(Go.CHANGING_END,this.changingEndListener)):e()}))}offMediaInitListeners(){this.canPlayListener&&this.mediaPlayer.event.off(qn.MediaCanPlay,this.canPlayListener),this.changingEndListener&&this.mediaChangingOperater.event.off(Go.CHANGING_END,this.changingEndListener)}play(){return rs(this,void 0,void 0,(function*(){const e=this.pMap.get("play");if(e.reset(),this.playerState.userPlayed=!0,this.media.clear(),this.optionContext.useCustomStream())this.customVideoControl.play();else if(this.optionContext.useMse())this.mseVideoControl.play();else{e.add(this.createWaitMediaPlayablePromise(),this.createWaitChangingPromise());try{yield e.all()}catch(t){if(t!==Wo)throw t;this.offMediaInitListeners()}this.mediaPlayer.play()}}))}pause(){this.playerState.userPlayed=!1,this.optionContext.useCustomStream()?this.customVideoControl.pause():this.optionContext.useMse()?this.mseVideoControl.pause():this.mediaPlayer.pause()}createMediaInfoEntity(e){return new _i({frameWidth:e.frameWidth,frameHeight:e.frameHeight,sampleRate:e.sampleRate,channelCount:2})}updateMediaInfo(e){const t=this.createMediaInfoEntity(e);if(t.validate()){if(this.renderConfig=e,this.optionContext.useMse())return this.logger.info("Use MSE Render"),void this.media.updateMedia(t);this.mediaChangingOperater.changing||this.mediaChangingOperater.mediaChanging(),this.media.event.off(In.BUFFER_CAN_PLAY,this.renderMediaCanplayListener),this.media.event.on(In.BUFFER_CAN_PLAY,this.renderMediaCanplayListener),this.media.updateMedia(t)}}waiting(){this.optionContext.useMse()||this.optionContext.useCustomStream()||this.waitingHandler.waiting()}resume(){this.optionContext.useCustomStream()&&this.customVideoControl.resume(),this.optionContext.useMse()||this.mediaPlayer.resume()}setMuted(e){this.playerState.muted=e,this.optionContext.useCustomStream()?this.customVideoControl.setMuted(e):this.optionContext.useMse()?this.mseVideoControl.setMuted(e):this.mediaPlayer.setMuted(e)}getCanvas(){return this.mediaPlayer.canvas}fullScreen(){this.optionContext.useCustomStream()?this.customVideoControl.fullScreen():this.optionContext.useMse()?this.mseVideoControl.fullScreen():this.mediaPlayer.fullScreen()}exitFullScreen(){if(this.optionContext.useMse()||this.optionContext.useCustomStream())throw new Vt("MSE exit full screen not support");this.mediaPlayer.exitFullScreen()}bindContainer(e){this.uiContainer.bindContainer(e),this.optionContext.useCustomStream()&&(this.renderingUiController.unmount(),this.customVideoControl.mount(),this.renderingUiController=this.customVideoControl),this.optionContext.useMse()&&(this.isUsingMseRender=!0,this.renderingUiController.unmount(),this.mseVideoControl.mount(),this.renderingUiController=this.mseVideoControl)}};ts([mt(tt.MSEVideoControl),is("design:type",Object)],os.prototype,"mseVideoControl",void 0),ts([mt(tt.CustomVideoControl),is("design:type",Object)],os.prototype,"customVideoControl",void 0),ts([mt(tt.UIContainer),is("design:type",Object)],os.prototype,"uiContainer",void 0),ts([Ht("0.bwhl"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"bindWaitingHandler",null),ts([Ht("tmi"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"terminate",null),ts([Ht("stp"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"stop",null),ts([Ht("bve"),is("design:type",Function),is("design:paramtypes",[HTMLVideoElement]),is("design:returntype",void 0)],os.prototype,"bindVideoElement",null),ts([Ht("omsg",{callInfo:!1}),is("design:type",Function),is("design:paramtypes",[Object]),is("design:returntype",void 0)],os.prototype,"onmessage",null),ts([Ht("ply"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",Promise)],os.prototype,"play",null),ts([Ht("pse"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"pause",null),ts([Ht("umif"),is("design:type",Function),is("design:paramtypes",[Object]),is("design:returntype",void 0)],os.prototype,"updateMediaInfo",null),ts([Ht("rdwt"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"waiting",null),ts([Ht("rsm"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"resume",null),ts([Ht("smd"),is("design:type",Function),is("design:paramtypes",[Boolean]),is("design:returntype",void 0)],os.prototype,"setMuted",null),ts([Ht("gcvs"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"getCanvas",null),ts([Ht("fusc"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"fullScreen",null),ts([Ht("exsc"),is("design:type",Function),is("design:paramtypes",[]),is("design:returntype",void 0)],os.prototype,"exitFullScreen",null),ts([Ht("cdiv"),is("design:type",Function),is("design:paramtypes",[HTMLDivElement]),is("design:returntype",void 0)],os.prototype,"bindContainer",null),os=ts([it(),ns(0,mt(tt.RenderableMedia)),ns(1,mt(tt.MediaUI)),ns(2,mt(tt.PlayerState)),ns(3,mt(tt.LogMana)),ns(4,mt(tt.FormatContext)),ns(5,mt(tt.OptionsContext)),ns(6,mt(tt.MediaChangingOperator)),ns(7,mt(tt.MediaWaitingHandler)),ns(8,mt(tt.GlobalEvent)),is("design:paramtypes",[Un,Object,fn,$t,Object,Object,$o,es,Object])],os);var ss=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},as=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ds=function(e,t){return function(i,n){t(i,n,e)}};let ls=class{constructor(e,t,i,n,r,o,s,a,d){this.formatContext=e,this.audioPackets=t,this.videoPackets=i,this.audioFrameQueue=n,this.videoFrameQueue=r,this.optionContext=o,this.playerState=s,this.lm=a,this.mseContextSingleton=d,this.audioDecodeTimer=null,this.videoDecodeTimer=null,this.audioIntervalDelayMS=0,this.videoIntervalDelayMS=0,this.videoDecodeInitialized=!1,this.audioDecodeInitialized=!1,this.destroyEmitter=new Jn("destroy"),this.videoFrameQueueMaxSize=3,this.audioFrameQueueMaxSize=9,this.videoSerial=0,this.audioSerial=0,this.audioDecoder=null,this.videoDecoder=null,this.videoDecodeLaunched=!1,this.audioDecodeLaunched=!1,this.logger=a.createLogger("d.dop"),this.e={videoDecodeCallback:this.videoDecodeCallback.bind(this),audioDecodeCallback:this.audioDecodeCallback.bind(this)},this.bindFormatChangeEvent()}initDecoder(e,t){this.audioDecoder=e,this.videoDecoder=t}switchAudioDecoder(e){if(!e)return void(this.audioDecoder=null);this.logger.info("stop audio decoder and ready to switch.");const t=this.audioDecodeLaunched;this.stopDecode(),this.audioDecoder=e,this.resetAudioDecoder(),t&&(this.logger.info("should restart audio decode"),this.startDecode()),this.logger.info("switch audio decoder success")}switchVideoDecoder(e){if(!e)return void(this.videoDecoder=null);this.logger.info("stop video decoder and ready to switch.");const t=this.videoDecodeLaunched;this.stopDecode(),this.videoDecoder=e,this.resetVideoDecoder(),t&&(this.logger.info("should restart video decode"),this.startDecode()),this.logger.info("switch video decoder success")}resetVideoDecoder(){var e;this.videoDecodeInitialized=!1,null===(e=this.videoDecoder)||void 0===e||e.reset(),this.videoFrameQueue.clear()}resetAudioDecoder(){var e;this.audioDecodeInitialized=!1,null===(e=this.audioDecoder)||void 0===e||e.reset(),this.audioFrameQueue.clear()}reset(){this.stopDecode(),this.resetAudioDecoder(),this.resetVideoDecoder()}restart(){let e=!1;(this.videoDecodeLaunched||this.audioDecodeLaunched)&&(e=!0),this.reset(),e&&this.startDecode()}bindFormatChangeEvent(){const e=()=>{this.logger.info("video description change"),this.resetVideoDecoder()},t=()=>{this.logger.info("audio description change"),this.resetAudioDecoder()},i=()=>{this.logger.info("audio remote mute change "+this.formatContext.audioNetTrackMuted),this.optionContext.useMse()&&(this.resetVideoDecoder(),this.resetAudioDecoder(),this.mseContextSingleton().reinit())},n=()=>{this.logger.info("video remote mute change "+this.formatContext.videoNetTrackMuted),this.optionContext.useMse()&&(this.resetVideoDecoder(),this.resetAudioDecoder(),this.mseContextSingleton().reinit())};this.formatContext.event.on(mi.VideoDescriptionChange,e),this.formatContext.event.on(mi.AudioDescriptionChange,t),this.formatContext.event.on(mi.AudioRemoteMuteStateUpdate,i),this.formatContext.event.on(mi.VideoRemoteMuteStateUpdate,n),this.destroyEmitter.once((()=>{this.formatContext.event.off(mi.VideoDescriptionChange,e),this.formatContext.event.off(mi.AudioDescriptionChange,t),this.formatContext.event.off(mi.AudioRemoteMuteStateUpdate,i),this.formatContext.event.off(mi.VideoRemoteMuteStateUpdate,n)}))}setVideoIntervalDelay(){this.videoIntervalDelayMS=1e3/60}clearVideoDecodeInterval(){this.videoDecodeTimer&&(clearInterval(this.videoDecodeTimer),this.videoDecodeTimer=null)}getDescriptionForVidDecoder(){this.formatContext.videoDescription&&this.formatContext.hasVideo()&&this.formatContext.videoCodecID&&this.videoDecoder&&(this.logger.info("video decoder configure "+this.formatContext.videoCodecID),this.videoDecoder.configure(this.formatContext.videoCodecID,this.formatContext.videoDescription),this.videoDecodeInitialized=!0)}readVideoPktAndDecode(){if(!this.videoDecoder)return!1;const e=this.videoPackets.read();return!!e&&(e.serial&&e.serial!==this.videoSerial&&(this.videoSerial=e.serial||0,this.videoDecoder.flush()),this.videoDecoder.decode(e),!0)}checkVideoFrameQueueDecode(){if(this.videoFrameQueue.size()>=this.videoFrameQueueMaxSize)return;let e=this.videoFrameQueueMaxSize-this.videoFrameQueue.size();for(;--e>=0&&this.readVideoPktAndDecode(););}videoDecodeCallback(){this.videoDecoder&&(this.videoDecodeInitialized?this.checkVideoFrameQueueDecode():this.getDescriptionForVidDecoder())}startVideoDecodeInterval(){this.clearVideoDecodeInterval(),this.videoDecodeTimer=setInterval(this.e.videoDecodeCallback,this.videoIntervalDelayMS)}setAudioIntervalDelay(){this.audioIntervalDelayMS=Math.max(1e3/(this.formatContext.sampleRate?this.formatContext.sampleRate:44e3)*1024*.8,30)}clearAudioDecodeInterval(){this.audioDecodeTimer&&(clearInterval(this.audioDecodeTimer),this.audioDecodeTimer=null)}getDescriptionForAudDecoder(){this.formatContext.audioDescription&&this.formatContext.hasAudio()&&this.formatContext.audioCodecID&&this.audioDecoder&&(this.logger.info("audio decoder configure "+this.formatContext.audioCodecID),this.audioDecoder.configure(this.formatContext.audioCodecID,this.formatContext.audioDescription),this.audioDecodeInitialized=!0)}audioDecodeCallback(){if(!this.audioDecoder)return;if(!this.audioDecodeInitialized)return void this.getDescriptionForAudDecoder();if(this.audioFrameQueue.size()>=this.audioFrameQueueMaxSize)return;let e=this.audioFrameQueueMaxSize-this.audioFrameQueue.size();for(;--e>=0;){const e=this.audioPackets.read();if(e&&e.serial&&e.serial!==this.audioSerial&&(this.audioSerial=e.serial||0,this.audioDecoder.flush()),!e)return;e&&this.audioDecoder.decode(e)}}startAudioDecodeInterval(){this.clearAudioDecodeInterval(),this.audioDecodeTimer=setInterval(this.e.audioDecodeCallback,this.audioIntervalDelayMS)}startDecode(){this.clearAudioDecodeInterval(),this.clearVideoDecodeInterval(),this.optionContext.useMse()?(this.logger.info("use callback read packets data"),this.videoPackets.on(ti.DATA,this.e.videoDecodeCallback),this.audioPackets.on(ti.DATA,this.e.audioDecodeCallback)):(this.logger.info("use interval read packets data"),this.setVideoIntervalDelay(),this.startVideoDecodeInterval(),this.setAudioIntervalDelay(),this.startAudioDecodeInterval()),this.videoDecodeLaunched=!0,this.audioDecodeLaunched=!0,this.playerState.decodeEnded=!1}stopDecode(){this.clearAudioDecodeInterval(),this.clearVideoDecodeInterval(),this.optionContext.useMse()&&(this.videoPackets.off(ti.DATA,this.e.videoDecodeCallback),this.audioPackets.off(ti.DATA,this.e.audioDecodeCallback)),this.videoDecodeLaunched=!1,this.audioDecodeLaunched=!1,this.playerState.decodeEnded=!0}destroy(){this.stopDecode(),this.destroyEmitter.emit()}};ss([Ht("swd.a"),as("design:type",Function),as("design:paramtypes",[Object]),as("design:returntype",void 0)],ls.prototype,"switchAudioDecoder",null),ss([Ht("swd"),as("design:type",Function),as("design:paramtypes",[Object]),as("design:returntype",void 0)],ls.prototype,"switchVideoDecoder",null),ss([Ht("rvd"),as("design:type",Function),as("design:paramtypes",[]),as("design:returntype",void 0)],ls.prototype,"resetVideoDecoder",null),ss([Ht("rad"),as("design:type",Function),as("design:paramtypes",[]),as("design:returntype",void 0)],ls.prototype,"resetAudioDecoder",null),ss([Ht("r"),as("design:type",Function),as("design:paramtypes",[]),as("design:returntype",void 0)],ls.prototype,"reset",null),ss([Ht("sd.0"),as("design:type",Function),as("design:paramtypes",[]),as("design:returntype",void 0)],ls.prototype,"startDecode",null),ss([Ht("sd.1"),as("design:type",Function),as("design:paramtypes",[]),as("design:returntype",void 0)],ls.prototype,"stopDecode",null),ls=ss([it(),ds(0,mt(tt.FormatContext)),ds(1,mt(tt.AudioPacketsProvider)),ds(2,mt(tt.VideoPacketsProvider)),ds(3,mt(tt.AudioFrameQueue)),ds(4,mt(tt.VideoFrameQueue)),ds(5,mt(tt.OptionsContext)),ds(6,mt(tt.PlayerState)),ds(7,mt(tt.LogMana)),ds(8,mt(tt.MseContextBuilder)),as("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object,$t,Function])],ls);var us=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},cs=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},hs=function(e,t){return function(i,n){t(i,n,e)}};let ps=class{constructor(e,t){this.frameQueue=e,this.lm=t,this.logger=t.createLogger("d.wcd"),this.reset()}onError(e){}flush(){var e;null===(e=this.decoder)||void 0===e||e.flush().then((()=>{}))}closeDecoder(){this.decoder&&"closed"!==this.decoder.state&&(this.logger.info("webcodec decoder close"),this.decoder.close(),this.decoder=null)}createDecoder(){this.closeDecoder(),this.decoder=new VideoDecoder({output:e=>{this.handleDecode(e)},error:e=>{this.handleError(e)}})}handleDecode(e){this.frameQueue.push({pts:e.timestamp,payload:e,serial:this.serial})}handleError(e){this.onError(e)}reset(){this.createDecoder(),this.hasInit=!1,this.hasFirstIFrame=!1,this.serial=0}formatVideoDecoderConfigure(e,t){let i="";if(e==gi.H265){const e=Kr(t);this.logger.info(JSON.stringify(e)),i=(null==e?void 0:e.codec)||""}else if(e==gi.H264){const e=Vr(t);this.logger.info(JSON.stringify(e)),i=(null==e?void 0:e.codec)||""}return{codec:i,description:t}}configure(e,t){const i=this.formatVideoDecoderConfigure(e,t);if(e===gi.H264||e===gi.H265){if(!this.hasInit&&this.decoder){try{this.decoder.configure(i)}catch(n){return void this.onError(n)}this.hasInit=!0}}else this.onError(new Error("no support codecID"))}isDecodeStateClosed(){return!this.decoder||"closed"===this.decoder.state}decode(e){if(!this.hasInit)return void this.logger.throttleInfo("cannot decode before configure (video webcodec)");if(!this.decoder)return;if(!this.hasFirstIFrame&&e.isKeyFrame&&(this.hasFirstIFrame=!0),!this.hasFirstIFrame)return;const t=new EncodedVideoChunk({data:e.payload,timestamp:e.pts,type:e.isKeyFrame?"key":"delta"});try{if(this.isDecodeStateClosed())return;this.serial=e.serial||0,this.decoder.decode(t)}catch(i){this.logger.error(`WebCodec decode error: ${i}`)}}destroy(){this.closeDecoder()}};us([Ht("fus"),cs("design:type",Function),cs("design:paramtypes",[]),cs("design:returntype",void 0)],ps.prototype,"flush",null),us([Ht("cs"),cs("design:type",Function),cs("design:paramtypes",[]),cs("design:returntype",void 0)],ps.prototype,"closeDecoder",null),us([Ht("r"),cs("design:type",Function),cs("design:paramtypes",[]),cs("design:returntype",void 0)],ps.prototype,"reset",null),us([Ht("dvc"),cs("design:type",Function),cs("design:paramtypes",[Number,Uint8Array]),cs("design:returntype",void 0)],ps.prototype,"formatVideoDecoderConfigure",null),us([Ht("cf"),cs("design:type",Function),cs("design:paramtypes",[Number,Uint8Array]),cs("design:returntype",void 0)],ps.prototype,"configure",null),ps=us([it(),hs(0,mt(tt.VideoFrameQueue)),hs(1,mt(tt.LogMana)),cs("design:paramtypes",[Object,$t])],ps);var fs=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},ms=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},gs=function(e,t){return function(i,n){t(i,n,e)}},ys=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};let vs=class{onsuccess(){}onerror(e){}onprogress(e){}onabort(){}onresume(){}get loaded(){return this._loaded}constructor(e,t){this.qualityCtx=e,this.lm=t,this.taskID=0,this.url="",this.lastAbortController=null,this.fetchSeq=0,this._loaded=!1,this.maxOfflineTime=9e4,this.maxNoReadDataDelay=5e3,this.firstDataDownLoad=!1,this.userAborted=!1,this.reader=null,this.lastReadMediaTime=0,this.readMediaTimeoutTimer=0,this.logger=t.createLogger("dmx.htf")}init(e){this.onabort=e.onabort,this.onsuccess=e.onsuccess,this.onerror=e.onerror,this.onprogress=e.onprogress,this.onresume=e.onresume,this.request(e.url)}confirmMediaEnded(e){return new Promise((t=>{const i=this.createLinkTimeout(e,15e3,(()=>{this.logger.info("confirm media link create timeout, may no more resource, stop requesting."),t(!0)}));this._crateFetchLink(this.url,e,i).then((e=>null==e?void t(!0):(this.logger.info("has more media resource, refetch media"),void t(!1)))).catch((e=>{t(!0)}))}))}_mediaLoadEnd(e){return ys(this,void 0,void 0,(function*(){if(this.taskID!==e)return;const t=yield this.confirmMediaEnded(e);this.taskID===e&&(t?(this._loaded=!0,this.onsuccess()):setTimeout((()=>{this.taskID===e&&this.refetch(!0)}),3e3))}))}_bufferOnProgress(e,t){e.length<=0||this.taskID!=t||this.onprogress(e)}createLinkTimeout(e,t,i){let n=setTimeout((()=>{this.taskID===e&&(n=null,i())}),t);return n}_crateFetchLink(e,t,i){return this.url=e,new Promise(((n,r)=>{let o=null;const s=()=>ys(this,void 0,void 0,(function*(){const r=new AbortController;this.lastAbortController=r,r.signal.addEventListener("abort",(e=>{this.onabort()}));let a=!1;try{o=yield fetch(e,{signal:r.signal})}catch(d){a=!0}if(this.taskID!==t)return;(()=>{o||(a=!0),o&&200!==o.status&&(a=!0);let e=0;return o&&o.headers.has("content-length")&&(e=Number.parseInt(o.headers.get("content-length")||"0")),a})()?setTimeout((()=>{null!==i&&(this.taskID==t?s().catch((e=>{this.logger.error(e)})):(clearTimeout(i),i=null,n(null)))}),3e3):(null!==i&&(clearTimeout(i),i=null),n(o))}));s().catch((e=>{this.logger.error(e)}))}))}refetch(e,t){this.fetchSeq++,!e&&t&&this.cancelReader(),this.onresume()}onReadData({done:e,value:t},i){const{fetchSeq:n,taskID:r,reader:o}=i;this.lastReadMediaTime=performance.now(),this.fetchSeq===n&&(e?this._mediaLoadEnd(r):(this.firstDataDownLoad||(this.qualityCtx.networkStatistic.fetchedFirstData(),this.firstDataDownLoad=!0),this._bufferOnProgress(t,r),this._readMedia(r,o)))}onReadError(e,t){const{fetchSeq:i,taskID:n,reader:r}=t;this.clearReadMediaTimeoutInterval(),this.fetchSeq===i?n===this.taskID?"AbortError"===e.name||e.message.includes("user aborted a request.")?this.logger.info(`media abort ${this.userAborted}`):"AbortError"!==e.name&&"ErrnoError"!==e.name||"AbortError"===e.name&&!this.userAborted?(this.logger.info("refetch media"),this.refetch(!0,r)):this.logger.error("onReadError: no handle"+e.name+" "+e.message):this.logger.info(`this taskID no equal taskID", ${this.taskID}, ${n}`):this.logger.info(`this fetchSeq no equal fetchSeq ${this.fetchSeq} ${i}`)}clearReadMediaTimeoutInterval(){this.readMediaTimeoutTimer&&(clearInterval(this.readMediaTimeoutTimer),this.readMediaTimeoutTimer=null)}setReadMediaTimeoutInterval(e,t){this.readMediaTimeoutTimer&&clearInterval(this.readMediaTimeoutTimer),this.readMediaTimeoutTimer=setInterval((()=>{performance.now()-this.lastReadMediaTime>=this.maxNoReadDataDelay&&e()}),t)}_readMedia(e,t){if(e===this.taskID)try{const i={fetchSeq:this.fetchSeq,taskID:e,reader:t};t.read().then((e=>{this.onReadData(e,i)})).catch((e=>{this.onReadError(e,i)}))}catch(i){throw this.clearReadMediaTimeoutInterval(),this.logger.error(i),i}}cancelReader(){return ys(this,void 0,void 0,(function*(){this.reader&&(yield this.reader.cancel(),this.clearReadMediaTimeoutInterval(),this.reader=null)}))}request(e){const t=++this.taskID;if(this._loaded=!1,this.abort(),""===e)return;this.firstDataDownLoad=!1,this.qualityCtx.networkStatistic.networkRequestStart(),this.qualityCtx.renderStatistic.renderRequestStart(),this.fetchSeq++,this.userAborted=!1;const i=this.createLinkTimeout(t,this.maxOfflineTime,(()=>{this.taskID++,this.onerror("Unable to request media resources! Please check your network and retry.")}));this._crateFetchLink(e,t,i).then((e=>{if(this.taskID===t&&e&&e.body){const i=e.body.getReader();this.reader=i,this.lastReadMediaTime=performance.now(),this.setReadMediaTimeoutInterval((()=>{this.refetch(!1,i)}),1e3),this._readMedia(t,i)}})).catch((e=>{this.logger.error(e)}))}abort(){this.lastAbortController&&this.cancelReader().then((()=>{this.userAborted=!0,this.lastAbortController&&this.lastAbortController.abort(),this.lastAbortController=null,this.taskID++})).catch((e=>{this.logger.error(e)}))}destroy(){this.taskID++,this.onabort=()=>{},this.onerror=()=>{},this.onprogress=()=>{},this.onresume=()=>{},this.onsuccess=()=>{},this.abort()}};vs=fs([it(),gs(0,mt(tt.QualityStatisticContext)),gs(1,mt(tt.LogMana)),ms("design:paramtypes",[Qi,$t])],vs);class bs{constructor(e,t){this.globalEvent=e,this.onBitRateUpdate=t,this.nextNode=null,this.countBytes=[0],this.statisticTimer=null,this.lastUpdateCountTime=performance.now(),this.statisticPeriodMs=1e3,this.countBytesMaxLen=3,this.startStatisticTimer(),this.globalEvent.event.once(di.DESTROY,(()=>{this.destroy()}))}reset(){this.countBytes=[0],this.lastUpdateCountTime=performance.now()}startStatisticTimer(){this.statisticTimer=setInterval((()=>{this.lastUpdateCountTime=performance.now(),this.countBytes.push(0),this.countBytes.length>this.countBytesMaxLen&&this.countBytes.shift(),this.onBitRateUpdate()}),this.statisticPeriodMs)}statistic(e){this.countBytes[this.countBytes.length-1]+=e.byteLength}clearStatisticTimer(){clearInterval(this.statisticTimer)}destroy(){this.clearStatisticTimer()}KBRate(){const e=performance.now()-this.lastUpdateCountTime+(this.countBytes.length-1)*this.statisticPeriodMs;return this.countBytes.reduce(((e,t)=>e+t))/(e/1e3)/1024}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}receive(e){var t;this.statistic(e.payload),null===(t=this.nextNode)||void 0===t||t.receive(e)}}class _s{constructor(e){this.packetQueue=e}reset(){this.packetQueue.clear()}receive(e){this.packetQueue.push(e)}}class Cs{constructor(e,t,i,n){this.type=e,this.lm=t,this.globalEvt=i,this.playerState=n,this.nextNode=null,this.minDtsLine=-1/0,this.waitKeyFrame=!1,this.maxErrorContinuousFrame=60,this.errorContinuousFrameCount=0,this.ended=!1,this.logger="audio"===e?t.createLogger("dmx.fdsa"):t.createLogger("dmx.fdsv"),this.globalEvt.event.on(di.DTS_ERROR_OCCUR,(()=>{this.ended=!0}))}pipe(e){this.nextNode=e}reset(){this.minDtsLine=-1/0,this.errorContinuousFrameCount=0,this.ended=!1}unpipe(){this.nextNode=null}receive(e){var t;this.ended||(this.minDtsLine<e.dts?(this.waitKeyFrame&&e.isKeyFrame&&(this.waitKeyFrame=!1),this.waitKeyFrame?this.logger.throttleInfo("wait key frame "+this.type):(null===(t=this.nextNode)||void 0===t||t.receive(e),this.minDtsLine=e.dts,this.errorContinuousFrameCount=0)):("video"===this.type&&(this.waitKeyFrame=!0),this.errorContinuousFrameCount++,this.errorContinuousFrameCount>this.maxErrorContinuousFrame&&(this.logger.info(`Detected frame dts no match. Refetch media. \n                    ${this.errorContinuousFrameCount}, ${this.maxErrorContinuousFrame}, ${e.dts}, ${this.minDtsLine}, ${this.type}.`),this.ended=!0,this.errorContinuousFrameCount=0,this.globalEvt.event.emit(di.DTS_ERROR_OCCUR),this.globalEvt.event.emit(di.MEDIA_REFETCH,this.playerState.url)),this.logger.throttleInfo("drop frames "+this.type)))}}class Es{constructor(e){this.onFrameRateUpdate=e,this.nextNode=null,this.lastTimestamp=0,this.statisticDelay=0,this.statisticFrameCount=0,this.maxStatisticDelay=1e3}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}reset(){this.lastTimestamp=0,this.statisticDelay=0,this.statisticFrameCount=0}statistic(e){if(this.lastTimestamp<=0)return void(this.lastTimestamp=e);const t=e-this.lastTimestamp;if(this.lastTimestamp=e,t<=0)return;if(this.statisticDelay+=t,this.statisticFrameCount++,this.statisticDelay<this.maxStatisticDelay)return;const i=1e3/(this.statisticDelay/this.statisticFrameCount);this.onFrameRateUpdate(i),this.statisticDelay=0,this.statisticFrameCount=0}receive(e){var t;this.statistic(e.dts),null===(t=this.nextNode)||void 0===t||t.receive(e)}}class Ss{constructor(e){this.onFrameRateUpdate=e,this.nextNode=null,this.statisticFrameCount=0,this.statisticInterval=3e3,this.statisticTimer=null,this.lastTimestamp=0}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}reset(){this.statisticTimer&&(clearTimeout(this.statisticTimer),this.statisticTimer=null),this.lastTimestamp=0,this.statisticFrameCount=0}stopStatisticTimer(){this.statisticTimer&&(clearTimeout(this.statisticTimer),this.statisticTimer=null)}startStatisticTimer(){this.stopStatisticTimer(),this.statisticTimer=setInterval((()=>{const e=performance.now(),t=1e3/((e-this.lastTimestamp)/this.statisticFrameCount);this.lastTimestamp=e,this.statisticFrameCount=0,this.onFrameRateUpdate(t)}),this.statisticInterval)}statistic(){this.statisticTimer||this.startStatisticTimer(),this.lastTimestamp<=0&&(this.lastTimestamp=performance.now()),this.statisticFrameCount++}receive(e){var t;this.statistic(),null===(t=this.nextNode)||void 0===t||t.receive(e)}}class ws{constructor(e,t,i){this.formatContext=e,this.lm=t,this.type=i,this.nextNode=null,this.lastDts=0,this.logger="audio"===i?t.createLogger("dmx.dsoa"):t.createLogger("dmx.dsov")}reset(){this.formatContext.republishCorrection=0,this.lastDts=0}destroy(){}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}receive(e){var t,i;if(this.lastDts<=0)return this.lastDts=e.dts,void(null===(t=this.nextNode)||void 0===t||t.receive(e));this.lastDts-(e.dts+this.formatContext.republishCorrection)>500&&e.dts<500&&(this.formatContext.republishCorrection=Math.max(this.lastDts,this.formatContext.republishCorrection),this.logger.throttleInfo("Detected remote republish. ("+this.type+") dts changed. set dts republishCorrection: "+this.formatContext.republishCorrection)),e.dts+=this.formatContext.republishCorrection,e.pts+=this.formatContext.republishCorrection,this.lastDts=e.dts,null===(i=this.nextNode)||void 0===i||i.receive(e)}}var Rs=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ds=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},As=function(e,t){return function(i,n){t(i,n,e)}};let Ps=class{constructor(e,t,i,n,r,o){this.packetContext=e,this.globalEvent=t,this.qualityCtx=i,this.lm=n,this.playerState=r,this.formatContext=o,this.bitrateStatisticNode=new bs(this.globalEvent,(()=>{this.qualityCtx.networkStatistic.audioNetBitrateKB=this.bitrateStatisticNode.KBRate()})),this.pipeNodes=[new ws(this.formatContext,this.lm,"audio"),this.bitrateStatisticNode,new Ss((e=>{this.qualityCtx.networkStatistic.downloadAudioFrameRate=e})),new Es((e=>{this.qualityCtx.networkStatistic.targetAudioFrameRate=e})),new Cs("audio",this.lm,this.globalEvent,this.playerState)],this.packetSaver=new _s(this.packetContext.audioPackets),this.connectNodes()}connectNodes(){for(let e=0;e<this.pipeNodes.length-1;e++)this.pipeNodes[e].pipe(this.pipeNodes[e+1]);this.pipeNodes[this.pipeNodes.length-1].pipe(this.packetSaver)}reset(){for(let e=0;e<this.pipeNodes.length;e++)this.pipeNodes[e].reset();this.packetSaver.reset()}receive(e){this.pipeNodes[0].receive(e)}};Ps=Rs([it(),As(0,mt(tt.PacketContext)),As(1,mt(tt.GlobalEvent)),As(2,mt(tt.QualityStatisticContext)),As(3,mt(tt.LogMana)),As(4,mt(tt.PlayerState)),As(5,mt(tt.FormatContext)),Ds("design:paramtypes",[Object,Object,Qi,$t,Object,Object])],Ps);class Fs{constructor(e){this.onGopUpdate=e,this.nextNode=null,this.lastKeyFrameTime=-1,this.gop=-1}get GOP(){return this.gop}statistic(e){e.isKeyFrame&&(e.firstKeyFrame&&this.reset(),this.lastKeyFrameTime<=0?this.lastKeyFrameTime=e.pts:(this.gop=(e.pts-this.lastKeyFrameTime)/1e3,this.lastKeyFrameTime=e.pts,this.onGopUpdate()))}destroy(){}reset(){this.gop=-1,this.lastKeyFrameTime=-1}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}receive(e){var t;this.statistic(e),null===(t=this.nextNode)||void 0===t||t.receive(e)}}class Ts{constructor(e,t){this.globalEvent=e,this.seiReceiver=t,this.nextNode=null,this.globalEvent.event.once(di.DESTROY,(()=>{this.destroy()}))}reset(){}destroy(){}pipe(e){this.nextNode=e}unpipe(){this.nextNode=null}parseSei(e){e&&e.naluPkt&&this.seiReceiver.receive(e.payload,e.pts)}receive(e){var t;this.parseSei(e),null===(t=this.nextNode)||void 0===t||t.receive(e)}}var xs=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},ks=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Ms=function(e,t){return function(i,n){t(i,n,e)}};let Os=class{constructor(e,t,i,n,r,o,s){this.globalEvent=t,this.qualityCtx=i,this.lm=n,this.playerState=r,this.seiReceiver=o,this.formatContext=s,this.bitrateStatisticNode=new bs(this.globalEvent,(()=>{this.qualityCtx.networkStatistic.videoNetBitrateKB=this.bitrateStatisticNode.KBRate()})),this.gopStatisticNode=new Fs((()=>{this.qualityCtx.networkStatistic.GOP=this.gopStatisticNode.GOP})),this.pipeNodes=[new ws(this.formatContext,this.lm,"video"),new Ts(this.globalEvent,this.seiReceiver),this.bitrateStatisticNode,new Es((e=>{this.qualityCtx.networkStatistic.targetVideoFrameRate=e})),new Ss((e=>{this.qualityCtx.networkStatistic.downloadVideoFrameRate=e})),this.gopStatisticNode,new Cs("video",this.lm,this.globalEvent,this.playerState)],this.packetSaver=new _s(e.videoPackets),this.connectNodes()}connectNodes(){for(let e=0;e<this.pipeNodes.length-1;e++)this.pipeNodes[e].pipe(this.pipeNodes[e+1]);this.pipeNodes[this.pipeNodes.length-1].pipe(this.packetSaver)}reset(){for(let e=0;e<this.pipeNodes.length;e++)this.pipeNodes[e].reset();this.packetSaver.reset()}receive(e){this.pipeNodes[0].receive(e)}};Os=xs([it(),Ms(0,mt(tt.PacketContext)),Ms(1,mt(tt.GlobalEvent)),Ms(2,mt(tt.QualityStatisticContext)),Ms(3,mt(tt.LogMana)),Ms(4,mt(tt.PlayerState)),Ms(5,mt(tt.SEIReceiver)),Ms(6,mt(tt.FormatContext)),ks("design:paramtypes",[Object,Object,Qi,$t,Object,Object,Object])],Os);var Is=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ls=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Bs=function(e,t){return function(i,n){t(i,n,e)}};let Vs=class{constructor(e,t,i,n){this.audioFrameQueue=e,this.videoFrameQueue=t,this.audioClock=i,this.videoClock=n}getAudioTime(){return this.audioClock.getClock()}videoFrameNotDelayed(e){return e.pts-this.getAudioTime()>0}removeDelayedVideoFrame(){for(;this.videoFrameQueue.size()>0;){const e=this.videoFrameQueue.front();if(e&&this.videoFrameNotDelayed(e))break;const t=this.videoFrameQueue.pop();t&&Ri(t.payload)&&t.payload.close()}}syncRenderData(){if(!this.videoClock.firstPtsReceived)return!this.videoFrameQueue.empty();const e=this.videoClock.getClock()-this.getAudioTime();return!(e>25)&&(e<-100?(this.removeDelayedVideoFrame(),!this.videoFrameQueue.empty()):!this.videoFrameQueue.empty())}videoDataEnough(){return!this.videoFrameQueue.empty()}audioDataEnough(){return!this.audioFrameQueue.empty()}getSyncAudioFrame(){return this.audioDataEnough()?this.audioFrameQueue.pop():null}getSyncVideoFrame(){return this.videoDataEnough()&&this.syncRenderData()?this.videoFrameQueue.pop():null}};Vs=Is([it(),Bs(0,mt(tt.AudioFrameQueue)),Bs(1,mt(tt.VideoFrameQueue)),Bs(2,mt(tt.AudioClock)),Bs(3,mt(tt.VideoClock)),Ls("design:paramtypes",[Object,Object,Object,Object])],Vs);var Us=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ns=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},js=function(e,t){return function(i,n){t(i,n,e)}};let Ws=class{constructor(e,t,i,n){this.audioFrameQueue=e,this.videoFrameQueue=t,this.audioClock=i,this.videoClock=n}videoDataEnough(){return!this.videoFrameQueue.empty()}audioDataEnough(){return!this.audioFrameQueue.empty()}getVideoLiveTime(){return this.videoClock.durationFromFirstPts()}audioFrameNotDelayed(e){return e.pts-this.getVideoLiveTime()>0}videoFrameNotDelayed(e){return e.pts-this.getVideoLiveTime()>0}removeDelayedVideoFrame(){for(;this.videoFrameQueue.size()>1;){const e=this.videoFrameQueue.front();if(e&&this.videoFrameNotDelayed(e))break;const t=this.videoFrameQueue.pop();t&&Ri(t.payload)&&t.payload.close()}}removeDelayedAudioFrame(){for(;this.audioFrameQueue.size()>0;){const e=this.audioFrameQueue.front();if(e&&this.audioFrameNotDelayed(e))break;this.audioFrameQueue.pop()}}syncAudioRenderData(){const e=this.audioClock.getClock()-this.getVideoLiveTime();return!(e>25)&&(e<-100?(this.removeDelayedAudioFrame(),!this.audioFrameQueue.empty()):!this.audioFrameQueue.empty())}syncVideoRenderData(){if(!this.videoClock.firstPtsReceived)return!this.videoFrameQueue.empty();const e=this.videoClock.getClock()-this.getVideoLiveTime();return!(e>25)&&(e<-100?(this.removeDelayedVideoFrame(),!this.videoFrameQueue.empty()):!this.videoFrameQueue.empty())}getSyncAudioFrame(){return this.audioDataEnough()&&this.syncAudioRenderData()?this.audioFrameQueue.pop():null}getSyncVideoFrame(){return this.videoDataEnough()&&this.syncVideoRenderData()?this.videoFrameQueue.pop():null}};Ws=Us([it(),js(0,mt(tt.AudioFrameQueue)),js(1,mt(tt.VideoFrameQueue)),js(2,mt(tt.AudioClock)),js(3,mt(tt.VideoClock)),Ns("design:paramtypes",[Object,Object,Object,Object])],Ws);var qs=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Hs=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class Qs{get deviceReady(){return this.playerState.audioDeviceReady}set deviceReady(e){this.playerState.audioDeviceReady=e}constructor(e,t,i,n,r){this.lm=i,this.qualityCtx=n,this.playerState=r,this.played=!1,this.bounding=!1,this._autoPlayTimeout=null,this.deviceTaskQueue=new wr,this.cacheUselessAudioBuffers=[],this.cacheUselessAudioBufferMaxNum=8,this.onACStateChange=()=>{"running"!==this.ac.state&&"closed"!==this.ac.state&&this.ac.resume(),this.logger.info("ac statechange. "+this.ac.state)},this.ResumeListener=()=>{"running"!==this.ac.state?(this.ac.onstatechange=()=>{"running"===this.ac.state&&document.body.removeEventListener("click",this.ResumeListener)},this.ac.resume().then((()=>{"running"===this.ac.state&&this.onDeviceReady()}))):document.body.removeEventListener("click",this.ResumeListener)},this.logger=this.lm.createLogger("rd.bspl"),this.deviceReady=!1;const o=window.AudioContext||window.webkitAudioContext;this.onComputeTimeoutBound=this.onComputeTimeout.bind(this),this.audioContext=new o({sampleRate:e}),this._sampleRate=e,this.logger.info("AudioContext sampleRate="+this.audioContext.sampleRate),this.channelCount=2,this.computeSamplesCount=1024,this.buffersToKeep=5,this.computeDuration=this.computeSamplesCount/this._sampleRate,this.computeDurationMS=1e3*this.computeDuration,this.audioBufferSources=[],this.computeSamplesTimeout=null,this.initGainNode(t),this.bindDocumentEvent(),this.bindACEvent()}getSampleRate(){return this._sampleRate}bindACEvent(){this.ac.addEventListener("statechange",this.onACStateChange)}initGainNode(e){this.gainNode=this.audioContext.createGain(),this.setVolume(e),this.gainNode.connect(this.audioContext.destination)}resumeAudioContext(){if("running"!==this.audioContext.state){const e=()=>{if("running"!==this.ac.state)throw this.logger.error("web audio auto play failed."),new jt("Auto play failed. Please call play() method after click.")},t=()=>{this._autoPlayTimeout&&clearTimeout(this._autoPlayTimeout)};this.audioContext.resume().then((()=>{"running"!=this.audioContext.state||this.onDeviceReady()})).catch((i=>{t(),e()})),t(),this._autoPlayTimeout=setTimeout((()=>{e()}),3e3),this.logger.info("audio context resumed.")}else this.onDeviceReady()}bindDocumentEvent(){document.body.addEventListener("click",this.ResumeListener)}offDocumentEvent(){document.body.removeEventListener("click",this.ResumeListener)}get ac(){return this.audioContext}get sampleRate(){return this._sampleRate}get stream(){return this.ac.createMediaStreamDestination().stream}isDeviceReady(){return this.deviceReady}getAudioContextTime(){return("safari"===bi.getBrowser()||"unknown"===bi.getBrowser()?this.audioContext.currentTime:this.audioContext.getOutputTimestamp?this.audioContext.getOutputTimestamp().contextTime:this.audioContext.currentTime)||0}startPlaying(){this.audioBufferSources.length>0&&this.pausePlaying();(()=>{if(this.audioContext.getOutputTimestamp){let e=this.audioContext.getOutputTimestamp();this.lastTimeoutTime=e.performanceTime||0}else this.lastTimeoutTime=performance.now();this.audioContextStartOffset=this.getAudioContextTime(),this.currentBufferTime=0})(),(()=>{this.audioBufferSources.forEach((e=>{const t=this.audioContext.createBufferSource();t.buffer=e.node.buffer,t.connect(this.gainNode),e.node=t,e.node.start(this.getNextBufferTime()),e.node.onended=()=>{e.onEnd(),this.audioBufferSources.shift()},this.currentBufferTime+=this.computeDuration}))})(),this.bounding=!0,this.onComputeTimeoutBound()}getNextBufferTime(){return this.audioContextStartOffset+this.currentBufferTime+.5}getProcessInfoFromCallback(){let e=null,t=()=>{};return this.onProcessPcm((t=>{e=t}),(e=>{t=e.onEnd})),e?{pcm:e,onEnd:t}:null}onComputeTimeout(){if(!this.bounding)return;for(;this.buffersToKeep>this.audioBufferSources.length;)this.bufferNext();let e=2*this.computeDurationMS-(performance.now()-this.lastTimeoutTime)-5;e=Math.max(0,e),this.lastTimeoutTime=performance.now(),this.computeSamplesTimeout=setTimeout(this.onComputeTimeoutBound,e)}createBuffer(e,t,i){let n;return this.cacheUselessAudioBuffers.length>0&&(n=this.cacheUselessAudioBuffers.shift()),n||this.audioContext.createBuffer(e,t,i)}bufferNext(){const e=this.createBuffer(this.channelCount,this.computeSamplesCount,this._sampleRate);this.channels=[];for(let r=0;r<this.channelCount;++r)this.channels.push(e.getChannelData(r));const t=this.getProcessInfoFromCallback();t&&(this.channels[0].set(t.pcm.leftChannel),this.channels[1].set(t.pcm.rightChannel));let i=this.audioContext.createBufferSource();i.connect(this.gainNode),i.buffer=e,i.start(this.getNextBufferTime()),i.onended=()=>{t&&t.onEnd&&t.onEnd(),this.audioBufferSources.shift(),i.buffer=null;for(let t=0;t<e.numberOfChannels;++t)e.getChannelData(t).fill(0);this.cacheUselessAudioBuffers.push(e),this.cacheUselessAudioBuffers.length>this.cacheUselessAudioBufferMaxNum&&this.cacheUselessAudioBuffers.shift()};let n=()=>{};t&&t.onEnd&&(n=t.onEnd),this.audioBufferSources.push({node:i,onEnd:n}),this.currentBufferTime+=this.computeDuration}pausePlaying(){if(this.audioBufferSources.length>0)for(let t of this.audioBufferSources)try{t.node.onended=null,t.node.stop()}catch(e){}this.computeSamplesTimeout&&clearTimeout(this.computeSamplesTimeout),this.computeSamplesTimeout=null,this.bounding=!1}stopPlaying(){this.pausePlaying(),this.audioBufferSources=[]}addDeviceTask(e){this.deviceReady?e():this.deviceTaskQueue.pushTask(e)}reset(){this.stopPlaying(),this.played&&this.startPlaying()}play(){this.played||(this.resumeAudioContext(),this.addDeviceTask((()=>{this.playerState.userPlayed&&(this.played=!0,this.startPlaying())})))}pause(){this.played&&(this.resumeAudioContext(),this.addDeviceTask((()=>{this.playerState.userPlayed||(this.played=!1,this.stopPlaying())})))}destroy(){this.stopPlaying(),this.gainNode.disconnect(),this.offDocumentEvent(),this.ac.removeEventListener("statechange",this.onACStateChange)}activeDevice(){this.resumeAudioContext()}setVolume(e){if(e<0||e>100)throw new Lt("volume need to be in the interval [0, 100].");this.gainNode.gain.value=e/100,this.qualityCtx.renderStatistic.volumeIn100=e}onDeviceReady(){this.deviceReady=!0,this.deviceTaskQueue.runAllTask()}onProcessPcm(e,t){}pauseReceivePcmData(){this.pause()}startReceivePcmData(){this.play()}}qs([Ht("0.rmac"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"resumeAudioContext",null),qs([Ht("stpl"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"startPlaying",null),qs([Ht("0.pup"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"pausePlaying",null),qs([Ht("rst"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"reset",null),qs([Ht("pl"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"play",null),qs([Ht("pu"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"pause",null),qs([Ht("dst"),Hs("design:type",Function),Hs("design:paramtypes",[]),Hs("design:returntype",void 0)],Qs.prototype,"destroy",null);const Gs=["auxclick","click","contextmenu","dblclick","keydown","keyup","mousedown","mouseup","touchend"];var zs=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ks=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Ys=function(e,t){return function(i,n){t(i,n,e)}};vi()&&function(){let e=window.AudioContext||window.webkitAudioContext;if(!(navigator.maxTouchPoints>0&&null!=e))return;let t,i,n,r="blocked",o="blocked";const s=function(e){const t=new ArrayBuffer(10),i=new DataView(t);return i.setUint32(0,e,!0),i.setUint32(4,e,!0),i.setUint16(8,1,!0),`data:audio/wav;base64,UklGRisAAABXQVZFZm10IBAAAAABAAEA${window.btoa(String.fromCharCode(...new Uint8Array(t))).slice(0,13)}AgAZGF0YQcAAACAgICAgICAAAA=`}((new e).sampleRate);function a(a){"blocked"===r&&(r="pending",t=document.createElement("audio"),t.setAttribute("x-webkit-airplay","deny"),t.preload="auto",t.loop=!0,t.src=s,t.load(),t.play().then((()=>{r="allowed",d()}),(()=>{r="blocked",t.pause(),t.removeAttribute("src"),t.load(),t=null}))),"blocked"===o&&(o="pending",i=new e,n=i.createBufferSource(),n.buffer=i.createBuffer(1,1,22050),n.connect(i.destination),n.start(),"running"===i.state?(o="allowed",d()):(o="blocked",n.disconnect(i.destination),n=null,i.close(),i=null))}function d(){"allowed"===r&&"allowed"===o&&Gs.forEach((e=>{window.removeEventListener(e,a,{capture:!0,passive:!0})}))}Gs.forEach((e=>{window.addEventListener(e,a,{capture:!0,passive:!0})}))}();let $s=class{constructor(e,t,i,n,r){this.media=e,this.audioClock=t,this.playerState=i,this.lm=n,this.qualityCtx=r,this.createPcmPlayer()}get sampleFrameDurationInMs(){return this.media.partialInfo.sampleRate<=0?0:1e3/this.media.partialInfo.sampleRate*1024}createPcmPlayer(){this.pcmPlayer=new Qs(this.media.partialInfo.sampleRate,this.playerState.volume,this.lm,this.qualityCtx,this.playerState),this.bindPcmPlayerProcessEvt()}getSyncFrameFrameMedia(){return this.media.sync.getSyncAudioFrame()}pcmPlayerProcessCallback(e,t){const i=this.getSyncFrameFrameMedia();if(!i)return;this.qualityCtx.renderStatistic.onRenderAudioFrame(),e(i.payload),t({onEnd:()=>{i.pts>=0&&this.audioClock.updateClock(i.pts+this.sampleFrameDurationInMs)}})}bindPcmPlayerProcessEvt(){this.pcmPlayer.onProcessPcm=(e,t)=>{this.pcmPlayerProcessCallback(e,t)}}get sampleRate(){return this.pcmPlayer.getSampleRate()}get stream(){return this.pcmPlayer.stream}deviceReady(){return this.pcmPlayer.isDeviceReady()}resume(){this.pcmPlayer.activeDevice()}reset(){this.audioClock.reset(),this.pcmPlayer.reset()}play(){this.audioClock.reset(),this.pcmPlayer.startReceivePcmData()}pause(){this.audioClock.paused(),this.pcmPlayer.pauseReceivePcmData()}destroy(){this.pause(),this.pcmPlayer.destroy()}setVolume(e){this.pcmPlayer.setVolume(e)}};$s=zs([it(),Ys(0,mt(tt.RenderableMedia)),Ys(1,mt(tt.AudioClock)),Ys(2,mt(tt.PlayerState)),Ys(3,mt(tt.LogMana)),Ys(4,mt(tt.QualityStatisticContext)),Ks("design:paramtypes",[Un,Object,fn,$t,Qi])],$s);class Xs{constructor(e,t){this.logger=t.createLogger("imr"),this.canvas=e,this._init()}destroy(){this.program&&this.gl.deleteProgram(this.program)}_createTexture(e){const t=e.createTexture();if(!t)throw this.logger.error("webgl cannot create texture."),new Vt("webgl cannot create texture.");return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),t}_createShader(e,t,i){const n=e.createShader(t);if(!n)throw new Vt("webgl cannot create shader");e.shaderSource(n,i),e.compileShader(n);if(!e.getShaderParameter(n,e.COMPILE_STATUS))throw this.logger.warn("get shader parameter error"+e.getShaderInfoLog(n)),e.deleteShader(n),new Vt("webgl cannot get shader parameter");return n}_createProgram(e,t,i){const n=this._createShader(e,e.VERTEX_SHADER,t),r=this._createShader(e,e.FRAGMENT_SHADER,i),o=e.createProgram();if(!o)throw this.logger.error("webgl cannot create program"),new Vt("webgl cannot create program");e.attachShader(o,n),e.attachShader(o,r),e.linkProgram(o);if(e.getProgramParameter(o,e.LINK_STATUS))return o;this.logger.warn("get program parameter error: "+e.getProgramInfoLog(o)),e.deleteProgram(o)}_init(){const e=this.canvas.getContext("webgl",{alpha:!1});if(!e)throw this.logger.error("can not get webgl context on canvas"),new Vt("can not get webgl context on canvas");this.gl=e;const t=this._createProgram(e,"\nattribute vec2 vertexPos; \nattribute vec2 texturePos;\nvarying vec2 textureCoord;\nvoid main() {\n    gl_Position = vec4(vertexPos * vec2(1, -1), 0, 1);\n    textureCoord = texturePos;\n}\n","\nprecision highp float;\nvarying highp vec2 textureCoord;\nuniform sampler2D ySampler;\nuniform sampler2D uSampler;\nuniform sampler2D vSampler;\nconst mat4 YUV2RGB = mat4(\n    1.1643828125, 0, 1.59602734375, -.87078515625,\n    1.1643828125, -.39176171875, -.81296875, .52959375,\n    1.1643828125, 2.017234375, 0, -1.081390625,\n    0, 0, 0, 1\n);\nvoid main(void) {\n    highp float y = texture2D(ySampler, textureCoord).r;\n    highp float u = texture2D(uSampler, textureCoord).r;\n    highp float v = texture2D(vSampler, textureCoord).r;\n    gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;\n}\n");if(this.program=t,!t)throw this.logger.error("webgl cannot create program when init."),new Vt("webgl cannot create program when init.");e.useProgram(t),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,1,-1,-1,1,-1,-1]),e.STATIC_DRAW);const i=e.getAttribLocation(t,"vertexPos");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,1,0,0,1,0,0]),e.STATIC_DRAW);const n=e.getAttribLocation(t,"texturePos");e.enableVertexAttribArray(n),e.vertexAttribPointer(n,2,e.FLOAT,!1,0,0);const r=this._createTexture(e),o=e.getUniformLocation(t,"ySampler");e.uniform1i(o,0);const s=this._createTexture(e),a=e.getUniformLocation(t,"uSampler");e.uniform1i(a,1);const d=this._createTexture(e),l=e.getUniformLocation(t,"vSampler");e.uniform1i(l,2),this._texture={y:r,u:s,v:d},e.pixelStorei(e.UNPACK_ALIGNMENT,1)}clearCanvas(){const e=this.gl;e.canvas.width=0,e.canvas.height=0,e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(e){const t=e.height,i=e.width,n=e.yuvData,r=this.gl;r.canvas.width===i&&r.canvas.height===t||(r.canvas.width=i,r.canvas.height=t),r.viewport(0,0,i,t);const o=n.y;r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._texture.y),r.texImage2D(r.TEXTURE_2D,0,r.LUMINANCE,o.width,o.height,0,r.LUMINANCE,r.UNSIGNED_BYTE,o.data);const s=n.u;r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this._texture.u),r.texImage2D(r.TEXTURE_2D,0,r.LUMINANCE,s.width,s.height,0,r.LUMINANCE,r.UNSIGNED_BYTE,s.data);const a=n.v;r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this._texture.v),r.texImage2D(r.TEXTURE_2D,0,r.LUMINANCE,a.width,a.height,0,r.LUMINANCE,r.UNSIGNED_BYTE,a.data),r.drawArrays(r.TRIANGLES,0,6)}}class Zs{constructor(e,t){this.canvasEl=e,this.lm=t,this.logger=t.createLogger("rd.wcir"),this.canvasCtx=this.canvasEl.getContext("2d",{alpha:!1})}destroy(){this.canvasCtx=null}render(e){if(!this.canvasCtx)throw e.close(),this.logger.error("cannot get canvas 2d context"),new Vt("cannot get canvas 2d context");const{displayWidth:t,displayHeight:i}=e;this.canvasEl.width===t&&this.canvasEl.height===i||(this.canvasEl.width=t,this.canvasEl.height=i),this.canvasCtx.clearRect(0,0,t,i),this.canvasCtx.drawImage(e,0,0,t,i),e.close()}clearCanvas(){if(!this.canvasCtx)throw this.logger.error("cannot get canvas 2d context"),new Vt("cannot get canvas 2d context");this.canvasCtx.clearRect(0,0,this.canvasEl.width,this.canvasEl.height)}}var Js=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},ea=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ta=function(e,t){return function(i,n){t(i,n,e)}},ia=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};let na=class{get synchronizer(){return this.media.sync}constructor(e,t,i,n,r,o){this.media=e,this.videoClock=t,this.lm=i,this.uiContainer=n,this.optionsContext=r,this.qualityCtx=o,this.imageRender=null,this.renderTimer=null,this.playing=!1,this.renderID=0,this.logger=this.lm.createLogger("rd.vdp"),this.initSelectImageRender(),this.pool=e.videoFrames}initSelectImageRender(){return ia(this,void 0,void 0,(function*(){this.optionsContext.useWebCodec()?this.createWebCodecImageRender():this.createYUVImageRender()}))}createWebCodecImageRender(){this.imageRender=new Zs(this.uiContainer.canvas,this.lm)}createYUVImageRender(){this.imageRender=new Xs(this.uiContainer.canvas,this.lm)}captureStream(){return this.uiContainer.canvas.captureStream()}readYUVFromQueue(){return this.pool.pop()}switchToYUVRender(){var e;null===(e=this.imageRender)||void 0===e||e.destroy(),this.imageRender=null,this.uiContainer.resetCanvas(),this.createYUVImageRender(),this.logger.warn("switch to yuv image render")}switchToWebCodecRender(){var e;null===(e=this.imageRender)||void 0===e||e.destroy(),this.imageRender=null,this.uiContainer.resetCanvas(),this.createWebCodecImageRender(),this.logger.warn("switch to web codec image render")}checkVideoFrameToSwitchRenderer(e){window.VideoFrame||this.imageRender&&this.imageRender instanceof Xs||this.switchToYUVRender(),!Ri(e.payload)||this.imageRender&&this.imageRender instanceof Zs||this.switchToWebCodecRender(),Ri(e.payload)||this.imageRender&&this.imageRender instanceof Xs||this.switchToYUVRender()}videoRender(e){var t;this.checkVideoFrameToSwitchRenderer(e),this.qualityCtx.renderStatistic.onRenderVideoFrame(),null===(t=this.imageRender)||void 0===t||t.render(e.payload),this.videoClock.updateClock(e.pts)}onVideoProcess(){if(this.pool.empty())return;const e=this.synchronizer.getSyncVideoFrame();e&&this.videoRender(e)}clearVideoTimer(){null!=this.renderTimer&&(cancelAnimationFrame(this.renderTimer),this.renderTimer=null)}startPlayTimer(e){if(e!==this.renderID)return;this.renderTimer=requestAnimationFrame((()=>{this.onVideoProcess(),this.startPlayTimer(e)}))}_stopPlayTimer(){this.clearVideoTimer(),this.renderID++}captureImage(){return this.uiContainer.canvas.toDataURL()}resume(){const e=this.readYUVFromQueue();e&&this.videoRender(e)}play(){this.playing?this.logger.info("video is already playing !"):(this.renderID++,this.startPlayTimer(this.renderID),this.playing=!0)}pause(){this.playing?(this._stopPlayTimer(),this.videoClock.reset(),this.playing=!1):this.logger.info("video is not playing !")}clearCanvas(){var e;null===(e=this.imageRender)||void 0===e||e.clearCanvas()}destroy(){this._stopPlayTimer(),this.playing=!1,this.videoClock.reset()}};Js([Ht("rsum"),ea("design:type",Function),ea("design:paramtypes",[]),ea("design:returntype",void 0)],na.prototype,"resume",null),Js([Ht("pl"),ea("design:type",Function),ea("design:paramtypes",[]),ea("design:returntype",void 0)],na.prototype,"play",null),Js([Ht("pu"),ea("design:type",Function),ea("design:paramtypes",[]),ea("design:returntype",void 0)],na.prototype,"pause",null),Js([Ht("dst"),ea("design:type",Function),ea("design:paramtypes",[]),ea("design:returntype",void 0)],na.prototype,"destroy",null),na=Js([it(),ta(0,mt(tt.RenderableMedia)),ta(1,mt(tt.VideoClock)),ta(2,mt(tt.LogMana)),ta(3,mt(tt.UIContainer)),ta(4,mt(tt.OptionsContext)),ta(5,mt(tt.QualityStatisticContext)),ea("design:paramtypes",[Un,Object,$t,Object,Object,Qi])],na);var ra=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},oa=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},sa=function(e,t){return function(i,n){t(i,n,e)}};let aa=class{get videoElement(){return this.uiContainer.videoElement}constructor(e){this.lastTimeUpdateTime=0,this.waitingCheckTimer=null,this.maxTimeUpdateGapMs=500,this.waitingCheckerIntervalMs=500,this.e={onvTimeUpdate:this.onvTimeUpdate.bind(this)},this.logger=e.createLogger("mse.wtd")}onvTimeUpdate(){this.lastTimeUpdateTime=performance.now(),!this.playerState.waiting||this.playerState.decodeEnded||this.playerState.loaded||(this.playerState.waiting=!1)}bindVideoElementEvents(){this.unbindVideoElementEvents(),this.videoElement.addEventListener("timeupdate",this.e.onvTimeUpdate)}unbindVideoElementEvents(){this.videoElement.removeEventListener("timeupdate",this.e.onvTimeUpdate)}startWaitingCheckTimer(){this.stopWaitingCheckTimer(),this.waitingCheckTimer=setInterval((()=>{performance.now()-this.lastTimeUpdateTime>this.maxTimeUpdateGapMs&&!this.playerState.waiting&&!this.playerState.loaded&&(this.logger.info("(mse) callback. set waiting true"),this.playerState.waiting=!0)}),this.waitingCheckerIntervalMs)}stopWaitingCheckTimer(){this.waitingCheckTimer&&(clearInterval(this.waitingCheckTimer),this.waitingCheckTimer=null)}startWaitingDetect(){this.logger.info("start waiting check"),this.lastTimeUpdateTime=performance.now(),this.bindVideoElementEvents(),this.startWaitingCheckTimer()}pauseWaitingDetect(){this.logger.info("pause waiting check"),this.unbindVideoElementEvents(),this.stopWaitingCheckTimer(),this.lastTimeUpdateTime=0}};ra([mt(tt.UIContainer),oa("design:type",Object)],aa.prototype,"uiContainer",void 0),ra([mt(tt.PlayerState),oa("design:type",Object)],aa.prototype,"playerState",void 0),aa=ra([it(),sa(0,mt(tt.LogMana)),oa("design:paramtypes",[$t])],aa);let da=class{constructor(){this.lastPlayStats={lastTimestamp:0,paintedFrames:0,renderTime:0,totalRenderFrames:0,videoElem:null},this.e={onVideoFramesRender:this.onVideoFramesRender.bind(this),onBeforeUploadQuality:this.onBeforeUploadQuality.bind(this)}}get videoElement(){return this.uiContainer.videoElement}onBeforeUploadQuality(){const e=this.getVideoRenderFps(this.videoElement);this.qualityStatistic.renderStatistic.setVideoFPS(e)}onVideoFramesRender(){const{videoElem:e,lastTimestamp:t}=this.lastPlayStats;if(e&&e.requestVideoFrameCallback){const i=e.currentTime;t!=i&&(this.lastPlayStats.paintedFrames++,this.lastPlayStats.lastTimestamp=i),e.requestVideoFrameCallback(this.e.onVideoFramesRender)}}isSupportGetVideoRenderFps(e){return e&&(!!e.getVideoPlaybackQuality||!!e.requestVideoFrameCallback||void 0!==e.mozPaintedFrames)}initElementByVideoFrameCallback(e){const t=this.lastPlayStats.videoElem,i=e.currentTime;t&&t==e||(this.lastPlayStats.videoElem=e,this.lastPlayStats.lastTimestamp=i,t||e.requestVideoFrameCallback(this.e.onVideoFramesRender))}getVideoRenderFps(e){if(!e||!this.isSupportGetVideoRenderFps(e))return-1;const t=e.getVideoPlaybackQuality();e.requestVideoFrameCallback&&!t.totalVideoFrames?this.initElementByVideoFrameCallback(e):this.lastPlayStats.videoElem=null;let i=-1;const n=this.lastPlayStats.videoElem,r=Date.now(),{renderTime:o,totalRenderFrames:s,paintedFrames:a}=this.lastPlayStats;let d;d="firefox"!==bi.getBrowser()||t.totalVideoFrames||n||void 0===e.mozPaintedFrames?n?a:t.totalVideoFrames-t.droppedVideoFrames:e.mozPaintedFrames;return i=0!=o?1e3*(d-s)/(r-o):d/t.creationTime,this.lastPlayStats.renderTime=r,this.lastPlayStats.totalRenderFrames=d,i}startFPSDetect(){this.qualityStatistic.event.off(ji.BEFORE_UPLOAD_QUALITY,this.e.onBeforeUploadQuality),this.qualityStatistic.event.on(ji.BEFORE_UPLOAD_QUALITY,this.e.onBeforeUploadQuality)}pauseFPSDetect(){this.lastPlayStats={lastTimestamp:0,paintedFrames:0,renderTime:0,totalRenderFrames:0,videoElem:null},this.qualityStatistic.renderStatistic.clearVideoFpsSet(),this.qualityStatistic.event.off(ji.BEFORE_UPLOAD_QUALITY,this.e.onBeforeUploadQuality)}};ra([mt(tt.UIContainer),oa("design:type",Object)],da.prototype,"uiContainer",void 0),ra([mt(tt.QualityStatisticContext),oa("design:type",Qi)],da.prototype,"qualityStatistic",void 0),da=ra([it()],da);let la=class{get videoElement(){return this.uiContainer.videoElement}constructor(e){this.maxDelayMS=5e3,this.logger=e.createLogger("rd.mapd")}isAutoPlayFailed(){return this.playerState.userPlayed&&this.videoElement.readyState>2&&this.videoElement.buffered.length>0&&this.videoElement.paused&&"hidden"!==document.visibilityState}start(){this.cancel(),this.playerState.userPlayed&&(this.timeout=setTimeout((()=>{if(this.isAutoPlayFailed())throw this.logger.warn("video auto play fail. (use mse)"),new jt("auto play error, please click the page continue to play.")}),this.maxDelayMS))}cancel(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}};ra([mt(tt.PlayerState),oa("design:type",Object)],la.prototype,"playerState",void 0),ra([mt(tt.UIContainer),oa("design:type",Object)],la.prototype,"uiContainer",void 0),ra([Ht("sta"),oa("design:type",Function),oa("design:paramtypes",[]),oa("design:returntype",void 0)],la.prototype,"start",null),ra([Ht("cnc"),oa("design:type",Function),oa("design:paramtypes",[]),oa("design:returntype",void 0)],la.prototype,"cancel",null),la=ra([it(),sa(0,mt(tt.LogMana)),oa("design:paramtypes",[$t])],la);let ua=class{constructor(e,t,i){this.globalEvent=e,this.lm=t,this.playerState=i,this.fullScreenPrefixes=["","moz","webkit","ms"],this.lastPausedTime=0,this.bufferCheckTimer=null,this.bufferCheckedCallbacks={activePlayVideo:null,setMediaOpened:null},this.lastVideoInteractTime=-1/0,this.lastApiCallPlayTime=-1/0,this.maxInteractDelay=100,this.minRemainBufferDuration=1,this.lastApiCallFullScreenTime=0,this.maxApiCallFullScreenDelay=500,this.isApiCallFullScreenEnter=!1,this.e={onvCanPlay:this.onvCanPlay.bind(this),onvTimeUpdate:this.onvTimeUpdate.bind(this),onvPlaying:this.onvPlaying.bind(this),onvWaiting:this.onvWaiting.bind(this),onvLoadedMetadata:this.onvLoadedMetadata.bind(this),onvPlay:this.onvPlay.bind(this),onvPause:this.onvPause.bind(this),onvVolumeChange:this.onvVolumeChange.bind(this),onvEnded:this.onvEnded.bind(this),onPageClick:this.onPageClick.bind(this),onVideoClick:this.onUserInteractVideo.bind(this),onFullScreenChange:this.onFullScreenChange.bind(this),onFullScreenEnter:this.onFullScreenEnter.bind(this),onFullScreenOut:this.onFullScreenOut.bind(this)},this.logger=t.createLogger("msvc"),this.globalEvent.event.once(di.DESTROY,(()=>{!this.videoElement.paused&&this.videoElement.pause()})),this.backgroundHandler=new Wn(this.playerState,this.lm,this)}get videoElement(){return this.uiContainer.videoElement}onvVolumeChange(){this.playerState.muted=this.videoElement.muted,this.playerState.volume=100*this.videoElement.volume,this.qualityContext.renderStatistic.volumeIn100=100*this.videoElement.volume}onvPause(){this.logger.info("video onpause callback"),this.playerState.pausedRendering=!0,this.isFromUserClick()&&(this.videoFpsDetection.pauseFPSDetect(),this.waitingDetection.pauseWaitingDetect(),this.autoPlayDetect.cancel(),this.playerState.userPlayed=!1),this.lastPausedTime=performance.now(),this.endBufferCheckTimer()}isFromApiCallPlay(){return performance.now()-this.lastApiCallPlayTime<this.maxInteractDelay}onvPlay(){this.logger.info("video onplay callback"),this.playerState.mediaOpened=!0,this.playerState.isRendering=!0,this.waitingDetection.startWaitingDetect(),this.videoFpsDetection.startFPSDetect(),this.autoPlayDetect.cancel(),this.seekToEndTime(),(this.isFromUserClick()||this.isFromApiCallPlay())&&(this.playerState.userPlayed=!0)}onvPlaying(){this.playerState.waiting=!1}onvWaiting(){this.playerState.waiting=!0}onvCanPlay(){this.playerState.mediaOpened||(this.isBufferEnough()?this.setMediaOpened():(this.logger.info("video canplay callback and wait buffer to set media opened"),this.bufferCheckedCallbacks.setMediaOpened=this.setMediaOpened.bind(this),this.launchBufferCheckTimer())),this.playerState.audioDeviceReady=!0,this.autoPlayDetect.start(),this.qualityContext.renderStatistic.firstVideoFrame()}onvTimeUpdate(){this.playerState.currentTime=1e3*this.videoElement.currentTime}onvLoadedMetadata(){this.minRemainBufferDuration=1,this.playerState.userPlayed&&this.videoElement.paused&&(this.logger.info("video start play"),this.play())}onFullScreenChange(){this.windowIsFullScreen()?this.windowIsFullScreen()&&this.onFullScreenEnter():this.onFullScreenOut()}onFullScreenEnter(){this.logger.info("video fullscreen enter"),this.uiContainer.isUserVideoElement()||performance.now()-this.lastApiCallFullScreenTime<this.maxApiCallFullScreenDelay&&(this.videoElement.controls=!0,this.isApiCallFullScreenEnter=!0)}onFullScreenOut(){this.logger.info("video fullscreen out"),this.uiContainer.isUserVideoElement()||(this.isApiCallFullScreenEnter&&(this.videoElement.controls=!1,this.isApiCallFullScreenEnter=!1),Ao.safari&&this.uiContainer.remountVideoInWrapper())}isBufferEnough(){const e=this.videoElement.buffered.length;let t=0;return e>0&&(t=this.videoElement.buffered.end(e-1)),t-this.videoElement.currentTime>this.minRemainBufferDuration}clearBufferCheckedCallbacks(){for(const e in this.bufferCheckedCallbacks)this.bufferCheckedCallbacks[e]=null}endBufferCheckTimer(){this.clearBufferCheckedCallbacks(),this.stopBufferCheckTimer()}stopBufferCheckTimer(){this.bufferCheckTimer&&(clearInterval(this.bufferCheckTimer),this.bufferCheckTimer=null)}runBufferCheckedCallbacks(){for(const e in this.bufferCheckedCallbacks){const t=this.bufferCheckedCallbacks[e];t&&t(),this.bufferCheckedCallbacks[e]=null}}launchBufferCheckTimer(){this.logger.info("launch buffer check timer"),this.stopBufferCheckTimer(),this.bufferCheckTimer=setInterval((()=>{this.isBufferEnough()&&(this.stopBufferCheckTimer(),this.runBufferCheckedCallbacks())}),100)}onvEnded(){this.videoElement.paused&&this.videoElement.ended&&(this.logger.info("onvEnd - wait buffer duration 2"),this.minRemainBufferDuration=2,this.bufferCheckedCallbacks.activePlayVideo=this.actionPlayWithoutCheckBuffer.bind(this),this.launchBufferCheckTimer())}setMediaOpened(){this.logger.info("set media opened"),this.playerState.mediaOpened=!0}onUserInteractVideo(){this.lastVideoInteractTime=performance.now()}isFromUserClick(){return performance.now()-this.lastVideoInteractTime<this.maxInteractDelay}bindVideoControlEvents(){this.unbindVideoControlEvents();const e=this.videoElement;e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("timeupdate",this.e.onvTimeUpdate),e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.addEventListener("pause",this.e.onvPause),e.addEventListener("play",this.e.onvPlay),e.addEventListener("volumechange",this.e.onvVolumeChange),e.addEventListener("ended",this.e.onvEnded),e.addEventListener("click",this.e.onVideoClick),document.body.addEventListener("click",this.e.onPageClick),this.bindFullScreenEvent()}onPageClick(){this.playerState.userPlayed&&this.videoElement.paused&&performance.now()-this.lastPausedTime>100&&this.videoElement.readyState>2&&(this.logger.info(`page click call resume play (mse) ${this.playerState.userPlayed} ${this.videoElement.paused} ${this.videoElement.readyState}`),this.play())}unbindFullScreenEvents(){const e=this.videoElement;this.fullScreenPrefixes.forEach((e=>{document.removeEventListener(e+"fullscreenchange",this.e.onFullScreenChange)})),e&&(e.removeEventListener("webkitendfullscreen",this.e.onFullScreenOut),e.removeEventListener("webkitenterfullscreen",this.onFullScreenEnter))}bindFullScreenEvent(){this.unbindFullScreenEvents();const e=this.videoElement;this.fullScreenPrefixes.forEach((e=>{document.addEventListener(e+"fullscreenchange",this.e.onFullScreenChange)})),e&&(e.addEventListener("webkitendfullscreen",this.e.onFullScreenOut),e.addEventListener("webkitenterfullscreen",this.onFullScreenEnter))}unbindVideoControlEvents(){const e=this.videoElement;e.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.removeEventListener("canplay",this.e.onvCanPlay),e.removeEventListener("timeupdate",this.e.onvTimeUpdate),e.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.removeEventListener("pause",this.e.onvPause),e.removeEventListener("play",this.e.onvPlay),e.removeEventListener("volumechange",this.e.onvEnded),e.removeEventListener("ended",this.e.onvVolumeChange),document.body.removeEventListener("click",this.e.onPageClick),this.unbindFullScreenEvents()}showVideoElement(){this.uiContainer.setVideoElementAttributes({controls:!1},[]),this.uiContainer.showVideoElement()}updateConfigFromVideoEl(){this.playerState.muted=this.videoElement.muted,this.playerState.volume=100*this.videoElement.volume,this.logger.info("video config set muted "+this.playerState.muted+" volume "+this.playerState.volume)}mount(){this.logger.info("(mse) video controller mount "),this.uiContainer.isUserVideoElement()?this.updateConfigFromVideoEl():this.showVideoElement(),this.bindVideoControlEvents(),this.videoElement.volume=this.playerState.volume/100,this.videoElement.muted=this.playerState.muted,this.qualityContext.renderStatistic.volumeIn100=100*this.videoElement.volume,this.backgroundHandler.active()}hideVideoElement(){this.uiContainer.setVideoElementAttributes({controls:!0},[]),this.uiContainer.hideVideoElement()}pauseAllSubModules(){this.logger.info("pause all submodule"),this.backgroundHandler.pause(),this.waitingDetection.pauseWaitingDetect(),this.autoPlayDetect.cancel(),this.videoFpsDetection.pauseFPSDetect(),this.unbindVideoControlEvents(),this.endBufferCheckTimer(),this.playerState.waiting||(this.playerState.waiting=!1)}unmount(){this.logger.info("(mse) video controller unmount "),this.uiContainer.isUserVideoElement()||this.hideVideoElement(),this.pauseAllSubModules()}destroy(){this.pauseAllSubModules()}setMuted(e){this.videoElement.muted=e}setVolume(e){this.videoElement.volume=e/100}windowIsFullScreen(){const e=this.videoElement;return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitCurrentFullScreenElement||e&&e.webkitDisplayingFullscreen}requestVideoFullScreen(e){e&&!this.windowIsFullScreen()&&(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitSupportsFullscreen&&e.webkitEnterFullscreen&&e.webkitEnterFullscreen())}fullScreen(){this.logger.info("full screen call (mse)"),this.lastApiCallFullScreenTime=performance.now(),this.requestVideoFullScreen(this.videoElement)}seekToEndTime(){this.logger.info("check and seek to end time"),this.mseContextSingleton().seekToEnd()}actionPlayWithoutCheckBuffer(){if(this.logger.info("action play video call"),this.backgroundHandler.isPageHidden())return this.logger.info("page hidden, pause video and wait page visible..."),this.backgroundHandler.setReplayWhenPageVisible(),void this.pause();this.lastApiCallPlayTime=performance.now(),this.videoElement.play().catch((e=>{this.logger.info(e)}))}play(){if(!this.isBufferEnough()&&!this.videoElement.autoplay)return this.bufferCheckedCallbacks.activePlayVideo=this.actionPlayWithoutCheckBuffer.bind(this),void this.launchBufferCheckTimer();this.actionPlayWithoutCheckBuffer()}pause(){this.endBufferCheckTimer(),this.onUserInteractVideo(),this.videoElement.pause()}resume(){}};ra([mt(tt.UIContainer),oa("design:type",Object)],ua.prototype,"uiContainer",void 0),ra([mt(tt.MSEWaitingDetection),oa("design:type",aa)],ua.prototype,"waitingDetection",void 0),ra([mt(tt.DomVideoFPSDetection),oa("design:type",da)],ua.prototype,"videoFpsDetection",void 0),ra([mt(tt.QualityStatisticContext),oa("design:type",Qi)],ua.prototype,"qualityContext",void 0),ra([mt(tt.MSEAutoPlayDetect),oa("design:type",la)],ua.prototype,"autoPlayDetect",void 0),ra([mt(tt.MseContextBuilder),oa("design:type",Function)],ua.prototype,"mseContextSingleton",void 0),ra([Ht("0.ucfv"),oa("design:type",Function),oa("design:paramtypes",[]),oa("design:returntype",void 0)],ua.prototype,"updateConfigFromVideoEl",null),ua=ra([it(),sa(0,mt(tt.GlobalEvent)),sa(1,mt(tt.LogMana)),sa(2,mt(tt.PlayerState)),oa("design:paramtypes",[Object,$t,Object])],ua);var ca,ha,pa=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},fa=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ma=function(e,t){return function(i,n){t(i,n,e)}};!function(e){e.UPDATE_MODEL="updateModel"}(ca||(ca={})),function(e){e.PLAYER_STATE="playerState",e.CONFIG_STATE="configState"}(ha||(ha={}));let ga=class{constructor(e,t,i){this._playerState=e,this._configState=t,this.lm=i,this.logger=this.lm.createLogger("0.dmg")}_setProp(e,t,i){e[t]=i}_updatePlayerState(e){for(const t of Object.keys(e)){const i=t,n=e[i];void 0!==n&&this._setProp(this._playerState,i,n)}}_updateConfigState(e){for(const t of Object.keys(e)){const i=t,n=e[i];void 0!==n&&this._setProp(this._configState,i,n)}}_updateModel(e,t){switch(e){case ha.PLAYER_STATE:this.logger.info("update player state",t),this._updatePlayerState(t);break;case ha.CONFIG_STATE:this.logger.info("update config state",t),this._updateConfigState(t);break;default:this.logger.error("unknown model name: ",e)}}postMessage(e){}onmessage(e){switch(e.type){case ca.UPDATE_MODEL:{const{modelName:t,model:i}=e.data;this._updateModel(t,i);break}default:this.logger.error("unknown msg type: ",e.type)}}terminate(){}};pa([Ht("0.uml"),fa("design:type",Function),fa("design:paramtypes",[String,Object]),fa("design:returntype",void 0)],ga.prototype,"_updateModel",null),ga=pa([it(),ma(0,mt(tt.PlayerState)),ma(1,mt(tt.ConstantState)),ma(2,mt(tt.LogMana)),fa("design:paramtypes",[fn,Dt,$t])],ga);var ya=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},va=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},ba=function(e,t){return function(i,n){t(i,n,e)}};let _a=class{constructor(e,t){this._playerEmitter=e,this.lm=t,this.logger=this.lm.createLogger("0.errh")}_handleZegoError(e){const{code:t,msg:i}=JSON.parse(e.message);if(this.logger.error("error: "+JSON.stringify({code:t,msg:i})),0===this._playerEmitter.listenerCount(li.ERROR))throw e;this._playerEmitter.emit(li.ERROR,{code:t,msg:i})}_handleErrorLog(e){this.logger.info("catch error: ",e.message)}postMessage(e){}onmessage(e){const{type:t}=e;switch(t){case"onzegoerror":{const{error:t}=e.data;this._handleZegoError(t);break}case"onerrorlog":{const{error:t}=e.data;this._handleErrorLog(t);break}default:throw new Vt("unknown message type "+t)}}terminate(){}};ya([Ht("hzer",{callInfo:!1}),va("design:type",Function),va("design:paramtypes",[Error]),va("design:returntype",void 0)],_a.prototype,"_handleZegoError",null),ya([Ht("lger",{callInfo:!1}),va("design:type",Function),va("design:paramtypes",[Error]),va("design:returntype",void 0)],_a.prototype,"_handleErrorLog",null),ya([Ht("omsg"),va("design:type",Function),va("design:paramtypes",[Object]),va("design:returntype",void 0)],_a.prototype,"onmessage",null),_a=ya([it(),ba(0,mt(tt.PlayerEventEmitter)),ba(1,mt(tt.LogMana)),va("design:paramtypes",[an,$t])],_a);var Ca=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ea=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Sa=function(e,t){return function(i,n){t(i,n,e)}},wa=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};let Ra=class{constructor(e,t,i,n,r,o,s,a){this._render=e,this._playerEmitter=t,this._dataManager=i,this.lm=n,this._errorHandler=r,this.qualityCtx=o,this._wasmFactory=s,this.globalEvt=a,this._map=new Map,this._destroied=!1,this._loaded=!1,this._cacheMsg=[],this._registerWorkerTags=[$n.WASM_WORKER],this._registerObjectTags=[$n.RENDER,$n.EVENT_EMITTER,$n.DATA_MANAGER,$n.LOGGER_MANAGER,$n.ERROR_HANDLER,$n.QUALITY_STATISTIC,$n.WASM_FACTORY],this.logger=this.lm.createLogger("dspt"),this.globalEvt.event.once(di.DESTROY,(()=>this.destroy())),this._registerWorkerTags.forEach(((e,t)=>wa(this,void 0,void 0,(function*(){yield this.load(e),t===this._registerWorkerTags.length-1&&(this._loaded=!0,this._cacheMsg.forEach((e=>{this.dispatchMessage(e)})),this._cacheMsg=[])})))),this._registerObjectTags.forEach((e=>this.load(e)))}_createDispatchable(e){return wa(this,void 0,void 0,(function*(){switch(e){case $n.WASM_WORKER:try{return new Worker(new URL(i.p+i.u(509),i.b))}catch(t){throw new Vt("cannot create worker 'wasm worker'. "+t.message)}case $n.RENDER:return this._render;case $n.EVENT_EMITTER:return this._playerEmitter;case $n.DATA_MANAGER:return this._dataManager;case $n.LOGGER_MANAGER:return this.lm;case $n.ERROR_HANDLER:return this._errorHandler;case $n.QUALITY_STATISTIC:return this.qualityCtx;case $n.WASM_FACTORY:return this._wasmFactory;default:throw new Vt("unknown worker tag "+e)}}))}onReceiveMessage(e){}dispatchMessage(e){if(this._destroied)return void this.logger.info("player destroyed, end dispatch message");if(qt.bind(e).is.exist.then(e.type).exist.then(e.target).exist.catch((()=>{throw new Vt("dispatcher error, illegal message.")})),!this._loaded)return void this._cacheMsg.push(e);const t=e.target;if(this._registerWorkerTags.some((e=>e===t))){const i=this._map.get(t);if(i){let t=[];e.transferableObjects&&(t=e.transferableObjects,delete e.transferableObjects),i.postMessage(e,t)}}else{if(!this._registerObjectTags.some((e=>e===t)))throw new Vt("can not dispatch message , target: "+t);{const i=this._map.get(t);e.transferableObjects&&delete e.transferableObjects,i&&i.onmessage(e)}}}load(e){return wa(this,void 0,void 0,(function*(){this._map.get(e)||this._map.set(e,yield this._createDispatchable(e));const t=this._map.get(e);if(!t)throw new Vt("cannot dispatch target: "+e);t instanceof window.Worker?t.onmessage=e=>{const{data:t}=e;this.dispatchMessage(t)}:t.postMessage=e=>{this.dispatchMessage(e)}}))}destroy(){this._map.forEach((e=>{e.terminate()})),this._destroied=!0}};Ca([Ht("cdpt",{callInfo:!1}),Ea("design:type",Function),Ea("design:paramtypes",[String]),Ea("design:returntype",Promise)],Ra.prototype,"_createDispatchable",null),Ra=Ca([it(),Sa(0,mt(tt.RenderContext)),Sa(1,mt(tt.PlayerEventEmitter)),Sa(2,mt(ga)),Sa(3,mt(tt.LogMana)),Sa(4,mt(_a)),Sa(5,mt(tt.QualityStatisticContext)),Sa(6,mt(tt.WasmFactory)),Sa(7,mt(tt.GlobalEvent)),Ea("design:paramtypes",[Object,an,ga,$t,_a,Qi,fr,Object])],Ra);class Da{constructor(e,t){this._global=e,this._postMessage=t,this._log=!1,this._errorMap=new Map}_postError(e){const t={target:$n.ERROR_HANDLER,type:"onzegoerror",data:{error:e}};if(this._postMessage)this._postMessage(t);else{if(!this._global.postMessage)throw new Vt("Cannot post error to ErrorHandler.");this._global.postMessage(t)}}_postLog(e){const t={target:$n.ERROR_HANDLER,type:"onerrorlog",data:{error:e}};if(this._postMessage)this._postMessage(t);else{if(!this._global.postMessage)throw new Vt("Cannot post error to ErrorHandler.");this._global.postMessage(t)}}_logError(e){const t=e.error&&e.error.message||e.message;this._postLog(new Error(t))}_logRejection(e){const t=e.reason&&e.reason.message||"unhandledrejection";this._postLog(new Error(t))}_handleError(e){const t=e.error;return!t||t.name!==At||(this._errorMap.get(t)||(this._errorMap.set(t,!0),this._postError(t)),e.preventDefault(e),e.stopPropagation(),!1)}_handleRejection(e){const t=e.reason;return!t||t.name!==At||(this._errorMap.get(t)||(this._errorMap.set(t,!0),this._postError(t)),e.preventDefault(e),e.stopPropagation(),!1)}listen(){this._global.addEventListener("error",(e=>(this._log&&this._logError(e),this._handleError(e)))),this._global.addEventListener("unhandledrejection",(e=>(this._log&&this._logRejection(e),this._handleRejection(e))))}enableLog(){this._log=!0}}var Aa=i(701),Pa=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Fa=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Ta=function(e,t){return function(i,n){t(i,n,e)}},xa=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};const ka=((e,t=21)=>((e,t,i)=>{let n=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*n*t/e.length);return(o=t)=>{let s="";for(;;){let t=i(r),a=r;for(;a--;)if(s+=e[t[a]&n]||"",s.length===o)return s}}})(e,t,Ct))(Aa.numbers,8);let Ma=class{environmentCheck(){if(!(window.WebAssembly&&(window.AudioContext||window.webkitAudioContext)&&window.WebGLRenderingContext&&window.Worker&&window.AbortController)){const e=`\n          environment not support!\n          window.WebAssembly: ${!!window.WebAssembly},\n          window.AudioContext: ${!!window.AudioContext}\n          window.webkitAudioContext : ${!!window.webkitAudioContext}\n          window.WebGLRenderingContext: ${!!window.WebGLRenderingContext}\n          window.Worker: ${!!window.Worker}\n          window.AbortController: ${!!window.AbortController}\n        `;throw this.logger.error(e),new Bt(e)}}seiConfigUpdate(){var e;const t=null===(e=this.engineInjections)||void 0===e?void 0:e.seiConfig();t&&this.seiReceiver.updateSeiConfig(t)}get destroyed(){return this.playerState.destroy}constructor(e,t,i,n,r,o,s,a,d,l){this.playerState=e,this.configState=t,this.dispatcher=i,this.playerEmitter=n,this.lm=r,this.contextFactory=o,this.seiReceiver=s,this.globalEvt=a,this.utils=d,this.qualityContext=l,this.playerReceiver={sendMsg:e=>{if("SEIConfigUpdate"===e.type)this.seiConfigUpdate()}},this.logger=this.lm.createLogger("0.pctl"),this.logger.info("ZegoExpressPlayer Version:"+St),this.logger.info(`browser info: ${JSON.stringify(Ao)}`),this.errorListener=new Da(window,(e=>{this.dispatcher.dispatchMessage(e)})),this.errorListener.listen(),this.bindGlobalEvent()}setCustomStream(e){var t;qt.expect(e).verify((e=>null===e||e instanceof MediaStream)).catch((()=>{throw new Lt("illegal stream. You can only set 'MediaStream' or null.")})),e?(this.qualityContext.startUploadQuality(),this.setUrl("")):this.qualityContext.stopUploadQuality(),this.playerState.customStream=e,null===(t=this.renderContext)||void 0===t||t.bindCustomStream(e)}getCustomStream(){return this.playerState.customStream}bindGlobalEvent(){this.globalEvt.event.on(di.MEDIA_REFETCH,(e=>{this.utils.antiShake.run(dn.ResumeFetchUrl,(()=>{var t,i;this.logger.info("resume fetch url.."),null===(t=this.renderContext)||void 0===t||t.resume(),null===(i=this.renderContext)||void 0===i||i.waiting(),this.playerState.setRefetchRuntimeState(),this.refetchUrl(e)}),{minDelayMs:2e3,mode:"cancel_before"})}))}createContexts(){this.demuxContext=this.contextFactory.createDemuxContext(),this.decoderContext=this.contextFactory.createDecodeContext(),this.renderContext=this.contextFactory.createRenderContext()}stateCheck(){if(!this.validated)throw new Vt("player is not validated. Please use verify() and pass in the correct token and userID.");if(this.destroyed)throw new Vt("player destroied!")}initConfig(e,t,i){var n;qt.bind(e).is.exist.catch((()=>{throw new Lt("config is needed. example: 'var player = new ZegoExpressPlayer(..., { /* config here */  });'")})).verify((e=>!(e.videoElement&&e.container))).catch((()=>{throw new Lt("Simultaneous use of parameter 'videoElement' and parameter 'container' is not allowed.")})).hasKey("mode").then(e.mode).eq("live").catch((()=>{throw new Lt("param 'mode' should be set 'live'. example: 'var player = new ZegoExpressPlayer(..., { ... , mode: \"live\");'")})),qt.bind(t).is.exist.hasKey("appid").hasKey("logger").hasKey("validateToken").hasKey("seiConfig").hasKey("addReceiver").hasKey("removeReceiver").catch((()=>{throw new Vt("player lacks injection from sdk, initialization failed! This may be caused by the version of 'zego-express-engine-webrtc' package being too low.")})),this.contextFactory.setOptions({decodeType:e.decodeType}),this.createContexts(),t.addReceiver(this.playerReceiver),this.validated=i||t.isLogin&&t.isLogin()||false,this.lm.setZegoLogger(t.logger),this.configState.setConfig({appid:t.appid,version:St}),e.videoElement&&this.setVideoEl(e.videoElement),e.container&&(null===(n=this.renderContext)||void 0===n||n.bindContainer(e.container)),this.engineInjections=t,this.environmentCheck(),t.seiConfig()&&this.seiConfigUpdate(),this.logger.info("player init success.")}verifyToken(e,t){var i;return xa(this,void 0,void 0,(function*(){if(this.validated)return!0;qt.expect(e).typeof("string").catch((()=>{throw new Lt("token need to be string")})).then(t).typeof("string").catch((()=>{throw new Lt("userID need to be string")}));const n=yield null===(i=this.engineInjections)||void 0===i?void 0:i.validateToken(e,t);return this.validated=!!n,this.validated}))}setUrl(e){if(this.stateCheck(),qt.expect(e).typeof("string").catch((()=>{throw new Lt("url need to be string")})).verify((e=>""===e||bi.isFlvMediaSource(e))).catch((()=>{throw new Lt("The URL of the media resource only supports 'flv' format")})),""!==e&&(e=bi.change2fullPath(e)),this.logger.info("set url to "+e),this.qualityContext.reset(),""===e)return this.stop(),void(this.playerState.url="");this.setCustomStream(null),this.stopLoad(),this.playerState.url=e,this.startLoad(e)}stopLoad(){var e,t;this.playerState.taskID=Number.parseInt(ka()),null===(e=this.demuxContext)||void 0===e||e.stop(),null===(t=this.decoderContext)||void 0===t||t.reset()}startLoad(e){var t,i;null===(t=this.decoderContext)||void 0===t||t.startDecode(),null===(i=this.demuxContext)||void 0===i||i.setUrl(e),this.qualityContext.networkStatistic.networkRequestStart(),this.qualityContext.renderStatistic.renderRequestStart()}refetchUrl(e){this.stopLoad(),""!==e?this.startLoad(e):this.stop()}getUrl(){return this.stateCheck(),this.playerState.url}play(){var e,t;this.stateCheck(),null===(e=this.renderContext)||void 0===e||e.resume(),null===(t=this.renderContext)||void 0===t||t.play()}pause(){var e;this.stateCheck(),null===(e=this.renderContext)||void 0===e||e.pause()}setVideoEl(e){var t;null===(t=this.renderContext)||void 0===t||t.bindVideoElement(e)}resume(){var e,t;this.stateCheck(),this.playerState.customStream?(this.setCustomStream(this.playerState.customStream),null===(e=this.renderContext)||void 0===e||e.resume(),this.play()):this.playerState.url&&(null===(t=this.renderContext)||void 0===t||t.resume(),this.setUrl(this.playerState.url),this.play())}getCurrentTime(){return this.stateCheck(),Number((this.playerState.currentTime/1e3).toFixed(2))}getPlayed(){return this.stateCheck(),this.playerState.isRendering}getPaused(){return this.stateCheck(),this.playerState.pausedRendering}getVolume(){return this.stateCheck(),this.playerState.volume}getDuration(){return this.stateCheck(),this.playerState.duration}getMediaInfo(){return this.stateCheck(),this.playerState.mediaInfo.info}getCanvas(){return this.stateCheck(),this.renderContext.getCanvas()}setVolume(e){var t;this.stateCheck(),qt.expect(e).typeof("number").range([0,100]).catch((()=>{throw new Lt("volume must be in the interval [0, 100].")})),null===(t=this.renderContext)||void 0===t||t.setVolume(e)}stopAllContext(){var e,t,i;null===(e=this.demuxContext)||void 0===e||e.stop(),null===(t=this.decoderContext)||void 0===t||t.stopDecode(),null===(i=this.renderContext)||void 0===i||i.stop()}stop(){this.stateCheck(),this.stopAllContext(),this.playerState.loaded=!0}destroy(){var e;this.globalEvt.event.emit(di.DESTROY),this.playerEmitter.removeAllListeners(),null===(e=this.engineInjections)||void 0===e||e.removeReceiver(this.playerReceiver),this.globalEvt.event.removeAllListeners(),this.playerState.destroy=!0}setMuted(e){var t;this.stateCheck(),null===(t=this.renderContext)||void 0===t||t.setMuted(e)}fullScreen(){var e;this.stateCheck(),null===(e=this.renderContext)||void 0===e||e.fullScreen()}setAdvanceConfig(e){this.configState.setConfig({advanceConfig:Object.assign(Object.assign({},this.configState.advanceConfig),e)})}addEventListener(e,t){this.stateCheck(),qt.expect(e).typeof("string").catch((()=>{throw new Lt("event name should be a string.")})),qt.expect(t).typeof("function").catch((()=>{throw new Lt("event callback should be a function")})),t&&this.playerEmitter.on(e,t)}removeEventListener(e,t){this.stateCheck(),qt.expect(e).typeof("string").catch((()=>{throw new Lt("event name should be a string.")})),t?this.playerEmitter.off(e,t):this.playerEmitter.removeAllListeners(e)}};Pa([Ht("0.eck"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"environmentCheck",null),Pa([Ht("0.seiu"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"seiConfigUpdate",null),Pa([Ht("icg"),Fa("design:type",Function),Fa("design:paramtypes",[Object,Object,Boolean]),Fa("design:returntype",void 0)],Ma.prototype,"initConfig",null),Pa([Ht("vify.tkn"),Fa("design:type",Function),Fa("design:paramtypes",[String,String]),Fa("design:returntype",Promise)],Ma.prototype,"verifyToken",null),Pa([Ht("sul"),Fa("design:type",Function),Fa("design:paramtypes",[String]),Fa("design:returntype",void 0)],Ma.prototype,"setUrl",null),Pa([Ht("gul"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",String)],Ma.prototype,"getUrl",null),Pa([Ht("ply"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"play",null),Pa([Ht("pus"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"pause",null),Pa([Ht("svel"),Fa("design:type",Function),Fa("design:paramtypes",[HTMLVideoElement]),Fa("design:returntype",void 0)],Ma.prototype,"setVideoEl",null),Pa([Ht("rsm"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"resume",null),Pa([Ht("0.stp"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"stopAllContext",null),Pa([Ht("stp"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"stop",null),Pa([Ht("dsy"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"destroy",null),Pa([Ht("stmut"),Fa("design:type",Function),Fa("design:paramtypes",[Boolean]),Fa("design:returntype",void 0)],Ma.prototype,"setMuted",null),Pa([Ht("fusc"),Fa("design:type",Function),Fa("design:paramtypes",[]),Fa("design:returntype",void 0)],Ma.prototype,"fullScreen",null),Pa([Ht("sacfg"),Fa("design:type",Function),Fa("design:paramtypes",[Object]),Fa("design:returntype",void 0)],Ma.prototype,"setAdvanceConfig",null),Pa([Ht("aevl"),Fa("design:type",Function),Fa("design:paramtypes",[String,Function]),Fa("design:returntype",void 0)],Ma.prototype,"addEventListener",null),Pa([Ht("revl"),Fa("design:type",Function),Fa("design:paramtypes",[String,Function]),Fa("design:returntype",void 0)],Ma.prototype,"removeEventListener",null),Ma=Pa([it(),Ta(0,mt(tt.PlayerState)),Ta(1,mt(tt.ConstantState)),Ta(2,mt(Ra)),Ta(3,mt(tt.PlayerEventEmitter)),Ta(4,mt(tt.LogMana)),Ta(5,mt(tt.ContextFactory)),Ta(6,mt(tt.SEIReceiver)),Ta(7,mt(tt.GlobalEvent)),Ta(8,mt(tt.Utils)),Ta(9,mt(tt.QualityStatisticContext)),Fa("design:paramtypes",[fn,Dt,Ra,an,$t,Object,Object,Object,cn,Qi])],Ma);var Oa=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},Ia=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},La=function(e,t){return function(i,n){t(i,n,e)}};let Ba=class{constructor(e,t,i){this.lm=e,this.playerState=t,this.globalEvent=i,this.lastPausedTime=0,this.fullScreenPrefixes=["","moz","webkit","ms"],this.lastVideoInteractTime=0,this.e={onvCanPlay:this.onvCanPlay.bind(this),onvTimeUpdate:this.onvTimeUpdate.bind(this),onvPlaying:this.onvPlaying.bind(this),onvWaiting:this.onvWaiting.bind(this),onvPlay:this.onvPlay.bind(this),onvPause:this.onvPause.bind(this),onvVolumeChange:this.onvVolumeChange.bind(this),onvEnded:this.onvEnded.bind(this),onPageClick:this.onPageClick.bind(this),onVideoClick:this.onUserInteractVideo.bind(this),onFullScreenChange:this.onFullScreenChange.bind(this),onFullScreenEnter:this.onFullScreenEnter.bind(this),onFullScreenOut:this.onFullScreenOut.bind(this)},this.logger=e.createLogger("rd.vid"),this.globalEvent.event.once(di.DESTROY,(()=>{!this.videoElement.paused&&this.videoElement.pause()})),this.backgroundHandler=new Wn(this.playerState,this.lm,this)}onvCanPlay(){this.playerState.mediaOpened||(this.playerState.mediaOpened=!0),this.playerState.audioDeviceReady=!0,this.qualityContext.renderStatistic.firstVideoFrame()}onvTimeUpdate(){this.playerState.currentTime=1e3*this.videoElement.currentTime}onvPlaying(){this.playerState.waiting=!1}onvWaiting(){this.playerState.waiting=!0}isFromUserClick(){return performance.now()-this.lastVideoInteractTime<100}onvEnded(){this.logger.info("onvEnd")}onvPause(){this.logger.info("video onpause callback"),this.playerState.pausedRendering=!0,this.isFromUserClick()&&(this.videoFpsDetection.pauseFPSDetect(),this.playerState.userPlayed=!1),this.lastPausedTime=performance.now()}onvPlay(){this.logger.info("video onplay callback"),this.playerState.mediaOpened=!0,this.playerState.isRendering=!0,this.videoFpsDetection.startFPSDetect(),this.isFromUserClick()&&(this.playerState.userPlayed=!0)}onvVolumeChange(){this.playerState.muted=this.videoElement.muted,this.playerState.volume=100*this.videoElement.volume,this.qualityContext.renderStatistic.volumeIn100=100*this.videoElement.volume}get videoElement(){return this.uiContainer.videoElement}showVideoElement(){this.uiContainer.setVideoElementAttributes({controls:!1},[]),this.uiContainer.showVideoElement()}updateConfigFromVideoEl(){this.playerState.muted=this.videoElement.muted,this.playerState.volume=100*this.videoElement.volume,this.logger.info("video config set muted "+this.playerState.muted+" volume "+this.playerState.volume)}bindFullScreenEvent(){this.unbindFullScreenEvents();const e=this.videoElement;this.fullScreenPrefixes.forEach((e=>{document.addEventListener(e+"fullscreenchange",this.e.onFullScreenChange)})),e&&(e.addEventListener("webkitendfullscreen",this.e.onFullScreenOut),e.addEventListener("webkitenterfullscreen",this.onFullScreenEnter))}onUserInteractVideo(){this.lastVideoInteractTime=performance.now()}onPageClick(){this.playerState.userPlayed&&this.videoElement.paused&&performance.now()-this.lastPausedTime>100&&this.videoElement.readyState>2&&(this.logger.info(`page click call resume play (custom) ${this.playerState.userPlayed} ${this.videoElement.paused} ${this.videoElement.readyState}`),this.play())}hideVideoElement(){this.uiContainer.setVideoElementAttributes({controls:!0},[]),this.uiContainer.hideVideoElement()}bindVideoControlEvents(){this.unbindVideoControlEvents();const e=this.videoElement;e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("timeupdate",this.e.onvTimeUpdate),e.addEventListener("pause",this.e.onvPause),e.addEventListener("play",this.e.onvPlay),e.addEventListener("volumechange",this.e.onvVolumeChange),e.addEventListener("ended",this.e.onvEnded),e.addEventListener("click",this.e.onVideoClick),document.body.addEventListener("click",this.e.onPageClick),this.bindFullScreenEvent()}unbindVideoControlEvents(){const e=this.videoElement;e.removeEventListener("canplay",this.e.onvCanPlay),e.removeEventListener("timeupdate",this.e.onvTimeUpdate),e.removeEventListener("pause",this.e.onvPause),e.removeEventListener("play",this.e.onvPlay),e.removeEventListener("volumechange",this.e.onvEnded),e.removeEventListener("ended",this.e.onvVolumeChange),document.body.removeEventListener("click",this.e.onPageClick),this.unbindFullScreenEvents()}onFullScreenChange(){this.windowIsFullScreen()?this.windowIsFullScreen()&&this.onFullScreenEnter():this.onFullScreenOut()}onFullScreenOut(){this.logger.info("video fullscreen out"),this.uiContainer.isUserVideoElement()||(this.videoElement.controls=!1,Ao.safari&&this.uiContainer.remountVideoInWrapper())}unbindFullScreenEvents(){const e=this.videoElement;this.fullScreenPrefixes.forEach((e=>{document.removeEventListener(e+"fullscreenchange",this.e.onFullScreenChange)})),e&&(e.removeEventListener("webkitendfullscreen",this.e.onFullScreenOut),e.removeEventListener("webkitenterfullscreen",this.onFullScreenEnter))}onFullScreenEnter(){this.logger.info("video fullscreen enter"),this.uiContainer.isUserVideoElement()||(this.videoElement.controls=!0)}pauseAllSubModules(){this.logger.info("pause all submodule"),this.backgroundHandler.pause(),this.videoFpsDetection.pauseFPSDetect(),this.unbindVideoControlEvents(),this.playerState.waiting||(this.playerState.waiting=!1)}mount(){this.logger.info("(custom) video controller mount "),this.uiContainer.isUserVideoElement()?this.updateConfigFromVideoEl():this.showVideoElement(),this.videoElement.srcObject=this.playerState.customStream,this.videoElement.volume=this.playerState.volume/100,this.videoElement.muted=this.playerState.muted,this.bindVideoControlEvents(),this.playerState.userPlayed&&this.play(),this.qualityContext.renderStatistic.volumeIn100=100*this.videoElement.volume,this.backgroundHandler.active()}unmount(){this.logger.info("(custom) video controller unmount "),this.uiContainer.isUserVideoElement()||this.hideVideoElement(),this.videoElement.srcObject=null,this.pauseAllSubModules()}play(){this.onUserInteractVideo(),this.videoElement.play().then((e=>{this.logger.info("play() was interrupted.")}))}pause(){this.onUserInteractVideo(),this.videoElement.pause()}resume(){this.videoElement.srcObject=null,this.videoElement.srcObject=this.playerState.customStream}setMuted(e){this.videoElement.muted=e}setVolume(e){this.videoElement.volume=e/100}windowIsFullScreen(){const e=this.videoElement;return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitCurrentFullScreenElement||e&&e.webkitDisplayingFullscreen}requestVideoFullScreen(e){e&&!this.windowIsFullScreen()&&(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitSupportsFullscreen&&e.webkitEnterFullscreen&&e.webkitEnterFullscreen())}fullScreen(){this.logger.info("full screen call (custom)"),this.requestVideoFullScreen(this.videoElement)}destroy(){this.videoElement.srcObject=null,this.pauseAllSubModules()}};Oa([mt(tt.UIContainer),Ia("design:type",Object)],Ba.prototype,"uiContainer",void 0),Oa([mt(tt.QualityStatisticContext),Ia("design:type",Qi)],Ba.prototype,"qualityContext",void 0),Oa([mt(tt.DomVideoFPSDetection),Ia("design:type",da)],Ba.prototype,"videoFpsDetection",void 0),Oa([Ht("0.ucfv"),Ia("design:type",Function),Ia("design:paramtypes",[]),Ia("design:returntype",void 0)],Ba.prototype,"updateConfigFromVideoEl",null),Ba=Oa([it(),La(0,mt(tt.LogMana)),La(1,mt(tt.PlayerState)),La(2,mt(tt.GlobalEvent)),Ia("design:paramtypes",[$t,Object,Object])],Ba);class Va extends et{constructor(){super({defaultScope:"Singleton",autoBindInjectable:!0,skipBaseClassChecks:!0}),this.bind(tt.VideoFrameQueue).to($i),this.bind(tt.AudioFrameQueue).to(tn),this.bind(tt.PacketContext).to(lt),this.bind(tt.DemuxerPacketsReceivers).to(vt),this.bind(tt.ContextFactory).to(ei),this.bind(tt.AudioPacketsProvider).to(ai),this.bind(tt.VideoPacketsProvider).to(fi),this.bind(tt.FormatContext).to(wi),this.bind(tt.RenderContext).to(os),this.bind(tt.VideoClock).to(vn),this.bind(tt.AudioClock).to(Sn),this.bind(tt.NetworkRequestor).to(An),this.bind(tt.PlayerState).to(fn),this.bind(tt.OptionsContext).to(xn),this.bind(tt.GlobalEvent).to(On),this.bind(tt.MediaUI).to(Yn),this.bind(tt.WasmFactory).to(fr),this.bind(tt.NaluParser).to(gr),this.bind(tt.SEIReceiver).to(Pr),this.bind(tt.LogMana).to($t),this.bind(tt.QualityStatisticContext).to(Qi),this.bind(tt.FlvDemuxer).to(eo),this.bind(tt.DemuxContext).to(ro),this.bind(tt.UIContainer).to(lo),this.bind(tt.AVPlayerOperator).to(po),this.bind(tt.PlayerEventEmitter).to(an),this.bind(tt.Utils).to(cn),this.bind(tt.RenderStatistic).to(Bi),this.bind(tt.NetworkStatistic).to(ki),this.bind(tt.DecodeStatistic).to(Ni),this.bind(tt.AudioPacketsReceiver).to(Ps),this.bind(tt.VideoPacketsReceiver).to(Os),this.bind(tt.RenderableMedia).to(Un),this.bind(tt.MediaChangingOperator).to($o),this.bind(tt.MediaWaitingHandler).to(es),this.bind(tt.CustomVideoControl).to(Ba),this.bind(So).to(So),this.bind(tt.DecodeContextBuilder).toAutoFactory(So),this.bind(No).to(No),this.bind(tt.MseContextBuilder).toAutoFactory(No),this.bind(tt.RemoteMuteStateDetect).to(Jr),this.bind(ls).to(ls),this.bind(tt.DecodeOperatorBuilder).toAutoFactory(ls),this.bind(ps).to(ps).inTransientScope(),this.bind(tt.WebCodecDecoderBuilder).toAutoFactory(ps),this.bind(vs).to(vs).inTransientScope(),this.bind(tt.HttpFetchBuilder).toAutoFactory(vs),this.bind(Vs).to(Vs).inTransientScope(),this.bind(tt.AudioMasterFrameSynchronizerBuilder).toAutoFactory(Vs),this.bind(Ws).to(Ws).inTransientScope(),this.bind(tt.VideoMasterFrameSynchronizerBuilder).toAutoFactory(Ws),this.bind($s).to($s).inTransientScope(),this.bind(tt.AudioPlayerBuilder).toAutoFactory($s),this.bind(na).to(na).inTransientScope(),this.bind(tt.VideoPlayerBuilder).toAutoFactory(na),this.bind(tt.PacketsDropSyncSignal).to(ni),this.bind(tt.MSEVideoControl).to(ua),this.bind(tt.PlayerController).to(Ma),this.bind(tt.SeiEmitter).to(_r),this.bind(tt.ConstantState).to(Dt),this.bind(tt.MSEWaitingDetection).to(aa),this.bind(tt.DomVideoFPSDetection).to(da),this.bind(tt.MSEAutoPlayDetect).to(la)}}var Ua,Na=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},ja=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},Wa=function(e,t){return function(i,n){t(i,n,e)}};!function(e){e.NET_QUALITY_SCORE_UPDATE="netQualityScoreUpdate"}(Ua||(Ua={}));let qa=class{constructor(e,t){this._playerEmitter=e,this.lm=t,this.sdkListener={},this.logger=this.lm.createLogger("0.sdk")}getSdkListener(e){return this.sdkListener[e]||(this.sdkListener[e]=[]),this.sdkListener[e]}removeSdkListener(e,t){this.sdkListener[e]&&(this.sdkListener[e]=this.sdkListener[e].filter((e=>e!=t)))}sdkExtEventsName2GlobalEventName(e){return e===Ua.NET_QUALITY_SCORE_UPDATE?di.ON_QUALITY_SCORE:""}set srcObject(e){this.playerControl.setCustomStream(e)}get srcObject(){return this.playerControl.getCustomStream()}on(e,t){if(t)if(this.getSdkListener(e).push(t),ui(e))this._playerEmitter.on(e,t);else{if(!function(e){for(var t in Ua)if(Ua[t]==e)return!0;return!1}(e))return void this.logger.error("unsupported event name "+e);this.globalEvt.event.on(this.sdkExtEventsName2GlobalEventName(e),t)}else this.logger.error("no event function to bind")}off(e,t){t?(this.removeSdkListener(e,t),ui(e)?this._playerEmitter.off(e,t):this.globalEvt.event.off(this.sdkExtEventsName2GlobalEventName(e),t)):(this.logger.info("remove all sdk listener"),this.getSdkListener(e).forEach((t=>{ui(e)?this._playerEmitter.off(e,t):this.globalEvt.event.off(this.sdkExtEventsName2GlobalEventName(e),t)})),this.sdkListener[e]=[])}};Na([mt(tt.GlobalEvent),ja("design:type",Object)],qa.prototype,"globalEvt",void 0),Na([mt(tt.PlayerController),ja("design:type",Object)],qa.prototype,"playerControl",void 0),Na([Ht("on"),ja("design:type",Function),ja("design:paramtypes",[String,Function]),ja("design:returntype",void 0)],qa.prototype,"on",null),Na([Ht("off"),ja("design:type",Function),ja("design:paramtypes",[String,Function]),ja("design:returntype",void 0)],qa.prototype,"off",null),qa=Na([it(),Wa(0,mt(tt.PlayerEventEmitter)),Wa(1,mt(tt.LogMana)),ja("design:paramtypes",[an,$t])],qa);var Ha=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{d(n.next(e))}catch(t){o(t)}}function a(e){try{d(n.throw(e))}catch(t){o(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))};class Qa{constructor(e,t){this._playerListener={},this._container=new Va,this._controller=this._container.get(tt.PlayerController),this._sdkExt=this._container.get(qa),qt.bind(e).is.exist.catch((()=>{throw new Lt("engine is needed. example: 'var player = new Player(zg, ..);'")})),t.engineType&&"liveroom"===t.engineType&&(e=e.zegoEntity),qt.bind(e.zegoWebRTC).is.exist.hasKey("inject").catch((()=>{throw new Vt("sdk version is not support! This may be caused by the version of 'zego-express-engine-webrtc' package being too low.")})),e.zegoWebRTC.inject("ZegoExpressPlayer",(e=>{this._controller.initConfig(t,e)}))}get _extApi(){return this._sdkExt}set src(e){this._controller.setUrl(e)}get src(){return this._controller.getUrl()}get currentTime(){return this._controller.getCurrentTime()}get played(){return this._controller.getPlayed()}get paused(){return this._controller.getPaused()}get volume(){return this._controller.getVolume()}get duration(){return this._controller.getDuration()}get canvas(){return this._controller.getCanvas()}verify(e,t){return Ha(this,void 0,void 0,(function*(){return yield this._controller.verifyToken(e,t)}))}play(){this._controller.play()}pause(){this._controller.pause()}resume(){this._controller.resume()}setVolume(e){this._controller.setVolume(e)}setMuted(e){this._controller.setMuted(e)}destroy(){this._controller.destroy()}stop(){this._controller.stop()}fullScreen(){this._controller.fullScreen()}setAdvanceConfig(e){this._controller.setAdvanceConfig(e)}set onEnded(e){this._playerListener.onEnded&&this._controller.removeEventListener(li.MEDIA_PLAY_ENDED,this._playerListener.onEnded),this._playerListener.onEnded=e,e&&this._controller.addEventListener(li.MEDIA_PLAY_ENDED,e)}set onCanPlay(e){this._playerListener.onCanPlay&&this._controller.removeEventListener(li.MEDIA_CAN_PLAY,this._playerListener.onCanPlay),this._playerListener.onCanPlay=e,e&&this._controller.addEventListener(li.MEDIA_CAN_PLAY,e)}set onPlay(e){this._playerListener.onPlay&&this._controller.removeEventListener(li.MEDIA_PLAYED,this._playerListener.onPlay),this._playerListener.onPlay=e,e&&this._controller.addEventListener(li.MEDIA_PLAYED,e)}set onPaused(e){this._playerListener.onPaused&&this._controller.removeEventListener(li.MEDIA_PAUSED,this._playerListener.onPaused),this._playerListener.onPaused=e,e&&this._controller.addEventListener(li.MEDIA_PAUSED,e)}set onLoaded(e){this._playerListener.onLoaded&&this._controller.removeEventListener(li.MEDIA_LOADED,this._playerListener.onLoaded),this._playerListener.onLoaded=e,e&&this._controller.addEventListener(li.MEDIA_LOADED,e)}set onTimeUpdate(e){this._playerListener.onTimeUpdate&&this._controller.removeEventListener(li.CURRENT_TIME_CHANGE,this._playerListener.onTimeUpdate),this._playerListener.onTimeUpdate=e,e&&this._controller.addEventListener(li.CURRENT_TIME_CHANGE,e)}set onWaiting(e){this._playerListener.onWaiting&&this._controller.removeEventListener(li.MEDIA_PLAY_WAITING,this._playerListener.onWaiting),this._playerListener.onWaiting=e,e&&this._controller.addEventListener(li.MEDIA_PLAY_WAITING,e)}set onPlaying(e){this._playerListener.onPlaying&&this._controller.removeEventListener(li.MEDIA_PLAYING,this._playerListener.onPlaying),this._playerListener.onPlaying=e,e&&this._controller.addEventListener(li.MEDIA_PLAYING,e)}set onError(e){this._playerListener.onError&&this._controller.removeEventListener(li.ERROR,this._playerListener.onError),this._playerListener.onError=e,e&&this._controller.addEventListener(li.ERROR,e)}set onMediaInfoUpdate(e){this._playerListener.onMediaInfoUpdate&&this._controller.removeEventListener(li.MEDIA_INFO_UPDATE,this._playerListener.onMediaInfoUpdate),this._playerListener.onMediaInfoUpdate=e,e&&this._controller.addEventListener(li.MEDIA_INFO_UPDATE,e)}set onRecvSEI(e){this._playerListener.onRecvSEI&&this._controller.removeEventListener(li.RECV_SEI,this._playerListener.onRecvSEI),this._playerListener.onRecvSEI=e,e&&this._controller.addEventListener(li.RECV_SEI,e)}}})(),ZegoExpressPlayer=n.ZegoExpressPlayer})();