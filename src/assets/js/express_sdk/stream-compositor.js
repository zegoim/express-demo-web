!function(t,i){if("object"==typeof exports&&"object"==typeof module)module.exports=i();else if("function"==typeof define&&define.amd)define([],i);else{var r=i();for(var n in r)("object"==typeof exports?exports:t)[n]=r[n]}}("undefined"!=typeof self?self:this,(function(){return function(){var t={3720:function(t){t.exports=r;var i=null;try{i=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(t){}function r(t,i,r){this.low=0|t,this.high=0|i,this.unsigned=!!r}function n(t){return!0===(t&&t.__isLong__)}Object.defineProperty(r.prototype,"__isLong__",{value:!0}),r.isLong=n;var e={},o={};function s(t,i){var r,n,s;return i?(s=0<=(t>>>=0)&&t<256)&&(n=o[t])?n:(r=h(t,(0|t)<0?-1:0,!0),s&&(o[t]=r),r):(s=-128<=(t|=0)&&t<128)&&(n=e[t])?n:(r=h(t,t<0?-1:0,!1),s&&(e[t]=r),r)}function u(t,i){if(isNaN(t))return i?w:p;if(i){if(t<0)return w;if(t>=l)return _}else{if(t<=-d)return L;if(t+1>=d)return E}return t<0?u(-t,i).neg():h(t%v|0,t/v|0,i)}function h(t,i,n){return new r(t,i,n)}r.fromInt=s,r.fromNumber=u,r.fromBits=h;var f=Math.pow;function c(t,i,r){if(0===t.length)throw Error("empty string");if("NaN"===t||"Infinity"===t||"+Infinity"===t||"-Infinity"===t)return p;if("number"==typeof i?(r=i,i=!1):i=!!i,(r=r||10)<2||36<r)throw RangeError("radix");var n;if((n=t.indexOf("-"))>0)throw Error("interior hyphen");if(0===n)return c(t.substring(1),i,r).neg();for(var e=u(f(r,8)),o=p,s=0;s<t.length;s+=8){var h=Math.min(8,t.length-s),a=parseInt(t.substring(s,s+h),r);if(h<8){var v=u(f(r,h));o=o.mul(v).add(u(a))}else o=(o=o.mul(e)).add(u(a))}return o.unsigned=i,o}function a(t,i){return"number"==typeof t?u(t,i):"string"==typeof t?c(t,i):h(t.low,t.high,"boolean"==typeof i?i:t.unsigned)}r.fromString=c,r.fromValue=a;var v=4294967296,l=v*v,d=l/2,m=s(1<<24),p=s(0);r.ZERO=p;var w=s(0,!0);r.UZERO=w;var y=s(1);r.ONE=y;var b=s(1,!0);r.UONE=b;var g=s(-1);r.NEG_ONE=g;var E=h(-1,2147483647,!1);r.MAX_VALUE=E;var _=h(-1,-1,!0);r.MAX_UNSIGNED_VALUE=_;var L=h(0,-2147483648,!1);r.MIN_VALUE=L;var O=r.prototype;O.toInt=function(){return this.unsigned?this.low>>>0:this.low},O.toNumber=function(){return this.unsigned?(this.high>>>0)*v+(this.low>>>0):this.high*v+(this.low>>>0)},O.toString=function(t){if((t=t||10)<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(L)){var i=u(t),r=this.div(i),n=r.mul(i).sub(this);return r.toString(t)+n.toInt().toString(t)}return"-"+this.neg().toString(t)}for(var e=u(f(t,6),this.unsigned),o=this,s="";;){var h=o.div(e),c=(o.sub(h.mul(e)).toInt()>>>0).toString(t);if((o=h).isZero())return c+s;for(;c.length<6;)c="0"+c;s=""+c+s}},O.getHighBits=function(){return this.high},O.getHighBitsUnsigned=function(){return this.high>>>0},O.getLowBits=function(){return this.low},O.getLowBitsUnsigned=function(){return this.low>>>0},O.getNumBitsAbs=function(){if(this.isNegative())return this.eq(L)?64:this.neg().getNumBitsAbs();for(var t=0!=this.high?this.high:this.low,i=31;i>0&&0==(t&1<<i);i--);return 0!=this.high?i+33:i+1},O.isZero=function(){return 0===this.high&&0===this.low},O.eqz=O.isZero,O.isNegative=function(){return!this.unsigned&&this.high<0},O.isPositive=function(){return this.unsigned||this.high>=0},O.isOdd=function(){return 1==(1&this.low)},O.isEven=function(){return 0==(1&this.low)},O.equals=function(t){return n(t)||(t=a(t)),(this.unsigned===t.unsigned||this.high>>>31!=1||t.high>>>31!=1)&&(this.high===t.high&&this.low===t.low)},O.eq=O.equals,O.notEquals=function(t){return!this.eq(t)},O.neq=O.notEquals,O.ne=O.notEquals,O.lessThan=function(t){return this.comp(t)<0},O.lt=O.lessThan,O.lessThanOrEqual=function(t){return this.comp(t)<=0},O.lte=O.lessThanOrEqual,O.le=O.lessThanOrEqual,O.greaterThan=function(t){return this.comp(t)>0},O.gt=O.greaterThan,O.greaterThanOrEqual=function(t){return this.comp(t)>=0},O.gte=O.greaterThanOrEqual,O.ge=O.greaterThanOrEqual,O.compare=function(t){if(n(t)||(t=a(t)),this.eq(t))return 0;var i=this.isNegative(),r=t.isNegative();return i&&!r?-1:!i&&r?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1},O.comp=O.compare,O.negate=function(){return!this.unsigned&&this.eq(L)?L:this.not().add(y)},O.neg=O.negate,O.add=function(t){n(t)||(t=a(t));var i=0,r=0,e=0,o=0;return e+=(o+=(65535&this.low)+(65535&t.low))>>>16,r+=(e+=(this.low>>>16)+(t.low>>>16))>>>16,i+=(r+=(65535&this.high)+(65535&t.high))>>>16,i+=(this.high>>>16)+(t.high>>>16),h((e&=65535)<<16|(o&=65535),(i&=65535)<<16|(r&=65535),this.unsigned)},O.subtract=function(t){return n(t)||(t=a(t)),this.add(t.neg())},O.sub=O.subtract,O.multiply=function(t){if(this.isZero())return p;if(n(t)||(t=a(t)),i)return h(i.mul(this.low,this.high,t.low,t.high),i.get_high(),this.unsigned);if(t.isZero())return p;if(this.eq(L))return t.isOdd()?L:p;if(t.eq(L))return this.isOdd()?L:p;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(m)&&t.lt(m))return u(this.toNumber()*t.toNumber(),this.unsigned);var r=65535&this.high,e=this.low>>>16,o=65535&this.low,s=65535&t.high,f=t.low>>>16,c=65535&t.low,v=0,l=0,d=0,w=0;return d+=(w+=o*c)>>>16,l+=(d+=e*c)>>>16,d&=65535,l+=(d+=o*f)>>>16,v+=(l+=r*c)>>>16,l&=65535,v+=(l+=e*f)>>>16,l&=65535,v+=(l+=o*s)>>>16,v+=(this.high>>>16)*c+r*f+e*s+o*(t.high>>>16),h((d&=65535)<<16|(w&=65535),(v&=65535)<<16|(l&=65535),this.unsigned)},O.mul=O.multiply,O.divide=function(t){if(n(t)||(t=a(t)),t.isZero())throw Error("division by zero");var r,e,o;if(i)return this.unsigned||-2147483648!==this.high||-1!==t.low||-1!==t.high?h((this.unsigned?i.div_u:i.div_s)(this.low,this.high,t.low,t.high),i.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?w:p;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return w;if(t.gt(this.shru(1)))return b;o=w}else{if(this.eq(L))return t.eq(y)||t.eq(g)?L:t.eq(L)?y:(r=this.shr(1).div(t).shl(1)).eq(p)?t.isNegative()?y:g:(e=this.sub(t.mul(r)),o=r.add(e.div(t)));if(t.eq(L))return this.unsigned?w:p;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();o=p}for(e=this;e.gte(t);){r=Math.max(1,Math.floor(e.toNumber()/t.toNumber()));for(var s=Math.ceil(Math.log(r)/Math.LN2),c=s<=48?1:f(2,s-48),v=u(r),l=v.mul(t);l.isNegative()||l.gt(e);)l=(v=u(r-=c,this.unsigned)).mul(t);v.isZero()&&(v=y),o=o.add(v),e=e.sub(l)}return o},O.div=O.divide,O.modulo=function(t){return n(t)||(t=a(t)),i?h((this.unsigned?i.rem_u:i.rem_s)(this.low,this.high,t.low,t.high),i.get_high(),this.unsigned):this.sub(this.div(t).mul(t))},O.mod=O.modulo,O.rem=O.modulo,O.not=function(){return h(~this.low,~this.high,this.unsigned)},O.and=function(t){return n(t)||(t=a(t)),h(this.low&t.low,this.high&t.high,this.unsigned)},O.or=function(t){return n(t)||(t=a(t)),h(this.low|t.low,this.high|t.high,this.unsigned)},O.xor=function(t){return n(t)||(t=a(t)),h(this.low^t.low,this.high^t.high,this.unsigned)},O.shiftLeft=function(t){return n(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?h(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):h(0,this.low<<t-32,this.unsigned)},O.shl=O.shiftLeft,O.shiftRight=function(t){return n(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?h(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):h(this.high>>t-32,this.high>=0?0:-1,this.unsigned)},O.shr=O.shiftRight,O.shiftRightUnsigned=function(t){if(n(t)&&(t=t.toInt()),0===(t&=63))return this;var i=this.high;return t<32?h(this.low>>>t|i<<32-t,i>>>t,this.unsigned):h(32===t?i:i>>>t-32,0,this.unsigned)},O.shru=O.shiftRightUnsigned,O.shr_u=O.shiftRightUnsigned,O.toSigned=function(){return this.unsigned?h(this.low,this.high,!1):this},O.toUnsigned=function(){return this.unsigned?this:h(this.low,this.high,!0)},O.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()},O.toBytesLE=function(){var t=this.high,i=this.low;return[255&i,i>>>8&255,i>>>16&255,i>>>24,255&t,t>>>8&255,t>>>16&255,t>>>24]},O.toBytesBE=function(){var t=this.high,i=this.low;return[t>>>24,t>>>16&255,t>>>8&255,255&t,i>>>24,i>>>16&255,i>>>8&255,255&i]},r.fromBytes=function(t,i,n){return n?r.fromBytesLE(t,i):r.fromBytesBE(t,i)},r.fromBytesLE=function(t,i){return new r(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,i)},r.fromBytesBE=function(t,i){return new r(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],i)}}},i={};function r(n){var e=i[n];if(void 0!==e)return e.exports;var o=i[n]={exports:{}};return t[n](o,o.exports,r),o.exports}r.d=function(t,i){for(var n in i)r.o(i,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},r.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return function(){"use strict";function t(t){return"number"==typeof t}function i(t){return void 0===t}function e(t){return null!==t&&t instanceof Object}function o(t){return t instanceof MediaStream}function s(t){return t instanceof HTMLVideoElement}function u(t){return t instanceof HTMLImageElement}r.r(n),r.d(n,{StreamCompositor:function(){return z}});r(3720);var h={code:1100001,message:w},f={code:1103074,message:"video track is not readable"},c={code:1103076,message:"audio track is not readable"},a={code:1103077,message:"compositor blur not support."},v=Promise,l=document;function d(){return navigator.userAgent||""}var m,p="stream is not from zego",w="input param error",y=function(){function t(t,i,r){this.t=t,this.i=i,this.u=r,this.fps=15,this.outputBitrate=1500,this.hasPortrait=!1,this.isClear=!1,this.canvasEl=l.createElement("canvas"),this.ctx=this.canvasEl.getContext("2d")}return t.prototype.setVideoConfig=function(t){var i=t.height,r=t.frameRate,n=t.bitrate;this.canvasEl.width=t.width,this.canvasEl.height=i,r&&(this.fps=r),n&&(this.outputBitrate=n)},t.prototype.setInputsOption=function(t){var i=this;this.isClear=!0,this.layers=t.filter((function(t){var i=t.stream,r=t.option,n=u(t.source),e=void 0!==r.contentType&&["ALL","VIDEO"].includes(r.contentType),o=!r.contentType||e,s=i&&i.getVideoTracks();if(0==(null==s?void 0:s.length)&&e)throw f;return n||o&&s&&(null==s?void 0:s.length)>0})).map((function(t){var r,n=t.source,e=t.stream,o=t.option;if(e&&"safari"===i.i.browser){var s=i.u.checkPreview(e);s.backgroundProcessor?(r=s.backgroundProcessor.getCanvas(),i.bgProcessor=s.backgroundProcessor,i.hasPortrait=!0):i.hasPortrait=!1}return{source:n,option:o,canvas:r}})),this.layers.sort((function(t,i){var r,n;return void 0!==(null===(r=t.option.layout)||void 0===r?void 0:r.zOrder)&&void 0!==(null===(n=i.option.layout)||void 0===n?void 0:n.zOrder)?t.option.layout.zOrder-i.option.layout.zOrder:-1}))},t.prototype.checkVideoInputs=function(t){var i=!0;return t.forEach((function(t){var r=t.stream,n=t.option,e=void 0!==n.contentType&&["ALL","VIDEO"].includes(n.contentType),o=r&&r.getVideoTracks();0==(null==o?void 0:o.length)&&e&&(i=!1)})),i},t.prototype.generateVideoTrack=function(){var t,i=this;if(this.hasPortrait?null===(t=this.bgProcessor)||void 0===t||t.setDrawBack((function(){i.draw()})):this.intervalId||(this.intervalId=setInterval((function(){i.draw()}),1e3/this.fps)),!this.canvasTrack){var r=this.canvasEl.captureStream(this.fps);this.canvasTrack=r.getVideoTracks()[0]}return this.canvasTrack},t.prototype.stopOutputStream=function(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.layers.forEach((function(t){t.source&&s(t.source)&&(t.source.pause(),t.source.remove(),t.source.srcObject=null,t.source=null)})),this.u.trackUtils.stopTrack(this.canvasTrack),this.canvasTrack=null,this.ctx=null,this.layers=[]},t.prototype.draw=function(){var t,i;if(this.ctx){this.ctx.clearRect(0,0,this.canvasEl.width,this.canvasEl.height);for(var r=0;r<this.layers.length;r++){var n=this.layers[r],e=n.source,o=n.option,h=n.canvas;if(o.layout){var f=o.layout,c=f.x,a=f.y,v=f.width,l=f.height,d=s(e)?e.videoWidth:u(e)?e.naturalWidth:0,m=s(e)?e.videoHeight:u(e)?e.naturalHeight:0;if(0==d||0==m)continue;var p=h||e;switch(o.objectFit){case"contain":if(v/l<=d/m){var w=(l-(b=v*m/d))/2;null===(t=this.ctx)||void 0===t||t.drawImage(p,c,a+w,v,b)}else{w=(v-(y=l*d/m))/2;null===(i=this.ctx)||void 0===i||i.drawImage(p,c+w,a,y,l)}break;case"cover":var y,b;if(v/l<=d/m)this.ctx.drawImage(p,(d-(y=v*m/l))/2,0,y,m,c,a,v,l);else this.ctx.drawImage(p,0,(m-(b=d*l/v))/2,d,b,c,a,v,l);break;case"fill":this.ctx.drawImage(p,c,a,v,l)}}}}},t}(),b=function(){function i(t,i,r){this.t=t,this.ac=i,this.u=r,this.inputs=[],this.descNode=this.ac.createMediaStreamDestination()}return i.prototype.setInputsOption=function(i){var r=this;this.inputs=i.filter((function(t){var i=t.stream,n=t.option,e=i&&i.getAudioTracks(),o=r.u.checkPreview(i),s=void 0!==n.contentType&&["ALL","AUDIO"].includes(n.contentType);if((0==(null==e?void 0:e.length)||(null==o?void 0:o.hasEmptyAudioTrack))&&s)throw c;return e&&(null==e?void 0:e.length)>0})),this.inputs.forEach((function(i){var r,n,e=i.audioNodes,o=i.option;(void 0===i.option.volume&&(i.option.volume=100),e)&&(!o.contentType||["ALL","AUDIO"].includes(o.contentType)?(!e.hasAudio&&(null===(r=null==e?void 0:e.srcNode)||void 0===r||r.connect(e.volumeNode)),e.hasAudio=!0,t(i.option.volume)&&(e.volumeNode.gain.value=i.option.volume/100)):(null===(n=null==e?void 0:e.srcNode)||void 0===n||n.disconnect(e.volumeNode),e.hasAudio=!1))}))},i.prototype.checkAudioInputs=function(t){var i=this,r=!0;return t.forEach((function(t){var n=t.stream,e=t.option,o=n&&n.getAudioTracks(),s=i.u.checkPreview(n),u=void 0!==e.contentType&&["ALL","AUDIO"].includes(e.contentType);(0==(null==o?void 0:o.length)||(null==s?void 0:s.hasEmptyAudioTrack))&&u&&(r=!1)})),r},i.prototype.generateAudioTrack=function(){for(var t,i=0;i<this.inputs.length;i++){var r=this.inputs[i],n=r.stream,e=r.option,o=!e.contentType||["ALL","AUDIO"].includes(e.contentType),s=this.createAudioNode(n,r.option.volume),u=s.srcNode,h=s.volumeNode;o&&(null==u||u.connect(h)),r.audioNodes={srcNode:u,volumeNode:h,hasAudio:o}}var f=null===(t=this.descNode)||void 0===t?void 0:t.stream.getAudioTracks();return f&&f.length>0?f[0]:(this.ac.resume(),null)},i.prototype.createAudioNode=function(t,i){var r=this.ac.createMediaStreamSource(t),n=this.ac.createGain();return n.gain.value=i/100,n.connect(this.descNode),{srcNode:r,volumeNode:n}},i.prototype.stopAudioCompositor=function(){for(var t=0;t<this.inputs.length;t++){var i=this.inputs[t],r=i.audioNodes,n=i.option;if(r){var e=r.srcNode,o=r.volumeNode;(!n.contentType||["ALL","AUDIO"].includes(n.contentType))&&(null==e||e.disconnect(o),null==o||o.disconnect(this.descNode)),r.volumeNode=null,r.srcNode=null}this.descNode=null}this.inputs=[]},i.prototype.replaceSource=function(t){var i=this;this.inputs.forEach((function(r){var n=r.stream,e=r.audioNodes;if(t===n&&e){var o=e.srcNode,s=e.volumeNode,u=e.hasAudio,h=i.ac.createMediaStreamSource(n);u&&(null==o||o.disconnect(s),h.connect(s)),e.srcNode=h}}))},i}();!function(t){t.STREAM_COMPOSITOR_MODULE="zc.scm.0"}(m||(m={}));var g=function(t){return t},E=function(t){return t},_={event:"/sdk/create_stream_zgp_compositor"},L={event:"/sdk/start_compositing_stream",error:{},media_stream_id:E,compose_stream_conf:g};var O,A="/sdk/init",I=A,k=function(){return k=Object.assign||function(t){for(var i,r=1,n=arguments.length;r<n;r++)for(var e in i=arguments[r])Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t},k.apply(this,arguments)},j=function(t,i,r,n){return new(r||(r=Promise))((function(e,o){function s(t){try{h(n.next(t))}catch(t){o(t)}}function u(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(t){t(i)}))).then(s,u)}h((n=n.apply(t,i||[])).next())}))},M=function(t,i){var r,n,e,o,s={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(h){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(s=0)),s;)try{if(r=1,n&&(e=2&u[0]?n.return:u[0]?n.throw||((e=n.return)&&e.call(n),0):n.next)&&!(e=e.call(n,u[1])).done)return e;switch(n=0,e&&(u=[2&u[0],e.value]),u[0]){case 0:case 1:e=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,n=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(e=s.trys,(e=e.length>0&&e[e.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!e||u[1]>e[0]&&u[1]<e[3])){s.label=u[1];break}if(6===u[0]&&s.label<e[1]){s.label=e[1],e=u;break}if(e&&s.label<e[2]){s.label=e[2],s.ops.push(u);break}e[2]&&s.ops.pop(),s.trys.pop();continue}u=i.call(t,s)}catch(t){u=[6,t],n=0}finally{r=e=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,h])}}},D=function(){function r(t,i,r,n){this.t=t,this.i=i,this.u=r,this.ac=n,this.mixOutputConfig={width:0,height:0,frameRate:15,bitrate:2500},this.inputStreamOptions=[],this.fit="cover",this.videoCompositor=new y(t,i,r),this.audioCompositor=new b(t,n,r)}return r.prototype.setOutputConfig=function(r){var n=r.height,e=r.frameRate,o=r.bitrate;if(!t(r.width))throw Error("param width error");if(!t(n))throw Error("param height error");if(!i(e)&&!t(e))throw Error("param frameRate error");if(!i(o)&&!t(o))throw Error("param bitrate error");this.mixOutputConfig=k(k({},this.mixOutputConfig),r),this.videoCompositor.setVideoConfig(this.mixOutputConfig)},r.prototype.setInputEndpoint=function(t,i){return j(this,void 0,void 0,(function(){var r,n,e;return M(this,(function(s){switch(s.label){case 0:if(r=function(t,i){if(t&&!o(t)&&t.zegoStream){if(i.info("cu.gs type:zego"),o(t.stream))return t.stream;throw new Error("The ZegoLocalStream type requires first calling the capture api to capture the stream")}return t}(t,this.t),!this.checkStreamIsLocal(r))throw Error(p);return n=this.inputStreamOptions.find((function(t){return t.stream===r})),this.checkInputOption(i,!!n),n?(n.option=this.assignObj(n.option,i),[3,3]):[3,1];case 1:return[4,this.createVideo(r)];case 2:e=s.sent(),this.addInputLayer({source:e,stream:r,option:k({objectFit:this.fit},i)}),s.label=3;case 3:if(!this.videoCompositor.checkVideoInputs(this.inputStreamOptions))throw f;if(!this.audioCompositor.checkAudioInputs(this.inputStreamOptions))throw c;return this.videoCompositor.setInputsOption(this.inputStreamOptions),this.audioCompositor.setInputsOption(this.inputStreamOptions),[2]}}))}))},r.prototype.addImage=function(t,i){this.checkImg(t);var r=this.inputStreamOptions.find((function(i){return i.source===t}));this.checkInputOption(i,!!r),r?r.option=this.assignObj(r.option,i):this.addInputLayer({source:t,option:k({objectFit:this.fit},i)}),this.videoCompositor.setInputsOption(this.inputStreamOptions)},r.prototype.removeImage=function(t){this.checkImg(t);var i=this.inputStreamOptions.findIndex((function(i){return i.source===t}));i>0&&(this.inputStreamOptions.splice(i,1),this.videoCompositor.setInputsOption(this.inputStreamOptions))},r.prototype.startComposingStream=function(){var t=this;return new v((function(i,r){if(!t.checkOutputs())return t.t.error("zc.sc.scs.0 output config error"),void r(h);if(!t.checkInputs())return t.t.error("zc.sc.scs.0 input params error"),void r(h);if(!t.checkBrowserSupport())return t.t.error("zc.sc.scs.0 browser not support compositor"),void r(a);t.videoCompositor.setInputsOption(t.inputStreamOptions);var n=t.videoCompositor.generateVideoTrack();t.audioCompositor.setInputsOption(t.inputStreamOptions);var e=t.audioCompositor.generateAudioTrack();t.uploadEvent();var o=[n];e&&o.push(e);var s=new MediaStream(o);t.outputStream=s,t.u.createCompositingPreviewer(s,t.mixOutputConfig,t.inputStreamOptions),i(s)}))},r.prototype.stopComposingStream=function(){var t=this;return new v((function(i){var r,n;if(t.outputStream){var e=t.u.checkPreview(t.outputStream);e&&(null===(r=e.rtcViewer)||void 0===r||r.destroy(),e.streamCompositor=null,t.u.removePreview(e)),null===(n=t.outputStream)||void 0===n||n.getTracks().forEach((function(i){t.u.trackUtils.stopTrack(i)}))}try{t.videoCompositor.stopOutputStream(),t.audioCompositor.stopAudioCompositor()}catch(t){i(!1)}t.inputStreamOptions=[],i(!0)}))},r.prototype.checkInputs=function(){var t=this.mixOutputConfig,i=t.width,r=t.height;return this.inputStreamOptions.every((function(t){var n=t.option.layout;return n.x<=i&&n.y<=r&&n.x+n.width<=i&&n.y+n.height<=r&&n.width<=i&&n.height<=r}))},r.prototype.checkOutputs=function(){var t=this.mixOutputConfig;return t.width>0&&t.height>0&&t.frameRate>0&&t.bitrate>0},r.prototype.uploadEvent=function(){var t=this.i.reporter.createSpan(O.H,{key:I},{key:""},L.event),i=this.inputStreamOptions.map((function(t){var i=t.option,r=i.layout,n=i.objectFit,e=i.contentType;return{content_control:"AUDIO"===e?1:"VIDEO"===e?2:0,x:r.x,y:r.y,w:r.width,h:r.height,order:r.zOrder,render_mode:"cover"===n?0:"contain"===n?1:2}})),r=this.mixOutputConfig;t.setAttributes({compose_stream_conf:L.compose_stream_conf({fps:r.frameRate,bitrate:r.bitrate,w:r.width,h:r.height,stream_cnt:i.length,input_stream_list:i})}),t.end()},r.prototype.checkImg=function(t){if(!t||!u(t)||!t.naturalWidth)throw this.t.error(m.STREAM_COMPOSITOR_MODULE+" source must be image and loaded"),Error("source must be image and loaded")},r.prototype.checkInputOption=function(t,r){var n=this,o=t.layout,s=t.objectFit,u=t.contentType;if(!i(o)){if(!e(o))throw Error("param layout error");["x","y","width","height"].forEach((function(t){n.checkNumParam(o,t,r)})),this.checkOptionalNumOptParam(o,"zOrder")}if(!i(s)&&!["cover","contain","fill"].includes(s))throw Error("param objectFit error");if(!i(u)&&!["ALL","VIDEO","AUDIO"].includes(u))throw Error("param contentType error");this.checkOptionalNumOptParam(t,"volume")},r.prototype.checkNumParam=function(i,r,n){if(n&&void 0===i[r]);else if(!t(i[r]))throw Error("param ".concat(r," error"))},r.prototype.checkOptionalNumOptParam=function(i,r){if(void 0!==i[r]&&!t(i[r]))throw Error("param ".concat(r," error"))},r.prototype.checkStreamIsLocal=function(t){var i=this.u.checkPreview(t),r=this.u.checkPlayer(t);return i&&(i.streamCompositor=this),!!i||!!r},r.prototype.addInputLayer=function(t){var i,r=t.option;void 0===(null===(i=r.layout)||void 0===i?void 0:i.zOrder)&&(r.layout.zOrder=0),this.inputStreamOptions.push(t)},r.prototype.createVideo=function(t){return j(this,void 0,void 0,(function(){var i=this;return M(this,(function(r){return[2,new v((function(r,n){return j(i,void 0,void 0,(function(){var i,e,o,s,u=this;return M(this,(function(h){return(i=l.createElement("video")).setAttribute("autoplay","autoplay"),i.setAttribute("muted","true"),i.muted=!0,i.setAttribute("playsinline","playsinline"),i.setAttribute("style","display:none"),e=null,o=function(){e&&(clearTimeout(e),e=null),i.play().catch((function(t){console.error(t)})),e=window.setTimeout((function(){u.t.warn("zc.sc.cv  video track error"),n(f)}),1e3)},s=function(){e&&clearTimeout(e),i&&i.removeEventListener("playing",s),r(i)},i&&i.addEventListener("playing",s),i.srcObject=t,i.play().catch((function(t){console.error(t)})),e=window.setTimeout((function(){o()}),1e3),[2]}))}))}))]}))}))},r.prototype.assignObj=function(t,i){void 0===t&&(t={});var r=t;if(!e(t)||!e(i))return i;for(var n in i)r[n]=t.hasOwnProperty(n)?this.assignObj(t[n],i[n]):i[n];return r},r.prototype.replaceSource=function(t){this.audioCompositor.replaceSource(t)},r.prototype.checkBrowserSupport=function(){var t=!0,i=function(){var t=d().toLowerCase().match(/cpu iphone os (.*?) like mac os/);return t&&t[1]||""}();return i&&i.includes("14_6")&&(t=!1),t},r}(),S=function(){function t(t){this.v=t}return t.prototype.addImage=function(t,i){this.v.addImage(t,i)},t.prototype.removeImage=function(t){this.v.removeImage(t)},t.prototype.setInputEndpoint=function(t,i){return this.v.setInputEndpoint(t,i)},t.prototype.setOutputConfig=function(t){this.v.setOutputConfig(t)},t.prototype.startComposingStream=function(){return this.v.startComposingStream()},t.prototype.stopComposingStream=function(){return this.v.stopComposingStream()},t}();!function(t){t[t.I=0]="I",t[t.H=10]="H",t[t.M=100]="M",t[t.L=1e3]="L"}(O||(O={}));var x={createStreamCompositor:function(){var t=this.reporter.createSpan(O.H,{key:I},{key:""},_.event),i=new D(this.logger,this.stateCenter,this.streamCenter,this.ac);return t.end(),new S(i)}},z={install:function(t){for(var i in x)Object.defineProperty(t.prototype,i,{value:x[i],writable:!1})},get type(){return"StreamCompositor"}}}(),n}()}));